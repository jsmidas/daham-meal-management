<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‹ë‹¨í‘œ ê´€ë¦¬ - ë‹¤í•¨ì‹ë‹¨ê´€ë¦¬ì‹œìŠ¤í…œ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Malgun Gothic', sans-serif;
            background-color: #f5f5f5;
            line-height: 1.4;
        }
        
        .navigation-bar {
            background: linear-gradient(135deg, #2d3748 0%, #4a5568 100%);
            display: flex;
            align-items: center;
            padding: 10px 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .nav-item {
            color: white;
            padding: 8px 16px;
            margin: 0 5px;
            border-radius: 6px;
            text-decoration: none;
            font-size: 14px;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .nav-item:hover {
            background: rgba(255,255,255,0.1);
        }
        
        .nav-item.active {
            background: rgba(255,255,255,0.2);
            font-weight: 600;
        }
        
        .nav-logo {
            font-size: 18px;
            font-weight: bold;
            color: white;
            margin-right: 30px;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 24px;
            font-weight: 600;
        }
        
        .main-container {
            height: calc(100vh - 140px);
            padding: 20px;
        }
        
        /* ìº˜ë¦°ë” ì˜ì—­ (ì „ì²´ í™”ë©´ ì‚¬ìš©) */
        .calendar-section {
            width: 100%;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
            overflow-y: auto;
        }
        
        /* ìº˜ë¦°ë” í—¤ë” */
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .calendar-nav {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .calendar-nav button {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .calendar-nav button:hover {
            background: #5a67d8;
            transform: translateY(-1px);
        }
        
        .current-date {
            font-size: 18px;
            font-weight: 600;
            color: #2d3748;
        }
        
        /* ìº˜ë¦°ë” ê·¸ë¦¬ë“œ */
        .calendar-grid {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        
        .calendar-grid th {
            background: #f7fafc;
            padding: 12px;
            text-align: center;
            font-weight: 600;
            color: #4a5568;
            border: 1px solid #e2e8f0;
            font-size: 14px;
        }
        
        .calendar-grid td {
            height: auto;
            min-height: calc(240px + var(--meal-slots, 15) * 25px);
            width: 14.28%;
            border: 1px solid #e2e8f0;
            vertical-align: top;
            padding: 8px;
            position: relative;
            background: white;
            transition: all 0.3s;
        }
        
        .calendar-grid td:hover {
            background: #f8fafc;
        }
        
        .calendar-grid td.other-month {
            background: #f8f9fa;
            color: #a0aec0;
        }
        
        .calendar-grid td.today {
            background: #e6f3ff;
            border-color: #3182ce;
        }
        
        .date-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        
        .date-number {
            font-size: 16px;
            font-weight: 600;
            color: #2d3748;
        }
        
        .manage-btn {
            background: #48bb78;
            color: white;
            border: none;
            padding: 3px 6px;
            border-radius: 3px;
            font-size: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .manage-btn:hover {
            background: #38a169;
            transform: scale(1.05);
        }
        
        .total-cost {
            position: absolute;
            bottom: 8px;
            right: 8px;
            background: #667eea;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }
        
        .meal-summary {
            font-size: 11px;
            color: #555;
            line-height: 1.3;
            margin-top: 5px;
            max-height: calc(var(--meal-slots, 15) * 25px);
            overflow-y: auto;
            overflow-x: hidden;
        }
        
        .meal-item {
            background: #e2e8f0;
            padding: 3px 5px;
            margin: 2px 0;
            border-radius: 3px;
            font-size: 9px;
            color: #4a5568;
            line-height: 1.2;
        }

        .meal-item.meal-header {
            background: #d1ecf1;
            font-weight: bold;
            border-left: 3px solid #007bff;
            font-size: 11px;
            padding: 4px 6px;
        }

        .meal-item.menu-detail {
            background: #f8f9fa;
            margin-left: 8px;
            border-left: 2px solid #dee2e6;
            padding: 4px 6px;
        }
        
        /* ìš°ì¸¡ ë©”ë‰´ ëª©ë¡ ìŠ¤íƒ€ì¼ */
        .menu-list-header {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .menu-list-header h3 {
            font-size: 16px;
            color: #2d3748;
            font-weight: 600;
        }
        
        .menu-category {
            margin-bottom: 20px;
        }
        
        .menu-category h4 {
            font-size: 14px;
            color: #4a5568;
            margin-bottom: 8px;
            padding: 5px 0;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .menu-item {
            padding: 8px 10px;
            margin-bottom: 5px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
            font-size: 12px;
        }
        
        .menu-item:hover {
            border-color: #667eea;
            background: #f7fafc;
            transform: translateX(3px);
        }
        
        .menu-item.dragging {
            opacity: 0.5;
            transform: rotate(5deg);
        }
        
        .menu-price {
            float: right;
            color: #38a169;
            font-weight: 600;
        }
        
        /* ì‹ë‹¨ ì…ë ¥ ëª¨ë‹¬ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-overlay.active {
            display: flex;
        }
        
        .meal-input-modal {
            background: white;
            width: 98%;
            max-width: 1600px;
            height: 95%;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h3 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
        }
        
        .modal-close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s;
        }
        
        .modal-close-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .modal-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        
        /* ìƒˆë¡œìš´ ë“œë˜ê·¸ ì•¤ ë“œë¡­ ë ˆì´ì•„ì›ƒ */
        .meal-planning-layout {
            display: flex;
            gap: 30px;
            height: 100%;
            min-height: 500px;
        }
        
        .meal-slots-section {
            flex: 6.5;
            background: #f8f9fb;
            border-radius: 12px;
            padding: 20px;
            overflow-y: auto;
        }
        
        .meal-slots-section h4 {
            margin: 0 0 15px 0;
            color: #2d3748;
            font-size: 16px;
            font-weight: 600;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 10px;
        }
        
        .menu-search-section {
            flex: 3.5;
            background: #fafbfc;
            border-radius: 12px;
            padding: 15px;
            display: flex;
            flex-direction: column;
        }
        
        .menu-search-section h4, .menu-search-section h5 {
            margin: 0 0 15px 0;
            color: #2d3748;
            font-weight: 600;
        }
        
        .menu-search-section h4 {
            font-size: 16px;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 10px;
        }
        
        .menu-search-section h5 {
            font-size: 14px;
            color: #4a5568;
        }
        
        /* ì¶•ì†Œëœ ì‹ë‹¨ ìŠ¬ë¡¯ë“¤ (2/3 í¬ê¸°) */
        .meal-input-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }
        
        .meal-slot {
            border: 2px dashed #cbd5e0;
            border-radius: 8px;
            padding: 12px;
            background: white;
            transition: all 0.3s;
            min-height: 80px;
            position: relative;
        }
        
        .meal-slot.drag-over {
            border-color: #667eea;
            background: #eef2ff;
            transform: scale(1.05);
        }
        
        .meal-slot:hover {
            border-color: #667eea;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
        }
        
        .meal-slot.has-menu {
            border-color: #48bb78;
            background: #f0fff4;
        }
        
        .meal-name {
            font-size: 14px;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 8px;
        }
        
        .menu-select {
            width: 100%;
            padding: 8px;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            font-size: 12px;
            background: white;
        }
        
        .menu-select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .modal-actions {
            padding: 20px;
            border-top: 1px solid #e2e8f0;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5a67d8;
            transform: translateY(-1px);
        }
        
        .btn-secondary {
            background: #e2e8f0;
            color: #4a5568;
        }
        
        .btn-secondary:hover {
            background: #cbd5e0;
        }
        
        /* ë©”ë‰´ ê²€ìƒ‰ ê´€ë ¨ ìŠ¤íƒ€ì¼ */
        .menu-search-container {
            display: flex;
            gap: 5px;
            margin-top: 8px;
        }
        
        .menu-search {
            flex: 1;
            padding: 8px;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
        }
        
        .menu-search:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
        }
        
        .menu-search-btn {
            padding: 8px 10px;
            border: 1px solid #667eea;
            border-radius: 4px;
            background: #667eea;
            color: white;
            cursor: pointer;
            font-size: 12px;
        }
        
        .menu-search-btn:hover {
            background: #5a67d8;
        }
        
        .selected-menu-info {
            margin-top: 5px;
            font-size: 10px;
            color: #666;
        }
        
        /* ë©”ë‰´ ê²€ìƒ‰ ëª¨ë‹¬ */
        .menu-search-modal {
            background: white;
            width: 90%;
            max-width: 800px;
            height: 70%;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
        }
        
        .search-input-container {
            padding: 20px;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .search-input-container input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        .search-input-container input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .menu-search-results {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            max-height: 400px;
        }
        
        .menu-result-item {
            padding: 12px 16px;
            margin-bottom: 8px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .menu-result-item:hover {
            border-color: #667eea;
            background: #f8fafc;
            transform: translateY(-1px);
        }
        
        .menu-result-item.selected {
            border-color: #48bb78;
            background: #f0fff4;
        }
        
        .menu-result-name {
            font-weight: 600;
            color: #2d3748;
        }
        
        .menu-result-info {
            font-size: 12px;
            color: #666;
        }
        
        /* ë©”ë‰´ ì´ë ¥ ë° ê²€ìƒ‰ ê²°ê³¼ ìŠ¤íƒ€ì¼ */
        .menu-list-container {
            flex: 1;
            overflow-y: auto;
        }
        
        .menu-history, .menu-search-results-inline {
            margin-bottom: 25px;
        }
        
        .menu-history-items {
            max-height: 120px;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 8px;
            background: white;
        }
        
        .menu-results-grid {
            max-height: 250px;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 8px;
            background: white;
        }
        
        /* ë“œë˜ê·¸ ê°€ëŠ¥í•œ ë©”ë‰´ ì•„ì´í…œ - ì»´íŒ©íŠ¸ ë””ìì¸ */
        .draggable-menu-item {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            margin: 2px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            background: white;
            cursor: grab;
            transition: all 0.3s;
            user-select: none;
            font-size: 12px;
            min-width: 120px;
            max-width: 150px;
        }
        
        .draggable-menu-item:hover {
            border-color: #667eea;
            background: #f8fafc;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.15);
        }
        
        .draggable-menu-item:active {
            cursor: grabbing;
        }
        
        .draggable-menu-item.dragging {
            opacity: 0.5;
            transform: rotate(5deg);
        }
        
        .menu-item-icon {
            font-size: 14px;
            flex-shrink: 0;
        }
        
        .menu-item-details {
            flex: 1;
            min-width: 0;
            overflow: hidden;
        }
        
        .menu-item-name {
            font-weight: 600;
            color: #2d3748;
            font-size: 11px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.2;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .menu-item-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 4px;
            font-size: 9px;
            margin-top: 2px;
        }
        
        .menu-item-rating {
            font-size: 9px;
            color: #667eea;
            white-space: nowrap;
        }

        .menu-item-ingredients {
            color: #666;
            font-size: 9px;
            margin-top: 2px;
            line-height: 1.2;
        }
        
        .menu-item-cost {
            color: #e74c3c;
            font-weight: bold;
            font-size: 9px;
            white-space: nowrap;
        }
        
        /* ì„ íƒëœ ë©”ë‰´ë“¤ */
        .selected-menu-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex: 1;
        }
        
        .selected-menu-name {
            font-size: 11px;
            font-weight: 600;
        }
        
        .selected-menu-cost {
            color: #e74c3c;
            font-weight: bold;
            font-size: 10px;
            margin-left: 8px;
        }
        .selected-menus-container {
            min-height: 30px;
            margin-top: 8px;
        }
        
        .selected-menu-item {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            padding: 8px 10px;
            margin: 4px 0;
            background: #e6f3ff;
            border: 1px solid #b8daff;
            border-radius: 6px;
            font-size: 11px;
            cursor: move;
            min-height: 50px;
        }

        .selected-menu-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }

        .selected-menu-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .selected-menu-name {
            font-weight: 600;
            color: #2d3748;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .selected-menu-cost {
            color: #e74c3c;
            font-weight: 600;
            font-size: 10px;
        }

        .menu-color-box {
            width: 12px;
            height: 12px;
            border-radius: 2px;
            display: inline-block;
            font-size: 0;
            border: 1px solid #ddd;
        }

        .selected-menu-ingredients {
            color: #666;
            font-size: 10px;
            margin-top: 4px;
            line-height: 1.3;
            width: 100%;
        }
        
        .selected-menu-item:hover {
            background: #cce7ff;
        }
        
        .selected-menu-remove {
            background: #f56565;
            color: white;
            border: none;
            border-radius: 3px;
            width: 16px;
            height: 16px;
            cursor: pointer;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .meal-name {
            font-size: 12px;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .meal-total-cost {
            color: #e74c3c;
            font-weight: bold;
            font-size: 11px;
        }
    </style>
</head>
<body>
    <!-- ë„¤ë¹„ê²Œì´ì…˜ ë°” -->
    <nav class="navigation-bar">
        <div class="nav-logo">ğŸ½ï¸ ë‹¤í•¨ì‹ë‹¨ê´€ë¦¬</div>
        <a href="/" class="nav-item">ë©”ë‰´ ê´€ë¦¬</a>
        <a href="/meal-plan" class="nav-item active">ì‹ë‹¨ ê´€ë¦¬</a>
        <a href="#" class="nav-item">ë°œì£¼ ê´€ë¦¬</a>
        <a href="#" class="nav-item">í†µê³„</a>
    </nav>

    <!-- í—¤ë” -->
    <div class="header">
        <h1>ğŸ“… ì‹ë‹¨í‘œ ê´€ë¦¬</h1>
    </div>

    <!-- ë©”ì¸ ì»¨í…Œì´ë„ˆ -->
    <div class="main-container">
        <!-- ìº˜ë¦°ë” ì˜ì—­ (ì „ì²´ í™”ë©´ ì‚¬ìš©) -->
        <div class="calendar-section">
            <div class="calendar-header">
                <div class="calendar-nav">
                    <button onclick="previousMonth()">â—€ ì´ì „</button>
                    <div class="current-date" id="currentDate">2025ë…„ 8ì›”</div>
                    <button onclick="nextMonth()">ë‹¤ìŒ â–¶</button>
                </div>
                <div>
                    <button class="btn btn-primary" onclick="goToToday()">ì˜¤ëŠ˜</button>
                    <button class="btn btn-secondary" onclick="openMealInputModal('2025-08-29')" style="margin-left: 10px;">í…ŒìŠ¤íŠ¸</button>
                </div>
            </div>
            
            <table class="calendar-grid" id="calendar">
                <thead>
                    <tr>
                        <th>ì¼</th>
                        <th>ì›”</th>
                        <th>í™”</th>
                        <th>ìˆ˜</th>
                        <th>ëª©</th>
                        <th>ê¸ˆ</th>
                        <th>í† </th>
                    </tr>
                </thead>
                <tbody id="calendarBody">
                    <!-- ìº˜ë¦°ë” ë‚´ìš©ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- ì‹ë‹¨ ì…ë ¥ ëª¨ë‹¬ -->
    <div class="modal-overlay" id="mealInputModal" style="z-index: 9999;" onclick="closeMealInputModal()">
        <div class="meal-input-modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3 id="modalTitle">2025ë…„ 8ì›” 29ì¼ ì‹ë‹¨ ì…ë ¥</h3>
                <button class="modal-close-btn" onclick="closeMealInputModal()">Ã—</button>
            </div>
            
            <div class="modal-content">
                <!-- ìƒˆë¡œìš´ ë ˆì´ì•„ì›ƒ: ì¢Œì¸¡ì€ ì‹ë‹¨ ìŠ¬ë¡¯, ìš°ì¸¡ì€ ê²€ìƒ‰ ë° ë©”ë‰´ ëª©ë¡ -->
                <div class="meal-planning-layout">
                    <!-- ì¢Œì¸¡: ì‹ë‹¨ ìŠ¬ë¡¯ë“¤ -->
                    <div class="meal-slots-section">
                        <h4>ğŸ“‹ ì‹ë‹¨ êµ¬ì„±</h4>
                        <div class="meal-input-grid" id="mealInputGrid">
                            <!-- 15ê°œ ì‹ë‹¨ ì…ë ¥ ìŠ¬ë¡¯ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
                        </div>
                    </div>
                    
                    <!-- ìš°ì¸¡: ë©”ë‰´ ê²€ìƒ‰ ë° ëª©ë¡ -->
                    <div class="menu-search-section">
                        <h4>ğŸ” ë©”ë‰´ ê²€ìƒ‰</h4>
                        <div class="search-input-container">
                            <input type="text" id="mealPlanSearchInput" placeholder="ë©”ë‰´ëª…ì„ ì…ë ¥í•˜ì„¸ìš”..." 
                                   onkeyup="searchMenusInMealPlan()" autocomplete="off">
                        </div>
                        
                        <!-- ê²€ìƒ‰ ê²°ê³¼ ë° ì´ë ¥ -->
                        <div class="menu-list-container">
                            <div class="menu-history" id="menuHistory">
                                <h5>ğŸ“Œ ìµœê·¼ ê²€ìƒ‰í•œ ë©”ë‰´</h5>
                                <div class="menu-history-items" id="menuHistoryItems">
                                    <!-- ê²€ìƒ‰ ì´ë ¥ ë©”ë‰´ë“¤ì´ ì—¬ê¸°ì— í‘œì‹œ -->
                                </div>
                            </div>
                            
                            <div class="menu-search-results-inline" id="menuSearchResultsInline">
                                <h5>ğŸ½ï¸ ê²€ìƒ‰ ê²°ê³¼</h5>
                                <div class="menu-results-grid" id="menuResultsGrid">
                                    <!-- ê²€ìƒ‰ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œ -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeMealInputModal()">ì·¨ì†Œ</button>
                <button class="btn btn-primary" onclick="saveMealPlan()">ì €ì¥</button>
            </div>
        </div>
    </div>

    <!-- ë©”ë‰´ ê²€ìƒ‰ ëª¨ë‹¬ -->
    <div class="modal-overlay" id="menuSearchModal" style="z-index: 10000;">
        <div class="menu-search-modal">
            <div class="modal-header">
                <h3>ë©”ë‰´ ê²€ìƒ‰ ë° ì„ íƒ</h3>
                <button class="modal-close-btn" onclick="closeMenuSearchModal()">Ã—</button>
            </div>
            
            <div class="modal-content">
                <div class="search-input-container">
                    <input type="text" id="menuSearchInput" placeholder="ë©”ë‰´ëª…ì„ ì…ë ¥í•˜ì„¸ìš”..." 
                           onkeyup="searchMenus()" autocomplete="off">
                </div>
                
                <div class="menu-search-results" id="menuSearchResults">
                    <!-- ê²€ìƒ‰ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                </div>
            </div>
            
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeMenuSearchModal()">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>

    <script>
        // ì „ì—­ ë³€ìˆ˜
        let currentDate = new Date();
        let selectedDate = null;
        let mealData = {}; // ë‚ ì§œë³„ ì‹ë‹¨ ë°ì´í„° ì €ì¥
        let allMenus = []; // ì „ì²´ ë©”ë‰´ ë°ì´í„°
        let menuHistory = []; // ê²€ìƒ‰ ì´ë ¥
        let menuCostsCache = {}; // ë©”ë‰´ ì›ê°€ ìºì‹œ
        let menuIngredientsCache = {}; // ë©”ë‰´ ì‹ì¬ë£Œ ìºì‹œ
        let currentMealSlotIndex = -1; // í˜„ì¬ ì„ íƒ ì¤‘ì¸ ì‹ë‹¨ ìŠ¬ë¡¯
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ìºì‹œëœ ë°ì´í„° ë³µì›
        function loadCachedData() {
            try {
                const cachedCosts = localStorage.getItem('menuCostsCache');
                if (cachedCosts) {
                    menuCostsCache = JSON.parse(cachedCosts);
                }
                
                const cachedIngredients = localStorage.getItem('menuIngredientsCache');
                if (cachedIngredients) {
                    menuIngredientsCache = JSON.parse(cachedIngredients);
                }
                
                console.log(`ìºì‹œ ë¡œë“œ ì™„ë£Œ: ì›ê°€ ${Object.keys(menuCostsCache).length}ê°œ, ì‹ì¬ë£Œ ${Object.keys(menuIngredientsCache).length}ê°œ`);
            } catch (error) {
                console.error('ìºì‹œ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }
        
        // ê¸°ë³¸ 15ê°œ ì‹ë‹¨ëª… (ìˆ˜ì • ê°€ëŠ¥)
        const defaultMealNames = [
            'ì¡°ì‹A', 'ì¡°ì‹B', 'ì¡°ì‹C',
            'ì¤‘ì‹A', 'ì¤‘ì‹B', 'ì¤‘ì‹C',
            'ì„ì‹A', 'ì„ì‹B', 'ì„ì‹C',
            'ê°„ì‹A', 'ê°„ì‹B', 'ê°„ì‹C',
            'íŠ¹ì‹A', 'íŠ¹ì‹B', 'íŠ¹ì‹C'
        ];
        
        // CSS ë³€ìˆ˜ ì„¤ì •ìœ¼ë¡œ ìº˜ë¦°ë” í¬ê¸° ì¡°ì •
        function adjustCalendarSize() {
            const mealSlotsCount = defaultMealNames.length;
            document.documentElement.style.setProperty('--meal-slots', mealSlotsCount);
            console.log(`ìº˜ë¦°ë” í¬ê¸° ì¡°ì •: ${mealSlotsCount}ê°œ ì‹ë‹¨ìœ¼ë¡œ ì„¤ì •`);
        }
        
        // ë©”ë‰´ë³„ ìƒ‰ìƒ ê²°ì • í•¨ìˆ˜ (ë©”ë‰´ ì¢…ë¥˜ì— ë”°ë¼ ìƒ‰ìƒ êµ¬ë¶„)
        function getMenuColor(menuName) {
            // ë©”ë‰´ëª…ì„ ê¸°ë°˜ìœ¼ë¡œ ìƒ‰ìƒì„ ê²°ì •í•˜ëŠ” ê°„ë‹¨í•œ ë¡œì§
            // ì‹¤ì œë¡œëŠ” ë°ì´í„°ë² ì´ìŠ¤ì— ë©”ë‰´ë³„ ì¹´í…Œê³ ë¦¬ ì •ë³´ê°€ ìˆì–´ì•¼ í•¨
            const colorMap = {
                'ë°¥': '#ff6b6b',     // ë¹¨ê°„ìƒ‰ - ì£¼ì‹
                'êµ­': '#4ecdc4',     // ì²­ë¡ìƒ‰ - êµ­ë¬¼ë¥˜
                'ì°Œê°œ': '#4ecdc4',   // ì²­ë¡ìƒ‰ - êµ­ë¬¼ë¥˜
                'ë³¶ìŒ': '#45b7d1',   // íŒŒë€ìƒ‰ - ë³¶ìŒë¥˜
                'ë¬´ì¹¨': '#96ceb4',   // ì´ˆë¡ìƒ‰ - ë‚˜ë¬¼ë¥˜
                'ì¡°ë¦¼': '#feca57',   // ë…¸ë€ìƒ‰ - ì¡°ë¦¼ë¥˜
                'êµ¬ì´': '#ff9ff3',   // í•‘í¬ìƒ‰ - êµ¬ì´ë¥˜
                'íŠ€ê¹€': '#ff7675',   // ì£¼í™©ìƒ‰ - íŠ€ê¹€ë¥˜
                'ê¹€ì¹˜': '#fd79a8',   // ë¶„í™ìƒ‰ - ê¹€ì¹˜ë¥˜
                'ì–‘ë…': '#fdcb6e'    // ì—°ë…¸ë€ìƒ‰ - ì–‘ë…ë¥˜
            };
            
            // ë©”ë‰´ëª…ì—ì„œ í‚¤ì›Œë“œë¥¼ ì°¾ì•„ ìƒ‰ìƒ ê²°ì •
            for (let [keyword, color] of Object.entries(colorMap)) {
                if (menuName.includes(keyword)) {
                    return color;
                }
            }
            
            // ê¸°ë³¸ ìƒ‰ìƒ (ë³´ë¼ìƒ‰)
            return '#a29bfe';
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', async function() {
            loadCachedData(); // ìºì‹œëœ ë°ì´í„° ë¨¼ì € ë³µì›
            adjustCalendarSize(); // ìº˜ë¦°ë” í¬ê¸° ë¨¼ì € ì¡°ì •
            await loadMenuData();
            generateCalendar();
            loadMealData();
        });
        
        // ë©”ë‰´ ë°ì´í„° ë¡œë“œ
        async function loadMenuData() {
            try {
                const response = await fetch('/recipes');
                const result = await response.json();
                if (result.success) {
                    allMenus = result.data;
                    console.log('ë©”ë‰´ ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', allMenus.length, 'ê°œ');
                }
            } catch (error) {
                console.error('ë©”ë‰´ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }
        
        // ìº˜ë¦°ë” ìƒì„±
        async function generateCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            // í˜„ì¬ ì›” ì²«ì§¸ ë‚ ê³¼ ë§ˆì§€ë§‰ ë‚ 
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());
            
            // í—¤ë” ì—…ë°ì´íŠ¸
            document.getElementById('currentDate').textContent = 
                `${year}ë…„ ${month + 1}ì›”`;
            
            // ìº˜ë¦°ë” ë°”ë”” ìƒì„±
            const calendarBody = document.getElementById('calendarBody');
            calendarBody.innerHTML = '';
            
            let currentWeekDate = new Date(startDate);
            
            for (let week = 0; week < 6; week++) {
                const row = document.createElement('tr');
                
                for (let day = 0; day < 7; day++) {
                    const cell = document.createElement('td');
                    const dateKey = formatDate(currentWeekDate);
                    const isCurrentMonth = currentWeekDate.getMonth() === month;
                    const isToday = dateKey === formatDate(new Date());
                    
                    // ì…€ í´ë˜ìŠ¤ ì„¤ì •
                    if (!isCurrentMonth) {
                        cell.classList.add('other-month');
                    }
                    if (isToday) {
                        cell.classList.add('today');
                    }
                    
                    // ë‚ ì§œ í—¤ë” (ë‚ ì§œ + ê´€ë¦¬ ë²„íŠ¼ì„ ë‚˜ë€íˆ ë°°ì¹˜)
                    const dateHeader = document.createElement('div');
                    dateHeader.className = 'date-header';
                    
                    const dateNumber = document.createElement('div');
                    dateNumber.className = 'date-number';
                    dateNumber.textContent = currentWeekDate.getDate();
                    dateHeader.appendChild(dateNumber);
                    
                    // ê´€ë¦¬ ë²„íŠ¼ (í˜„ì¬ ì›”ë§Œ)
                    if (isCurrentMonth) {
                        const manageBtn = document.createElement('button');
                        manageBtn.className = 'manage-btn';
                        manageBtn.textContent = 'ê´€ë¦¬';
                        manageBtn.onclick = () => openMealInputModal(dateKey);
                        dateHeader.appendChild(manageBtn);
                    }
                    
                    cell.appendChild(dateHeader);
                    
                    // ì‹ë‹¨ ìš”ì•½ í‘œì‹œ (í˜„ì¬ ì›”ë§Œ)
                    if (isCurrentMonth) {
                        const mealSummary = document.createElement('div');
                        mealSummary.className = 'meal-summary';
                        
                        if (mealData[dateKey] && mealData[dateKey].length > 0) {
                            // ëª¨ë“  ë©”ë‰´ì˜ ì‹ì¬ë£Œ ì •ë³´ë¥¼ ë¨¼ì € ë¡œë“œ
                            const allMenuNames = [];
                            mealData[dateKey].forEach(meal => {
                                const menus = meal.menus || [meal.menu].filter(Boolean);
                                allMenuNames.push(...menus);
                            });
                            
                            if (allMenuNames.length > 0) {
                                await getMenuIngredients(allMenuNames);
                            }
                            
                            mealData[dateKey].forEach(meal => {
                                const menus = meal.menus || [meal.menu].filter(Boolean);
                                if (menus.length > 0) {
                                    // ì‹ë‹¨ëª…ê³¼ ì´ ê¸ˆì•¡ í‘œì‹œ
                                    let mealTotalCost = 0;
                                    menus.forEach(menuName => {
                                        const cost = menuCostsCache[menuName] || 0;
                                        mealTotalCost += cost;
                                    });
                                    
                                    const mealHeaderItem = document.createElement('div');
                                    mealHeaderItem.className = 'meal-item meal-header';
                                    mealHeaderItem.innerHTML = `
                                        <div style="font-weight: bold; color: #2d3748; font-size: 11px; display: flex; justify-content: space-between; align-items: center;">
                                            <span>${meal.name}</span>
                                            <span style="color: #e74c3c; font-size: 10px;">ï¿¦${mealTotalCost.toLocaleString()}</span>
                                        </div>
                                    `;
                                    mealSummary.appendChild(mealHeaderItem);
                                    
                                    // ê° ë©”ë‰´ë³„ ìƒì„¸ í‘œì‹œ
                                    menus.forEach((menuName) => {
                                        const cost = menuCostsCache[menuName] || 0;
                                        const costDisplay = cost > 0 ? `ï¿¦${cost}` : 'ì›ê°€ë¯¸ì‚°ì •';
                                        
                                        // ì‹ì¬ë£Œ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                                        const ingredientInfo = menuIngredientsCache[menuName];
                                        let ingredientsDisplay = '';
                                        if (ingredientInfo && ingredientInfo.ingredients) {
                                            const ingredients = ingredientInfo.ingredients.slice(0, 7); // ìµœëŒ€ 7ê°œ
                                            ingredientsDisplay = ingredients.map(ing => `â– ë‹¤)${ing}`).join('<br>');
                                        }
                                        
                                        const menuDetailItem = document.createElement('div');
                                        menuDetailItem.className = 'meal-item menu-detail';
                                        menuDetailItem.innerHTML = `
                                            <div style="font-size: 10px; line-height: 1.4; color: #555;">
                                                <div style="font-weight: 600; margin-bottom: 2px; color: #2d3748; display: flex; align-items: center; gap: 5px;">
                                                    <span class="menu-color-box" style="background-color: ${getMenuColor(menuName)}; width: 10px; height: 10px; border-radius: 2px; display: inline-block; border: 1px solid #ccc;">â–¡</span>
                                                    <span>${menuName}</span>
                                                    <span style="color: #e74c3c; font-weight: bold; font-size: 9px;">${costDisplay}</span>
                                                </div>
                                                ${ingredientsDisplay ? `<div style="color: #777; font-size: 8px; margin-left: 15px; line-height: 1.3;">${ingredientsDisplay}</div>` : ''}
                                            </div>
                                        `;
                                        mealSummary.appendChild(menuDetailItem);
                                    });
                                }
                            });
                        }
                        
                        cell.appendChild(mealSummary);
                        
                        // ì´ ê¸ˆì•¡ í‘œì‹œ
                        const totalCost = calculateDayTotal(dateKey);
                        if (totalCost > 0) {
                            const totalCostDiv = document.createElement('div');
                            totalCostDiv.className = 'total-cost';
                            totalCostDiv.textContent = `${totalCost.toLocaleString()}ì›`;
                            cell.appendChild(totalCostDiv);
                        }
                    }
                    
                    row.appendChild(cell);
                    currentWeekDate.setDate(currentWeekDate.getDate() + 1);
                }
                
                calendarBody.appendChild(row);
            }
        }
        
        // ë‚ ì§œ í˜•ì‹ ë³€í™˜
        function formatDate(date) {
            return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
        }
        
        // ì´ì „/ë‹¤ìŒ ì›”
        function previousMonth() {
            currentDate.setMonth(currentDate.getMonth() - 1);
            generateCalendar();
        }
        
        function nextMonth() {
            currentDate.setMonth(currentDate.getMonth() + 1);
            generateCalendar();
        }
        
        function goToToday() {
            currentDate = new Date();
            generateCalendar();
        }
        
        // ì‹ë‹¨ ì…ë ¥ ëª¨ë‹¬ ì—´ê¸°
        function openMealInputModal(dateKey) {
            console.log('Opening meal input modal for date:', dateKey);
            selectedDate = dateKey;
            const date = new Date(dateKey);
            const modalTitle = `${date.getFullYear()}ë…„ ${date.getMonth() + 1}ì›” ${date.getDate()}ì¼ ì‹ë‹¨ ì…ë ¥`;
            document.getElementById('modalTitle').textContent = modalTitle;
            
            // 15ê°œ ì‹ë‹¨ ì…ë ¥ ìŠ¬ë¡¯ ìƒì„±
            const mealInputGrid = document.getElementById('mealInputGrid');
            mealInputGrid.innerHTML = '';
            
            const currentMealData = mealData[dateKey] || defaultMealNames.map(name => ({ name, menu: '' }));
            
            currentMealData.forEach((meal, index) => {
                const mealSlot = document.createElement('div');
                mealSlot.className = 'meal-slot';
                mealSlot.setAttribute('data-slot-index', index);
                
                // ë“œë¡­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
                mealSlot.addEventListener('dragover', handleDragOver);
                mealSlot.addEventListener('drop', handleDrop);
                mealSlot.addEventListener('dragleave', handleDragLeave);
                
                const selectedMenus = meal.menus || [meal.menu].filter(Boolean);
                
                mealSlot.innerHTML = `
                    <div class="meal-name">
                        ${meal.name}
                        <span class="meal-total-cost" id="totalCost${index}">0ì›</span>
                    </div>
                    <div class="selected-menus-container" id="selectedMenus${index}">
                        ${selectedMenus.map((menuName, menuIndex) => {
                            const cost = menuCostsCache[menuName] || 0;
                            const costDisplay = cost > 0 ? `${cost.toLocaleString()}ì›` : 'ì›ê°€ë¯¸ì‚°ì •';
                            return `
                            <div class="selected-menu-item" draggable="true" 
                                 data-menu-name="${menuName}" data-menu-index="${menuIndex}">
                                <div class="selected-menu-header">
                                    <div class="selected-menu-name">
                                        <span class="menu-color-box" style="background-color: ${getMenuColor(menuName)};">â–¡</span>
                                        ${menuName}
                                    </div>
                                    <div class="selected-menu-actions">
                                        <span class="selected-menu-cost">${costDisplay}</span>
                                        <button class="selected-menu-remove" onclick="removeSelectedMenu(${index}, ${menuIndex})">Ã—</button>
                                    </div>
                                </div>
                            </div>
                            `;
                        }).join('')}
                    </div>
                `;
                
                mealInputGrid.appendChild(mealSlot);
                
                // ê° ì‹ë‹¨ì˜ ì´ ê¸ˆì•¡ ì—…ë°ì´íŠ¸
                updateMealTotalCost(index);
            });
            
            // ê²€ìƒ‰ì°½ ì´ˆê¸°í™” ë° ì´ë ¥ í‘œì‹œ
            document.getElementById('mealPlanSearchInput').value = '';
            displayMenuHistory();
            displayInitialMenus();
            
            const modal = document.getElementById('mealInputModal');
            modal.classList.add('active');
            console.log('Modal should now be visible:', modal.classList.contains('active'));
        }
        
        // ì‹ë‹¨ ì…ë ¥ ëª¨ë‹¬ ë‹«ê¸°
        function closeMealInputModal() {
            document.getElementById('mealInputModal').classList.remove('active');
            selectedDate = null;
        }
        
        // ì‹ë‹¨ ì €ì¥
        function saveMealPlan() {
            if (!selectedDate) return;
            
            const mealPlan = defaultMealNames.map((name, index) => {
                const container = document.getElementById(`selectedMenus${index}`);
                const selectedMenus = Array.from(container.querySelectorAll('.selected-menu-item'))
                    .map(item => item.dataset.menuName);
                
                return {
                    name,
                    menus: selectedMenus,
                    menu: selectedMenus[0] || '' // í˜¸í™˜ì„±ì„ ìœ„í•´ ì²« ë²ˆì§¸ ë©”ë‰´ë¥¼ menuë¡œë„ ì €ì¥
                };
            });
            
            mealData[selectedDate] = mealPlan;
            
            // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥
            localStorage.setItem('mealPlanData', JSON.stringify(mealData));
            
            // ìº˜ë¦°ë” ë‹¤ì‹œ ê·¸ë¦¬ê¸°
            generateCalendar();
            
            // ëª¨ë‹¬ ë‹«ê¸°
            closeMealInputModal();
            
            alert('ì‹ë‹¨ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }
        
        // ë°ì´í„° ë¡œë“œ
        function loadMealData() {
            const saved = localStorage.getItem('mealPlanData');
            if (saved) {
                mealData = JSON.parse(saved);
            }
        }
        
        // í•˜ë£¨ ì´ ê¸ˆì•¡ ê³„ì‚° (ì„ì‹œë¡œ ê³ ì • ê°€ê²© ì‚¬ìš©)
        function calculateDayTotal(dateKey) {
            if (!mealData[dateKey] || mealData[dateKey].length === 0) {
                return 0;
            }
            
            let total = 0;
            mealData[dateKey].forEach(meal => {
                const menus = meal.menus || [meal.menu].filter(Boolean);
                menus.forEach(menuName => {
                    const cost = menuCostsCache[menuName] || 0;
                    total += cost;
                });
            });
            
            return total;
        }
        
        // ë©”ë‰´ ê²€ìƒ‰ ëª¨ë‹¬ ì—´ê¸°
        function openMenuSearch(slotIndex) {
            currentMealSlotIndex = slotIndex;
            document.getElementById('menuSearchInput').value = '';
            document.getElementById('menuSearchResults').innerHTML = '';
            
            // ì´ˆê¸° ë©”ë‰´ ëª©ë¡ í‘œì‹œ (ìµœëŒ€ 50ê°œ)
            displayMenuResults(allMenus.slice(0, 50));
            
            document.getElementById('menuSearchModal').classList.add('active');
            document.getElementById('menuSearchInput').focus();
        }
        
        // ë©”ë‰´ ê²€ìƒ‰ ëª¨ë‹¬ ë‹«ê¸°
        function closeMenuSearchModal() {
            document.getElementById('menuSearchModal').classList.remove('active');
            currentMealSlotIndex = -1;
        }
        
        // ë©”ë‰´ ê²€ìƒ‰ ì‹¤í–‰
        function searchMenus() {
            const searchTerm = document.getElementById('menuSearchInput').value.toLowerCase().trim();
            
            if (searchTerm === '') {
                // ê²€ìƒ‰ì–´ê°€ ì—†ìœ¼ë©´ ì „ì²´ ëª©ë¡ ì¼ë¶€ í‘œì‹œ
                displayMenuResults(allMenus.slice(0, 50));
                return;
            }
            
            // ê²€ìƒ‰ì–´ë¡œ í•„í„°ë§
            const filteredMenus = allMenus.filter(menu => 
                menu.name.toLowerCase().includes(searchTerm) ||
                (menu.notes && menu.notes.toLowerCase().includes(searchTerm))
            );
            
            displayMenuResults(filteredMenus.slice(0, 100)); // ìµœëŒ€ 100ê°œ ê²°ê³¼
        }
        
        // ê²€ìƒ‰ ê²°ê³¼ í‘œì‹œ
        function displayMenuResults(menus) {
            const resultsContainer = document.getElementById('menuSearchResults');
            
            if (menus.length === 0) {
                resultsContainer.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }
            
            resultsContainer.innerHTML = menus.map(menu => `
                <div class="menu-result-item" onclick="selectMenu('${menu.name}', ${menu.id})">
                    <div>
                        <div class="menu-result-name">${menu.name}</div>
                        <div class="menu-result-info">${menu.notes || 'ë©”ë‰´ ì„¤ëª… ì—†ìŒ'} â€¢ í‰ì : ${menu.evaluation_score || 'N/A'}/5</div>
                    </div>
                    <div class="menu-result-score" style="color: #667eea; font-weight: 600;">
                        â˜…${menu.evaluation_score || 'N/A'}
                    </div>
                </div>
            `).join('');
        }
        
        // ìƒˆë¡œìš´ ê²€ìƒ‰ ê¸°ëŠ¥
        // ê²€ìƒ‰ëœ ë©”ë‰´ë“¤ì˜ ì›ê°€ ê³„ì‚°
        async function calculateMenuCosts(menuNames) {
            try {
                // ì´ë¯¸ ìºì‹œëœ ë©”ë‰´ë“¤ ì œì™¸
                const uncachedMenus = menuNames.filter(name => !menuCostsCache[name]);
                
                if (uncachedMenus.length > 0) {
                    const response = await fetch('/api/calculate_menu_costs', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ menu_names: uncachedMenus })
                    });
                    
                    const costs = await response.json();
                    
                    // ìºì‹œì— ì €ì¥ (ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ë„ ì €ì¥í•˜ì—¬ ì˜êµ¬ ë³´ì¡´)
                    Object.assign(menuCostsCache, costs);
                    localStorage.setItem('menuCostsCache', JSON.stringify(menuCostsCache));
                }
                
                return menuNames.map(name => menuCostsCache[name] || 0);
                
            } catch (error) {
                console.error('ë©”ë‰´ ì›ê°€ ê³„ì‚° ì‹¤íŒ¨:', error);
                return menuNames.map(() => 0);
            }
        }

        // ë©”ë‰´ë³„ ì‹ì¬ë£Œ ì •ë³´ ê°€ì ¸ì˜¤ê¸° - ë°°ì¹˜ ì²˜ë¦¬ë¡œ ì„±ëŠ¥ ìµœì í™”
        async function getMenuIngredients(menuNames) {
            try {
                // ì´ë¯¸ ìºì‹œëœ ë©”ë‰´ë“¤ ì œì™¸
                const uncachedMenus = menuNames.filter(name => !menuIngredientsCache[name]);
                
                if (uncachedMenus.length > 0) {
                    // 50ê°œì”© ë°°ì¹˜ë¡œ ë‚˜ëˆ„ì–´ ì²˜ë¦¬í•˜ì—¬ ì„œë²„ ë¶€í•˜ ê°ì†Œ
                    const batchSize = 50;
                    for (let i = 0; i < uncachedMenus.length; i += batchSize) {
                        const batch = uncachedMenus.slice(i, i + batchSize);
                        
                        const response = await fetch('/api/menus_ingredients', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ menu_names: batch })
                        });
                        
                        if (response.ok) {
                            const ingredients = await response.json();
                            
                            // ìºì‹œì— ì €ì¥ (ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ë„ ì €ì¥í•˜ì—¬ ì˜êµ¬ ë³´ì¡´)
                            Object.assign(menuIngredientsCache, ingredients);
                            localStorage.setItem('menuIngredientsCache', JSON.stringify(menuIngredientsCache));
                        }
                        
                        // ë°°ì¹˜ ê°„ ì§§ì€ ì§€ì—°ìœ¼ë¡œ ì„œë²„ ë¶€í•˜ ë°©ì§€
                        if (i + batchSize < uncachedMenus.length) {
                            await new Promise(resolve => setTimeout(resolve, 100));
                        }
                    }
                }
                
                return menuNames.map(name => menuIngredientsCache[name] || { ingredients: ['ì •ë³´ì—†ìŒ'] });
                
            } catch (error) {
                console.error('ë©”ë‰´ ì‹ì¬ë£Œ ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', error);
                return menuNames.map(() => ({ ingredients: ['ì •ë³´ì—†ìŒ'] }));
            }
        }

        async function searchMenusInMealPlan() {
            const searchTerm = document.getElementById('mealPlanSearchInput').value.toLowerCase().trim();
            
            if (searchTerm === '') {
                displayInitialMenus();
                return;
            }
            
            const filteredMenus = allMenus.filter(menu => 
                menu.name.toLowerCase().includes(searchTerm) ||
                (menu.notes && menu.notes.toLowerCase().includes(searchTerm))
            );
            
            // ê²€ìƒ‰ëœ ë©”ë‰´ë“¤ì˜ ì›ê°€ ê³„ì‚° ë° ì‹ì¬ë£Œ ì •ë³´ ë¡œë“œ
            const menuNames = filteredMenus.slice(0, 50).map(menu => menu.name); // ìµœëŒ€ 50ê°œê¹Œì§€ë§Œ
            await calculateMenuCosts(menuNames);
            await getMenuIngredients(menuNames); // ì‹ì¬ë£Œ ì •ë³´ë„ í•¨ê»˜ ë¡œë“œ
            
            displaySearchResults(filteredMenus.slice(0, 100)); // ë” ë§ì€ ê²€ìƒ‰ ê²°ê³¼ í‘œì‹œ
        }
        
        // ì´ˆê¸° ë©”ë‰´ ëª©ë¡ í‘œì‹œ
        async function displayInitialMenus() {
            const container = document.getElementById('menuResultsGrid');
            const popularMenus = allMenus
                .filter(menu => menu.evaluation_score >= 4)
                .slice(0, 50); // ë” ë§ì€ ì¸ê¸° ë©”ë‰´ í‘œì‹œ
            
            // ì¸ê¸° ë©”ë‰´ë“¤ì˜ ì›ê°€ ë° ì‹ì¬ë£Œ ì •ë³´ ê³„ì‚°
            const menuNames = popularMenus.map(menu => menu.name);
            await calculateMenuCosts(menuNames);
            await getMenuIngredients(menuNames);
            
            displayMenuItems(container, popularMenus, 'ì¸ê¸° ë©”ë‰´');
        }
        
        // ê²€ìƒ‰ ê²°ê³¼ í‘œì‹œ
        function displaySearchResults(menus) {
            const container = document.getElementById('menuResultsGrid');
            displayMenuItems(container, menus, 'ê²€ìƒ‰ ê²°ê³¼');
        }
        
        // ë©”ë‰´ ì´ë ¥ í‘œì‹œ
        async function displayMenuHistory() {
            const container = document.getElementById('menuHistoryItems');
            const uniqueHistory = [...new Set(menuHistory)].slice(0, 30); // ë” ë§ì€ ì´ë ¥ í‘œì‹œ
            
            if (uniqueHistory.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #666; padding: 15px; font-size: 12px;">ê²€ìƒ‰ ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }
            
            const historyMenus = allMenus.filter(menu => uniqueHistory.includes(menu.name));
            
            // ì´ë ¥ ë©”ë‰´ë“¤ì˜ ì›ê°€ ë° ì‹ì¬ë£Œ ì •ë³´ ê³„ì‚°
            const menuNames = historyMenus.map(menu => menu.name);
            await calculateMenuCosts(menuNames);
            await getMenuIngredients(menuNames);
            
            displayMenuItems(container, historyMenus, 'ìµœê·¼ ì‚¬ìš©');
        }
        
        // ë“œë˜ê·¸ ê°€ëŠ¥í•œ ë©”ë‰´ ì•„ì´í…œë“¤ í‘œì‹œ (ì›ê°€ ì •ë³´ í¬í•¨)
        function displayMenuItems(container, menus, category) {
            if (menus.length === 0) {
                container.innerHTML = `<div style="text-align: center; color: #666; padding: 20px;">${category} ì—†ìŒ</div>`;
                return;
            }
            
            container.innerHTML = menus.map(menu => {
                const cost = menuCostsCache[menu.name];
                const costDisplay = cost !== undefined 
                    ? (cost > 0 ? `${cost.toLocaleString()}ì›` : 'ì›ê°€ë¯¸ì‚°ì •')
                    : 'ê³„ì‚°ì¤‘...';
                
                const ingredientInfo = menuIngredientsCache[menu.name];
                const ingredients = ingredientInfo ? ingredientInfo.ingredients : ['ì •ë³´ì—†ìŒ'];
                const ingredientDisplay = ingredients.slice(0, 5).join(', '); // ìµœëŒ€ 5ê°œê¹Œì§€ë§Œ
                
                return `
                    <div class="draggable-menu-item" 
                         draggable="true" 
                         data-menu-name="${menu.name}"
                         data-menu-id="${menu.id}">
                        <div class="menu-item-content">
                            <div class="menu-item-icon">ğŸ½ï¸</div>
                            <div class="menu-item-details">
                                <div class="menu-item-name">
                                    <span class="menu-color-box" style="background-color: ${getMenuColor(menu.name)};">â–¡</span>
                                    ${menu.name}
                                </div>
                                <div class="menu-item-ingredients">${ingredientDisplay}</div>
                                <div class="menu-item-meta">
                                    <span class="menu-item-rating">â˜…${menu.evaluation_score || 'N/A'}</span>
                                    <span class="menu-item-cost">${costDisplay}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // ë“œë˜ê·¸ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
            container.querySelectorAll('.draggable-menu-item').forEach(item => {
                item.addEventListener('dragstart', handleDragStart);
                item.addEventListener('dragend', handleDragEnd);
            });
        }
        
        // ë“œë˜ê·¸ ì‹œì‘
        function handleDragStart(e) {
            e.target.classList.add('dragging');
            e.dataTransfer.setData('text/plain', e.target.dataset.menuName);
            e.dataTransfer.effectAllowed = 'copy';
        }
        
        // ë“œë˜ê·¸ ì¢…ë£Œ
        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
        }
        
        // ë“œë˜ê·¸ ì˜¤ë²„
        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'copy';
            e.currentTarget.classList.add('drag-over');
        }
        
        // ë“œë˜ê·¸ ë¦¬ë¸Œ
        function handleDragLeave(e) {
            e.currentTarget.classList.remove('drag-over');
        }
        
        // ë“œë¡­ ì²˜ë¦¬
        function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('drag-over');
            
            const menuName = e.dataTransfer.getData('text/plain');
            const slotIndex = parseInt(e.currentTarget.dataset.slotIndex);
            
            if (menuName && slotIndex >= 0) {
                addMenuToSlot(slotIndex, menuName);
            }
        }
        
        // ìŠ¬ë¡¯ì— ë©”ë‰´ ì¶”ê°€
        function addMenuToSlot(slotIndex, menuName) {
            const container = document.getElementById(`selectedMenus${slotIndex}`);
            
            // ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ë©”ë‰´ì¸ì§€ í™•ì¸
            const existingMenus = container.querySelectorAll('.selected-menu-item');
            for (let item of existingMenus) {
                if (item.dataset.menuName === menuName) {
                    return; // ì´ë¯¸ ì¡´ì¬í•¨
                }
            }
            
            // ìƒˆ ë©”ë‰´ ì•„ì´í…œ ìƒì„±
            const menuIndex = existingMenus.length;
            const menuItem = document.createElement('div');
            menuItem.className = 'selected-menu-item';
            menuItem.setAttribute('draggable', 'true');
            menuItem.setAttribute('data-menu-name', menuName);
            menuItem.setAttribute('data-menu-index', menuIndex);
            
            // ë©”ë‰´ ì›ê°€ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            const cost = menuCostsCache[menuName];
            const costDisplay = cost !== undefined 
                ? (cost > 0 ? `${cost.toLocaleString()}ì›` : 'ì›ê°€ë¯¸ì‚°ì •')
                : 'ê³„ì‚°ì¤‘...';
                
            // ë©”ë‰´ ì‹ì¬ë£Œ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            const ingredientInfo = menuIngredientsCache[menuName];
            const ingredients = ingredientInfo ? ingredientInfo.ingredients : ['ì •ë³´ì—†ìŒ'];
            const ingredientDisplay = ingredients.slice(0, 4).join(', '); // ìµœëŒ€ 4ê°œê¹Œì§€ë§Œ
            
            menuItem.innerHTML = `
                <div class="selected-menu-header">
                    <div class="selected-menu-name">
                        <span class="menu-color-box" style="background-color: ${getMenuColor(menuName)};">â–¡</span>
                        ${menuName}
                    </div>
                    <div class="selected-menu-actions">
                        <span class="selected-menu-cost">${costDisplay}</span>
                        <button class="selected-menu-remove" onclick="removeSelectedMenu(${slotIndex}, ${menuIndex})">Ã—</button>
                    </div>
                </div>
                <div class="selected-menu-ingredients">${ingredientDisplay}</div>
            `;
            
            container.appendChild(menuItem);
            
            // ê²€ìƒ‰ ì´ë ¥ì— ì¶”ê°€
            if (!menuHistory.includes(menuName)) {
                menuHistory.unshift(menuName);
                menuHistory = menuHistory.slice(0, 50); // ìµœëŒ€ 50ê°œë§Œ ë³´ê´€
                displayMenuHistory();
            }
            
            // ì‹ë‹¨ ë°ì´í„° ì €ì¥
            saveMealData();
            
            // ì´ ê¸ˆì•¡ ì—…ë°ì´íŠ¸ (ìº˜ë¦°ë”ìš©)
            updateTotalCost(slotIndex);
            
            // ì‹ë‹¨ ì…ë ¥ ëª¨ë‹¬ìš© ì´ ê¸ˆì•¡ ì—…ë°ì´íŠ¸
            updateMealTotalCost(slotIndex);
        }

        // ì‹ë‹¨ ì…ë ¥ ëª¨ë‹¬ì—ì„œ ê°œë³„ ì‹ë‹¨ì˜ ì´ ê¸ˆì•¡ ì—…ë°ì´íŠ¸
        async function updateMealTotalCost(slotIndex) {
            const container = document.getElementById(`selectedMenus${slotIndex}`);
            if (!container) return;
            
            const menuItems = container.querySelectorAll('.selected-menu-item');
            const menuNames = Array.from(menuItems).map(item => item.getAttribute('data-menu-name'));
            
            if (menuNames.length > 0) {
                // ë©”ë‰´ë“¤ì˜ ì›ê°€ ê³„ì‚°
                await calculateMenuCosts(menuNames);
                
                let totalCost = 0;
                menuNames.forEach(menuName => {
                    const cost = menuCostsCache[menuName] || 0;
                    totalCost += cost;
                });
                
                // ì‹ë‹¨ë³„ ì´ ê¸ˆì•¡ í‘œì‹œ ì—…ë°ì´íŠ¸
                const totalCostElement = document.getElementById(`totalCost${slotIndex}`);
                if (totalCostElement) {
                    totalCostElement.textContent = `${totalCost.toLocaleString()}ì›`;
                }
            } else {
                // ë©”ë‰´ê°€ ì—†ìœ¼ë©´ 0ì› í‘œì‹œ
                const totalCostElement = document.getElementById(`totalCost${slotIndex}`);
                if (totalCostElement) {
                    totalCostElement.textContent = '0ì›';
                }
            }
        }
        
        // ì„ íƒëœ ë©”ë‰´ ì œê±°
        function removeSelectedMenu(slotIndex, menuIndex) {
            const container = document.getElementById(`selectedMenus${slotIndex}`);
            const menuItems = container.querySelectorAll('.selected-menu-item');
            if (menuItems[menuIndex]) {
                menuItems[menuIndex].remove();
                
                // ì¸ë±ìŠ¤ ì¬ì •ë ¬
                container.querySelectorAll('.selected-menu-item').forEach((item, index) => {
                    item.setAttribute('data-menu-index', index);
                    const removeBtn = item.querySelector('.selected-menu-remove');
                    removeBtn.setAttribute('onclick', `removeSelectedMenu(${slotIndex}, ${index})`);
                });
                
                // ì‹ë‹¨ ë°ì´í„° ì €ì¥
                saveMealData();
                
                // ì´ ê¸ˆì•¡ ì—…ë°ì´íŠ¸ (ìº˜ë¦°ë”ìš©)
                updateTotalCost(slotIndex);
                
                // ì‹ë‹¨ ì…ë ¥ ëª¨ë‹¬ìš© ì´ ê¸ˆì•¡ ì—…ë°ì´íŠ¸
                updateMealTotalCost(slotIndex);
            }
        }
        
        // ì‹ë‹¨ ë°ì´í„° ì €ì¥
        function saveMealData() {
            const mealPlanData = {};
            
            // í˜„ì¬ í‘œì‹œë˜ëŠ” ëª¨ë“  ë‚ ì§œì˜ ì‹ë‹¨ ë°ì´í„° ìˆ˜ì§‘
            document.querySelectorAll('[data-date]').forEach(dateCell => {
                const dateStr = dateCell.getAttribute('data-date');
                const dayData = {};
                
                // ê° ì‹ë‹¨ ìŠ¬ë¡¯ì˜ ë©”ë‰´ë“¤ ìˆ˜ì§‘
                for (let slotIndex = 0; slotIndex < defaultMealNames.length; slotIndex++) {
                    const container = dateCell.querySelector(`#selectedMenus${slotIndex}`);
                    if (container) {
                        const menus = [];
                        container.querySelectorAll('.selected-menu-item').forEach(item => {
                            const menuName = item.getAttribute('data-menu-name');
                            if (menuName) {
                                menus.push(menuName);
                            }
                        });
                        if (menus.length > 0) {
                            dayData[defaultMealNames[slotIndex]] = menus;
                        }
                    }
                }
                
                if (Object.keys(dayData).length > 0) {
                    mealPlanData[dateStr] = dayData;
                }
            });
            
            localStorage.setItem('mealPlanData', JSON.stringify(mealPlanData));
            console.log('ì‹ë‹¨ ë°ì´í„° ì €ì¥ì™„ë£Œ:', mealPlanData);
        }
        
        // ì‹ë‹¨ ë°ì´í„° ë¡œë“œ
        function loadMealData() {
            try {
                const savedData = localStorage.getItem('mealPlanData');
                if (savedData) {
                    const mealPlanData = JSON.parse(savedData);
                    console.log('ì €ì¥ëœ ì‹ë‹¨ ë°ì´í„° ë¡œë“œ:', mealPlanData);
                    
                    // ì €ì¥ëœ ë°ì´í„°ë¥¼ ìº˜ë¦°ë”ì— ì ìš©
                    Object.keys(mealPlanData).forEach(dateStr => {
                        const dayData = mealPlanData[dateStr];
                        const dateCell = document.querySelector(`[data-date="${dateStr}"]`);
                        
                        if (dateCell) {
                            Object.keys(dayData).forEach(mealName => {
                                const slotIndex = defaultMealNames.indexOf(mealName);
                                if (slotIndex >= 0) {
                                    const menus = dayData[mealName];
                                    menus.forEach(menuName => {
                                        addMenuToSlot(slotIndex, menuName);
                                    });
                                    // ì´ ê¸ˆì•¡ ì—…ë°ì´íŠ¸
                                    updateTotalCost(slotIndex);
                                }
                            });
                        }
                    });
                }
            } catch (error) {
                console.error('ì‹ë‹¨ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }
        
        // ìŠ¬ë¡¯ë³„ ì´ ê¸ˆì•¡ ê³„ì‚° ë° í‘œì‹œ
        async function updateTotalCost(slotIndex) {
            const containers = document.querySelectorAll(`[id^="selectedMenus${slotIndex}"]`);
            
            containers.forEach(async container => {
                const menuItems = container.querySelectorAll('.selected-menu-item');
                const menuNames = Array.from(menuItems).map(item => item.getAttribute('data-menu-name'));
                
                if (menuNames.length > 0) {
                    // ë©”ë‰´ë“¤ì˜ ì›ê°€ ê³„ì‚°
                    await calculateMenuCosts(menuNames);
                    
                    let totalCost = 0;
                    menuNames.forEach(menuName => {
                        const cost = menuCostsCache[menuName] || 0;
                        totalCost += cost;
                    });
                    
                    // ë‚ ì§œ ì…€ì—ì„œ ì´í•©ê³„ í‘œì‹œ ì—…ë°ì´íŠ¸
                    const dateCell = container.closest('[data-date]');
                    if (dateCell) {
                        let totalCostElement = dateCell.querySelector('.total-cost');
                        if (!totalCostElement) {
                            totalCostElement = document.createElement('div');
                            totalCostElement.className = 'total-cost';
                            dateCell.appendChild(totalCostElement);
                        }
                        
                        // í•´ë‹¹ ë‚ ì§œì˜ ëª¨ë“  ì‹ë‹¨ ì´í•©ê³„ ê³„ì‚°
                        let dayTotalCost = 0;
                        for (let i = 0; i < defaultMealNames.length; i++) {
                            const slotContainer = dateCell.querySelector(`#selectedMenus${i}`);
                            if (slotContainer) {
                                const slotMenus = slotContainer.querySelectorAll('.selected-menu-item');
                                Array.from(slotMenus).forEach(item => {
                                    const menuName = item.getAttribute('data-menu-name');
                                    const cost = menuCostsCache[menuName] || 0;
                                    dayTotalCost += cost;
                                });
                            }
                        }
                        
                        totalCostElement.textContent = `${dayTotalCost.toLocaleString()}ì›`;
                    }
                }
            });
        }
    </script>
</body>
</html>