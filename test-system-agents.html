<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>시스템 에이전트 테스트 대시보드</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .status-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
        }

        .status-loading { background: #ffeaa7; color: #2d3436; }
        .status-healthy { background: #00b894; color: white; }
        .status-error { background: #e17055; color: white; }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-left: 5px solid #3498db;
        }

        .card h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-content {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }

        .button {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }

        .button:hover {
            background: #2980b9;
        }

        .button.danger {
            background: #e74c3c;
        }

        .button.danger:hover {
            background: #c0392b;
        }

        .button.success {
            background: #27ae60;
        }

        .button.success:hover {
            background: #229954;
        }

        .console {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 5px;
            height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            margin-top: 20px;
        }

        .console-line {
            margin-bottom: 5px;
        }

        .console-line.info { color: #3498db; }
        .console-line.success { color: #27ae60; }
        .console-line.error { color: #e74c3c; }
        .console-line.warning { color: #f39c12; }

        .metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }

        .metric {
            text-align: center;
            background: #ecf0f1;
            padding: 15px;
            border-radius: 5px;
        }

        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
        }

        .metric-label {
            font-size: 12px;
            color: #7f8c8d;
            margin-top: 5px;
        }

        .controls {
            text-align: center;
            margin: 30px 0;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🚀 시스템 에이전트 테스트 대시보드</h1>
            <div id="overall-status" class="status-badge status-loading">초기화 중...</div>
        </div>

        <div class="controls">
            <button class="button success" onclick="initializeAgents()">🚀 에이전트 초기화</button>
            <button class="button" onclick="checkStatus()">📊 상태 확인</button>
            <button class="button" onclick="testAllAgents()">🧪 전체 테스트</button>
            <button class="button danger" onclick="stopAllAgents()">🛑 모든 에이전트 정지</button>
        </div>

        <div class="grid">
            <!-- 모니터링 에이전트 카드 -->
            <div class="card">
                <h3>🔍 모니터링 에이전트</h3>
                <div class="card-content">
                    <div><strong>상태:</strong> <span id="monitoring-status">대기 중</span></div>
                    <div class="metrics">
                        <div class="metric">
                            <div class="metric-value" id="cpu-usage">-</div>
                            <div class="metric-label">CPU 사용률</div>
                        </div>
                        <div class="metric">
                            <div class="metric-value" id="memory-usage">-</div>
                            <div class="metric-label">메모리 사용률</div>
                        </div>
                        <div class="metric">
                            <div class="metric-value" id="error-count">-</div>
                            <div class="metric-label">에러 개수</div>
                        </div>
                    </div>
                    <button class="button" onclick="testMonitoring()">🔍 모니터링 테스트</button>
                    <button class="button" onclick="generateTestError()">⚠️ 테스트 에러 생성</button>
                </div>
            </div>

            <!-- 유지보수 에이전트 카드 -->
            <div class="card">
                <h3>🔧 유지보수 에이전트</h3>
                <div class="card-content">
                    <div><strong>상태:</strong> <span id="maintenance-status">대기 중</span></div>
                    <div><strong>마지막 백업:</strong> <span id="last-backup">-</span></div>
                    <div><strong>마지막 헬스체크:</strong> <span id="last-healthcheck">-</span></div>
                    <button class="button" onclick="testMaintenance()">🔧 유지보수 테스트</button>
                    <button class="button" onclick="createTestBackup()">💾 테스트 백업</button>
                    <button class="button" onclick="runHealthCheck()">🏥 헬스체크</button>
                </div>
            </div>

            <!-- API 게이트웨이 에이전트 카드 -->
            <div class="card">
                <h3>🌐 API 게이트웨이 에이전트</h3>
                <div class="card-content">
                    <div><strong>상태:</strong> <span id="gateway-status">대기 중</span></div>
                    <div class="metrics">
                        <div class="metric">
                            <div class="metric-value" id="total-requests">-</div>
                            <div class="metric-label">총 요청</div>
                        </div>
                        <div class="metric">
                            <div class="metric-value" id="success-rate">-</div>
                            <div class="metric-label">성공률</div>
                        </div>
                        <div class="metric">
                            <div class="metric-value" id="avg-response">-</div>
                            <div class="metric-label">평균 응답시간</div>
                        </div>
                    </div>
                    <button class="button" onclick="testGateway()">🌐 게이트웨이 테스트</button>
                    <button class="button" onclick="testAPICall()">📡 API 호출 테스트</button>
                </div>
            </div>

            <!-- 시스템 통합 상태 카드 -->
            <div class="card">
                <h3>⚡ 시스템 통합 상태</h3>
                <div class="card-content">
                    <div><strong>초기화 상태:</strong> <span id="init-status">미초기화</span></div>
                    <div><strong>활성 에이전트:</strong> <span id="active-agents">0/3</span></div>
                    <div><strong>전체 헬스:</strong> <span id="system-health">알 수 없음</span></div>
                    <button class="button" onclick="showSystemInfo()">📋 시스템 정보</button>
                    <button class="button" onclick="clearConsole()">🗑️ 콘솔 지우기</button>
                </div>
            </div>
        </div>

        <div class="console" id="console">
            <div class="console-line info">[INFO] 시스템 에이전트 테스트 대시보드 준비 완료</div>
            <div class="console-line info">[INFO] 에이전트 초기화를 시작하려면 '에이전트 초기화' 버튼을 클릭하세요</div>
        </div>
    </div>

    <!-- 스크립트 로드 -->
    <script src="system/core/module-registry.js"></script>
    <script src="system/init-system-agents.js"></script>

    <script>
        // 콘솔 로깅 함수
        function log(message, type = 'info') {
            const console = document.getElementById('console');
            const timestamp = new Date().toLocaleTimeString();
            const line = document.createElement('div');
            line.className = `console-line ${type}`;
            line.textContent = `[${timestamp}] [${type.toUpperCase()}] ${message}`;
            console.appendChild(line);
            console.scrollTop = console.scrollHeight;
        }

        // 상태 업데이트 함수
        function updateStatus(elementId, status, isHealthy = true) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = status;
                element.className = isHealthy ? 'status-healthy' : 'status-error';
            }
        }

        // 전체 상태 업데이트
        function updateOverallStatus() {
            if (window.SystemAgents) {
                const health = window.SystemAgents.getHealth();
                const badge = document.getElementById('overall-status');

                badge.textContent = `시스템 ${health.overall}`;
                badge.className = `status-badge ${
                    health.overall === 'healthy' ? 'status-healthy' :
                    health.overall === 'unhealthy' ? 'status-error' : 'status-loading'
                }`;
            }
        }

        // 에이전트 초기화
        async function initializeAgents() {
            try {
                log('시스템 에이전트 초기화 시작...', 'info');

                if (!window.SystemAgentManager) {
                    log('SystemAgentManager를 찾을 수 없습니다', 'error');
                    return;
                }

                await window.SystemAgentManager.initializeAll();
                log('모든 시스템 에이전트가 성공적으로 초기화되었습니다', 'success');

                // 상태 업데이트
                checkStatus();

            } catch (error) {
                log(`에이전트 초기화 실패: ${error.message}`, 'error');
            }
        }

        // 상태 확인
        function checkStatus() {
            try {
                if (!window.SystemAgents) {
                    log('시스템 에이전트가 초기화되지 않았습니다', 'warning');
                    return;
                }

                const status = window.SystemAgents.getStatus();
                const health = window.SystemAgents.getHealth();

                // 전체 상태
                document.getElementById('init-status').textContent = status.initialized ? '초기화 완료' : '미초기화';
                document.getElementById('active-agents').textContent = `${status.agentCount}/3`;
                document.getElementById('system-health').textContent = health.overall;

                // 개별 에이전트 상태
                if (status.agents.monitoring) {
                    document.getElementById('monitoring-status').textContent = '활성화';
                    updateMonitoringMetrics();
                }

                if (status.agents.maintenance) {
                    document.getElementById('maintenance-status').textContent = '활성화';
                    updateMaintenanceInfo();
                }

                if (status.agents['api-gateway']) {
                    document.getElementById('gateway-status').textContent = '활성화';
                    updateGatewayMetrics();
                }

                updateOverallStatus();
                log('상태 확인 완료', 'success');

            } catch (error) {
                log(`상태 확인 실패: ${error.message}`, 'error');
            }
        }

        // 모니터링 메트릭 업데이트
        function updateMonitoringMetrics() {
            try {
                const monitoring = window.SystemAgents.monitoring;
                if (monitoring && monitoring.getPublicInterface) {
                    const api = monitoring.getPublicInterface();
                    const metrics = api.getSystemMetrics();

                    document.getElementById('cpu-usage').textContent = `${metrics.cpuUsage}%`;
                    document.getElementById('memory-usage').textContent = `${metrics.memoryUsage}%`;

                    const errorLogs = api.getErrorLogs(10);
                    document.getElementById('error-count').textContent = errorLogs.length;
                }
            } catch (error) {
                log(`모니터링 메트릭 업데이트 실패: ${error.message}`, 'error');
            }
        }

        // 유지보수 정보 업데이트
        function updateMaintenanceInfo() {
            try {
                const maintenance = window.SystemAgents.maintenance;
                if (maintenance && maintenance.getPublicInterface) {
                    const api = maintenance.getPublicInterface();

                    // 백업 이력이 있다면 마지막 백업 표시
                    const backups = api.getBackupHistory();
                    if (backups.length > 0) {
                        const lastBackup = new Date(backups[backups.length - 1].timestamp);
                        document.getElementById('last-backup').textContent = lastBackup.toLocaleString();
                    }

                    // 헬스체크 결과
                    const health = api.getHealthStatus();
                    if (health.timestamp) {
                        const lastCheck = new Date(health.timestamp);
                        document.getElementById('last-healthcheck').textContent = lastCheck.toLocaleString();
                    }
                }
            } catch (error) {
                log(`유지보수 정보 업데이트 실패: ${error.message}`, 'error');
            }
        }

        // 게이트웨이 메트릭 업데이트
        function updateGatewayMetrics() {
            try {
                const gateway = window.SystemAgents.apiGateway;
                if (gateway && gateway.getPublicInterface) {
                    const api = gateway.getPublicInterface();
                    const stats = api.getStatistics();

                    document.getElementById('total-requests').textContent = stats.totalRequests;

                    const successRate = stats.totalRequests > 0 ?
                        Math.round((stats.successfulRequests / stats.totalRequests) * 100) : 0;
                    document.getElementById('success-rate').textContent = `${successRate}%`;

                    document.getElementById('avg-response').textContent = `${Math.round(stats.averageResponseTime)}ms`;
                }
            } catch (error) {
                log(`게이트웨이 메트릭 업데이트 실패: ${error.message}`, 'error');
            }
        }

        // 개별 에이전트 테스트 함수들
        async function testMonitoring() {
            log('모니터링 에이전트 테스트 시작...', 'info');
            try {
                const monitoring = window.SystemAgents.monitoring;
                if (monitoring && monitoring.getPublicInterface) {
                    const api = monitoring.getPublicInterface();
                    api.startMonitoring();
                    log('모니터링이 시작되었습니다', 'success');

                    // 5초 후 메트릭 업데이트
                    setTimeout(() => {
                        updateMonitoringMetrics();
                        log('모니터링 메트릭이 업데이트되었습니다', 'info');
                    }, 5000);
                } else {
                    log('모니터링 에이전트를 찾을 수 없습니다', 'error');
                }
            } catch (error) {
                log(`모니터링 테스트 실패: ${error.message}`, 'error');
            }
        }

        async function testMaintenance() {
            log('유지보수 에이전트 테스트 시작...', 'info');
            try {
                const maintenance = window.SystemAgents.maintenance;
                if (maintenance && maintenance.getPublicInterface) {
                    const api = maintenance.getPublicInterface();
                    log('유지보수 에이전트가 정상 작동 중입니다', 'success');

                    // 설정 정보 표시
                    const config = api.getConfig();
                    log(`백업 간격: ${config.backupInterval / (60 * 60 * 1000)}시간`, 'info');
                } else {
                    log('유지보수 에이전트를 찾을 수 없습니다', 'error');
                }
            } catch (error) {
                log(`유지보수 테스트 실패: ${error.message}`, 'error');
            }
        }

        async function testGateway() {
            log('API 게이트웨이 테스트 시작...', 'info');
            try {
                const gateway = window.SystemAgents.apiGateway;
                if (gateway && gateway.getPublicInterface) {
                    const api = gateway.getPublicInterface();

                    if (api.isActive()) {
                        log('API 게이트웨이가 활성화되어 있습니다', 'success');
                    } else {
                        api.startGateway();
                        log('API 게이트웨이를 시작했습니다', 'info');
                    }

                    const services = api.getServices();
                    log(`등록된 서비스 개수: ${services.length}`, 'info');
                } else {
                    log('API 게이트웨이 에이전트를 찾을 수 없습니다', 'error');
                }
            } catch (error) {
                log(`게이트웨이 테스트 실패: ${error.message}`, 'error');
            }
        }

        // 테스트 헬퍼 함수들
        function generateTestError() {
            log('테스트 에러를 생성합니다...', 'warning');
            // 의도적인 에러 생성
            try {
                throw new Error('테스트용 에러입니다');
            } catch (error) {
                log(`테스트 에러 생성됨: ${error.message}`, 'error');
            }
        }

        async function createTestBackup() {
            log('테스트 백업을 생성합니다...', 'info');
            try {
                const maintenance = window.SystemAgents.maintenance;
                if (maintenance && maintenance.getPublicInterface) {
                    const api = maintenance.getPublicInterface();
                    await api.createBackup('test');
                    log('테스트 백업이 생성되었습니다', 'success');
                    updateMaintenanceInfo();
                } else {
                    log('유지보수 에이전트를 찾을 수 없습니다', 'error');
                }
            } catch (error) {
                log(`테스트 백업 실패: ${error.message}`, 'error');
            }
        }

        async function runHealthCheck() {
            log('헬스체크를 실행합니다...', 'info');
            try {
                const maintenance = window.SystemAgents.maintenance;
                if (maintenance && maintenance.getPublicInterface) {
                    const api = maintenance.getPublicInterface();
                    const result = await api.performHealthCheck();
                    log(`헬스체크 완료: ${result.status}`, 'success');
                    updateMaintenanceInfo();
                } else {
                    log('유지보수 에이전트를 찾을 수 없습니다', 'error');
                }
            } catch (error) {
                log(`헬스체크 실패: ${error.message}`, 'error');
            }
        }

        async function testAPICall() {
            log('API 호출 테스트를 시작합니다...', 'info');
            try {
                const response = await fetch('/api/admin/dashboard-stats');
                if (response.ok) {
                    log('API 호출 성공', 'success');
                } else {
                    log(`API 호출 실패: ${response.status}`, 'error');
                }
                updateGatewayMetrics();
            } catch (error) {
                log(`API 호출 테스트 실패: ${error.message}`, 'error');
            }
        }

        // 전체 테스트
        async function testAllAgents() {
            log('전체 에이전트 테스트를 시작합니다...', 'info');

            await testMonitoring();
            await new Promise(resolve => setTimeout(resolve, 1000));

            await testMaintenance();
            await new Promise(resolve => setTimeout(resolve, 1000));

            await testGateway();
            await new Promise(resolve => setTimeout(resolve, 1000));

            log('전체 에이전트 테스트 완료', 'success');
            checkStatus();
        }

        // 모든 에이전트 정지
        function stopAllAgents() {
            log('모든 에이전트를 정지합니다...', 'warning');
            try {
                if (window.SystemAgents) {
                    window.SystemAgents.stop();
                    log('모든 에이전트가 정지되었습니다', 'info');
                    checkStatus();
                } else {
                    log('시스템 에이전트가 초기화되지 않았습니다', 'warning');
                }
            } catch (error) {
                log(`에이전트 정지 실패: ${error.message}`, 'error');
            }
        }

        // 시스템 정보 표시
        function showSystemInfo() {
            try {
                if (window.SystemAgents) {
                    const status = window.SystemAgents.getStatus();
                    const health = window.SystemAgents.getHealth();

                    log('=== 시스템 정보 ===', 'info');
                    log(`초기화 상태: ${status.initialized}`, 'info');
                    log(`활성 에이전트: ${status.agentCount}/3`, 'info');
                    log(`전체 헬스: ${health.overall}`, 'info');
                    log(`타임스탬프: ${health.timestamp}`, 'info');
                    log('================', 'info');
                } else {
                    log('시스템 에이전트가 초기화되지 않았습니다', 'warning');
                }
            } catch (error) {
                log(`시스템 정보 조회 실패: ${error.message}`, 'error');
            }
        }

        // 콘솔 지우기
        function clearConsole() {
            document.getElementById('console').innerHTML = '';
            log('콘솔이 지워졌습니다', 'info');
        }

        // 자동 상태 업데이트 (10초마다)
        setInterval(() => {
            if (window.SystemAgents && window.SystemAgents.getStatus().initialized) {
                updateMonitoringMetrics();
                updateGatewayMetrics();
                updateOverallStatus();
            }
        }, 10000);

        // 페이지 로드 완료 시
        document.addEventListener('DOMContentLoaded', function() {
            log('테스트 대시보드가 로드되었습니다', 'success');
        });
    </script>
</body>
</html>