<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> 식자재 관리 시스템 - 관리자 대시보드</title>
    
    <!-- 외부 CSS (HTTP 환경에서만 작동) -->
    <!-- <link rel="stylesheet" href="static/css/admin-dashboard-main.css">
    <link rel="stylesheet" href="static/css/admin-dashboard-inline.css"> -->

    <!-- 인라인 CSS (file:// 프로토콜에서도 작동) -->
    <style>
        /* 기본 스타일 */
        body {
            margin: 0;
            font-family: 'Segoe UI', Arial, sans-serif;
            background: #f5f5f5;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        /* 사이드바 */
        .sidebar {
            width: 280px;
            background: linear-gradient(180deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            display: flex;
            flex-direction: column;
            box-shadow: 3px 0 15px rgba(0,0,0,0.2);
            min-height: 100vh;
        }

        .sidebar-header {
            padding: 15px;
            background: rgba(0,0,0,0.2);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            text-align: center;
        }

        .sidebar-header h2 {
            margin: 0;
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .sidebar-header p {
            margin: 0;
            font-size: 11px;
            opacity: 0.8;
        }

        .logo {
            padding: 20px;
            font-size: 24px;
            font-weight: bold;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }

        .nav-menu {
            flex: 1;
            padding: 20px 0;
        }

        .nav-item {
            display: block;
            padding: 12px 20px;
            color: white;
            text-decoration: none;
            transition: all 0.3s;
        }

        .nav-item:hover {
            background: rgba(255,255,255,0.1);
            padding-left: 30px;
        }

        .nav-item.active {
            background: rgba(255,255,255,0.2);
            border-left: 4px solid white;
        }

        /* 메인 컨텐츠 */
        .main-content {
            flex: 1;
            overflow-y: auto;
            background: #f5f5f5;
        }

        .header {
            background: white;
            padding: 8px 15px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
            min-height: 40px;
        }

        .header h1 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .date-time {
            font-size: 12px;
            color: #666;
        }

        #content-area {
            padding: 15px;
        }

        .content-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .content-header h1,
        .content-header h2 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }

        .page-header {
            margin-bottom: 15px;
        }

        .page-header h2 {
            margin: 0 0 5px 0;
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }

        .page-description {
            margin: 0;
            font-size: 12px;
            color: #666;
        }

        .page-content {
            display: none;
        }

        .page-content.active {
            display: block;
        }

        /* 대시보드 카드 */
        .dashboard-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }

        .dashboard-card {
            background: white;
            padding: 10px 12px;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            transition: transform 0.2s, box-shadow 0.2s;
            border-left: 3px solid #667eea;
            min-width: 120px;
            max-width: 150px;
            flex: 0 0 auto;
        }

        .dashboard-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-bottom: 6px;
        }

        .card-header .icon {
            font-size: 16px;
        }

        .card-title {
            font-size: 11px;
            font-weight: 600;
            color: #555;
            white-space: nowrap;
        }

        .stat-number {
            font-size: 18px;
            font-weight: bold;
            color: #2a5298;
            margin: 3px 0;
        }

        .stat-label {
            font-size: 9px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* 테이블 스타일 */
        .table-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: #f8f9fa;
            padding: 10px;
            text-align: left;
            font-weight: 600;
        }

        td {
            padding: 10px;
            border-bottom: 1px solid #f0f0f0;
        }

        /* 버튼 스타일 */
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-success {
            background: #48bb78;
            color: white;
        }

        .btn-danger {
            background: #f56565;
            color: white;
        }

        /* 사용자 관리 스타일 */
        .role-badge {
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: bold;
        }

        .role-badge.admin {
            background: #ff4444;
            color: white;
        }

        .controls {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .pagination {
            display: flex;
            justify-content: center;
            gap: 5px;
            margin-top: 20px;
        }
    </style>

    <!-- 간단한 대시보드 스크립트 -->
    <script>
        // 모듈 로더 대신 간단한 초기화
        const API_BASE = 'http://127.0.0.1:8009';
        console.log('Admin Dashboard 시작');
    </script>
</head>
<body>
    <!-- 메인 컨테이너 -->
    <div class="container">
        <!-- 사이드바 -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <h2>🍽️ 식자재 관리</h2>
                <p>관리자 시스템</p>
            </div>
            
            <div class="nav-menu">
                <a href="#" class="nav-item active" data-page="dashboard">
                    <span class="icon">📊</span>대시보드
                </a>
                <a href="#" class="nav-item" data-page="users">
                    <span class="icon">👥</span>사용자 관리
                </a>
                <a href="#" class="nav-item" data-page="suppliers">
                    <span class="icon">🚛</span>협력업체 관리
                </a>
                <a href="#" class="nav-item" data-page="business-locations">
                    <span class="icon">🏢</span>사업장 관리
                </a>
                <a href="#" class="nav-item" data-page="supplier-mapping">
                    <span class="icon">🔗</span>협력업체 매칭
                </a>
                <a href="#" class="nav-item" data-page="meal-pricing">
                    <span class="icon">💰</span>식단가 관리
                </a>
                <a href="#" class="nav-item" data-page="ingredients">
                    <span class="icon">📦</span>식자재 관리
                </a>
            </div>
            
            <div class="sidebar-footer" style="margin-top: auto; padding: 20px;">
                <div style="border-top: 1px solid rgba(255,255,255,0.2); padding-top: 20px;">
                    <a href="/" class="nav-item" style="background: #e8f5e8; color: #4caf50;">
                        <span class="icon">🍽️</span>급식관리로 이동
                    </a>
                </div>
            </div>
        </nav>

        <!-- 메인 컨텐츠 -->
        <main class="main-content">
            <!-- 헤더 -->
            <div class="header">
                <h1 id="page-title">관리자 대시보드</h1>
                <div class="header-info">
                    <div class="user-info">
                        관리자님, 안녕하세요! | 오늘: <span id="current-date"></span>
                    </div>
                    <button class="logout-btn" onclick="logout()">로그아웃</button>
                </div>
            </div>

            <!-- 페이지별 컨텐츠 영역 -->
            <div id="content-area">
                <!-- 대시보드 기본 컨텐츠 -->
                <div id="dashboard-content" class="page-content active">
                    <div class="dashboard-grid">
                        <div class="dashboard-card">
                            <div class="card-header">
                                <span class="icon">👥</span>
                                <h3 class="card-title">전체 사용자</h3>
                            </div>
                            <div class="card-content">
                                <div class="stat-number" id="total-users">-</div>
                                <div class="stat-label">등록된 사용자 수</div>
                            </div>
                        </div>
                        
                        <div class="dashboard-card">
                            <div class="card-header">
                                <span class="icon">🏢</span>
                                <h3 class="card-title">사업장</h3>
                            </div>
                            <div class="card-content">
                                <div class="stat-number" id="total-sites">-</div>
                                <div class="stat-label">관리 중인 사업장</div>
                            </div>
                        </div>
                        
                        <div class="dashboard-card">
                            <div class="card-header">
                                <span class="icon">📦</span>
                                <h3 class="card-title">식자재</h3>
                            </div>
                            <div class="card-content">
                                <div class="stat-number" id="total-ingredients">-</div>
                                <div class="stat-label">등록된 식자재</div>
                            </div>
                        </div>
                        
                        <div class="dashboard-card">
                            <div class="card-header">
                                <span class="icon">🚛</span>
                                <h3 class="card-title">협력업체</h3>
                            </div>
                            <div class="card-content">
                                <div class="stat-number" id="total-suppliers">-</div>
                                <div class="stat-label">등록된 협력업체</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 최근 활동 로그 -->
                    <div class="activity-log">
                        <h3 style="margin-bottom: 20px;">📈 최근 활동</h3>
                        <div id="activity-list">
                            <div class="log-item">
                                <div class="log-time">로딩 중...</div>
                                <div class="log-message">시스템 데이터를 불러오고 있습니다.</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 다른 페이지 컨텐츠들은 동적으로 로드 -->
                <div id="users-content" class="page-content">
                    <!-- 템플릿으로 동적 로드 (static/templates/users-section.html) -->
                </div>

                <!-- 사용자 모달은 동적으로 로드됨 (user-modal.html) -->
                <div id="userModalContainer"></div>
                
                <div id="suppliers-content" class="page-content">
                    <!-- 템플릿으로 동적 로드 (static/templates/suppliers-section.html) -->
                </div>
                
                <div id="business-locations-content" class="page-content">
                    <!-- 템플릿으로 동적 로드 (static/templates/sites-section.html) -->
                </div>

                <div id="supplier-mapping-content" class="page-content" style="display: none;">
                    <!-- 협력업체 매칭 모듈이 여기에 로드됩니다 -->
                </div>

                <div id="meal-pricing-content" class="page-content" style="display: none;">
                    <!-- 템플릿으로 동적 로드 (static/templates/meal-pricing-section.html) -->
                </div>
                
                <div id="ingredients-content" class="page-content" style="display: none;">
                    <!-- 식자재 관리 모듈이 여기에 로드됩니다 -->
                </div>
            </div>
        </main>
    </div>

    <!-- 초기화 스크립트 (HTTP 환경에서만 작동) -->
    <!-- <script src="static/js/admin-dashboard-init.js"></script> -->

    <!-- CONFIG 설정 -->
    <script>
        // config.js 내용을 직접 포함
        window.CONFIG = {
            API_BASE_URL: 'http://127.0.0.1:8010',
            API_TIMEOUT: 30000
        };
    </script>

    <!-- 모듈 로드 (옵션) -->
    <!-- <script src="static/modules/users/users-complete.js"></script>
    <script src="static/modules/sites/sites-complete.js"></script> -->

    <!-- 네비게이션 스크립트 -->
    <script>
        // 템플릿 HTML 직접 반환 (file:// 프로토콜용 폴백)
        function getUsersTemplateHTML() {
            return `
                <div class="user-management-container">
                    <div class="dashboard-grid" id="userStatsGrid">
                        <div class="dashboard-card user-stat-card">
                            <div class="card-header">
                                <span class="icon">👥</span>
                                <span class="card-title">전체 사용자</span>
                            </div>
                            <div class="stat-number" id="totalUsers">-</div>
                            <div class="stat-label">Total Users</div>
                        </div>
                        <div class="dashboard-card user-stat-card">
                            <div class="card-header">
                                <span class="icon">✅</span>
                                <span class="card-title">활성 사용자</span>
                            </div>
                            <div class="stat-number" id="activeUsers">-</div>
                            <div class="stat-label">Active Users</div>
                        </div>
                        <div class="dashboard-card user-stat-card">
                            <div class="card-header">
                                <span class="icon">⏸️</span>
                                <span class="card-title">비활성 사용자</span>
                            </div>
                            <div class="stat-number" id="inactiveUsers">-</div>
                            <div class="stat-label">Inactive Users</div>
                        </div>
                        <div class="dashboard-card user-stat-card">
                            <div class="card-header">
                                <span class="icon">👤</span>
                                <span class="card-title">관리자</span>
                            </div>
                            <div class="stat-number" id="adminUsers">-</div>
                            <div class="stat-label">Admin Users</div>
                        </div>
                    </div>

                    <div class="controls">
                        <div class="search-container">
                            <input type="text" id="searchInput" placeholder="사용자명, 연락처, 부서로 검색...">
                        </div>
                        <div class="filter-container">
                            <select id="roleFilter">
                                <option value="">모든 권한</option>
                                <option value="admin">관리자</option>
                                <option value="nutritionist">영양사</option>
                                <option value="operator">운영자</option>
                                <option value="viewer">조회자</option>
                            </select>
                            <button class="btn btn-primary" onclick="UsersManagementFull.loadUsers(1)">검색</button>
                            <button class="btn btn-success" onclick="UsersManagementFull.showAddUserModal()">사용자 추가</button>
                        </div>
                    </div>

                    <div id="bulkActions" style="display: none;">
                        <span>선택된 사용자: <strong id="selectedCount">0</strong>명</span>
                        <button class="btn btn-danger" onclick="UsersManagementFull.bulkDelete()">선택 삭제</button>
                    </div>

                    <div class="table-container">
                        <div id="loadingIndicator" class="loading" style="display: none;">
                            <p>사용자 목록을 불러오는 중...</p>
                        </div>
                        <table id="usersTable" class="data-table">
                            <thead>
                                <tr>
                                    <th><input type="checkbox" id="selectAll"></th>
                                    <th>사용자명</th>
                                    <th>권한</th>
                                    <th>상태</th>
                                    <th>부서</th>
                                    <th>연락처</th>
                                    <th>가입일</th>
                                    <th>마지막 로그인</th>
                                    <th>작업</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody">
                                <tr>
                                    <td colspan="9" class="empty-state">
                                        <p>데이터를 불러오는 중...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div id="usersPagination" class="pagination"></div>
                </div>
                <div id="userModalContainer"></div>
            `;
        }

        // 사업장 관리 템플릿 HTML
        function getSitesTemplateHTML() {
            return `
                <div class="content-header">
                    <h1>사업장 관리</h1>
                    <button class="btn btn-primary" onclick="showAddSiteModal()">
                        <span>+ 새 사업장 추가</span>
                    </button>
                </div>

                <div class="dashboard-grid" id="siteStatsGrid">
                    <div class="dashboard-card site-stat-card">
                        <div class="card-header">
                            <span class="icon">🏢</span>
                            <span class="card-title">전체 사업장</span>
                        </div>
                        <div class="stat-number" id="totalSites">-</div>
                        <div class="stat-label">Total Sites</div>
                    </div>

                    <div class="dashboard-card site-stat-card">
                        <div class="card-header">
                            <span class="icon">🍱</span>
                            <span class="card-title">도시락</span>
                        </div>
                        <div class="stat-number" id="lunchboxSites">-</div>
                        <div class="stat-label">Lunchbox Sites</div>
                    </div>

                    <div class="dashboard-card site-stat-card">
                        <div class="card-header">
                            <span class="icon">🚚</span>
                            <span class="card-title">운반</span>
                        </div>
                        <div class="stat-number" id="transportSites">-</div>
                        <div class="stat-label">Transport Sites</div>
                    </div>

                    <div class="dashboard-card site-stat-card">
                        <div class="card-header">
                            <span class="icon">🏫</span>
                            <span class="card-title">학교</span>
                        </div>
                        <div class="stat-number" id="schoolSites">-</div>
                        <div class="stat-label">School Sites</div>
                    </div>

                    <div class="dashboard-card site-stat-card">
                        <div class="card-header">
                            <span class="icon">🏥</span>
                            <span class="card-title">요양원</span>
                        </div>
                        <div class="stat-number" id="nursingHomeSites">-</div>
                        <div class="stat-label">Nursing Home Sites</div>
                    </div>
                </div>

                <div class="table-container" style="margin-top: 30px;">
                    <h2>사업장 목록</h2>
                    <table id="sitesTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>사업장명</th>
                                <th>구분</th>
                                <th>지역</th>
                                <th>담당자</th>
                                <th>연락처</th>
                                <th>상태</th>
                                <th>작업</th>
                            </tr>
                        </thead>
                        <tbody id="sitesTableBody">
                            <tr>
                                <td colspan="8" style="text-align: center;">데이터 로딩 중...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            `;
        }

        // 식단가 관리 템플릿 HTML
        function getMealPricingTemplateHTML() {
            return `
                <div class="page-header">
                    <h2>식단가 관리</h2>
                    <p class="page-description">사업장별 세부식단표를 관리하고 끼니별 판매가, 목표식재료비를 설정합니다.</p>
                </div>

                <div class="stats-container" style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <div class="stat-box" style="background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); min-width: 150px;">
                        <div style="font-size: 24px; font-weight: bold; color: #007bff;" id="total-meal-plans-count">-</div>
                        <div style="font-size: 14px; color: #666;">전체 식단표</div>
                    </div>
                    <div class="stat-box" style="background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); min-width: 150px;">
                        <div style="font-size: 24px; font-weight: bold; color: #28a745;" id="locations-with-pricing-count">-</div>
                        <div style="font-size: 14px; color: #666;">운영 사업장</div>
                    </div>
                    <div class="stat-box" style="background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); min-width: 150px;">
                        <div style="font-size: 24px; font-weight: bold; color: #17a2b8;" id="average-selling-price">-</div>
                        <div style="font-size: 14px; color: #666;">평균 판매가</div>
                    </div>
                </div>

                <div class="filter-bar" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: white; padding: 15px; border-radius: 8px;">
                    <div class="filter-group">
                        <label style="font-weight: 600; color: #333;">사업장 선택:</label>
                        <select id="businessLocationSelect" class="form-control" style="width: 300px; padding: 8px 12px; font-size: 14px; border: 1px solid #ddd; border-radius: 4px;">
                            <option value="">사업장을 선택하세요</option>
                        </select>
                    </div>
                    <div class="action-group">
                        <button id="addMealPlanBtn" class="btn btn-primary" onclick="addNewMealPlan()" style="display: none;">
                            새 식단표 추가
                        </button>
                    </div>
                </div>

                <div id="mealPlansContainer" class="table-container">
                    <p style="color: #888; text-align: center; padding: 40px;">사업장을 선택하면 세부식단표 목록이 표시됩니다.</p>
                </div>
            `;
        }

        // 스크립트 동적 로드 헬퍼 함수
        function loadScript(src) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }

        // 페이지 네비게이션 설정
        function setupNavigation() {
            console.log('🧭 네비게이션 설정 중...');

            document.querySelectorAll('.nav-item').forEach(navItem => {
                navItem.addEventListener('click', function(e) {
                    e.preventDefault();
                    const targetPage = this.getAttribute('data-page');
                    switchToPage(targetPage);
                });
            });

            // 기본으로 대시보드 활성화
            switchToPage('dashboard');

            // 초기 대시보드 통계 로드
            fetch('http://127.0.0.1:8010/api/admin/dashboard-stats')
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        const els = {
                            'total-users': data.totalUsers,
                            'total-sites': data.totalSites,
                            'total-ingredients': (data.totalIngredients || 0).toLocaleString(),
                            'total-suppliers': data.totalSuppliers
                        };
                        for (const [id, value] of Object.entries(els)) {
                            const el = document.getElementById(id);
                            if (el) el.textContent = value;
                        }
                    }
                })
                .catch(err => console.error('초기 대시보드 통계 로드 실패:', err));
        }

        async function switchToPage(pageName) {
            console.log(`🔄 페이지 전환: ${pageName}`);

            // 네비게이션 상태 업데이트
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });

            const activeNavItem = document.querySelector(`[data-page="${pageName}"]`);
            if (activeNavItem) {
                activeNavItem.classList.add('active');
            }

            // 모든 페이지 콘텐츠 숨기기 - display 직접 제어
            document.querySelectorAll('.page-content').forEach(content => {
                content.classList.remove('active');
                content.style.display = 'none';
            });

            // 선택된 페이지만 표시 - display 직접 제어
            const targetContent = document.getElementById(`${pageName}-content`);
            if (targetContent) {
                targetContent.classList.add('active');
                targetContent.style.display = 'block';
                console.log(`✅ ${pageName} 콘텐츠 표시 완료`);

                // 모듈 초기화 (ModuleLoader 선호, 폴백 지원)
                await initializePageModule(pageName);
            } else {
                console.error(`❌ ${pageName}-content 요소를 찾을 수 없음`);
            }
        }

        // 페이지별 모듈 초기화 (ModuleLoader 우선, 폴백 지원)
        async function initializePageModule(pageName) {
            // 대시보드는 모듈 초기화 불필요
            if (pageName === 'dashboard') {
                console.log('📊 대시보드 - 모듈 초기화 불필요');
                // 대시보드 통계 로드
                fetch('http://127.0.0.1:8010/api/admin/dashboard-stats')
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            const els = {
                                'total-users': data.totalUsers,
                                'total-sites': data.totalSites,
                                'total-ingredients': (data.totalIngredients || 0).toLocaleString(),
                                'total-suppliers': data.totalSuppliers
                            };
                            for (const [id, value] of Object.entries(els)) {
                                const el = document.getElementById(id);
                                if (el) el.textContent = value;
                            }
                        }
                    })
                    .catch(err => console.error('대시보드 통계 로드 실패:', err));
                return;
            }

            const fallbackInitialization = {
                'users': async () => {
                    // 템플릿 로드 먼저 (HTTP 환경에서만 작동)
                    const userContent = document.getElementById('users-content');
                    if (userContent && userContent.innerHTML.trim().length < 100) {
                        try {
                            // HTTP 환경인지 확인
                            if (window.location.protocol.startsWith('http')) {
                                const response = await fetch('static/templates/users-section.html');
                                if (response.ok) {
                                    const html = await response.text();
                                    userContent.innerHTML = html;
                                    console.log('✅ 사용자 템플릿 로드 완료');
                                }
                            } else {
                                // file:// 프로토콜인 경우 기본 HTML 삽입
                                userContent.innerHTML = getUsersTemplateHTML();
                                console.log('✅ 사용자 템플릿 직접 삽입');
                            }
                        } catch (err) {
                            console.error('❌ 사용자 템플릿 로드 실패:', err);
                            // 폴백: 기본 HTML 삽입
                            userContent.innerHTML = getUsersTemplateHTML();
                        }
                    }

                    // 모듈 초기화
                    if (!window.UsersManagementFull) {
                        await loadScript('static/modules/users/users-management-full.js');
                        await new Promise(resolve => setTimeout(resolve, 100));
                    }
                    return window.UsersManagementFull?.init?.();
                },
                'suppliers': async () => {
                    // 템플릿 로드 (추후 구현)

                    // 모듈 초기화
                    if (!window.SupplierManagement) {
                        await loadScript('static/modules/suppliers/suppliers.js');
                        await new Promise(resolve => setTimeout(resolve, 100));
                    }
                    return window.SupplierManagement?.init?.();
                },
                'business-locations': async () => {
                    // 템플릿 로드
                    const sitesContent = document.getElementById('business-locations-content');
                    if (sitesContent && sitesContent.innerHTML.trim().length < 100) {
                        sitesContent.innerHTML = getSitesTemplateHTML();
                        console.log('✅ 사업장 템플릿 직접 삽입');
                    }

                    // 모듈 초기화
                    if (!window.BusinessLocationsModule) {
                        await loadScript('static/modules/sites/sites.js');
                        await new Promise(resolve => setTimeout(resolve, 100));
                    }
                    return window.BusinessLocationsModule?.init?.();
                },
                'business-locations-old': async () => {
                    if (!window.SitesModule) {
                        await loadScript('static/modules/sites/sites-complete.js');
                        await new Promise(resolve => setTimeout(resolve, 100));
                    }
                    return window.SitesModule?.init?.();
                },
                'meal-pricing': async () => {
                    console.log('🎯 meal-pricing 모듈 초기화 시작');

                    // 템플릿 로드
                    const pricingContent = document.getElementById('meal-pricing-content');
                    if (pricingContent && pricingContent.innerHTML.trim().length < 100) {
                        pricingContent.innerHTML = getMealPricingTemplateHTML();
                        console.log('✅ 식단가 템플릿 직접 삽입');
                    }

                    // Meal Pricing 모듈 로드 (운영타입/계획명 직접 수정 버전)
                    const timestamp = new Date().getTime();
                    await loadScript(`static/modules/meal-pricing/meal-pricing.js?v=${timestamp}`);
                    await new Promise(resolve => setTimeout(resolve, 100));

                    if (window.MealPricingModule) {
                        console.log('🚀 MealPricingModule.init 호출');
                        await window.MealPricingModule.init();
                        // 사업장 선택 이벤트 추가
                        const select = document.getElementById('businessLocationSelect');
                        if (select) {
                            select.addEventListener('change', window.loadMealPlansForLocation);
                        }
                    } else {
                        console.error('❌ MealPricingModule을 찾을 수 없음');
                    }
                },
                'ingredients': async () => {
                    if (!window.IngredientManagement) {
                        await loadScript('static/modules/ingredients/ingredients.js');
                        await new Promise(resolve => setTimeout(resolve, 100));
                    }
                    return window.IngredientManagement?.init?.();
                },
                'supplier-mapping': async () => {
                    // 개선된 매핑 모듈 사용
                    if (!window.initEnhancedMapping) {
                        await loadScript('static/modules/mappings/enhanced-mapping.js');
                        await new Promise(resolve => setTimeout(resolve, 100));
                    }

                    // 개선된 매핑 초기화
                    if (window.initEnhancedMapping) {
                        await window.initEnhancedMapping();
                    }
                }
            };

            // ModuleLoader 먼저 시도
            if (window.moduleLoader) {
                try {
                    console.log(`📦 [ModuleLoader] ${pageName} 모듈 로드 중...`);
                    const moduleObject = await window.moduleLoader.loadModule(pageName);

                    if (moduleObject && typeof moduleObject.init === 'function') {
                        console.log(`🎯 [ModuleLoader] ${pageName} 모듈 초기화 중...`);
                        await moduleObject.init();
                        console.log(`✅ [ModuleLoader] ${pageName} 모듈 초기화 완료`);
                        return;
                    }
                } catch (error) {
                    console.warn(`⚠️ [ModuleLoader] ${pageName} 모듈 로드 실패:`, error);
                }
            }

            // 폴백: 직접 모듈 로딩
            console.log(`🔄 [Fallback] 직접 ${pageName} 모듈 로드 중...`);
            if (fallbackInitialization[pageName]) {
                try {
                    await fallbackInitialization[pageName]();
                    console.log(`✅ [Fallback] ${pageName} 모듈 초기화 완료`);
                } catch (fallbackError) {
                    console.error(`❌ [Fallback] ${pageName} 모듈 초기화 실패:`, fallbackError);
                }
            } else {
                console.warn(`⚠️ ${pageName} 페이지에 대한 모듈이 정의되지 않음`);
            }
        }

        // 간단한 초기화 함수
        async function initializePage() {
            console.log('🚀 [Admin Dashboard] 초기화 시작');

            // 날짜 표시
            const currentDateElement = document.getElementById('current-date');
            if (currentDateElement) {
                currentDateElement.textContent = new Date().toLocaleDateString('ko-KR', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    weekday: 'short'
                });
            }

            console.log('✅ [Admin Dashboard] 초기화 완료');
        }

        // 초기화 에러 표시 함수
        function showInitializationError(error) {
            const contentArea = document.getElementById('content-area');
            if (contentArea) {
                contentArea.innerHTML = `
                    <div style="padding: 40px; text-align: center; background: #fff; border-radius: 10px;">
                        <h2 style="color: #ff6b6b;">⚠️ 시스템 초기화 실패</h2>
                        <p style="color: #666; margin: 20px 0;">관리자 시스템을 시작할 수 없습니다.</p>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 20px 0;">
                            ${error.message || error.toString()}
                        </div>
                        <button onclick="location.reload()" style="padding: 12px 24px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer;">
                            🔄 페이지 새로고침
                        </button>
                    </div>
                `;
            }
        }

        // 페이지 로드 시 통합 초기화 (단일 DOMContentLoaded 이벤트)
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('🎯 [Admin Dashboard] 통합 초기화 시작');

            try {
                // 기본 초기화 실행
                await initializePage();

                // 네비게이션 설정
                setupNavigation();

                console.log('✅ [Admin Dashboard] 통합 초기화 완료');

            } catch (error) {
                console.error('❌ [Admin Dashboard] 통합 초기화 실패:', error);
                showInitializationError(error);
            }
        });
    </script>
</body>
</html>