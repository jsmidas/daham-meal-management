<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>다함 식자재 관리 시스템 - 관리자 대시보드</title>
    
    <!-- 외부 CSS -->
    <link rel="stylesheet" href="static/css/admin-dashboard-main.css">
    
    <!-- 간단한 대시보드 스크립트 -->
    <script>
        // 모듈 로더 대신 간단한 초기화
        const API_BASE = 'http://127.0.0.1:8006';
        console.log('Admin Dashboard 시작');
    </script>
</head>
<body>
    <!-- 메인 컨테이너 -->
    <div class="admin-container">
        <!-- 사이드바 -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <h2>🍽️ 다함 식자재 관리</h2>
                <p>관리자 시스템</p>
            </div>
            
            <div class="nav-menu">
                <a href="#" class="nav-item active" data-page="dashboard">
                    <span class="icon">📊</span>대시보드
                </a>
                <a href="#" class="nav-item" data-page="users">
                    <span class="icon">👥</span>사용자 관리
                </a>
                <a href="#" class="nav-item" data-page="suppliers">
                    <span class="icon">🚛</span>협력업체 관리
                </a>
                <a href="#" class="nav-item" data-page="business-locations">
                    <span class="icon">🏢</span>사업장 관리
                </a>
                <a href="#" class="nav-item" data-page="meal-pricing">
                    <span class="icon">💰</span>식단가 관리
                </a>
                <a href="#" class="nav-item" data-page="ingredients">
                    <span class="icon">📦</span>식자재 관리
                </a>
            </div>
            
            <div class="sidebar-footer" style="margin-top: auto; padding: 20px;">
                <div style="border-top: 1px solid rgba(255,255,255,0.2); padding-top: 20px;">
                    <a href="/" class="nav-item" style="background: #e8f5e8; color: #4caf50;">
                        <span class="icon">🍽️</span>급식관리로 이동
                    </a>
                </div>
            </div>
        </nav>

        <!-- 메인 컨텐츠 -->
        <main class="main-content">
            <!-- 헤더 -->
            <div class="header">
                <h1 id="page-title">관리자 대시보드</h1>
                <div class="header-info">
                    <div class="user-info">
                        관리자님, 안녕하세요! | 오늘: <span id="current-date"></span>
                    </div>
                    <button class="logout-btn" onclick="logout()">로그아웃</button>
                </div>
            </div>

            <!-- 페이지별 컨텐츠 영역 -->
            <div id="content-area">
                <!-- 대시보드 기본 컨텐츠 -->
                <div id="dashboard-content" class="page-content">
                    <div class="dashboard-grid">
                        <div class="dashboard-card">
                            <div class="card-header">
                                <span class="icon">👥</span>
                                <h3 class="card-title">전체 사용자</h3>
                            </div>
                            <div class="card-content">
                                <div class="stat-number" id="total-users">-</div>
                                <div class="stat-label">등록된 사용자 수</div>
                            </div>
                        </div>
                        
                        <div class="dashboard-card">
                            <div class="card-header">
                                <span class="icon">🏢</span>
                                <h3 class="card-title">사업장</h3>
                            </div>
                            <div class="card-content">
                                <div class="stat-number" id="total-sites">-</div>
                                <div class="stat-label">관리 중인 사업장</div>
                            </div>
                        </div>
                        
                        <div class="dashboard-card">
                            <div class="card-header">
                                <span class="icon">📦</span>
                                <h3 class="card-title">식자재</h3>
                            </div>
                            <div class="card-content">
                                <div class="stat-number" id="total-ingredients">-</div>
                                <div class="stat-label">등록된 식자재</div>
                            </div>
                        </div>
                        
                        <div class="dashboard-card">
                            <div class="card-header">
                                <span class="icon">🚛</span>
                                <h3 class="card-title">협력업체</h3>
                            </div>
                            <div class="card-content">
                                <div class="stat-number" id="total-suppliers">-</div>
                                <div class="stat-label">등록된 협력업체</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 최근 활동 로그 -->
                    <div class="activity-log">
                        <h3 style="margin-bottom: 20px;">📈 최근 활동</h3>
                        <div id="activity-list">
                            <div class="log-item">
                                <div class="log-time">로딩 중...</div>
                                <div class="log-message">시스템 데이터를 불러오고 있습니다.</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 다른 페이지 컨텐츠들은 동적으로 로드 -->
                <div id="users-content" class="page-content" style="display: none;">
                    <!-- 사용자 관리 모듈이 여기에 로드됩니다 -->
                </div>
                
                <div id="suppliers-content" class="page-content" style="display: none;">
                    <!-- 협력업체 관리 모듈이 여기에 로드됩니다 -->
                </div>
                
                <div id="business-locations-content" class="page-content" style="display: none;">
                    <!-- 사업장 관리 모듈이 여기에 로드됩니다 -->
                </div>
                
                <div id="meal-pricing-content" class="page-content" style="display: none;">
                    <!-- 식단가 관리 모듈이 여기에 로드됩니다 -->
                </div>
                
                <div id="ingredients-content" class="page-content" style="display: none;">
                    <!-- 식자재 관리 모듈이 여기에 로드됩니다 -->
                </div>
            </div>
        </main>
    </div>

    <!-- 🚀 시스템 초기화 (의존성 자동 관리) -->
    <script>
        // 스크립트 동적 로드 헬퍼 함수
        function loadScript(src) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }
        
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('🚀 [Admin Dashboard] 시스템 초기화 시작');
            
            try {
                
                // ⚡ Phase 1: 필수 모듈 수동 로드 (순차적 + 검증)
                console.log('📦 [Admin Dashboard] 필수 모듈 수동 로드 중...');
                
                // config.js 직접 로드 및 확인
                if (!window.CONFIG) {
                    console.log('🔧 config.js 로딩...');
                    await loadScript('config.js');
                    
                    let attempts = 0;
                    while (!window.CONFIG && attempts < 20) {
                        await new Promise(resolve => setTimeout(resolve, 100));
                        attempts++;
                    }
                    
                    if (!window.CONFIG) {
                        throw new Error('config.js 로드 실패');
                    }
                    console.log('✅ CONFIG 로드 완료');
                }
                
                // DateTimeUtils 로드 및 확인
                console.log('🕒 date-time-utils.js 로딩...');
                await loadScript('static/utils/date-time-utils.js');
                
                let attempts = 0;
                while ((!window.DateTimeUtils || typeof window.DateTimeUtils.startRealTimeUpdate !== 'function') && attempts < 20) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                    attempts++;
                }
                
                if (!window.DateTimeUtils || typeof window.DateTimeUtils.startRealTimeUpdate !== 'function') {
                    console.warn('⚠️  DateTimeUtils 로드 실패 - 기본 기능 사용');
                } else {
                    console.log('✅ DateTimeUtils 로드 완료');
                }
                
                // 나머지 유틸리티들 로드
                console.log('🛡️ error-handler.js 로딩...');
                await loadScript('static/utils/error-handler.js');
                
                console.log('🔄 loading-manager.js 로딩...');
                await loadScript('static/utils/loading-manager.js');
                
                // LoadingManager 로드 확인 및 대기
                attempts = 0;
                while ((!window.LoadingManager || typeof window.LoadingManager.startLoading !== 'function') && attempts < 20) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                    attempts++;
                }
                
                if (!window.LoadingManager || typeof window.LoadingManager.startLoading !== 'function') {
                    console.warn('⚠️  LoadingManager 로드 실패 - 기본 기능 사용');
                } else {
                    console.log('✅ LoadingManager 로드 완료');
                }
                
                console.log('🗄️ admin-cache.js 로딩...');
                await loadScript('static/utils/admin-cache.js');
                
                console.log('✅ [Admin Dashboard] 필수 모듈 로드 완료');
                
                // ⚡ Phase 2: 대시보드 코어 로드  
                console.log('🎯 [Admin Dashboard] 대시보드 코어 로드 중...');
                await loadScript('static/modules/dashboard-core/dashboard-core.js');
                
                if (!window.DashboardCore) {
                    throw new Error('DashboardCore 클래스를 찾을 수 없습니다');
                }
                
                // ⚡ Phase 3: 시스템 시작
                console.log('✨ [Admin Dashboard] 시스템 시작');
                
                // 날짜 표시 (기본 방식)
                const currentDateElement = document.getElementById('current-date');
                if (currentDateElement) {
                    currentDateElement.textContent = new Date().toLocaleDateString('ko-KR', {
                        year: 'numeric',
                        month: 'long', 
                        day: 'numeric',
                        weekday: 'short'
                    });
                }
                
                // 대시보드 초기화
                window.dashboard = new window.DashboardCore();
                
                console.log('🎉 [Admin Dashboard] 시스템 초기화 완료');
                
                // 모듈 상태 확인
                console.log('📊 [Admin Dashboard] 로드된 모듈들:');
                console.log('- CONFIG:', !!window.CONFIG);
                console.log('- DateTimeUtils:', !!window.DateTimeUtils, typeof window.DateTimeUtils?.startRealTimeUpdate);
                console.log('- ErrorHandler:', !!window.ErrorHandler, typeof window.ErrorHandler?.handleError);
                console.log('- LoadingManager:', !!window.LoadingManager, typeof window.LoadingManager?.startLoading);
                console.log('- AdminCache:', !!window.AdminCache);
                console.log('- DashboardCore:', !!window.DashboardCore);
                
            } catch (error) {
                console.error('❌ [Admin Dashboard] 시스템 초기화 실패:', error);
                showInitializationError(error);
            }
        });
        
        /**
         * 초기화 실패 시 에러 표시
         */
        function showInitializationError(error) {
            const contentArea = document.getElementById('content-area');
            if (contentArea) {
                contentArea.innerHTML = `
                    <div style="padding: 40px; text-align: center; background: #fff; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                        <h2 style="color: #ff6b6b;">⚠️ 시스템 초기화 실패</h2>
                        <p style="color: #666; margin: 20px 0;">관리자 시스템을 시작할 수 없습니다.</p>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 20px 0; font-family: monospace; font-size: 12px; color: #333; text-align: left;">
                            ${error.message || error.toString()}
                        </div>
                        <button onclick="location.reload()" style="padding: 12px 24px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer; margin-right: 10px;">
                            🔄 페이지 새로고침
                        </button>
                        <button onclick="ModuleLoader.getModuleStatus()" style="padding: 12px 24px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer;">
                            🔍 모듈 상태 확인
                        </button>
                    </div>
                `;
            }
        }
        
        /**
         * 안전한 로그아웃 (의존성 확인 후 실행)
         */
        async function logout() {
            if (confirm('로그아웃하시겠습니까?')) {
                try {
                    // 캐시 정리
                    if (window.AdminCache) {
                        AdminCache.clearAllCache();
                        console.log('🗑️ [Logout] 캐시 정리 완료');
                    }
                    
                    // 대시보드 정리
                    if (window.dashboard && typeof window.dashboard.destroy === 'function') {
                        window.dashboard.destroy();
                        console.log('🧹 [Logout] 대시보드 정리 완료');
                    }
                    
                    // 메인 페이지로 이동
                    console.log('🚪 [Logout] 메인 페이지로 이동');
                    window.location.href = '/';
                    
                } catch (error) {
                    console.error('❌ [Logout] 로그아웃 중 오류:', error);
                    // 오류가 있어도 로그아웃 진행
                    window.location.href = '/';
                }
            }
        }
        
        /**
         * 개발자용 디버그 함수들 (콘솔에서 사용)
         */
        window.debugInfo = {
            modules: () => ModuleLoader.getModuleStatus(),
            cache: () => AdminCache ? AdminCache.getCacheStatus() : 'AdminCache not loaded',
            dashboard: () => window.dashboard || 'Dashboard not initialized',
            reload: () => location.reload(),
            clearCache: () => AdminCache ? AdminCache.clearAllCache() : 'AdminCache not available'
        };
        
        console.log('🔧 [Admin Dashboard] 디버그 함수 사용법:');
        console.log('  debugInfo.modules()  - 모듈 상태 확인');
        console.log('  debugInfo.cache()    - 캐시 상태 확인');
        console.log('  debugInfo.dashboard() - 대시보드 상태 확인');
        console.log('  debugInfo.clearCache() - 캐시 초기화');
        console.log('  debugInfo.reload()   - 페이지 새로고침');
    </script>
</body>
</html>