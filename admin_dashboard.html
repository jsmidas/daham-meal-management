<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>다함식단관리 - 관리자 대시보드</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Malgun Gothic', sans-serif;
            background-color: #f5f5f5;
        }

        .admin-container {
            display: flex;
            height: 100vh;
        }

        /* 사이드바 */
        .sidebar {
            width: 250px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 0;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }

        .sidebar-header {
            text-align: center;
            padding: 0 20px 30px;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }

        .sidebar-header h2 {
            font-size: 18px;
            font-weight: 600;
        }

        .sidebar-header p {
            font-size: 12px;
            opacity: 0.8;
            margin-top: 5px;
        }

        .nav-menu {
            padding: 20px 0;
        }

        .nav-item {
            display: block;
            padding: 15px 25px;
            color: white;
            text-decoration: none;
            transition: all 0.3s;
            border-left: 3px solid transparent;
        }

        .nav-item:hover, .nav-item.active {
            background: rgba(255,255,255,0.1);
            border-left-color: #ffd700;
        }

        .nav-item .icon {
            margin-right: 10px;
            font-size: 16px;
        }

        /* 메인 컨텐츠 */
        .main-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .header h1 {
            color: #333;
            font-size: 24px;
        }

        .header-info {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-top: 10px;
        }

        .user-info {
            color: #666;
            font-size: 14px;
        }

        .logout-btn {
            background: #ff6b6b;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .logout-btn:hover {
            background: #ff5252;
        }

        /* 대시보드 카드들 */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .dashboard-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .card-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .card-header .icon {
            font-size: 24px;
            margin-right: 10px;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }

        .card-content {
            color: #666;
        }

        .stat-number {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
            margin: 10px 0;
        }

        .stat-label {
            font-size: 14px;
            color: #999;
        }

        /* 최근 활동 로그 */
        .activity-log {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .log-item {
            padding: 12px 0;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
        }

        .log-item:last-child {
            border-bottom: none;
        }

        .log-time {
            font-size: 12px;
            color: #999;
            margin-right: 15px;
            min-width: 100px;
        }

        .log-message {
            color: #666;
            flex: 1;
        }

        .log-user {
            font-size: 12px;
            color: #667eea;
            margin-left: 10px;
        }

        /* 반응형 */
        @media (max-width: 768px) {
            .admin-container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: auto;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }

        .hidden {
            display: none !important;
        }

        /* 식자재 업로드 관련 스타일 */
        .upload-notice {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .upload-notice h3 {
            color: #856404;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .notice-content p {
            color: #856404;
            margin-bottom: 15px;
            line-height: 1.5;
        }

        .warning-item {
            background: white;
            border-left: 4px solid #f39c12;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 0 8px 8px 0;
        }

        .warning-item strong {
            color: #e67e22;
            display: block;
            margin-bottom: 8px;
        }

        .warning-item p {
            color: #666;
            margin: 5px 0;
            font-size: 14px;
        }

        .upload-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .upload-container {
            margin-bottom: 20px;
        }

        .upload-area {
            border: 2px dashed #4a90e2;
            border-radius: 10px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #f8f9fa;
        }

        .upload-area:hover {
            border-color: #357abd;
            background: #e7f3ff;
        }

        .upload-area.dragover {
            border-color: #28a745;
            background: #d4edda;
        }

        .upload-icon {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.7;
        }

        .upload-text h4 {
            color: #333;
            margin-bottom: 8px;
        }

        .upload-text p {
            color: #666;
            font-size: 14px;
        }

        .upload-progress {
            margin-top: 20px;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #20c997);
            width: 0%;
            transition: width 0.3s;
        }

        .progress-text {
            text-align: center;
            color: #666;
            font-size: 14px;
        }

        .upload-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .upload-results {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .upload-results h3 {
            color: #333;
            margin-bottom: 15px;
        }

        .result-summary {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .result-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 15px;
            border-radius: 8px;
            font-weight: 500;
        }

        .result-item.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .result-item.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .result-count {
            font-size: 18px;
            font-weight: bold;
        }

        .result-details {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 8px;
        }

        .result-file {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            border-bottom: 1px solid #f8f9fa;
        }

        .result-file:last-child {
            border-bottom: none;
        }

        .result-file.success {
            background: #f8fff9;
        }

        .result-file.error {
            background: #fff5f5;
        }

        .file-name {
            font-weight: 500;
            color: #333;
        }

        .file-status {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
        }

        .file-status.success {
            color: #28a745;
        }

        .file-status.error {
            color: #dc3545;
        }

        .ingredients-list {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .ingredients-list h3 {
            color: #333;
            margin-bottom: 15px;
        }

        .list-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            align-items: center;
        }

        .search-input, .filter-select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .search-input {
            flex: 2;
        }

        .filter-select {
            flex: 1;
        }

        /* 식수 등록 관리 전용 스타일 */
        .meal-count-notice {
            background: #e7f3ff;
            border: 1px solid #b3d9ff;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .meal-count-notice h3 {
            color: #0056b3;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .notice-content p {
            color: #0056b3;
            margin-bottom: 15px;
            line-height: 1.5;
        }

        .notice-rules {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .rule-item {
            background: white;
            border-left: 4px solid #007bff;
            padding: 12px 15px;
            border-radius: 0 8px 8px 0;
            font-size: 14px;
        }

        .rule-item strong {
            color: #0056b3;
            margin-right: 8px;
        }

        .meal-count-summary {
            margin-bottom: 20px;
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .summary-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
            border-left: 4px solid #4a90e2;
        }

        .card-header {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
            font-weight: 500;
        }

        .card-value {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }

        .meal-count-table-container {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
        }

        .table-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            align-items: center;
        }

        .meal-count-table {
            width: 100%;
            border-collapse: collapse;
        }

        .meal-count-table th,
        .meal-count-table td {
            border: 1px solid #ddd;
            padding: 8px 12px;
            text-align: center;
            font-size: 13px;
        }

        .meal-count-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }

        .meal-count-table tbody tr:hover {
            background: #f8f9fa;
        }

        .delivery-site-cell {
            font-weight: 600;
            color: #4a90e2;
            background: #f0f8ff !important;
        }

        .meal-type-cell {
            font-weight: 500;
        }

        .cost-cell {
            font-weight: 600;
            color: #28a745;
        }

        .count-cell {
            font-weight: 600;
            color: #dc3545;
        }

        .site-detail-row {
            background: #f9f9f9 !important;
            font-size: 12px;
        }

        .date-input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            margin-left: 8px;
        }

        .date-selector {
            display: flex;
            align-items: center;
            margin-right: 15px;
        }

        .date-selector label {
            font-weight: 500;
            color: #333;
        }

        /* 모달 폼 스타일 */
        .form-row {
            display: flex;
            gap: 20px;
        }

        .form-row .form-group {
            flex: 1;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #333;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .form-group textarea {
            resize: vertical;
        }

        .form-group small {
            color: #666;
            font-size: 12px;
            margin-top: 5px;
            display: block;
        }

        .btn-group {
            display: flex;
            gap: 5px;
        }

        .btn-small {
            padding: 4px 8px;
            font-size: 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
        }

        .btn-small.btn-primary {
            background: #4a90e2;
            color: white;
        }

        .btn-small.btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn-small.btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .modal {
            display: none;
        }

        /* 사용자 관리 페이지 스타일 */
        .page-header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .header-actions {
            display: flex;
            justify-content: between;
            align-items: center;
            gap: 20px;
        }

        .search-box {
            display: flex;
            align-items: center;
            flex: 1;
        }

        .search-box input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px 0 0 5px;
            outline: none;
        }

        .search-box button {
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-left: none;
            border-radius: 0 5px 5px 0;
            background: #f8f9fa;
            cursor: pointer;
        }

        .btn-primary {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.3s;
        }

        .btn-primary:hover {
            background: #5a6fd8;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.3s;
        }

        .btn-secondary:hover {
            background: #545b62;
        }

        .btn-small {
            padding: 5px 10px;
            font-size: 12px;
            border-radius: 3px;
            border: none;
            cursor: pointer;
            margin-right: 5px;
        }

        .btn-edit {
            background: #28a745;
            color: white;
        }

        .btn-delete {
            background: #dc3545;
            color: white;
        }

        .btn-reset {
            background: #ffc107;
            color: black;
        }

        /* 테이블 스타일 */
        .table-container {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th {
            background: #f8f9fa;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid #dee2e6;
        }

        .data-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #dee2e6;
        }

        .data-table tbody tr:hover {
            background: #f8f9fa;
        }

        .status-active {
            color: #28a745;
            font-weight: 500;
        }

        .status-inactive {
            color: #dc3545;
            font-weight: 500;
        }

        /* 페이지네이션 */
        .pagination {
            text-align: center;
            padding: 20px;
        }

        .pagination button {
            background: white;
            border: 1px solid #dee2e6;
            padding: 8px 16px;
            margin: 0 5px;
            border-radius: 5px;
            cursor: pointer;
        }

        .pagination button:hover {
            background: #e9ecef;
        }

        .pagination button:disabled {
            background: #f8f9fa;
            color: #6c757d;
            cursor: not-allowed;
        }

        /* 모달 스타일 */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            border-radius: 10px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            justify-content: between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
            color: #333;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }

        .modal-close:hover {
            color: #333;
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 20px;
            border-top: 1px solid #dee2e6;
            text-align: right;
        }

        .modal-footer button {
            margin-left: 10px;
        }

        /* 폼 스타일 */
        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #333;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            outline: none;
        }

        .form-group input:focus,
        .form-group select:focus {
            border-color: #667eea;
        }

        .form-group small {
            display: block;
            margin-top: 5px;
            color: #6c757d;
            font-size: 12px;
        }

        .checkbox-label {
            display: flex !important;
            align-items: center;
            cursor: pointer;
        }

        .checkbox-label input[type="checkbox"] {
            width: auto !important;
            margin-right: 8px;
        }

        /* 사업장 관리 페이지 스타일 */
        .action-buttons {
            display: flex;
            gap: 10px;
        }

        .sites-container {
            display: flex;
            gap: 20px;
        }

        .sites-tree {
            flex: 2;
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-height: 600px;
            overflow-y: auto;
        }

        .site-details-panel {
            flex: 1;
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-height: 600px;
            overflow-y: auto;
        }

        .panel-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #dee2e6;
        }

        .panel-header h3 {
            margin: 0;
            color: #333;
        }

        .panel-close {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #999;
        }

        .panel-close:hover {
            color: #333;
        }

        /* 트리 노드 스타일 */
        .tree-node {
            margin: 5px 0;
            user-select: none;
        }

        .tree-node-content {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.2s;
            position: relative;
        }

        .tree-node-content:hover {
            background: #f8f9fa;
        }

        .tree-node-content.selected {
            background: #e7f3ff;
            border: 1px solid #b3d9ff;
        }

        .tree-node-content.head-site {
            background: #e8f5e8;
            border-left: 4px solid #28a745;
        }

        .tree-node-content.detail-site {
            background: #fff8e1;
            border-left: 4px solid #ffc107;
        }

        .tree-node-content.period-site {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
        }

        .tree-expand-btn {
            width: 20px;
            height: 20px;
            border: none;
            background: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 5px;
            border-radius: 3px;
        }

        .tree-expand-btn:hover {
            background: #e9ecef;
        }

        .tree-expand-btn.expanded::before {
            content: '▼';
        }

        .tree-expand-btn.collapsed::before {
            content: '▶';
        }

        .tree-expand-btn.no-children {
            visibility: hidden;
        }

        .tree-node-icon {
            margin-right: 8px;
            font-size: 16px;
        }

        .tree-node-label {
            flex: 1;
            font-weight: 500;
            color: #333;
        }

        .tree-node-status {
            font-size: 12px;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 10px;
        }

        .tree-node-status.active {
            background: #d4edda;
            color: #155724;
        }

        .tree-node-status.inactive {
            background: #f8d7da;
            color: #721c24;
        }

        .tree-node-actions {
            display: none;
            margin-left: 10px;
            gap: 5px;
        }

        .tree-node-content:hover .tree-node-actions {
            display: flex;
        }

        .tree-action-btn {
            padding: 2px 6px;
            border: none;
            border-radius: 3px;
            font-size: 12px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .tree-action-btn.add {
            background: #d4edda;
            color: #155724;
        }

        .tree-action-btn.edit {
            background: #cce5ff;
            color: #004085;
        }

        .tree-action-btn.delete {
            background: #f8d7da;
            color: #721c24;
        }

        .tree-action-btn:hover {
            opacity: 0.8;
        }

        /* 자식 노드 들여쓰기 */
        .tree-children {
            margin-left: 25px;
            border-left: 1px solid #dee2e6;
            padding-left: 10px;
        }

        .tree-children.hidden {
            display: none;
        }

        /* 드래그 앤 드롭 스타일 */
        .tree-node-content {
            cursor: move;
            transition: all 0.2s ease;
        }

        .tree-node-content.dragging {
            opacity: 0.5;
            transform: rotate(5deg);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .tree-node-content.drag-over {
            background: #e3f2fd;
            border: 2px dashed #2196F3;
            transform: scale(1.02);
        }

        .tree-node-content.drop-invalid {
            background: #ffebee;
            border: 2px dashed #f44336;
        }

        .drag-indicator {
            position: absolute;
            height: 2px;
            background: #2196F3;
            left: 0;
            right: 0;
            pointer-events: none;
            z-index: 1000;
        }

        /* 사업장 상세 정보 스타일 */
        .site-info-group {
            margin-bottom: 15px;
        }

        .site-info-label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 5px;
        }

        .site-info-value {
            color: #333;
            background: #f8f9fa;
            padding: 8px 12px;
            border-radius: 5px;
        }

        .site-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }

        .stat-box {
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            font-size: 12px;
            color: #6c757d;
            margin-top: 5px;
        }

        /* 드래그 앤 드롭 스타일 */
        .tree-node-content.dragging {
            opacity: 0.5;
        }

        .tree-node-content.drop-target {
            background: #e7f3ff;
            border: 2px dashed #007bff;
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <!-- 사이드바 -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <h2>관리자 시스템</h2>
                <p>다함식단관리</p>
            </div>
            
            <div class="nav-menu">
                <a href="#" class="nav-item active" data-page="dashboard">
                    <span class="icon">📊</span>대시보드
                </a>
                <a href="#" class="nav-item" data-page="users">
                    <span class="icon">👥</span>사용자 관리
                </a>
                <a href="#" class="nav-item" data-page="sites">
                    <span class="icon">🏢</span>사업장 관리
                </a>
                <a href="meal_plan_management.html" class="nav-item" target="_blank">
                    <span class="icon">📋</span>식단표 관리
                </a>
                <a href="menu_recipe_management.html" class="nav-item" target="_blank">
                    <span class="icon">🍽️</span>메뉴/레시피 관리
                </a>
                <a href="#" class="nav-item" data-page="ingredients">
                    <span class="icon">📦</span>식자재/업체 관리
                </a>
                <a href="#" class="nav-item" data-page="meal-counts">
                    <span class="icon">👥</span>식수 등록 관리
                </a>
                <a href="#" class="nav-item" data-page="pricing">
                    <span class="icon">💰</span>단가 관리
                </a>
                <a href="#" class="nav-item" data-page="settings">
                    <span class="icon">⚙️</span>시스템 설정
                </a>
                <a href="#" class="nav-item" data-page="logs">
                    <span class="icon">📋</span>로그 관리
                </a>
            </div>
        </nav>

        <!-- 메인 컨텐츠 -->
        <main class="main-content">
            <!-- 헤더 -->
            <div class="header">
                <div class="header-info">
                    <div>
                        <h1 id="page-title">관리자 대시보드</h1>
                        <div class="user-info">
                            관리자님, 안녕하세요! | 마지막 접속: 2025-08-30 12:00
                        </div>
                    </div>
                    <button class="logout-btn" onclick="logout()">로그아웃</button>
                </div>
            </div>

            <!-- 대시보드 페이지 -->
            <div id="dashboard-page" class="page-content">
                <div class="dashboard-grid">
                    <div class="dashboard-card">
                        <div class="card-header">
                            <span class="icon">👥</span>
                            <span class="card-title">전체 사용자</span>
                        </div>
                        <div class="card-content">
                            <div class="stat-number" id="total-users">-</div>
                            <div class="stat-label">활성 사용자</div>
                        </div>
                    </div>

                    <div class="dashboard-card">
                        <div class="card-header">
                            <span class="icon">🏢</span>
                            <span class="card-title">사업장 수</span>
                        </div>
                        <div class="card-content">
                            <div class="stat-number" id="total-sites">-</div>
                            <div class="stat-label">등록된 사업장</div>
                        </div>
                    </div>

                    <div class="dashboard-card">
                        <div class="card-header">
                            <span class="icon">📋</span>
                            <span class="card-title">오늘의 식단</span>
                        </div>
                        <div class="card-content">
                            <div class="stat-number" id="today-menus">-</div>
                            <div class="stat-label">오늘 편성된 식단</div>
                        </div>
                    </div>

                    <div class="dashboard-card">
                        <div class="card-header">
                            <span class="icon">💰</span>
                            <span class="card-title">단가 업데이트</span>
                        </div>
                        <div class="card-content">
                            <div class="stat-number" id="price-updates">-</div>
                            <div class="stat-label">최근 7일간 업데이트</div>
                        </div>
                    </div>
                </div>

                <!-- 최근 활동 로그 -->
                <div class="activity-log">
                    <div class="card-header">
                        <span class="icon">📋</span>
                        <span class="card-title">최근 활동</span>
                    </div>
                    <div id="activity-list">
                        <!-- 동적으로 로드될 활동 로그 -->
                    </div>
                </div>
            </div>

            <!-- 다른 페이지들은 hidden 상태로 시작 -->
            <div id="users-page" class="page-content hidden">
                <!-- 사용자 관리 헤더 -->
                <div class="page-header">
                    <div class="header-actions">
                        <div class="search-box">
                            <input type="text" id="user-search" placeholder="사용자 검색 (이름, 아이디, 부서)">
                            <button onclick="searchUsers()">🔍</button>
                        </div>
                        <button class="btn-primary" onclick="showAddUserModal()">+ 새 사용자</button>
                    </div>
                </div>

                <!-- 사용자 목록 테이블 -->
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>사용자명</th>
                                <th>역할</th>
                                <th>부서</th>
                                <th>담당 사업장</th>
                                <th>상태</th>
                                <th>마지막 접속</th>
                                <th>관리</th>
                            </tr>
                        </thead>
                        <tbody id="users-table-body">
                            <!-- 동적으로 로드될 사용자 목록 -->
                        </tbody>
                    </table>
                </div>

                <!-- 페이지네이션 -->
                <div class="pagination">
                    <button onclick="changePage(-1)">이전</button>
                    <span id="page-info">1 / 1</span>
                    <button onclick="changePage(1)">다음</button>
                </div>
            </div>

            <!-- 사용자 추가/수정 모달 -->
            <div id="user-modal" class="modal hidden">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 id="modal-title">새 사용자 추가</h3>
                        <button class="modal-close" onclick="closeUserModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <form id="user-form">
                            <div class="form-group">
                                <label>사용자 ID</label>
                                <input type="text" id="user-username" required>
                            </div>
                            <div class="form-group">
                                <label>비밀번호</label>
                                <input type="password" id="user-password">
                                <small>수정 시 비워두면 변경하지 않음</small>
                            </div>
                            <div class="form-group">
                                <label>역할</label>
                                <select id="user-role" required>
                                    <option value="">선택하세요</option>
                                    <option value="nutritionist">영양사</option>
                                    <option value="admin">관리자</option>
                                    <option value="super_admin">최고관리자</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>연락처</label>
                                <input type="text" id="user-contact">
                            </div>
                            <div class="form-group">
                                <label>부서</label>
                                <input type="text" id="user-department">
                            </div>
                            <div class="form-group">
                                <label>직책</label>
                                <input type="text" id="user-position">
                            </div>
                            <div class="form-group">
                                <label>담당 사업장</label>
                                <select id="user-managed-site">
                                    <option value="">선택하세요</option>
                                    <!-- 동적으로 로드될 사업장 목록 -->
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="user-operator">
                                    운영자 권한
                                </label>
                            </div>
                            <div class="form-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="user-semi-operator">
                                    부운영자 권한
                                </label>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn-secondary" onclick="closeUserModal()">취소</button>
                        <button type="button" class="btn-primary" onclick="saveUser()">저장</button>
                    </div>
                </div>
            </div>

            <div id="sites-page" class="page-content hidden">
                <!-- 사업장 관리 헤더 -->
                <div class="page-header">
                    <div class="header-actions">
                        <div class="action-buttons">
                            <button class="btn-primary" onclick="showAddSiteModal('head')">+ 헤드 사업장</button>
                            <button class="btn-secondary" onclick="expandAllSites()">전체 펼치기</button>
                            <button class="btn-secondary" onclick="collapseAllSites()">전체 접기</button>
                        </div>
                    </div>
                </div>

                <!-- 사업장 트리 구조 -->
                <div class="sites-container">
                    <div class="sites-tree" id="sites-tree">
                        <!-- 동적으로 로드될 사업장 트리 -->
                    </div>
                </div>

                <!-- 사업장 상세 정보 패널 -->
                <div class="site-details-panel hidden" id="site-details-panel">
                    <div class="panel-header">
                        <h3 id="site-details-title">사업장 상세정보</h3>
                        <button class="panel-close" onclick="closeSiteDetails()">&times;</button>
                    </div>
                    <div class="panel-content" id="site-details-content">
                        <!-- 동적으로 로드될 상세정보 -->
                    </div>
                </div>
            </div>

            <!-- 사업장 추가/수정 모달 -->
            <div id="site-modal" class="modal hidden">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 id="site-modal-title">새 사업장 추가</h3>
                        <button class="modal-close" onclick="closeSiteModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <form id="site-form">
                            <input type="hidden" id="site-parent-id">
                            <input type="hidden" id="site-type">
                            
                            <div class="form-group">
                                <label>사업장명</label>
                                <input type="text" id="site-name" required>
                            </div>
                            
                            <div class="form-group">
                                <label>담당자</label>
                                <input type="text" id="site-contact-person">
                            </div>
                            
                            <div class="form-group">
                                <label>연락처</label>
                                <input type="text" id="site-contact-phone">
                            </div>
                            
                            <div class="form-group">
                                <label>주소</label>
                                <textarea id="site-address" rows="3"></textarea>
                            </div>
                            
                            <div class="form-group">
                                <label>1인당 제공량 (g)</label>
                                <input type="number" id="site-portion-size" min="0">
                            </div>
                            
                            <div class="form-group">
                                <label>설명</label>
                                <textarea id="site-description" rows="3"></textarea>
                            </div>
                            
                            <div class="form-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="site-is-active" checked>
                                    활성 상태
                                </label>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn-secondary" onclick="closeSiteModal()">취소</button>
                        <button type="button" class="btn-primary" onclick="saveSite()">저장</button>
                    </div>
                </div>
            </div>


            <!-- 식자재/업체 관리 페이지 -->
            <div id="ingredients-page" class="page-content hidden">
                <div class="page-header">
                    <h2>식자재/업체 관리</h2>
                    <div class="header-actions">
                        <button class="btn btn-primary" onclick="showUploadSection()">
                            <span class="icon">📁</span>파일 업로드
                        </button>
                        <button class="btn btn-secondary" onclick="downloadTemplate()">
                            <span class="icon">📋</span>양식 다운로드
                        </button>
                    </div>
                </div>

                <!-- 업로드 주의사항 -->
                <div class="upload-notice">
                    <h3>📋 엑셀파일 수정 주의사항!</h3>
                    <div class="notice-content">
                        <p>식자재 등록을 위한 다운로드 양식 및 각 식자재 정보본판만 복사해서 붙여넣기만 합니다. 아래 주의사항 꼭 준수하세요.</p>
                        
                        <div class="warning-item">
                            <strong>1. 첫번째행 수정 금지</strong>
                            <p>컬럼명, 기본 식자재, 고유코드 등... 정성한 양식 기준정보를 수정하면 안됩니다.</p>
                        </div>
                        
                        <div class="warning-item">
                            <strong>2. 시트목적, 시트 추가 등.. 금지</strong>
                            <p>다른 목적의 엑셀과 합본 및 수정 안됩니다 양식을 위한 구조가 변경되면 안됩니다.</p>
                            <p>이 이상은 개발자에게 문의하여 일괄리합니다.</p>
                        </div>
                    </div>
                </div>

                <!-- 파일 업로드 섹션 -->
                <div id="upload-section" class="upload-section" style="display: none;">
                    <div class="upload-container">
                        <div class="upload-area" onclick="document.getElementById('file-input').click()">
                            <div class="upload-icon">📁</div>
                            <div class="upload-text">
                                <h4>파일을 선택하거나 여기로 드래그하세요</h4>
                                <p>지원 형식: .xlsx, .xls (최대 10MB)</p>
                            </div>
                        </div>
                        <input type="file" id="file-input" accept=".xlsx,.xls" multiple style="display: none;">
                        
                        <div class="upload-progress" id="upload-progress" style="display: none;">
                            <div class="progress-bar">
                                <div class="progress-fill" id="progress-fill"></div>
                            </div>
                            <div class="progress-text" id="progress-text">업로드 중...</div>
                        </div>
                    </div>
                    
                    <div class="upload-actions">
                        <button class="btn btn-primary" onclick="uploadFiles()" id="upload-btn" disabled>
                            업로드 시작
                        </button>
                        <button class="btn btn-secondary" onclick="clearFiles()">
                            파일 초기화
                        </button>
                    </div>
                </div>

                <!-- 업로드 결과 -->
                <div id="upload-results" class="upload-results" style="display: none;">
                    <h3>업로드 결과</h3>
                    <div class="result-summary">
                        <div class="result-item success">
                            <span class="result-label">성공:</span>
                            <span class="result-count" id="success-count">0</span>개 파일
                        </div>
                        <div class="result-item error">
                            <span class="result-label">실패:</span>
                            <span class="result-count" id="error-count">0</span>개 파일
                        </div>
                    </div>
                    
                    <div class="result-details" id="result-details">
                        <!-- 상세 결과가 여기에 표시됩니다 -->
                    </div>
                </div>

                <!-- 식자재 목록 -->
                <div class="ingredients-list">
                    <h3>등록된 식자재 목록</h3>
                    <div class="list-controls">
                        <input type="text" id="ingredient-search" placeholder="식자재명으로 검색..." class="search-input">
                        <select id="supplier-filter" class="filter-select">
                            <option value="">전체 업체</option>
                        </select>
                        <button class="btn btn-secondary" onclick="loadIngredientsList()">새로고침</button>
                    </div>
                    
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>식자재명</th>
                                    <th>업체</th>
                                    <th>단위</th>
                                    <th>단가</th>
                                    <th>최소주문량</th>
                                    <th>등록일</th>
                                    <th>관리</th>
                                </tr>
                            </thead>
                            <tbody id="ingredients-tbody">
                                <tr>
                                    <td colspan="7" style="text-align: center; color: #666;">
                                        식자재 목록을 불러오는 중...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 식수 등록 관리 페이지 -->
            <div id="meal-counts-page" class="page-content hidden">
                <div class="page-header">
                    <h2>식수 등록 관리</h2>
                    <div class="header-actions">
                        <div class="date-selector">
                            <label>기준일:</label>
                            <input type="date" id="meal-count-date" class="date-input">
                        </div>
                        <button class="btn btn-primary" onclick="showAddMealCountModal()">
                            <span class="icon">➕</span>식수 등록
                        </button>
                        <button class="btn btn-secondary" onclick="exportMealCounts()">
                            <span class="icon">📊</span>발주서 출력
                        </button>
                    </div>
                </div>

                <!-- 식수 관리 안내 -->
                <div class="meal-count-notice">
                    <h3>📋 식수 등록 관리 안내</h3>
                    <div class="notice-content">
                        <p><strong>발주를 위한 기초 데이터</strong>로 사용되는 식수 정보입니다. 소분지시서 기준으로 정확히 입력해주세요.</p>
                        
                        <div class="notice-rules">
                            <div class="rule-item">
                                <strong>⚠️ 월중 삭제 불가:</strong> 한 번 등록된 데이터는 삭제할 수 없으며, 수정만 가능합니다.
                            </div>
                            <div class="rule-item">
                                <strong>➕ 추가 등록 가능:</strong> 새로운 사업장이나 메뉴는 언제든 추가할 수 있습니다.
                            </div>
                            <div class="rule-item">
                                <strong>🏢 사업장명 기준:</strong> 소분지시서에 사용되는 정확한 사업장명을 입력하세요.
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 식수 현황 요약 -->
                <div class="meal-count-summary">
                    <div class="summary-cards">
                        <div class="summary-card">
                            <div class="card-header">총 식수</div>
                            <div class="card-value" id="total-meal-count">0명</div>
                        </div>
                        <div class="summary-card">
                            <div class="card-header">평균 재료비</div>
                            <div class="card-value" id="avg-material-cost">0원</div>
                        </div>
                        <div class="summary-card">
                            <div class="card-header">등록된 운반처</div>
                            <div class="card-value" id="delivery-sites-count">0개소</div>
                        </div>
                        <div class="summary-card">
                            <div class="card-header">예상 총 비용</div>
                            <div class="card-value" id="estimated-total-cost">0원</div>
                        </div>
                    </div>
                </div>

                <!-- 식수 데이터 테이블 -->
                <div class="meal-count-table-container">
                    <div class="table-controls">
                        <input type="text" id="meal-count-search" placeholder="운반처/사업장명으로 검색..." class="search-input">
                        <select id="meal-type-filter" class="filter-select">
                            <option value="">전체 식사</option>
                            <option value="조식">조식</option>
                            <option value="중식">중식</option>
                            <option value="석식">석식</option>
                        </select>
                        <button class="btn btn-secondary" onclick="refreshMealCounts()">새로고침</button>
                    </div>

                    <div class="table-container">
                        <table class="data-table meal-count-table">
                            <thead>
                                <tr>
                                    <th rowspan="2">운반처</th>
                                    <th rowspan="2">식사유형</th>
                                    <th rowspan="2">목표재료비</th>
                                    <th rowspan="2">총 식수</th>
                                    <th colspan="3">사업장별 식수</th>
                                    <th rowspan="2">관리</th>
                                </tr>
                                <tr>
                                    <th>사업장명</th>
                                    <th>식수</th>
                                    <th>비고</th>
                                </tr>
                            </thead>
                            <tbody id="meal-counts-tbody">
                                <tr>
                                    <td colspan="8" style="text-align: center; color: #666;">
                                        식수 데이터를 불러오는 중...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 식수 등록 모달 -->
            <div id="meal-count-modal" class="modal hidden">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 id="meal-count-modal-title">식수 등록</h3>
                        <button class="modal-close" onclick="closeMealCountModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <form id="meal-count-form">
                            <input type="hidden" id="meal-count-id">
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label>기준일</label>
                                    <input type="date" id="form-meal-date" required>
                                </div>
                                <div class="form-group">
                                    <label>운반처</label>
                                    <input type="text" id="form-delivery-site" placeholder="예: 다함-운반" required>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label>식사유형</label>
                                    <select id="form-meal-type" required>
                                        <option value="">선택하세요</option>
                                        <option value="조식">조식</option>
                                        <option value="중식">중식</option>
                                        <option value="석식">석식</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>목표재료비 (원)</label>
                                    <input type="number" id="form-target-cost" placeholder="2000" required>
                                </div>
                            </div>

                            <div class="form-group">
                                <label>메뉴 정보</label>
                                <input type="text" id="form-menu-info" placeholder="예: 4찬저 4,500원">
                            </div>

                            <div class="form-group">
                                <label>사업장별 식수 (콤마로 구분)</label>
                                <textarea id="form-site-counts" placeholder="해오름:40,원앤원:10" rows="3"></textarea>
                                <small>예시: 해오름:40,원앤원:10 또는 창녕화성:100,화성에이엔티:50</small>
                            </div>

                            <div class="form-group">
                                <label>비고</label>
                                <textarea id="form-notes" placeholder="특이사항을 입력하세요" rows="2"></textarea>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn-secondary" onclick="closeMealCountModal()">취소</button>
                        <button type="button" class="btn-primary" onclick="saveMealCount()">저장</button>
                    </div>
                </div>
            </div>

            <div id="pricing-page" class="page-content hidden">
                <h2>단가 관리 페이지</h2>
                <p>단가 관리 기능이 여기에 구현될 예정입니다.</p>
            </div>

            <div id="settings-page" class="page-content hidden">
                <h2>시스템 설정 페이지</h2>
                <p>시스템 설정 기능이 여기에 구현될 예정입니다.</p>
            </div>

            <div id="logs-page" class="page-content hidden">
                <h2>로그 관리 페이지</h2>
                <p>로그 관리 기능이 여기에 구현될 예정입니다.</p>
            </div>
        </main>
    </div>

    <script>
        // 페이지 네비게이션 관리
        function showPage(pageName) {
            // 모든 페이지 숨기기
            document.querySelectorAll('.page-content').forEach(page => {
                page.classList.add('hidden');
            });
            
            // 선택된 페이지 보이기
            const targetPage = document.getElementById(`${pageName}-page`);
            if (targetPage) {
                targetPage.classList.remove('hidden');
            }
            
            // 네비게이션 활성 상태 변경
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            const activeItem = document.querySelector(`[data-page="${pageName}"]`);
            if (activeItem) {
                activeItem.classList.add('active');
            }
            
            // 페이지 제목 변경
            const titles = {
                'dashboard': '관리자 대시보드',
                'users': '사용자 관리',
                'sites': '사업장 관리', 
                'ingredients': '식자재/업체 관리',
                'pricing': '단가 관리',
                'settings': '시스템 설정',
                'logs': '로그 관리'
            };
            
            document.getElementById('page-title').textContent = titles[pageName] || '관리자 시스템';
        }


        // 네비게이션 클릭 이벤트
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', (e) => {
                e.preventDefault();
                const pageName = e.currentTarget.getAttribute('data-page');
                showPage(pageName);
                
                // 페이지별 초기화
                if (pageName === 'users') {
                    loadUsers();
                    loadManagedSites();
                } else if (pageName === 'sites') {
                    loadSitesTree();
                } else if (pageName === 'ingredients') {
                    loadIngredientsList();
                    loadSupplierFilter();
                } else if (pageName === 'meal-counts') {
                    initMealCountsPage();
                    loadMealCounts();
                }
            });
        });

        // 로그아웃 함수
        async function logout() {
            if (confirm('로그아웃 하시겠습니까?')) {
                try {
                    const response = await fetch('/api/auth/logout', {
                        method: 'POST',
                        credentials: 'include'  // 쿠키 포함
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        window.location.href = result.redirect || '/login';
                    } else {
                        console.error('로그아웃 실패:', result.message);
                        window.location.href = '/login';  // 실패해도 로그인 페이지로 이동
                    }
                } catch (error) {
                    console.error('로그아웃 중 오류:', error);
                    window.location.href = '/login';  // 오류 시에도 로그인 페이지로 이동
                }
            }
        }

        // 대시보드 데이터 로드
        async function loadDashboardData() {
            try {
                // 통계 데이터 가져오기
                const response = await fetch('/api/admin/dashboard-stats');
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('total-users').textContent = data.totalUsers || 0;
                    document.getElementById('total-sites').textContent = data.totalSites || 0;
                    document.getElementById('today-menus').textContent = data.todayMenus || 0;
                    document.getElementById('price-updates').textContent = data.priceUpdates || 0;
                }
            } catch (error) {
                console.error('대시보드 데이터 로드 실패:', error);
            }
        }

        // 최근 활동 로그 로드
        async function loadRecentActivity() {
            try {
                const response = await fetch('/api/admin/recent-activity');
                const activities = await response.json();
                
                const activityList = document.getElementById('activity-list');
                if (activities.length === 0) {
                    activityList.innerHTML = '<div class="log-item">최근 활동이 없습니다.</div>';
                    return;
                }
                
                activityList.innerHTML = activities.map(activity => `
                    <div class="log-item">
                        <div class="log-time">${activity.time}</div>
                        <div class="log-message">${activity.message}</div>
                        <div class="log-user">${activity.user}</div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('활동 로그 로드 실패:', error);
                document.getElementById('activity-list').innerHTML = 
                    '<div class="log-item">활동 로그를 불러올 수 없습니다.</div>';
            }
        }

        // 전역 변수들
        let pageInitialized = false;
        let allowModalDisplay = false;

        // 페이지 로드시 초기화
        document.addEventListener('DOMContentLoaded', () => {
            console.log('페이지 초기화 시작');
            
            // 강제로 모든 모달 숨김 처리
            setTimeout(() => {
                const userModal = document.getElementById('user-modal');
                const siteModal = document.getElementById('site-modal');
                
                if (userModal) {
                    userModal.style.display = 'none';
                    userModal.classList.add('hidden');
                    console.log('사용자 모달 강제 숨김');
                }
                if (siteModal) {
                    siteModal.style.display = 'none';
                    siteModal.classList.add('hidden');
                    console.log('사업장 모달 강제 숨김');
                }
                
                // 변수 초기화
                if (typeof currentEditUserId !== 'undefined') {
                    currentEditUserId = null;
                }
                if (typeof currentEditSiteId !== 'undefined') {
                    currentEditSiteId = null;
                }
                
                console.log('모든 모달 숨김 처리 완료');
                
                // 초기화 완료 후 1초 뒤에 모달 표시 허용
                setTimeout(() => {
                    pageInitialized = true;
                    allowModalDisplay = true;
                    console.log('모달 표시 허용됨');
                }, 1000);
            }, 100);
            
            // 기본으로 대시보드 페이지 표시
            console.log('대시보드 페이지 표시');
            showPage('dashboard');
            loadDashboardData();
            loadRecentActivity();
        });

        // 사용자 관리 관련 변수
        let currentPage = 1;
        let totalPages = 1;
        let currentEditUserId = null;

        // 사용자 관리 함수들

        // 사용자 목록 로드
        async function loadUsers() {
            try {
                const response = await fetch('/api/admin/users');
                const data = await response.json();
                
                if (data.success) {
                    displayUsers(data.users);
                    updatePagination(data.currentPage, data.totalPages);
                }
            } catch (error) {
                console.error('사용자 목록 로드 실패:', error);
                document.getElementById('users-table-body').innerHTML = 
                    '<tr><td colspan="8">사용자 목록을 불러올 수 없습니다.</td></tr>';
            }
        }

        // 사용자 목록 표시
        function displayUsers(users) {
            const tbody = document.getElementById('users-table-body');
            
            if (!users || users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8">등록된 사용자가 없습니다.</td></tr>';
                return;
            }
            
            tbody.innerHTML = users.map(user => `
                <tr>
                    <td>${user.id}</td>
                    <td>${user.username}</td>
                    <td>${getRoleDisplay(user.role)}</td>
                    <td>${user.department || '-'}</td>
                    <td>${user.managed_site || '-'}</td>
                    <td><span class="${user.is_active ? 'status-active' : 'status-inactive'}">
                        ${user.is_active ? '활성' : '비활성'}
                    </span></td>
                    <td>${user.last_login || '접속 기록 없음'}</td>
                    <td>
                        <button class="btn-small btn-edit" onclick="editUser(${user.id})">수정</button>
                        <button class="btn-small btn-reset" onclick="resetPassword(${user.id})">초기화</button>
                        <button class="btn-small btn-delete" onclick="deleteUser(${user.id})">삭제</button>
                    </td>
                </tr>
            `).join('');
        }

        // 역할 표시명 변환
        function getRoleDisplay(role) {
            const roleMap = {
                'nutritionist': '영양사',
                'admin': '관리자', 
                'super_admin': '최고관리자'
            };
            return roleMap[role] || role;
        }

        // 페이지네이션 업데이트
        function updatePagination(current, total) {
            currentPage = current;
            totalPages = total;
            document.getElementById('page-info').textContent = `${current} / ${total}`;
        }

        // 페이지 변경
        function changePage(direction) {
            const newPage = currentPage + direction;
            if (newPage >= 1 && newPage <= totalPages) {
                currentPage = newPage;
                loadUsers();
            }
        }

        // 사용자 검색
        function searchUsers() {
            const keyword = document.getElementById('user-search').value;
            // 실제 구현에서는 검색 API 호출
            console.log('검색 키워드:', keyword);
            loadUsers(); // 임시로 전체 목록 다시 로드
        }

        // 담당 사업장 목록 로드
        async function loadManagedSites() {
            try {
                const response = await fetch('/api/admin/sites');
                const sites = await response.json();
                
                const select = document.getElementById('user-managed-site');
                select.innerHTML = '<option value="">선택하세요</option>';
                
                sites.forEach(site => {
                    select.innerHTML += `<option value="${site.name}">${site.name}</option>`;
                });
            } catch (error) {
                console.error('사업장 목록 로드 실패:', error);
            }
        }

        // 새 사용자 추가 모달 표시
        function showAddUserModal() {
            currentEditUserId = null;
            document.getElementById('modal-title').textContent = '새 사용자 추가';
            document.getElementById('user-form').reset();
            document.getElementById('user-modal').classList.remove('hidden');
        }

        // 사용자 수정 모달 표시
        async function editUser(userId) {
            try {
                const response = await fetch(`/api/admin/users/${userId}`);
                const user = await response.json();
                
                if (user) {
                    currentEditUserId = userId;
                    document.getElementById('modal-title').textContent = '사용자 정보 수정';
                    
                    // 폼에 기존 데이터 채우기
                    document.getElementById('user-username').value = user.username;
                    document.getElementById('user-password').value = ''; // 비밀번호는 비움
                    document.getElementById('user-role').value = user.role;
                    document.getElementById('user-contact').value = user.contact_info || '';
                    document.getElementById('user-department').value = user.department || '';
                    document.getElementById('user-position').value = user.position || '';
                    document.getElementById('user-managed-site').value = user.managed_site || '';
                    document.getElementById('user-operator').checked = user.operator || false;
                    document.getElementById('user-semi-operator').checked = user.semi_operator || false;
                    
                    document.getElementById('user-modal').classList.remove('hidden');
                }
            } catch (error) {
                console.error('사용자 정보 로드 실패:', error);
                alert('사용자 정보를 불러올 수 없습니다.');
            }
        }

        // 사용자 모달 닫기
        function closeUserModal() {
            document.getElementById('user-modal').classList.add('hidden');
            currentEditUserId = null;
        }

        // 사용자 저장
        async function saveUser() {
            const userData = {
                username: document.getElementById('user-username').value,
                password: document.getElementById('user-password').value,
                role: document.getElementById('user-role').value,
                contact_info: document.getElementById('user-contact').value,
                department: document.getElementById('user-department').value,
                position: document.getElementById('user-position').value,
                managed_site: document.getElementById('user-managed-site').value,
                operator: document.getElementById('user-operator').checked,
                semi_operator: document.getElementById('user-semi-operator').checked
            };

            try {
                const url = currentEditUserId ? 
                    `/api/admin/users/${currentEditUserId}` : 
                    '/api/admin/users';
                
                const method = currentEditUserId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(userData)
                });

                const result = await response.json();
                
                if (result.success) {
                    alert(currentEditUserId ? '사용자가 수정되었습니다.' : '새 사용자가 추가되었습니다.');
                    closeUserModal();
                    loadUsers();
                } else {
                    alert(result.message || '저장 중 오류가 발생했습니다.');
                }
            } catch (error) {
                console.error('사용자 저장 실패:', error);
                alert('저장 중 오류가 발생했습니다.');
            }
        }

        // 비밀번호 초기화
        async function resetPassword(userId) {
            if (!confirm('이 사용자의 비밀번호를 초기화하시겠습니까?')) {
                return;
            }

            try {
                const response = await fetch(`/api/admin/users/${userId}/reset-password`, {
                    method: 'POST'
                });

                const result = await response.json();
                
                if (result.success) {
                    alert(`비밀번호가 초기화되었습니다. 새 비밀번호: ${result.newPassword}`);
                } else {
                    alert('비밀번호 초기화에 실패했습니다.');
                }
            } catch (error) {
                console.error('비밀번호 초기화 실패:', error);
                alert('비밀번호 초기화 중 오류가 발생했습니다.');
            }
        }

        // 사용자 삭제
        async function deleteUser(userId) {
            if (!confirm('이 사용자를 삭제하시겠습니까? 이 작업은 취소할 수 없습니다.')) {
                return;
            }

            try {
                const response = await fetch(`/api/admin/users/${userId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();
                
                if (result.success) {
                    alert('사용자가 삭제되었습니다.');
                    loadUsers();
                } else {
                    alert('사용자 삭제에 실패했습니다.');
                }
            } catch (error) {
                console.error('사용자 삭제 실패:', error);
                alert('사용자 삭제 중 오류가 발생했습니다.');
            }
        }

        // 사업장 관리 관련 변수
        let sitesData = [];
        let selectedSiteId = null;
        let currentEditSiteId = null;

        // 사업장 트리 로드
        async function loadSitesTree() {
            try {
                const response = await fetch('/api/admin/sites/tree');
                const data = await response.json();
                
                if (data.success) {
                    sitesData = data.sites;
                    renderSitesTree();
                }
            } catch (error) {
                console.error('사업장 트리 로드 실패:', error);
                document.getElementById('sites-tree').innerHTML = 
                    '<div class="text-center">사업장 정보를 불러올 수 없습니다.</div>';
            }
        }

        // 사업장 트리 렌더링
        function renderSitesTree() {
            const container = document.getElementById('sites-tree');
            container.innerHTML = '';
            
            if (sitesData.length === 0) {
                container.innerHTML = '<div class="text-center">등록된 사업장이 없습니다.</div>';
                return;
            }
            
            // 헤드 사업장들 렌더링
            const headSites = sitesData.filter(site => site.site_type === 'head');
            headSites.forEach(site => {
                container.appendChild(createTreeNode(site));
            });
        }

        // 트리 노드 생성
        function createTreeNode(site) {
            const nodeDiv = document.createElement('div');
            nodeDiv.className = 'tree-node';
            nodeDiv.dataset.siteId = site.id;
            
            const contentDiv = document.createElement('div');
            contentDiv.className = `tree-node-content ${site.site_type}-site`;
            contentDiv.onclick = () => selectSite(site.id);
            
            // 드래그 앤 드롭 이벤트 추가
            setupDragAndDrop(contentDiv, site);
            
            // 확장/축소 버튼
            const expandBtn = document.createElement('button');
            expandBtn.className = 'tree-expand-btn';
            const hasChildren = site.children && site.children.length > 0;
            
            if (hasChildren) {
                expandBtn.className += ' expanded';
                expandBtn.onclick = (e) => {
                    e.stopPropagation();
                    toggleNode(site.id);
                };
            } else {
                expandBtn.className += ' no-children';
            }
            
            // 아이콘
            const iconSpan = document.createElement('span');
            iconSpan.className = 'tree-node-icon';
            iconSpan.textContent = getSiteIcon(site.site_type);
            
            // 라벨
            const labelSpan = document.createElement('span');
            labelSpan.className = 'tree-node-label';
            labelSpan.textContent = site.name;
            
            // 상태
            const statusSpan = document.createElement('span');
            statusSpan.className = `tree-node-status ${site.is_active ? 'active' : 'inactive'}`;
            statusSpan.textContent = site.is_active ? '활성' : '비활성';
            
            // 액션 버튼들
            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'tree-node-actions';
            
            if (site.site_type === 'head') {
                const addDetailBtn = document.createElement('button');
                addDetailBtn.className = 'tree-action-btn add';
                addDetailBtn.textContent = '+ 세부';
                addDetailBtn.onclick = (e) => {
                    e.stopPropagation();
                    showAddSiteModal('detail', site.id);
                };
                actionsDiv.appendChild(addDetailBtn);
            } else if (site.site_type === 'detail') {
                const addPeriodBtn = document.createElement('button');
                addPeriodBtn.className = 'tree-action-btn add';
                addPeriodBtn.textContent = '+ 기간';
                addPeriodBtn.onclick = (e) => {
                    e.stopPropagation();
                    showAddSiteModal('period', site.id);
                };
                actionsDiv.appendChild(addPeriodBtn);
            }
            
            const editBtn = document.createElement('button');
            editBtn.className = 'tree-action-btn edit';
            editBtn.textContent = '수정';
            editBtn.onclick = (e) => {
                e.stopPropagation();
                editSite(site.id);
            };
            
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'tree-action-btn delete';
            deleteBtn.textContent = '삭제';
            deleteBtn.onclick = (e) => {
                e.stopPropagation();
                deleteSite(site.id);
            };
            
            actionsDiv.appendChild(editBtn);
            actionsDiv.appendChild(deleteBtn);
            
            // 컨텐츠 조립
            contentDiv.appendChild(expandBtn);
            contentDiv.appendChild(iconSpan);
            contentDiv.appendChild(labelSpan);
            contentDiv.appendChild(statusSpan);
            contentDiv.appendChild(actionsDiv);
            
            nodeDiv.appendChild(contentDiv);
            
            // 자식 노드들
            if (hasChildren) {
                const childrenDiv = document.createElement('div');
                childrenDiv.className = 'tree-children';
                site.children.forEach(child => {
                    childrenDiv.appendChild(createTreeNode(child));
                });
                nodeDiv.appendChild(childrenDiv);
            }
            
            return nodeDiv;
        }

        // 사업장 아이콘 가져오기
        function getSiteIcon(siteType) {
            switch (siteType) {
                case 'head': return '🏢';
                case 'detail': return '🏫';
                case 'period': return '📅';
                default: return '📍';
            }
        }

        // 노드 확장/축소
        function toggleNode(siteId) {
            const node = document.querySelector(`[data-site-id="${siteId}"]`);
            if (!node) return;
            
            const expandBtn = node.querySelector('.tree-expand-btn');
            const childrenDiv = node.querySelector('.tree-children');
            
            if (!childrenDiv) return;
            
            if (expandBtn.classList.contains('expanded')) {
                expandBtn.className = expandBtn.className.replace('expanded', 'collapsed');
                childrenDiv.classList.add('hidden');
            } else {
                expandBtn.className = expandBtn.className.replace('collapsed', 'expanded');
                childrenDiv.classList.remove('hidden');
            }
        }

        // 모든 노드 확장
        function expandAllSites() {
            document.querySelectorAll('.tree-expand-btn.collapsed').forEach(btn => {
                btn.className = btn.className.replace('collapsed', 'expanded');
            });
            document.querySelectorAll('.tree-children.hidden').forEach(children => {
                children.classList.remove('hidden');
            });
        }

        // 모든 노드 축소
        function collapseAllSites() {
            document.querySelectorAll('.tree-expand-btn.expanded').forEach(btn => {
                btn.className = btn.className.replace('expanded', 'collapsed');
            });
            document.querySelectorAll('.tree-children').forEach(children => {
                children.classList.add('hidden');
            });
        }

        // 사업장 선택
        function selectSite(siteId) {
            // 이전 선택 해제
            document.querySelectorAll('.tree-node-content.selected').forEach(node => {
                node.classList.remove('selected');
            });
            
            // 새 선택
            const node = document.querySelector(`[data-site-id="${siteId}"] .tree-node-content`);
            if (node) {
                node.classList.add('selected');
                selectedSiteId = siteId;
                showSiteDetails(siteId);
            }
        }

        // 사업장 상세정보 표시
        async function showSiteDetails(siteId) {
            try {
                const response = await fetch(`/api/admin/sites/${siteId}`);
                const site = await response.json();
                
                const panel = document.getElementById('site-details-panel');
                const content = document.getElementById('site-details-content');
                
                content.innerHTML = `
                    <div class="site-info-group">
                        <div class="site-info-label">사업장명</div>
                        <div class="site-info-value">${site.name}</div>
                    </div>
                    <div class="site-info-group">
                        <div class="site-info-label">유형</div>
                        <div class="site-info-value">${getSiteTypeDisplay(site.site_type)}</div>
                    </div>
                    <div class="site-info-group">
                        <div class="site-info-label">담당자</div>
                        <div class="site-info-value">${site.contact_person || '-'}</div>
                    </div>
                    <div class="site-info-group">
                        <div class="site-info-label">연락처</div>
                        <div class="site-info-value">${site.contact_phone || '-'}</div>
                    </div>
                    <div class="site-info-group">
                        <div class="site-info-label">주소</div>
                        <div class="site-info-value">${site.address || '-'}</div>
                    </div>
                    <div class="site-info-group">
                        <div class="site-info-label">1인당 제공량</div>
                        <div class="site-info-value">${site.portion_size || 0}g</div>
                    </div>
                    <div class="site-stats">
                        <div class="stat-box">
                            <div class="stat-number">${site.menu_count || 0}</div>
                            <div class="stat-label">등록된 식단</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-number">${site.children_count || 0}</div>
                            <div class="stat-label">하위 사업장</div>
                        </div>
                    </div>
                `;
                
                panel.classList.remove('hidden');
            } catch (error) {
                console.error('사업장 상세정보 로드 실패:', error);
            }
        }

        // 사업장 유형 표시명
        function getSiteTypeDisplay(siteType) {
            switch (siteType) {
                case 'head': return '헤드 사업장';
                case 'detail': return '세부 사업장';
                case 'period': return '기간별 사업장';
                default: return siteType;
            }
        }

        // ==============================================================================
        // 드래그 앤 드롭 기능
        // ==============================================================================
        
        let draggedElement = null;
        let draggedSite = null;

        // 드래그 앤 드롭 이벤트 설정
        function setupDragAndDrop(element, site) {
            element.draggable = true;
            
            element.addEventListener('dragstart', (e) => {
                draggedElement = element;
                draggedSite = site;
                element.classList.add('dragging');
                
                // 드래그 데이터 설정
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/plain', site.id);
                
                console.log('드래그 시작:', site.name);
            });
            
            element.addEventListener('dragend', (e) => {
                element.classList.remove('dragging');
                // 모든 드롭 인디케이터 제거
                clearDropIndicators();
                draggedElement = null;
                draggedSite = null;
                
                console.log('드래그 종료');
            });
            
            element.addEventListener('dragover', (e) => {
                if (!draggedSite || draggedSite.id === site.id) return;
                
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                
                // 유효한 드롭 대상인지 확인
                if (canDropOn(draggedSite, site)) {
                    element.classList.add('drag-over');
                } else {
                    element.classList.add('drop-invalid');
                }
            });
            
            element.addEventListener('dragleave', (e) => {
                element.classList.remove('drag-over', 'drop-invalid');
            });
            
            element.addEventListener('drop', (e) => {
                e.preventDefault();
                element.classList.remove('drag-over', 'drop-invalid');
                
                if (!draggedSite || draggedSite.id === site.id) return;
                
                // 유효한 드롭인지 확인
                if (canDropOn(draggedSite, site)) {
                    handleDrop(draggedSite, site);
                } else {
                    console.log('유효하지 않은 드롭:', draggedSite.name, '->', site.name);
                }
            });
        }

        // 드롭 가능 여부 확인
        function canDropOn(draggedSite, targetSite) {
            // 자기 자신에게는 드롭 불가
            if (draggedSite.id === targetSite.id) return false;
            
            // 계층 구조 규칙 확인
            // head -> detail 또는 detail -> period만 가능
            if (draggedSite.site_type === 'head') {
                // head는 이동 불가
                return false;
            } else if (draggedSite.site_type === 'detail') {
                // detail은 head에만 드롭 가능
                return targetSite.site_type === 'head';
            } else if (draggedSite.site_type === 'period') {
                // period는 detail에만 드롭 가능
                return targetSite.site_type === 'detail';
            }
            
            return false;
        }

        // 드롭 처리
        async function handleDrop(draggedSite, targetSite) {
            console.log(`드롭 처리: ${draggedSite.name} -> ${targetSite.name}`);
            
            // 확인 대화상자
            const message = `"${draggedSite.name}"을(를) "${targetSite.name}" 하위로 이동하시겠습니까?`;
            if (!confirm(message)) {
                return;
            }
            
            try {
                // 서버에 이동 요청
                const response = await fetch(`/api/admin/sites/${draggedSite.id}/move`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        new_parent_id: targetSite.id
                    }),
                });
                
                const result = await response.json();
                
                if (result.success) {
                    console.log('이동 성공:', result.message);
                    // 트리 새로고침
                    loadSitesTree();
                } else {
                    console.error('이동 실패:', result.message);
                    alert(`이동 실패: ${result.message}`);
                }
            } catch (error) {
                console.error('이동 요청 오류:', error);
                alert('이동 중 오류가 발생했습니다.');
            }
        }

        // 드롭 인디케이터 정리
        function clearDropIndicators() {
            document.querySelectorAll('.tree-node-content').forEach(el => {
                el.classList.remove('drag-over', 'drop-invalid');
            });
        }

        // 상세정보 패널 닫기
        function closeSiteDetails() {
            document.getElementById('site-details-panel').classList.add('hidden');
            selectedSiteId = null;
            
            // 선택 해제
            document.querySelectorAll('.tree-node-content.selected').forEach(node => {
                node.classList.remove('selected');
            });
        }

        // 사업장 추가 모달 표시
        function showAddSiteModal(siteType, parentId = null) {
            console.log('showAddSiteModal 호출됨:', siteType, parentId, 'allowModalDisplay:', allowModalDisplay);
            
            // 페이지 초기화가 완료되지 않았으면 실행하지 않음
            if (!allowModalDisplay) {
                console.log('페이지 초기화 중이므로 모달 표시 취소');
                return;
            }
            
            currentEditSiteId = null;
            
            const modal = document.getElementById('site-modal');
            if (!modal) {
                console.error('사업장 모달을 찾을 수 없음');
                return;
            }
            
            document.getElementById('site-modal-title').textContent = `새 ${getSiteTypeDisplay(siteType)} 추가`;
            document.getElementById('site-form').reset();
            document.getElementById('site-parent-id').value = parentId || '';
            document.getElementById('site-type').value = siteType;
            document.getElementById('site-is-active').checked = true;
            
            modal.style.display = 'flex';
            modal.classList.remove('hidden');
            console.log('사업장 모달 표시됨');
        }

        // 사업장 수정
        async function editSite(siteId) {
            try {
                const response = await fetch(`/api/admin/sites/${siteId}`);
                const site = await response.json();
                
                currentEditSiteId = siteId;
                document.getElementById('site-modal-title').textContent = '사업장 정보 수정';
                
                // 폼에 기존 데이터 채우기
                document.getElementById('site-name').value = site.name;
                document.getElementById('site-contact-person').value = site.contact_person || '';
                document.getElementById('site-contact-phone').value = site.contact_phone || '';
                document.getElementById('site-address').value = site.address || '';
                document.getElementById('site-portion-size').value = site.portion_size || '';
                document.getElementById('site-description').value = site.description || '';
                document.getElementById('site-is-active').checked = site.is_active;
                
                document.getElementById('site-modal').classList.remove('hidden');
            } catch (error) {
                console.error('사업장 정보 로드 실패:', error);
                alert('사업장 정보를 불러올 수 없습니다.');
            }
        }

        // 사업장 삭제
        async function deleteSite(siteId) {
            if (!confirm('이 사업장을 삭제하시겠습니까? 하위 사업장도 함께 삭제됩니다.')) {
                return;
            }

            try {
                const response = await fetch(`/api/admin/sites/${siteId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();
                
                if (result.success) {
                    alert('사업장이 삭제되었습니다.');
                    loadSitesTree();
                    closeSiteDetails();
                } else {
                    alert('사업장 삭제에 실패했습니다.');
                }
            } catch (error) {
                console.error('사업장 삭제 실패:', error);
                alert('사업장 삭제 중 오류가 발생했습니다.');
            }
        }

        // 사업장 모달 닫기
        function closeSiteModal() {
            console.log('closeSiteModal 호출됨');
            const modal = document.getElementById('site-modal');
            if (modal) {
                modal.style.display = 'none';
                modal.classList.add('hidden');
                console.log('사업장 모달 완전히 숨김');
            }
            currentEditSiteId = null;
        }

        // 사업장 저장
        async function saveSite() {
            const siteData = {
                name: document.getElementById('site-name').value,
                contact_person: document.getElementById('site-contact-person').value,
                contact_phone: document.getElementById('site-contact-phone').value,
                address: document.getElementById('site-address').value,
                portion_size: parseInt(document.getElementById('site-portion-size').value) || null,
                description: document.getElementById('site-description').value,
                is_active: document.getElementById('site-is-active').checked
            };

            if (!currentEditSiteId) {
                // 새 사업장 추가
                siteData.site_type = document.getElementById('site-type').value;
                siteData.parent_id = document.getElementById('site-parent-id').value || null;
            }

            try {
                const url = currentEditSiteId ? 
                    `/api/admin/sites/${currentEditSiteId}` : 
                    '/api/admin/sites';
                
                const method = currentEditSiteId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(siteData)
                });

                const result = await response.json();
                
                if (result.success) {
                    alert(currentEditSiteId ? '사업장이 수정되었습니다.' : '새 사업장이 추가되었습니다.');
                    closeSiteModal();
                    loadSitesTree();
                } else {
                    alert(result.message || '저장 중 오류가 발생했습니다.');
                }
            } catch (error) {
                console.error('사업장 저장 실패:', error);
                alert('저장 중 오류가 발생했습니다.');
            }
        }

        // ===== 식자재 업로드 관련 함수들 =====
        
        let selectedFiles = [];
        
        // 업로드 섹션 표시/숨기기
        function showUploadSection() {
            const uploadSection = document.getElementById('upload-section');
            const isVisible = uploadSection.style.display !== 'none';
            uploadSection.style.display = isVisible ? 'none' : 'block';
        }

        // 양식 다운로드
        function downloadTemplate() {
            // 템플릿 파일 다운로드 로직
            const link = document.createElement('a');
            link.href = '/templates/ingredient_template.xlsx';
            link.download = '식자재_업로드_양식.xlsx';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // 파일 선택 이벤트 처리
        document.addEventListener('DOMContentLoaded', function() {
            const fileInput = document.getElementById('file-input');
            const uploadArea = document.querySelector('.upload-area');
            
            if (fileInput && uploadArea) {
                // 파일 선택 이벤트
                fileInput.addEventListener('change', handleFileSelect);
                
                // 드래그 앤 드롭 이벤트
                uploadArea.addEventListener('dragover', handleDragOver);
                uploadArea.addEventListener('drop', handleDrop);
                uploadArea.addEventListener('dragleave', handleDragLeave);
            }
        });

        function handleFileSelect(event) {
            const files = Array.from(event.target.files);
            addFiles(files);
        }

        function handleDragOver(event) {
            event.preventDefault();
            event.currentTarget.classList.add('dragover');
        }

        function handleDrop(event) {
            event.preventDefault();
            event.currentTarget.classList.remove('dragover');
            const files = Array.from(event.dataTransfer.files);
            addFiles(files);
        }

        function handleDragLeave(event) {
            event.currentTarget.classList.remove('dragover');
        }

        function addFiles(files) {
            // 파일 형식 검증
            const validFiles = files.filter(file => {
                const isValidType = file.type.includes('sheet') || file.name.endsWith('.xlsx') || file.name.endsWith('.xls');
                const isValidSize = file.size <= 10 * 1024 * 1024; // 10MB
                
                if (!isValidType) {
                    alert(`${file.name}은(는) 지원하지 않는 파일 형식입니다.`);
                    return false;
                }
                
                if (!isValidSize) {
                    alert(`${file.name}은(는) 파일 크기가 10MB를 초과합니다.`);
                    return false;
                }
                
                return true;
            });

            // 중복 파일 체크
            validFiles.forEach(file => {
                const isDuplicate = selectedFiles.some(selectedFile => 
                    selectedFile.name === file.name && selectedFile.size === file.size
                );
                
                if (!isDuplicate) {
                    selectedFiles.push(file);
                }
            });

            updateFileList();
            updateUploadButton();
        }

        function updateFileList() {
            const uploadText = document.querySelector('.upload-text h4');
            const uploadBtn = document.getElementById('upload-btn');
            
            if (selectedFiles.length > 0) {
                uploadText.textContent = `${selectedFiles.length}개 파일이 선택되었습니다`;
                uploadBtn.disabled = false;
            } else {
                uploadText.textContent = '파일을 선택하거나 여기로 드래그하세요';
                uploadBtn.disabled = true;
            }
        }

        function updateUploadButton() {
            const uploadBtn = document.getElementById('upload-btn');
            uploadBtn.disabled = selectedFiles.length === 0;
        }

        function clearFiles() {
            selectedFiles = [];
            document.getElementById('file-input').value = '';
            updateFileList();
            updateUploadButton();
            hideResults();
        }

        function hideResults() {
            document.getElementById('upload-results').style.display = 'none';
        }

        // 파일 업로드 실행
        async function uploadFiles() {
            if (selectedFiles.length === 0) {
                alert('업로드할 파일을 선택해주세요.');
                return;
            }

            const uploadProgress = document.getElementById('upload-progress');
            const progressFill = document.getElementById('progress-fill');
            const progressText = document.getElementById('progress-text');
            const uploadBtn = document.getElementById('upload-btn');

            // 업로드 시작
            uploadProgress.style.display = 'block';
            uploadBtn.disabled = true;
            
            let successCount = 0;
            let errorCount = 0;
            const results = [];

            for (let i = 0; i < selectedFiles.length; i++) {
                const file = selectedFiles[i];
                const formData = new FormData();
                formData.append('file', file);

                try {
                    // 진행률 업데이트
                    const progress = ((i + 1) / selectedFiles.length) * 100;
                    progressFill.style.width = `${progress}%`;
                    progressText.textContent = `업로드 중... ${i + 1}/${selectedFiles.length} (${Math.round(progress)}%)`;

                    const response = await fetch('/api/admin/upload-ingredients', {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();

                    if (result.success) {
                        successCount++;
                        results.push({
                            fileName: file.name,
                            status: 'success',
                            message: `${result.processed_count}개 식자재 처리 완료`,
                            details: result.details || {}
                        });
                    } else {
                        errorCount++;
                        results.push({
                            fileName: file.name,
                            status: 'error',
                            message: result.message || '업로드 실패',
                            details: result.details || {}
                        });
                    }
                } catch (error) {
                    console.error('파일 업로드 오류:', error);
                    errorCount++;
                    results.push({
                        fileName: file.name,
                        status: 'error',
                        message: '서버 연결 오류',
                        details: {}
                    });
                }
            }

            // 업로드 완료
            uploadProgress.style.display = 'none';
            uploadBtn.disabled = false;
            
            // 결과 표시
            showUploadResults(successCount, errorCount, results);
            
            // 성공한 경우 식자재 목록 새로고침
            if (successCount > 0) {
                loadIngredientsList();
            }
        }

        function showUploadResults(successCount, errorCount, results) {
            document.getElementById('success-count').textContent = successCount;
            document.getElementById('error-count').textContent = errorCount;
            
            const resultDetails = document.getElementById('result-details');
            resultDetails.innerHTML = '';
            
            results.forEach(result => {
                const resultDiv = document.createElement('div');
                resultDiv.className = `result-file ${result.status}`;
                
                resultDiv.innerHTML = `
                    <div class="file-name">${result.fileName}</div>
                    <div class="file-status ${result.status}">
                        <span>${result.status === 'success' ? '✓' : '✗'}</span>
                        <span>${result.message}</span>
                    </div>
                `;
                
                resultDetails.appendChild(resultDiv);
            });
            
            document.getElementById('upload-results').style.display = 'block';
        }

        // 식자재 목록 로드
        async function loadIngredientsList() {
            try {
                const response = await fetch('/api/admin/ingredients');
                const ingredients = await response.json();
                
                const tbody = document.getElementById('ingredients-tbody');
                tbody.innerHTML = '';
                
                if (ingredients.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #666;">등록된 식자재가 없습니다.</td></tr>';
                    return;
                }
                
                ingredients.forEach(ingredient => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${ingredient.name}</td>
                        <td>${ingredient.supplier_name || '-'}</td>
                        <td>${ingredient.base_unit}</td>
                        <td>${ingredient.price ? ingredient.price.toLocaleString() + '원' : '-'}</td>
                        <td>${ingredient.moq || '1'}</td>
                        <td>${new Date(ingredient.created_at).toLocaleDateString()}</td>
                        <td>
                            <button class="btn-small btn-primary" onclick="editIngredient(${ingredient.id})">수정</button>
                            <button class="btn-small btn-danger" onclick="deleteIngredient(${ingredient.id})">삭제</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
                
            } catch (error) {
                console.error('식자재 목록 로드 실패:', error);
                document.getElementById('ingredients-tbody').innerHTML = 
                    '<tr><td colspan="7" style="text-align: center; color: #dc3545;">식자재 목록을 불러올 수 없습니다.</td></tr>';
            }
        }

        // 공급업체 필터 로드
        async function loadSupplierFilter() {
            try {
                const response = await fetch('/api/admin/suppliers');
                const suppliers = await response.json();
                
                const supplierFilter = document.getElementById('supplier-filter');
                supplierFilter.innerHTML = '<option value="">전체 업체</option>';
                
                suppliers.forEach(supplier => {
                    const option = document.createElement('option');
                    option.value = supplier.id;
                    option.textContent = supplier.name;
                    supplierFilter.appendChild(option);
                });
                
            } catch (error) {
                console.error('공급업체 목록 로드 실패:', error);
            }
        }

        // 식자재 수정 (추후 구현)
        function editIngredient(ingredientId) {
            alert(`식자재 ID ${ingredientId} 수정 기능은 곧 구현될 예정입니다.`);
        }

        // 식자재 삭제 (추후 구현)
        function deleteIngredient(ingredientId) {
            if (confirm('이 식자재를 삭제하시겠습니까?')) {
                alert(`식자재 ID ${ingredientId} 삭제 기능은 곧 구현될 예정입니다.`);
            }
        }

        // ===== 식수 등록 관리 관련 함수들 =====
        
        // 식수 등록 페이지 초기화
        function initMealCountsPage() {
            // 오늘 날짜를 기본값으로 설정
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('meal-count-date').value = today;
            document.getElementById('form-meal-date').value = today;
        }

        // 식수 데이터 로드
        async function loadMealCounts() {
            try {
                const selectedDate = document.getElementById('meal-count-date').value;
                const url = selectedDate ? `/api/admin/meal-counts?date=${selectedDate}` : '/api/admin/meal-counts';
                
                const response = await fetch(url);
                const mealCounts = await response.json();
                
                updateMealCountsSummary(mealCounts);
                updateMealCountsTable(mealCounts);
                
            } catch (error) {
                console.error('식수 데이터 로드 실패:', error);
                document.getElementById('meal-counts-tbody').innerHTML = 
                    '<tr><td colspan="8" style="text-align: center; color: #dc3545;">식수 데이터를 불러올 수 없습니다.</td></tr>';
            }
        }

        // 식수 현황 요약 업데이트
        function updateMealCountsSummary(mealCounts) {
            let totalCount = 0;
            let totalCost = 0;
            let deliverySites = new Set();
            
            mealCounts.forEach(item => {
                totalCount += item.total_count || 0;
                totalCost += (item.target_material_cost || 0) * (item.total_count || 0);
                deliverySites.add(item.delivery_site);
            });
            
            document.getElementById('total-meal-count').textContent = `${totalCount.toLocaleString()}명`;
            document.getElementById('avg-material-cost').textContent = 
                totalCount > 0 ? `${Math.round(totalCost / totalCount).toLocaleString()}원` : '0원';
            document.getElementById('delivery-sites-count').textContent = `${deliverySites.size}개소`;
            document.getElementById('estimated-total-cost').textContent = `${totalCost.toLocaleString()}원`;
        }

        // 식수 데이터 테이블 업데이트
        function updateMealCountsTable(mealCounts) {
            const tbody = document.getElementById('meal-counts-tbody');
            tbody.innerHTML = '';
            
            if (mealCounts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #666;">등록된 식수 데이터가 없습니다.</td></tr>';
                return;
            }
            
            mealCounts.forEach((item, index) => {
                // 메인 행
                const mainRow = document.createElement('tr');
                mainRow.innerHTML = `
                    <td class="delivery-site-cell" rowspan="${item.site_details.length + 1}">${item.delivery_site}</td>
                    <td class="meal-type-cell" rowspan="${item.site_details.length + 1}">${item.meal_type}</td>
                    <td class="cost-cell" rowspan="${item.site_details.length + 1}">${(item.target_material_cost || 0).toLocaleString()}원</td>
                    <td class="count-cell" rowspan="${item.site_details.length + 1}">${(item.total_count || 0).toLocaleString()}명</td>
                    <td colspan="3" style="background: #f0f8ff; font-weight: 500;">${item.menu_info || '-'}</td>
                    <td rowspan="${item.site_details.length + 1}">
                        <div class="btn-group">
                            <button class="btn-small btn-primary" onclick="editMealCount(${item.id})">수정</button>
                            <button class="btn-small btn-warning" onclick="duplicateMealCount(${item.id})">복사</button>
                        </div>
                    </td>
                `;
                tbody.appendChild(mainRow);
                
                // 사업장별 상세 행들
                item.site_details.forEach(site => {
                    const detailRow = document.createElement('tr');
                    detailRow.className = 'site-detail-row';
                    detailRow.innerHTML = `
                        <td>${site.site_name}</td>
                        <td class="count-cell">${site.count}명</td>
                        <td>${site.notes || '-'}</td>
                    `;
                    tbody.appendChild(detailRow);
                });
            });
        }

        // 식수 등록 모달 표시
        function showAddMealCountModal() {
            document.getElementById('meal-count-modal-title').textContent = '식수 등록';
            document.getElementById('meal-count-form').reset();
            document.getElementById('meal-count-id').value = '';
            
            // 선택된 날짜를 폼에도 반영
            const selectedDate = document.getElementById('meal-count-date').value;
            document.getElementById('form-meal-date').value = selectedDate;
            
            document.getElementById('meal-count-modal').classList.remove('hidden');
        }

        // 식수 등록 모달 닫기
        function closeMealCountModal() {
            document.getElementById('meal-count-modal').classList.add('hidden');
        }

        // 식수 데이터 저장
        async function saveMealCount() {
            try {
                const formData = {
                    meal_date: document.getElementById('form-meal-date').value,
                    delivery_site: document.getElementById('form-delivery-site').value.trim(),
                    meal_type: document.getElementById('form-meal-type').value,
                    target_material_cost: parseInt(document.getElementById('form-target-cost').value) || 0,
                    menu_info: document.getElementById('form-menu-info').value.trim(),
                    site_counts: document.getElementById('form-site-counts').value.trim(),
                    notes: document.getElementById('form-notes').value.trim()
                };

                // 유효성 검사
                if (!formData.meal_date || !formData.delivery_site || !formData.meal_type) {
                    alert('필수 항목을 모두 입력해주세요.');
                    return;
                }

                if (!formData.site_counts) {
                    alert('사업장별 식수를 입력해주세요.');
                    return;
                }

                const mealCountId = document.getElementById('meal-count-id').value;
                const url = mealCountId ? `/api/admin/meal-counts/${mealCountId}` : '/api/admin/meal-counts';
                const method = mealCountId ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();

                if (result.success) {
                    alert(mealCountId ? '식수 정보가 수정되었습니다.' : '식수 정보가 등록되었습니다.');
                    closeMealCountModal();
                    loadMealCounts();
                } else {
                    alert(result.message || '저장 중 오류가 발생했습니다.');
                }
                
            } catch (error) {
                console.error('식수 데이터 저장 실패:', error);
                alert('저장 중 오류가 발생했습니다.');
            }
        }

        // 식수 데이터 수정
        async function editMealCount(mealCountId) {
            try {
                const response = await fetch(`/api/admin/meal-counts/${mealCountId}`);
                const mealCount = await response.json();
                
                if (mealCount) {
                    document.getElementById('meal-count-modal-title').textContent = '식수 수정';
                    document.getElementById('meal-count-id').value = mealCount.id;
                    document.getElementById('form-meal-date').value = mealCount.meal_date;
                    document.getElementById('form-delivery-site').value = mealCount.delivery_site;
                    document.getElementById('form-meal-type').value = mealCount.meal_type;
                    document.getElementById('form-target-cost').value = mealCount.target_material_cost;
                    document.getElementById('form-menu-info').value = mealCount.menu_info || '';
                    document.getElementById('form-notes').value = mealCount.notes || '';
                    
                    // 사업장별 식수 데이터 변환
                    const siteCountsText = mealCount.site_details.map(site => 
                        `${site.site_name}:${site.count}`
                    ).join(',');
                    document.getElementById('form-site-counts').value = siteCountsText;
                    
                    document.getElementById('meal-count-modal').classList.remove('hidden');
                }
                
            } catch (error) {
                console.error('식수 데이터 로드 실패:', error);
                alert('식수 정보를 불러올 수 없습니다.');
            }
        }

        // 식수 데이터 복사
        async function duplicateMealCount(mealCountId) {
            try {
                const response = await fetch(`/api/admin/meal-counts/${mealCountId}`);
                const mealCount = await response.json();
                
                if (mealCount) {
                    document.getElementById('meal-count-modal-title').textContent = '식수 복사 등록';
                    document.getElementById('meal-count-id').value = ''; // 새로운 등록이므로 ID 비움
                    
                    // 오늘 날짜로 설정
                    const today = new Date().toISOString().split('T')[0];
                    document.getElementById('form-meal-date').value = today;
                    
                    document.getElementById('form-delivery-site').value = mealCount.delivery_site;
                    document.getElementById('form-meal-type').value = mealCount.meal_type;
                    document.getElementById('form-target-cost').value = mealCount.target_material_cost;
                    document.getElementById('form-menu-info').value = mealCount.menu_info || '';
                    document.getElementById('form-notes').value = '';
                    
                    // 사업장별 식수 데이터 변환
                    const siteCountsText = mealCount.site_details.map(site => 
                        `${site.site_name}:${site.count}`
                    ).join(',');
                    document.getElementById('form-site-counts').value = siteCountsText;
                    
                    document.getElementById('meal-count-modal').classList.remove('hidden');
                }
                
            } catch (error) {
                console.error('식수 데이터 로드 실패:', error);
                alert('식수 정보를 불러올 수 없습니다.');
            }
        }

        // 식수 데이터 새로고침
        function refreshMealCounts() {
            loadMealCounts();
        }

        // 발주서 출력 (추후 구현)
        function exportMealCounts() {
            alert('발주서 출력 기능은 곧 구현될 예정입니다.');
        }

        // 날짜 변경 이벤트
        document.addEventListener('DOMContentLoaded', function() {
            const mealCountDateInput = document.getElementById('meal-count-date');
            if (mealCountDateInput) {
                mealCountDateInput.addEventListener('change', loadMealCounts);
            }
        });

    </script>
</body>
</html>