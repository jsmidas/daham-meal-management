<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>레시피 저장 콘솔 테스트</title>
</head>
<body>
    <h1>레시피 저장 디버깅</h1>
    <button onclick="testSaveWithDebug()">디버그 모드로 저장 테스트</button>
    <div id="status"></div>
    <pre id="log"></pre>

    <script>
        function log(message) {
            const logEl = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logEl.textContent += `[${timestamp}] ${message}\n`;
            console.log(message);
        }

        async function testSaveWithDebug() {
            log('=== 저장 시작 ===');
            document.getElementById('status').textContent = '저장 중...';

            const testData = {
                recipe_name: '테스트 메뉴',
                category: '국',
                cooking_note: '테스트 조리법',
                ingredients: JSON.stringify([
                    {
                        ingredient_code: 'TEST001',
                        ingredient_name: '테스트 재료',
                        specification: '1kg',
                        unit: 'kg',
                        delivery_days: 1,
                        selling_price: 10000,
                        quantity: 0.5,
                        amount: 5000,
                        supplier_name: '테스트 업체'
                    }
                ])
            };

            log('FormData 생성 중...');
            const formData = new FormData();
            for (const key in testData) {
                formData.append(key, testData[key]);
                log(`  ${key}: ${testData[key].substring ? testData[key].substring(0, 50) : testData[key]}`);
            }

            try {
                log('fetch 요청 시작...');
                const response = await fetch('http://127.0.0.1:8010/api/recipe/save', {
                    method: 'POST',
                    body: formData
                });

                log(`응답 수신: 상태 코드 ${response.status}`);

                const responseText = await response.text();
                log(`응답 텍스트: ${responseText}`);

                let result;
                try {
                    result = JSON.parse(responseText);
                    log('JSON 파싱 성공');
                } catch (parseError) {
                    log('JSON 파싱 실패: ' + parseError.message);
                    throw parseError;
                }

                log(`결과: ${JSON.stringify(result, null, 2)}`);

                if (result.success) {
                    log('✅ 저장 성공!');
                    log(`recipe_id: ${result.recipe_id}`);

                    // alert 테스트
                    log('alert 표시 시도...');
                    alert(`"테스트 메뉴" 레시피가 성공적으로 저장되었습니다!`);
                    log('alert 표시 완료');

                    // confirm 테스트
                    log('confirm 표시 시도...');
                    const confirmResult = confirm('새 레시피를 작성하시겠습니까?');
                    log(`confirm 결과: ${confirmResult}`);

                    document.getElementById('status').textContent = '✅ 저장 성공!';
                } else {
                    log('❌ 저장 실패!');
                    log(`오류: ${result.detail || result.error || '알 수 없는 오류'}`);

                    alert('저장 실패: ' + (result.detail || '알 수 없는 오류'));
                    document.getElementById('status').textContent = '❌ 저장 실패';
                }
            } catch (error) {
                log('❌ 예외 발생: ' + error.toString());
                log('스택: ' + error.stack);

                alert('저장 중 오류가 발생했습니다: ' + error.message);
                document.getElementById('status').textContent = '❌ 오류 발생';
            }

            log('=== 저장 프로세스 종료 ===');
        }

        // 페이지 로드 시 자동 실행
        window.onload = function() {
            log('페이지 로드 완료');
            log('브라우저: ' + navigator.userAgent);
        };
    </script>
</body>
</html>