<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Îã§Ìï®ÏãùÎã®Í¥ÄÎ¶¨ - Í¥ÄÎ¶¨Ïûê ÎåÄÏãúÎ≥¥Îìú</title>
    <link rel="stylesheet" href="/static/admin-dashboard.css">
    <!-- <style style="display: none;">
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Malgun Gothic', sans-serif;
            background-color: #f5f5f5;
        }

        .admin-container {
            display: flex;
            height: 100vh;
        }

        /* ÏÇ¨Ïù¥ÎìúÎ∞î */
        .sidebar {
            width: 250px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 0;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .sidebar-header {
            text-align: center;
            padding: 0 20px 30px;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }

        .sidebar-header h2 {
            font-size: 18px;
            font-weight: 600;
        }

        .sidebar-header p {
            font-size: 12px;
            opacity: 0.8;
            margin-top: 5px;
        }

        .nav-menu {
            padding: 20px 0;
        }

        .nav-item {
            display: block;
            padding: 15px 25px;
            color: white;
            text-decoration: none;
            transition: all 0.3s;
            border-left: 3px solid transparent;
        }

        .nav-item:hover, .nav-item.active {
            background: rgba(255,255,255,0.1);
            border-left-color: #ffd700;
        }

        .nav-item .icon {
            margin-right: 10px;
            font-size: 16px;
        }

        /* Î©îÏù∏ Ïª®ÌÖêÏ∏† */
        .main-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .header h1 {
            color: #333;
            font-size: 24px;
        }

        .header-info {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-top: 10px;
        }

        .user-info {
            color: #666;
            font-size: 14px;
        }

        .logout-btn {
            background: #ff6b6b;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .logout-btn:hover {
            background: #ff5252;
        }

        /* ÎåÄÏãúÎ≥¥Îìú Ïπ¥ÎìúÎì§ */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .dashboard-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .card-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .card-header .icon {
            font-size: 24px;
            margin-right: 10px;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }

        .card-content {
            color: #666;
        }

        .stat-number {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
            margin: 10px 0;
        }

        .stat-label {
            font-size: 14px;
            color: #999;
        }

        /* ÏµúÍ∑º ÌôúÎèô Î°úÍ∑∏ */
        .activity-log {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .log-item {
            padding: 12px 0;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
        }

        .log-item:last-child {
            border-bottom: none;
        }

        .log-time {
            font-size: 12px;
            color: #999;
            margin-right: 15px;
            min-width: 100px;
        }

        .log-message {
            color: #666;
            flex: 1;
        }

        .log-user {
            font-size: 12px;
            color: #667eea;
            margin-left: 10px;
        }

        /* ÌÜµÌï© ÏãùÎã®Ìëú Í¥ÄÎ¶¨ ÌÉ≠ Ïä§ÌÉÄÏùº */
        .tab-btn {
            padding: 12px 20px;
            border: none;
            background: #f8f9fa;
            color: #666;
            cursor: pointer;
            border-radius: 8px 8px 0 0;
            margin-right: 5px;
            transition: all 0.3s;
            font-size: 14px;
        }
        
        .tab-btn.active {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
        }
        
        .tab-btn:hover {
            background: #e9ecef;
        }
        
        .tab-btn.active:hover {
            background: #5a6fd8;
        }
        
        .meal-plan-tab-content {
            padding: 20px 0;
        }
        
        .overview-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.15) !important;
            transition: all 0.3s;
        }
        
        .instruction-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.15) !important;
            transition: all 0.3s;
        }

        /* Î∞òÏùëÌòï */
        @media (max-width: 768px) {
            .admin-container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: auto;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .meal-plan-tabs {
                flex-wrap: wrap;
            }
            
            .tab-btn {
                margin-bottom: 5px;
            }
            
            .overview-cards {
                grid-template-columns: 1fr !important;
            }
        }

        .hidden {
            display: none !important;
        }

        /* ÏãùÏûêÏû¨ ÏóÖÎ°úÎìú Í¥ÄÎ†® Ïä§ÌÉÄÏùº */
        .upload-notice {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .upload-notice h3 {
            color: #856404;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .notice-content p {
            color: #856404;
            margin-bottom: 15px;
            line-height: 1.5;
        }

        .warning-item {
            background: white;
            border-left: 4px solid #f39c12;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 0 8px 8px 0;
        }

        .warning-item strong {
            color: #e67e22;
            display: block;
            margin-bottom: 8px;
        }

        .warning-item p {
            color: #666;
            margin: 5px 0;
            font-size: 14px;
        }

        .upload-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .upload-container {
            margin-bottom: 20px;
        }

        .upload-area {
            border: 2px dashed #4a90e2;
            border-radius: 10px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #f8f9fa;
        }

        .upload-area:hover {
            border-color: #357abd;
            background: #e7f3ff;
        }

        .upload-area.dragover {
            border-color: #28a745;
            background: #d4edda;
        }

        .upload-icon {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.7;
        }

        .upload-text h4 {
            color: #333;
            margin-bottom: 8px;
        }

        .upload-text p {
            color: #666;
            font-size: 14px;
        }

        .upload-progress {
            margin-top: 20px;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #20c997);
            width: 0%;
            transition: width 0.3s;
        }

        .progress-text {
            text-align: center;
            color: #666;
            font-size: 14px;
        }

        .upload-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .upload-results {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .upload-results h3 {
            color: #333;
            margin-bottom: 15px;
        }

        .result-summary {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .result-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 15px;
            border-radius: 8px;
            font-weight: 500;
        }

        .result-item.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .result-item.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .result-count {
            font-size: 18px;
            font-weight: bold;
        }

        .result-details {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 8px;
        }

        .result-file {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            border-bottom: 1px solid #f8f9fa;
        }

        .result-file:last-child {
            border-bottom: none;
        }

        .result-file.success {
            background: #f8fff9;
        }

        .result-file.error {
            background: #fff5f5;
        }

        .file-name {
            font-weight: 500;
            color: #333;
        }

        .file-status {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
        }

        .file-status.success {
            color: #28a745;
        }

        .file-status.error {
            color: #dc3545;
        }

        .ingredients-list {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .ingredients-list h3 {
            color: #333;
            margin-bottom: 15px;
        }

        .list-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            align-items: center;
        }

        .search-input, .filter-select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .search-input {
            flex: 2;
        }

        .filter-select {
            flex: 1;
        }

        /* ÏãùÏàò Îì±Î°ù Í¥ÄÎ¶¨ Ï†ÑÏö© Ïä§ÌÉÄÏùº */
        .meal-count-notice {
            background: #e7f3ff;
            border: 1px solid #b3d9ff;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .meal-count-notice h3 {
            color: #0056b3;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .notice-content p {
            color: #0056b3;
            margin-bottom: 15px;
            line-height: 1.5;
        }

        .notice-rules {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .rule-item {
            background: white;
            border-left: 4px solid #007bff;
            padding: 12px 15px;
            border-radius: 0 8px 8px 0;
            font-size: 14px;
        }

        .rule-item strong {
            color: #0056b3;
            margin-right: 8px;
        }

        .meal-count-summary {
            margin-bottom: 20px;
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .summary-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
            border-left: 4px solid #4a90e2;
        }

        .card-header {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
            font-weight: 500;
        }

        .card-value {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }

        .meal-count-table-container {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
        }

        .table-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            align-items: center;
        }

        .meal-count-table {
            width: 100%;
            border-collapse: collapse;
        }

        .meal-count-table th,
        .meal-count-table td {
            border: 1px solid #ddd;
            padding: 8px 12px;
            text-align: center;
            font-size: 13px;
        }

        .meal-count-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }

        .meal-count-table tbody tr:hover {
            background: #f8f9fa;
        }

        .delivery-site-cell {
            font-weight: 600;
            color: #4a90e2;
            background: #f0f8ff !important;
        }

        .meal-type-cell {
            font-weight: 500;
        }

        .cost-cell {
            font-weight: 600;
            color: #28a745;
        }

        .count-cell {
            font-weight: 600;
            color: #dc3545;
        }

        .site-detail-row {
            background: #f9f9f9 !important;
            font-size: 12px;
        }

        .date-input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            margin-left: 8px;
        }

        .date-selector {
            display: flex;
            align-items: center;
            margin-right: 15px;
        }

        .date-selector label {
            font-weight: 500;
            color: #333;
        }

        /* Î™®Îã¨ Ìèº Ïä§ÌÉÄÏùº */
        .form-row {
            display: flex;
            gap: 20px;
        }

        .form-row .form-group {
            flex: 1;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #333;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .form-group textarea {
            resize: vertical;
        }

        .form-group small {
            color: #666;
            font-size: 12px;
            margin-top: 5px;
            display: block;
        }

        .btn-group {
            display: flex;
            gap: 5px;
        }

        .btn-small {
            padding: 4px 8px;
            font-size: 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
        }

        .btn-small.btn-primary {
            background: #4a90e2;
            color: white;
        }

        .btn-small.btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn-small.btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .modal {
            display: none;
        }

        /* ÏÇ¨Ïö©Ïûê Í¥ÄÎ¶¨ ÌéòÏù¥ÏßÄ Ïä§ÌÉÄÏùº */
        .page-header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .header-actions {
            display: flex;
            justify-content: between;
            align-items: center;
            gap: 20px;
        }

        .search-box {
            display: flex;
            align-items: center;
            flex: 1;
        }

        .search-box input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px 0 0 5px;
            outline: none;
        }

        .search-box button {
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-left: none;
            border-radius: 0 5px 5px 0;
            background: #f8f9fa;
            cursor: pointer;
        }

        .btn-primary {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.3s;
        }

        .btn-primary:hover {
            background: #5a6fd8;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.3s;
        }

        .btn-secondary:hover {
            background: #545b62;
        }

        .btn-small {
            padding: 5px 10px;
            font-size: 12px;
            border-radius: 3px;
            border: none;
            cursor: pointer;
            margin-right: 5px;
        }

        .btn-edit {
            background: #28a745;
            color: white;
        }

        .btn-delete {
            background: #dc3545;
            color: white;
        }

        .btn-add {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
        }

        .btn-add:hover {
            background: #0056b3;
        }

        .btn-remove {
            background: #dc3545;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }

        .btn-remove:hover {
            background: #c82333;
        }

        .supplier-row {
            display: grid;
            grid-template-columns: 2fr 1.5fr 0.8fr 0.5fr auto;
            gap: 10px;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
            background: #f9f9f9;
            margin-bottom: 5px;
            border-radius: 4px;
        }

        .supplier-row:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .supplier-row label {
            font-size: 12px;
            color: #666;
            margin-bottom: 2px;
        }

        .supplier-row select,
        .supplier-row input {
            width: 100%;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 13px;
        }

        .btn-reset {
            background: #ffc107;
            color: black;
        }

        /* ÌÖåÏù¥Î∏î Ïä§ÌÉÄÏùº */
        .table-container {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th {
            background: #f8f9fa;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid #dee2e6;
        }

        .data-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #dee2e6;
        }

        .data-table tbody tr:hover {
            background: #f8f9fa;
        }

        .status-active {
            color: #28a745;
            font-weight: 500;
        }

        .status-inactive {
            color: #dc3545;
            font-weight: 500;
        }

        /* ÌéòÏù¥ÏßÄÎÑ§Ïù¥ÏÖò */
        .pagination {
            text-align: center;
            padding: 20px;
        }

        .pagination button {
            background: white;
            border: 1px solid #dee2e6;
            padding: 8px 16px;
            margin: 0 5px;
            border-radius: 5px;
            cursor: pointer;
        }

        .pagination button:hover {
            background: #e9ecef;
        }

        .pagination button:disabled {
            background: #f8f9fa;
            color: #6c757d;
            cursor: not-allowed;
        }

        /* Î™®Îã¨ Ïä§ÌÉÄÏùº */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            border-radius: 10px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            justify-content: between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
            color: #333;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }

        .modal-close:hover {
            color: #333;
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 20px;
            border-top: 1px solid #dee2e6;
            text-align: right;
        }

        .modal-footer button {
            margin-left: 10px;
        }

        /* Ìèº Ïä§ÌÉÄÏùº */
        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #333;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            outline: none;
        }

        .form-group input:focus,
        .form-group select:focus {
            border-color: #667eea;
        }

        .form-group small {
            display: block;
            margin-top: 5px;
            color: #6c757d;
            font-size: 12px;
        }

        .checkbox-label {
            display: flex !important;
            align-items: center;
            cursor: pointer;
        }

        .checkbox-label input[type="checkbox"] {
            width: auto !important;
            margin-right: 8px;
        }

        /* ÏÇ¨ÏóÖÏû• Í¥ÄÎ¶¨ ÌéòÏù¥ÏßÄ Ïä§ÌÉÄÏùº */
        .action-buttons {
            display: flex;
            gap: 10px;
        }

        .sites-container {
            display: flex;
            gap: 20px;
        }

        .sites-tree {
            flex: 2;
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-height: 600px;
            overflow-y: auto;
        }

        .site-details-panel {
            flex: 1;
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-height: 600px;
            overflow-y: auto;
        }

        .panel-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #dee2e6;
        }

        .panel-header h3 {
            margin: 0;
            color: #333;
        }

        .panel-close {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #999;
        }

        .panel-close:hover {
            color: #333;
        }

        /* Ìä∏Î¶¨ ÎÖ∏Îìú Ïä§ÌÉÄÏùº */
        .tree-node {
            margin: 5px 0;
            user-select: none;
        }

        .tree-node-content {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.2s;
            position: relative;
        }

        .tree-node-content:hover {
            background: #f8f9fa;
        }

        .tree-node-content.selected {
            background: #e7f3ff;
            border: 1px solid #b3d9ff;
        }

        .tree-node-content.head-site {
            background: #e8f5e8;
            border-left: 4px solid #28a745;
        }

        .tree-node-content.detail-site {
            background: #fff8e1;
            border-left: 4px solid #ffc107;
        }

        .tree-node-content.period-site {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
        }

        .tree-expand-btn {
            width: 20px;
            height: 20px;
            border: none;
            background: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 5px;
            border-radius: 3px;
        }

        .tree-expand-btn:hover {
            background: #e9ecef;
        }

        .tree-expand-btn.expanded::before {
            content: '‚ñº';
        }

        .tree-expand-btn.collapsed::before {
            content: '‚ñ∂';
        }

        .tree-expand-btn.no-children {
            visibility: hidden;
        }

        .tree-node-icon {
            margin-right: 8px;
            font-size: 16px;
        }

        .tree-node-label {
            flex: 1;
            font-weight: 500;
            color: #333;
        }

        .tree-node-status {
            font-size: 12px;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 10px;
        }

        .tree-node-status.active {
            background: #d4edda;
            color: #155724;
        }

        .tree-node-status.inactive {
            background: #f8d7da;
            color: #721c24;
        }

        .tree-node-actions {
            display: none;
            margin-left: 10px;
            gap: 5px;
        }

        .tree-node-content:hover .tree-node-actions {
            display: flex;
        }

        .tree-action-btn {
            padding: 2px 6px;
            border: none;
            border-radius: 3px;
            font-size: 12px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .tree-action-btn.add {
            background: #d4edda;
            color: #155724;
        }

        .tree-action-btn.edit {
            background: #cce5ff;
            color: #004085;
        }

        .tree-action-btn.delete {
            background: #f8d7da;
            color: #721c24;
        }

        .tree-action-btn:hover {
            opacity: 0.8;
        }

        /* ÏûêÏãù ÎÖ∏Îìú Îì§Ïó¨Ïì∞Í∏∞ */
        .tree-children {
            margin-left: 25px;
            border-left: 1px solid #dee2e6;
            padding-left: 10px;
        }

        .tree-children.hidden {
            display: none;
        }

        /* ÎìúÎûòÍ∑∏ Ïï§ ÎìúÎ°≠ Ïä§ÌÉÄÏùº */
        .tree-node-content {
            cursor: move;
            transition: all 0.2s ease;
        }

        .tree-node-content.dragging {
            opacity: 0.5;
            transform: rotate(5deg);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .tree-node-content.drag-over {
            background: #e3f2fd;
            border: 2px dashed #2196F3;
            transform: scale(1.02);
        }

        .tree-node-content.drop-invalid {
            background: #ffebee;
            border: 2px dashed #f44336;
        }

        .drag-indicator {
            position: absolute;
            height: 2px;
            background: #2196F3;
            left: 0;
            right: 0;
            pointer-events: none;
            z-index: 1000;
        }

        /* ÏÇ¨ÏóÖÏû• ÏÉÅÏÑ∏ Ï†ïÎ≥¥ Ïä§ÌÉÄÏùº */
        .site-info-group {
            margin-bottom: 15px;
        }

        .site-info-label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 5px;
        }

        .site-info-value {
            color: #333;
            background: #f8f9fa;
            padding: 8px 12px;
            border-radius: 5px;
        }

        .site-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }

        .stat-box {
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            font-size: 12px;
            color: #6c757d;
            margin-top: 5px;
        }

        /* ÎìúÎûòÍ∑∏ Ïï§ ÎìúÎ°≠ Ïä§ÌÉÄÏùº */
        .tree-node-content.dragging {
            opacity: 0.5;
        }

        .tree-node-content.drop-target {
            background: #e7f3ff;
            border: 2px dashed #007bff;
        }
        
        /* ÌïÑÏàò ÌïÑÎìú Î≥ÑÌëú Ïä§ÌÉÄÏùº */
        .required {
            color: #e74c3c;
            font-weight: bold;
            font-size: 18px;
            text-shadow: 1px 1px 2px rgba(231, 76, 60, 0.3);
            margin-left: 3px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.6; }
            100% { opacity: 1; }
        }
        
    </style> -->
    
    <!-- Settings Module CSS -->
    <style>
    /* Settings Module Specific Styles */
    .settings-container {
        max-width: 800px;
    }

    .settings-group {
        display: flex;
        flex-direction: column;
        gap: 15px;
        margin-top: 15px;
    }

    .setting-item {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }

    .setting-item label {
        font-weight: 600;
        color: #333;
        font-size: 14px;
    }

    .setting-item input,
    .setting-item select {
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 14px;
    }

    .info-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid #f0f0f0;
    }

    .info-item:last-child {
        border-bottom: none;
    }

    .info-label {
        font-weight: 500;
        color: #666;
    }

    .info-value {
        font-weight: 600;
        color: #333;
    }

    .status-active {
        color: #28a745;
    }

    .status-inactive {
        color: #dc3545;
    }

    .settings-actions {
        margin-top: 30px;
        display: flex;
        gap: 15px;
        justify-content: flex-end;
    }
    
    .settings-alert {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 16px;
        margin-bottom: 20px;
        border-radius: 5px;
        font-size: 14px;
        font-weight: 500;
    }

    .alert-success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }

    .alert-error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }

    .alert-warning {
        background-color: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
    }

    .alert-info {
        background-color: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
    }
    
    /* Dashboard Module Enhanced Styles */
    .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .dashboard-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    }

    .btn-refresh {
        position: absolute;
        right: 0;
        background: none;
        border: 1px solid #ddd;
        border-radius: 5px;
        padding: 5px 10px;
        cursor: pointer;
        font-size: 12px;
        color: #666;
        transition: all 0.3s ease;
    }

    .btn-refresh:hover {
        background: #f8f9fa;
        color: #333;
    }

    .stat-trend {
        font-size: 12px;
        font-weight: 600;
        padding: 2px 6px;
        border-radius: 12px;
        display: inline-block;
        margin-top: 5px;
    }

    .stat-trend.positive {
        color: #28a745;
        background: rgba(40, 167, 69, 0.1);
    }

    .stat-trend.negative {
        color: #dc3545;
        background: rgba(220, 53, 69, 0.1);
    }

    .stat-trend.neutral {
        color: #6c757d;
        background: rgba(108, 117, 125, 0.1);
    }

    .activity-container {
        max-height: 300px;
        overflow-y: auto;
    }

    .activity-loading {
        text-align: center;
        padding: 40px;
        color: #666;
    }

    .log-item {
        display: flex;
        align-items: center;
        padding: 12px 0;
        border-bottom: 1px solid #f0f0f0;
        transition: background-color 0.2s ease;
    }

    .log-item:hover {
        background-color: #f8f9fa;
        margin: 0 -10px;
        padding: 12px 10px;
        border-radius: 5px;
        border-bottom: 1px solid transparent;
    }

    .log-item:last-child {
        border-bottom: none;
    }

    .log-time {
        font-size: 12px;
        color: #888;
        min-width: 80px;
        margin-right: 15px;
    }

    .log-message {
        flex: 1;
        font-size: 14px;
        color: #333;
    }

    .log-user {
        font-size: 12px;
        color: #666;
        font-weight: 500;
    }

    .quick-actions {
        background: white;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .actions-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
        margin-top: 15px;
    }

    .action-btn {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
        padding: 20px 15px;
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        color: #495057;
    }

    .action-btn:hover {
        background: #667eea;
        color: white;
        border-color: #667eea;
        transform: translateY(-1px);
    }

    .action-btn i {
        font-size: 20px;
    }

    .action-btn span {
        font-size: 13px;
        font-weight: 500;
    }

    /* Î∞òÏùëÌòï ÎîîÏûêÏù∏ */
    @media (max-width: 768px) {
        .dashboard-grid {
            grid-template-columns: 1fr;
            gap: 15px;
        }
        
        .actions-grid {
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        
        .action-btn {
            padding: 15px 10px;
        }
    }
    
    /* Users Module Enhanced Styles */
    .users-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin: 20px 0 30px 0;
    }

    .stat-card {
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        transition: transform 0.2s ease;
    }

    .stat-card:hover {
        transform: translateY(-2px);
    }

    .stat-header {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 10px;
    }

    .stat-icon {
        font-size: 18px;
    }

    .stat-title {
        font-size: 14px;
        color: #666;
        font-weight: 500;
    }

    .stat-value {
        font-size: 28px;
        font-weight: 700;
        color: #667eea;
    }

    .filter-section {
        background: white;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        display: flex;
        gap: 20px;
        align-items: end;
        flex-wrap: wrap;
    }

    .filter-group {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }

    .filter-group label {
        font-size: 14px;
        font-weight: 500;
        color: #333;
    }

    .filter-group select,
    .filter-group input {
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 14px;
        min-width: 150px;
    }

    .sortable {
        cursor: pointer;
        position: relative;
        user-select: none;
    }

    .sortable:hover {
        background-color: #f8f9fa;
    }

    .sortable::after {
        content: '‚áÖ';
        position: absolute;
        right: 5px;
        opacity: 0.3;
    }

    .sortable.sort-asc::after {
        content: '‚Üë';
        opacity: 1;
    }

    .sortable.sort-desc::after {
        content: '‚Üì';
        opacity: 1;
    }

    .loading-row {
        text-align: center;
        padding: 40px;
        color: #666;
    }

    .page-size-selector {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-left: 20px;
    }

    .page-size-selector label {
        font-size: 14px;
        color: #666;
    }

    .page-size-selector select {
        padding: 5px 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
    }

    .user-checkbox {
        cursor: pointer;
    }

    .selected-row {
        background-color: #e3f2fd !important;
    }

    .bulk-actions-bar {
        background: #667eea;
        color: white;
        padding: 10px 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        display: none;
        align-items: center;
        gap: 15px;
    }

    .bulk-actions-bar.show {
        display: flex;
    }

    .bulk-action-btn {
        background: rgba(255,255,255,0.2);
        color: white;
        border: 1px solid rgba(255,255,255,0.3);
        padding: 5px 15px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.2s ease;
    }

    .bulk-action-btn:hover {
        background: rgba(255,255,255,0.3);
    }

    .user-info {
        display: flex;
        flex-direction: column;
        gap: 2px;
    }

    .username {
        font-weight: 500;
        color: #333;
    }

    .user-email {
        font-size: 12px;
        color: #666;
    }

    .role-badge {
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
    }

    .role-admin {
        background: #dc3545;
        color: white;
    }

    .role-manager {
        background: #667eea;
        color: white;
    }

    .role-viewer {
        background: #28a745;
        color: white;
    }

    .status-badge {
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
    }

    .status-active {
        background: rgba(40, 167, 69, 0.1);
        color: #28a745;
    }

    .status-inactive {
        background: rgba(220, 53, 69, 0.1);
        color: #dc3545;
    }

    .actions-cell {
        white-space: nowrap;
    }

    .btn-small {
        padding: 4px 8px;
        margin: 0 2px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
        transition: all 0.2s ease;
    }

    .btn-edit {
        background: #667eea;
        color: white;
    }

    .btn-sites {
        background: #17a2b8;
        color: white;
    }

    .btn-reset {
        background: #fd7e14;
        color: white;
    }

    .btn-success {
        background: #28a745;
        color: white;
    }

    .btn-danger {
        background: #dc3545;
        color: white;
    }

    .btn-small:hover {
        transform: translateY(-1px);
        opacity: 0.9;
    }
    </style>
</head>
<body>
    <div class="admin-container">
        <!-- ÏÇ¨Ïù¥ÎìúÎ∞î -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <h2>Í¥ÄÎ¶¨Ïûê ÏãúÏä§ÌÖú</h2>
                <p>Îã§Ìï®ÏãùÎã®Í¥ÄÎ¶¨</p>
            </div>
            
            <div class="nav-menu">
                <a href="#" class="nav-item active" data-page="dashboard">
                    <span class="icon">üìä</span>ÎåÄÏãúÎ≥¥Îìú
                </a>
                <a href="#" class="nav-item" data-page="users">
                    <span class="icon">üë•</span>ÏÇ¨Ïö©Ïûê Í¥ÄÎ¶¨
                </a>
                <a href="#" class="nav-item" data-page="suppliers">
                    <span class="icon">üöõ</span>ÌòëÎ†•ÏóÖÏ≤¥ Í¥ÄÎ¶¨
                </a>
                <a href="#" class="nav-item" data-page="business-locations">
                    <span class="icon">üè¢</span>ÏÇ¨ÏóÖÏû• Í¥ÄÎ¶¨
                </a>
                <a href="#" class="nav-item" data-page="supplier-mapping">
                    <span class="icon">üîó</span>Îß§Ìïë Í¥ÄÎ¶¨
                </a>
                <a href="#" class="nav-item" data-page="meal-pricing" onclick="showMealPricingPage()">
                    <span class="icon">üí∞</span>ÏãùÎã®Í∞Ä Í¥ÄÎ¶¨
                </a>
                <a href="#" class="nav-item" data-page="ingredients">
                    <span class="icon">üì¶</span>ÏãùÏûêÏû¨ Í¥ÄÎ¶¨
                </a>
                <a href="#" class="nav-item" data-page="settings">
                    <span class="icon">‚öôÔ∏è</span>ÏãúÏä§ÌÖú ÏÑ§Ï†ï
                </a>
                <a href="#" class="nav-item" data-page="logs">
                    <span class="icon">üìã</span>Î°úÍ∑∏ Í¥ÄÎ¶¨
                </a>
                
                <!-- ÌïòÎã® ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò Î≤ÑÌäºÎì§ -->
                <div style="margin-top: auto; padding-top: 20px; border-top: 1px solid #ddd;">
                    <a href="/" class="nav-item" style="background: #e8f5e8; color: #4caf50;">
                        <span class="icon">üçΩÔ∏è</span>Í∏âÏãùÍ¥ÄÎ¶¨Î°ú Ïù¥Îèô
                    </a>
                </div>
            </div>
        </nav>

        <!-- Î©îÏù∏ Ïª®ÌÖêÏ∏† -->
        <main class="main-content">
            <!-- Ìó§Îçî -->
            <div class="header">
                <div class="header-info">
                    <div>
                        <h1 id="page-title">Í¥ÄÎ¶¨Ïûê ÎåÄÏãúÎ≥¥Îìú</h1>
                        <div class="user-info">
                            Í¥ÄÎ¶¨ÏûêÎãò, ÏïàÎÖïÌïòÏÑ∏Ïöî! | ÎßàÏßÄÎßâ Ï†ëÏÜç: 2025-08-30 12:00
                        </div>
                    </div>
                    <button class="logout-btn" onclick="logout()">Î°úÍ∑∏ÏïÑÏõÉ</button>
                </div>
            </div>

            <!-- ÎåÄÏãúÎ≥¥Îìú ÌéòÏù¥ÏßÄ -->
            <div id="dashboard-page" class="page-content">
                <div class="page-header">
                    <h2>üìä ÎåÄÏãúÎ≥¥Îìú</h2>
                    <p>ÏãúÏä§ÌÖú ÌòÑÌô©Í≥º Ï£ºÏöî ÏßÄÌëúÎ•º ÌôïÏù∏ÌïòÏÑ∏Ïöî.</p>
                </div>

                <!-- ÌÜµÍ≥Ñ Ïπ¥Îìú Í∑∏Î¶¨Îìú -->
                <div class="dashboard-grid">
                    <div class="dashboard-card">
                        <div class="card-header">
                            <span class="icon">üë•</span>
                            <span class="card-title">Ï†ÑÏ≤¥ ÏÇ¨Ïö©Ïûê</span>
                        </div>
                        <div class="card-content">
                            <div class="stat-number" id="total-users">-</div>
                            <div class="stat-label">ÌôúÏÑ± ÏÇ¨Ïö©Ïûê</div>
                            <div class="stat-trend positive" id="users-trend">+2.3%</div>
                        </div>
                    </div>

                    <div class="dashboard-card">
                        <div class="card-header">
                            <span class="icon">üè¢</span>
                            <span class="card-title">ÏÇ¨ÏóÖÏû• Ïàò</span>
                        </div>
                        <div class="card-content">
                            <div class="stat-number" id="total-sites">-</div>
                            <div class="stat-label">Îì±Î°ùÎêú ÏÇ¨ÏóÖÏû•</div>
                            <div class="stat-trend neutral" id="sites-trend">0%</div>
                        </div>
                    </div>

                    <div class="dashboard-card">
                        <div class="card-header">
                            <span class="icon">üìã</span>
                            <span class="card-title">Ïò§ÎäòÏùò ÏãùÎã®</span>
                        </div>
                        <div class="card-content">
                            <div class="stat-number" id="today-menus">-</div>
                            <div class="stat-label">Ïò§Îäò Ìé∏ÏÑ±Îêú ÏãùÎã®</div>
                            <div class="stat-trend positive" id="menus-trend">+5.1%</div>
                        </div>
                    </div>

                    <div class="dashboard-card">
                        <div class="card-header">
                            <span class="icon">üí∞</span>
                            <span class="card-title">Îã®Í∞Ä ÏóÖÎç∞Ïù¥Ìä∏</span>
                        </div>
                        <div class="card-content">
                            <div class="stat-number" id="price-updates">-</div>
                            <div class="stat-label">ÏµúÍ∑º 7ÏùºÍ∞Ñ ÏóÖÎç∞Ïù¥Ìä∏</div>
                            <div class="stat-trend negative" id="price-trend">-1.2%</div>
                        </div>
                    </div>
                </div>

                <!-- ÏµúÍ∑º ÌôúÎèô Î°úÍ∑∏ -->
                <div class="activity-log">
                    <div class="card-header">
                        <span class="icon">üìã</span>
                        <span class="card-title">ÏµúÍ∑º ÌôúÎèô</span>
                        <button onclick="DashboardModule.refreshActivity()" class="btn-refresh">
                            <i class="fas fa-sync-alt"></i> ÏÉàÎ°úÍ≥†Ïπ®
                        </button>
                    </div>
                    <div class="activity-container">
                        <div id="activity-list">
                            <!-- ÎèôÏ†ÅÏúºÎ°ú Î°úÎìúÎê† ÌôúÎèô Î°úÍ∑∏ -->
                            <div class="activity-loading">
                                <i class="fas fa-spinner fa-spin"></i> ÌôúÎèô Î°úÍ∑∏Î•º Î∂àÎü¨Ïò§Îäî Ï§ë...
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Îπ†Î•∏ Ïï°ÏÖò -->
                <div class="quick-actions">
                    <div class="card-header">
                        <span class="icon">‚ö°</span>
                        <span class="card-title">Îπ†Î•∏ Ïï°ÏÖò</span>
                    </div>
                    <div class="actions-grid">
                        <button onclick="showPage('users')" class="action-btn">
                            <i class="fas fa-users"></i>
                            <span>ÏÇ¨Ïö©Ïûê Í¥ÄÎ¶¨</span>
                        </button>
                        <button onclick="showPage('business-locations')" class="action-btn">
                            <i class="fas fa-building"></i>
                            <span>ÏÇ¨ÏóÖÏû• Í¥ÄÎ¶¨</span>
                        </button>
                        <button onclick="showPage('suppliers')" class="action-btn">
                            <i class="fas fa-truck"></i>
                            <span>ÌòëÎ†•ÏóÖÏ≤¥ Í¥ÄÎ¶¨</span>
                        </button>
                        <button onclick="showPage('ingredients')" class="action-btn">
                            <i class="fas fa-carrot"></i>
                            <span>ÏãùÏûêÏû¨ Í¥ÄÎ¶¨</span>
                        </button>
                        <button onclick="SettingsModule.createBackup()" class="action-btn">
                            <i class="fas fa-save"></i>
                            <span>Î∞±ÏóÖ ÏÉùÏÑ±</span>
                        </button>
                        <button onclick="showPage('settings')" class="action-btn">
                            <i class="fas fa-cog"></i>
                            <span>ÏãúÏä§ÌÖú ÏÑ§Ï†ï</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Îã§Î•∏ ÌéòÏù¥ÏßÄÎì§ÏùÄ hidden ÏÉÅÌÉúÎ°ú ÏãúÏûë -->
            <div id="users-page" class="page-content hidden">
                <!-- ÏÇ¨Ïö©Ïûê Í¥ÄÎ¶¨ Ìó§Îçî -->
                <div class="page-header">
                    <h2>üë• ÏÇ¨Ïö©Ïûê Í¥ÄÎ¶¨</h2>
                    <p>ÏãúÏä§ÌÖú ÏÇ¨Ïö©ÏûêÎ•º Í¥ÄÎ¶¨ÌïòÍ≥† Í∂åÌïúÏùÑ ÏÑ§Ï†ïÌïòÏÑ∏Ïöî.</p>
                    
                    <div class="header-actions">
                        <div class="search-box">
                            <input type="text" id="user-search" placeholder="ÏÇ¨Ïö©Ïûê Í≤ÄÏÉâ (Ïù¥Î¶Ñ, ÏïÑÏù¥Îîî, Î∂ÄÏÑú)">
                            <button onclick="UsersModule.searchUsers()">üîç</button>
                        </div>
                        <button class="btn-primary" onclick="UsersModule.showAddUserModal()">
                            <i class="fas fa-plus"></i> ÏÉà ÏÇ¨Ïö©Ïûê
                        </button>
                        <button class="btn-secondary" onclick="UsersModule.exportUsers()" style="background: #28a745; margin-left: 10px;">
                            <i class="fas fa-download"></i> ÎÇ¥Î≥¥ÎÇ¥Í∏∞
                        </button>
                    </div>
                </div>

                <!-- ÏÇ¨Ïö©Ïûê ÌÜµÍ≥Ñ Ïπ¥Îìú -->
                <div class="users-stats">
                    <div class="stat-card">
                        <div class="stat-header">
                            <span class="stat-icon">üë§</span>
                            <span class="stat-title">Ï†ÑÏ≤¥ ÏÇ¨Ïö©Ïûê</span>
                        </div>
                        <div class="stat-value" id="total-users-count">-</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-header">
                            <span class="stat-icon">‚úÖ</span>
                            <span class="stat-title">ÌôúÏÑ± ÏÇ¨Ïö©Ïûê</span>
                        </div>
                        <div class="stat-value" id="active-users-count">-</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-header">
                            <span class="stat-icon">üîí</span>
                            <span class="stat-title">Í¥ÄÎ¶¨Ïûê</span>
                        </div>
                        <div class="stat-value" id="admin-users-count">-</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-header">
                            <span class="stat-icon">‚ö†Ô∏è</span>
                            <span class="stat-title">ÎπÑÌôúÏÑ± ÏÇ¨Ïö©Ïûê</span>
                        </div>
                        <div class="stat-value" id="inactive-users-count">-</div>
                    </div>
                </div>

                <!-- ÌïÑÌÑ∞ ÏòµÏÖò -->
                <div class="filter-section">
                    <div class="filter-group">
                        <label for="role-filter">Ïó≠Ìï† ÌïÑÌÑ∞:</label>
                        <select id="role-filter" onchange="UsersModule.filterUsers()">
                            <option value="">Ï†ÑÏ≤¥ Ïó≠Ìï†</option>
                            <option value="admin">Í¥ÄÎ¶¨Ïûê</option>
                            <option value="manager">Îã¥ÎãπÏûê</option>
                            <option value="viewer">Ïó¥ÎûåÏûê</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label for="status-filter">ÏÉÅÌÉú ÌïÑÌÑ∞:</label>
                        <select id="status-filter" onchange="UsersModule.filterUsers()">
                            <option value="">Ï†ÑÏ≤¥ ÏÉÅÌÉú</option>
                            <option value="active">ÌôúÏÑ±</option>
                            <option value="inactive">ÎπÑÌôúÏÑ±</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <button onclick="UsersModule.clearFilters()" class="btn-secondary">
                            <i class="fas fa-times"></i> ÌïÑÌÑ∞ Ï¥àÍ∏∞Ìôî
                        </button>
                    </div>
                </div>

                <!-- ÏÇ¨Ïö©Ïûê Î™©Î°ù ÌÖåÏù¥Î∏î -->
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>
                                    <input type="checkbox" id="select-all-users" onchange="UsersModule.toggleSelectAll()">
                                </th>
                                <th onclick="UsersModule.sortBy('id')" class="sortable">ID</th>
                                <th onclick="UsersModule.sortBy('username')" class="sortable">ÏÇ¨Ïö©ÏûêÎ™Ö</th>
                                <th onclick="UsersModule.sortBy('role')" class="sortable">Ïó≠Ìï†</th>
                                <th>Î∂ÄÏÑú</th>
                                <th>Ï†ÑÌôîÎ≤àÌò∏</th>
                                <th>Îã¥Îãπ ÏÇ¨ÏóÖÏû•</th>
                                <th>Ï†ëÍ∑º ÏÇ¨ÏóÖÏû•</th>
                                <th onclick="UsersModule.sortBy('is_active')" class="sortable">ÏÉÅÌÉú</th>
                                <th>ÏµúÍ∑º Ï†ëÏÜç</th>
                                <th>Í¥ÄÎ¶¨</th>
                            </tr>
                        </thead>
                        <tbody id="users-table-body">
                            <tr>
                                <td colspan="11" class="loading-row">
                                    <i class="fas fa-spinner fa-spin"></i> ÏÇ¨Ïö©Ïûê Î™©Î°ùÏùÑ Î∂àÎü¨Ïò§Îäî Ï§ë...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- ÌéòÏù¥ÏßÄÎÑ§Ïù¥ÏÖò -->
                <div class="pagination">
                    <button onclick="UsersModule.changePage(-1)" id="prev-page-btn">Ïù¥Ï†Ñ</button>
                    <span id="page-info">1 / 1</span>
                    <button onclick="UsersModule.changePage(1)" id="next-page-btn">Îã§Ïùå</button>
                    
                    <div class="page-size-selector">
                        <label for="page-size">ÌëúÏãú Í∞úÏàò:</label>
                        <select id="page-size" onchange="UsersModule.changePageSize()">
                            <option value="10">10Í∞ú</option>
                            <option value="20" selected>20Í∞ú</option>
                            <option value="50">50Í∞ú</option>
                            <option value="100">100Í∞ú</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- ÏóÖÏ≤¥ Ï∂îÍ∞Ä/ÏàòÏ†ï Î™®Îã¨ -->
            <div id="supplier-modal" class="modal hidden">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 id="supplier-modal-title">ÏÉà ÏóÖÏ≤¥ Îì±Î°ù</h3>
                        <button class="close-btn" onclick="closeSupplierModal()">√ó</button>
                    </div>
                    <div class="modal-body">
                        <form id="supplier-form">
                            <input type="hidden" id="supplier-id">
                            
                            <div class="form-group">
                                <label>ÌòëÎ†•ÏóÖÏ≤¥Î™Ö <span style="color: red;">*</span></label>
                                <input type="text" id="supplier-name" required placeholder="Ïòà: CJÌîÑÎ†àÏãúÏõ®Ïù¥, Ïõ∞Ïä§ÌÜ†Î¶¨">
                            </div>

                            <div class="form-group">
                                <label>ÎåÄÌëúÏûê</label>
                                <input type="text" id="supplier-representative" placeholder="ÎåÄÌëúÏûêÎ™ÖÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî">
                            </div>

                            <div class="form-group">
                                <label>Îã¥ÎãπÏûê</label>
                                <input type="text" id="supplier-contact" placeholder="Îã¥ÎãπÏûêÎ™ÖÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî">
                            </div>

                            <div class="form-group">
                                <label>Ìå©Ïä§Î≤àÌò∏</label>
                                <input type="text" id="supplier-fax" placeholder="Ïòà: 02-1234-5679">
                            </div>

                            <div class="form-group">
                                <label>Ïù¥Î©îÏùº</label>
                                <input type="email" id="supplier-email" placeholder="Ïòà: contact@company.com">
                            </div>

                            <div class="form-group">
                                <label>ÏÇ¨ÏóÖÏûêÎ≤àÌò∏</label>
                                <input type="text" id="supplier-business-number" placeholder="Ïòà: 123-45-67890">
                            </div>

                            <div class="form-group">
                                <label>ÏóÖÎ™©</label>
                                <input type="text" id="supplier-business-item" placeholder="Ï£ºÏöî Ï∑®Í∏â ÌíàÎ™©">
                            </div>

                            <div class="form-group">
                                <label>Îã¥ÎãπÏûê Ïó∞ÎùΩÏ≤ò</label>
                                <input type="text" id="supplier-manager-name" placeholder="Îã¥ÎãπÏûêÎ™Ö">
                            </div>

                            <div class="form-group">
                                <label>Îã¥ÎãπÏûê Ï†ÑÌôîÎ≤àÌò∏</label>
                                <input type="text" id="supplier-manager-phone" placeholder="Îã¥ÎãπÏûê Ï†ÑÌôîÎ≤àÌò∏">
                            </div>
                            
                            <div class="form-group">
                                <label>ÏóÖÏ≤¥ÏΩîÎìú (Î™®ÏΩîÎìú)</label>
                                <input type="text" id="supplier-parent-code" maxlength="10" placeholder="Ïòà: CJ001, Ïõ∞Ïä§ÌÜ†Î¶¨001">
                                <small class="form-hint">ÌòëÎ†•ÏóÖÏ≤¥ÏóêÏÑú Î∂ÄÏó¨Ìïú Í≥†Ïú†ÏΩîÎìú</small>
                            </div>

                            <div class="form-group">
                                <label>ÏÇ¨ÏóÖÏû•ÏΩîÎìú</label>
                                <input type="text" id="supplier-site-code" maxlength="20" placeholder="ÏÇ¨ÏóÖÏû• Í≥†Ïú†ÏΩîÎìú">
                            </div>

                            <div class="form-group">
                                <label>ÏÇ¨ÏóÖÏû•Î™Ö</label>
                                <input type="text" id="supplier-site-name" placeholder="ÏÇ¨ÏóÖÏû•Î™ÖÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî">
                            </div>
                            
                            <div class="form-group">
                                <label>ÏóÖÏ≤¥ Ïú†Ìòï</label>
                                <select id="supplier-business-type">
                                    <option value="">Ïú†ÌòïÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</option>
                                    <option value="ÏãùÏûêÏû¨ÎÇ©Ìíà">ÏãùÏûêÏû¨ ÎÇ©ÌíàÏóÖÏ≤¥</option>
                                    <option value="ÏÑúÎπÑÏä§">ÏÑúÎπÑÏä§ ÏóÖÏ≤¥</option>
                                    <option value="Ïû•ÎπÑ">Ïû•ÎπÑ/ÏãúÏÑ§ ÏóÖÏ≤¥</option>
                                    <option value="Í∏∞ÌÉÄ">Í∏∞ÌÉÄ</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label>Ïó∞ÎùΩÏ≤ò</label>
                                <input type="text" id="supplier-phone" placeholder="Ïòà: 02-1234-5678">
                            </div>
                            
                            <div class="form-group">
                                <label>Ï£ºÏÜå</label>
                                <textarea id="supplier-address" rows="2" placeholder="ÏóÖÏ≤¥ Ï£ºÏÜåÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî"></textarea>
                            </div>
                            
                            <div class="form-group">
                                <label>ÏóÖÎç∞Ïù¥Ìä∏ Ï£ºÍ∏∞</label>
                                <select id="supplier-update-frequency">
                                    <option value="daily">Îß§Ïùº</option>
                                    <option value="weekly" selected>Ï£ºÍ∞Ñ</option>
                                    <option value="monthly">ÏõîÍ∞Ñ</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="supplier-is-active" checked>
                                    ÌôúÏÑ± ÏÉÅÌÉú
                                </label>
                            </div>
                            
                            <div class="form-group">
                                <label>ÎπÑÍ≥†</label>
                                <textarea id="supplier-notes" rows="2" placeholder="ÌäπÏù¥ÏÇ¨Ìï≠Ïù¥ÎÇò Î©îÎ™®Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî"></textarea>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn-secondary" onclick="closeSupplierModal()">Ï∑®ÏÜå</button>
                        <button type="button" class="btn-primary" onclick="saveSupplier()">Ï†ÄÏû•</button>
                    </div>
                </div>
            </div>

            <!-- ÏÇ¨Ïö©Ïûê Ï∂îÍ∞Ä/ÏàòÏ†ï Î™®Îã¨ -->
            <div id="user-modal" class="modal hidden">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 id="modal-title">ÏÉà ÏÇ¨Ïö©Ïûê Ï∂îÍ∞Ä</h3>
                        <button class="modal-close" onclick="closeUserModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <form id="user-form">
                            <div class="form-group">
                                <label>ÏÇ¨Ïö©Ïûê ID</label>
                                <input type="text" id="user-username" required>
                            </div>
                            <div class="form-group">
                                <label>ÎπÑÎ∞ÄÎ≤àÌò∏</label>
                                <input type="password" id="user-password">
                                <small>ÏàòÏ†ï Ïãú ÎπÑÏõåÎëêÎ©¥ Î≥ÄÍ≤ΩÌïòÏßÄ ÏïäÏùå</small>
                            </div>
                            <div class="form-group">
                                <label>Ïó≠Ìï†</label>
                                <select id="user-role" required>
                                    <option value="">ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</option>
                                    <option value="nutritionist">ÏòÅÏñëÏÇ¨</option>
                                    <option value="admin">Í¥ÄÎ¶¨Ïûê</option>
                                    <option value="super_admin">ÏµúÍ≥†Í¥ÄÎ¶¨Ïûê</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Ïó∞ÎùΩÏ≤ò</label>
                                <input type="text" id="user-contact">
                            </div>
                            <div class="form-group">
                                <label>Î∂ÄÏÑú</label>
                                <input type="text" id="user-department">
                            </div>
                            <div class="form-group">
                                <label>ÏßÅÏ±Ö</label>
                                <input type="text" id="user-position">
                            </div>
                            <div class="form-group">
                                <label>Îã¥Îãπ ÏÇ¨ÏóÖÏû•</label>
                                <select id="user-managed-site">
                                    <option value="">ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</option>
                                    <!-- ÎèôÏ†ÅÏúºÎ°ú Î°úÎìúÎê† ÏÇ¨ÏóÖÏû• Î™©Î°ù -->
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Ï†ÑÌôîÎ≤àÌò∏</label>
                                <input type="tel" id="user-phone" placeholder="010-1234-5678">
                            </div>
                            <div class="form-group">
                                <label>ÏÉùÎÖÑÏõîÏùº</label>
                                <input type="date" id="user-birth-date">
                            </div>
                            <div class="form-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="user-is-active" checked>
                                    ÌôúÏÑ± ÏÉÅÌÉú
                                </label>
                            </div>
                            <div class="form-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="user-operator">
                                    Ïö¥ÏòÅÏûê Í∂åÌïú
                                </label>
                            </div>
                            <div class="form-group">
                                <label>Ï†ëÍ∑º Í∞ÄÎä•Ìïú ÏÇ¨ÏóÖÏû•</label>
                                <div id="user-sites-container" style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 4px;">
                                    <label class="checkbox-label" style="margin-bottom: 10px;">
                                        <input type="checkbox" id="sites-all" onchange="toggleAllSites(this)">
                                        <strong>Î™®Îì† ÏÇ¨ÏóÖÏû•</strong>
                                    </label>
                                    <div id="sites-list">
                                        <!-- ÎèôÏ†ÅÏúºÎ°ú Î°úÎìúÎê† ÏÇ¨ÏóÖÏû• Ï≤¥ÌÅ¨Î∞ïÏä§ Î™©Î°ù -->
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="user-semi-operator">
                                    Î∂ÄÏö¥ÏòÅÏûê Í∂åÌïú
                                </label>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn-secondary" onclick="closeUserModal()">Ï∑®ÏÜå</button>
                        <button type="button" class="btn-primary" onclick="saveUser()">Ï†ÄÏû•</button>
                    </div>
                </div>
            </div>

            <!-- ÏóÖÏ≤¥ Í¥ÄÎ¶¨ ÌéòÏù¥ÏßÄ -->
            <div id="suppliers-page" class="page-content hidden">
                <!-- ÏóÖÏ≤¥ Í¥ÄÎ¶¨ Ìó§Îçî -->
                <div class="page-header">
                    <div class="header-actions">
                        <div class="search-box">
                            <input type="text" id="supplier-search" placeholder="ÏóÖÏ≤¥Î™Ö, Ïó∞ÎùΩÏ≤ò, Ïù¥Î©îÏùºÎ°ú Í≤ÄÏÉâ...">
                            <select id="supplier-status-filter" style="margin-left: 10px;">
                                <option value="">Ï†ÑÏ≤¥ ÏÉÅÌÉú</option>
                                <option value="1">Í±∞ÎûòÏ§ë</option>
                                <option value="0">Í±∞ÎûòÏ§ëÎã®</option>
                            </select>
                        </div>
                        <button class="btn-primary" onclick="showAddSupplierModal()">+ ÏÉà ÏóÖÏ≤¥ Îì±Î°ù</button>
                        <button class="btn-secondary" onclick="initSupplierExtensions()" style="background: #17a2b8; margin-left: 10px;" title="Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§Ïóê ÏÉàÎ°úÏö¥ ÌïÑÎìúÎ•º Ï∂îÍ∞ÄÌïòÏó¨ ÏóÖÏ≤¥ Í¥ÄÎ¶¨ Í∏∞Îä•ÏùÑ ÌôïÏû•Ìï©ÎãàÎã§">‚öôÔ∏è DB ÌôïÏû•</button>
                    </div>
                </div>

                <!-- ÏóÖÏ≤¥ Î™©Î°ù ÌÖåÏù¥Î∏î -->
                <div class="content-section">
                    <table id="suppliers-table" class="data-table">
                        <thead>
                            <tr>
                                <th>Î™®ÏΩîÎìú</th>
                                <th>ÏÇ¨ÏóÖÏû•ÏΩîÎìú</th>
                                <th>ÏÇ¨ÏóÖÏû•Î™Ö</th>
                                <th>ÏóÖÏ≤¥Î™Ö</th>
                                <th>Ïó∞ÎùΩÏ≤ò</th>
                                <th>Ïù¥Î©îÏùº</th>
                                <th>Í±∞ÎûòÏÉÅÌÉú</th>
                                <th>ÏÇ¨ÏóÖÏûêÎ≤àÌò∏</th>
                                <th>ÎåÄÌëúÏûê</th>
                                <th>Îã¥ÎãπÏûê</th>
                                <th>Í¥ÄÎ¶¨</th>
                            </tr>
                        </thead>
                        <tbody id="suppliers-table-body">
                            <tr>
                                <td colspan="11" class="loading">ÏóÖÏ≤¥ Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§Îäî Ï§ë...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="business-locations-page" class="page-content hidden">
                <div class="page-header">
                    <h3>ÏÇ¨ÏóÖÏû• Í¥ÄÎ¶¨</h3>
                    <button class="btn-primary" onclick="showAddSiteModal('ÏùºÎ∞ò')">+ ÏÇ¨ÏóÖÏû• Ï∂îÍ∞Ä</button>
                </div>
                <div class="sites-container">
                    <div class="sites-tree">
                        <div id="sites-tree">
                            <!-- ÏÇ¨ÏóÖÏû• Ìä∏Î¶¨Í∞Ä Ïó¨Í∏∞Ïóê Î°úÎìúÎê©ÎãàÎã§ -->
                        </div>
                    </div>
                    <div class="sites-list">
                        <div id="sites-list">
                            <!-- ÏÇ¨ÏóÖÏû• Î™©Î°ùÏù¥ Ïó¨Í∏∞Ïóê Î°úÎìúÎê©ÎãàÎã§ -->
                        </div>
                    </div>
                </div>
            </div>

            <div id="supplier-mapping-page" class="page-content hidden">
                <div style="padding: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                        <h2>üîó ÏÇ¨ÏóÖÏû•-ÌòëÎ†•ÏóÖÏ≤¥ Îß§Ìïë Í¥ÄÎ¶¨</h2>
                        <button onclick="openMappingModal()" class="btn-primary">
                            <i class="fas fa-plus"></i> ÏÉà Îß§Ìïë Ï∂îÍ∞Ä
                        </button>
                    </div>

                    <!-- ÌïÑÌÑ∞ ÏÑπÏÖò -->
                    <div class="filter-section" style="background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 15px; align-items: end;">
                            <div class="form-group" style="margin: 0;">
                                <label>ÏÇ¨ÏóÖÏû• ÌïÑÌÑ∞</label>
                                <select id="mapping-customer-filter" onchange="filterMappings()">
                                    <option value="">Ï†ÑÏ≤¥ ÏÇ¨ÏóÖÏû•</option>
                                </select>
                            </div>
                            <div class="form-group" style="margin: 0;">
                                <label>ÌòëÎ†•ÏóÖÏ≤¥ ÌïÑÌÑ∞</label>
                                <select id="mapping-supplier-filter" onchange="filterMappings()">
                                    <option value="">Ï†ÑÏ≤¥ ÌòëÎ†•ÏóÖÏ≤¥</option>
                                </select>
                            </div>
                            <div class="form-group" style="margin: 0;">
                                <label>ÏÉÅÌÉú ÌïÑÌÑ∞</label>
                                <select id="mapping-status-filter" onchange="filterMappings()">
                                    <option value="">Ï†ÑÏ≤¥ ÏÉÅÌÉú</option>
                                    <option value="true">ÌôúÏÑ±</option>
                                    <option value="false">ÎπÑÌôúÏÑ±</option>
                                </select>
                            </div>
                            <div>
                                <button onclick="clearMappingFilters()" class="btn-secondary">ÌïÑÌÑ∞ Ï¥àÍ∏∞Ìôî</button>
                            </div>
                        </div>
                    </div>

                    <!-- Îß§Ìïë ÌÖåÏù¥Î∏î -->
                    <div class="table-container" style="background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>ÏÇ¨ÏóÖÏû•</th>
                                    <th>ÏÇ¨ÏóÖÏû•ÏΩîÎìú</th>
                                    <th>ÏÇ¨ÏóÖÏû•ÏÉÅÌÉú</th>
                                    <th>ÌòëÎ†•ÏóÖÏ≤¥</th>
                                    <th>ÏóÖÏ≤¥ÏΩîÎìú</th>
                                    <th>Î∞∞ÏÜ°ÏΩîÎìú</th>
                                    <th>Ïö∞ÏÑ†ÏàúÏúÑ</th>
                                    <th>Ï£ºÏöîÏóÖÏ≤¥</th>
                                    <th>Í≥ÑÏïΩÏãúÏûë</th>
                                    <th>Í≥ÑÏïΩÏ¢ÖÎ£å</th>
                                    <th>Îß§ÌïëÏÉÅÌÉú</th>
                                    <th>ÏÇ¨ÏóÖÏû•Í¥ÄÎ¶¨</th>
                                    <th>Îß§ÌïëÍ¥ÄÎ¶¨</th>
                                </tr>
                            </thead>
                            <tbody id="mappings-table-body">
                                <tr>
                                    <td colspan="14" class="loading">Îß§Ìïë Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§Îäî Ï§ë...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- ÌÜµÍ≥Ñ ÏÑπÏÖò -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 30px;">
                        <div class="stat-card">
                            <h3>Ï¥ù Îß§Ìïë</h3>
                            <div class="stat-value" id="total-mappings">0</div>
                        </div>
                        <div class="stat-card">
                            <h3>ÌôúÏÑ± Îß§Ìïë</h3>
                            <div class="stat-value" id="active-mappings">0</div>
                        </div>
                        <div class="stat-card">
                            <h3>Îß§ÌïëÎêú ÏÇ¨ÏóÖÏû•</h3>
                            <div class="stat-value" id="mapped-customers">0</div>
                        </div>
                        <div class="stat-card">
                            <h3>Îß§ÌïëÎêú ÌòëÎ†•ÏóÖÏ≤¥</h3>
                            <div class="stat-value" id="mapped-suppliers">0</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ÏÇ¨ÏóÖÏû• Ï∂îÍ∞Ä/ÏàòÏ†ï Î™®Îã¨ -->
            <div id="site-modal" class="modal hidden">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 id="site-modal-title">ÏÉà ÏÇ¨ÏóÖÏû• Ï∂îÍ∞Ä</h3>
                        <button class="modal-close" onclick="closeSiteModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <form id="site-form">
                            <input type="hidden" id="site-parent-id">
                            
                            <div class="form-group">
                                <label>ÏÇ¨ÏóÖÏû•Î™Ö</label>
                                <input type="text" id="site-name" required>
                            </div>
                            
                            <div class="form-group">
                                <label>Íµ¨Î∂Ñ</label>
                                <select id="site-type" required>
                                    <option value="">ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</option>
                                    <option value="ÎèÑÏãúÎùΩ">ÎèÑÏãúÎùΩ</option>
                                    <option value="Ïö¥Î∞ò">Ïö¥Î∞ò</option>
                                    <option value="ÌïôÍµê">ÌïôÍµê</option>
                                    <option value="ÏöîÏñëÏõê">ÏöîÏñëÏõê</option>
                                    <option value="ÏúÑÌÉÅ">ÏúÑÌÉÅ</option>
                                    <option value="ÏùºÎ∞òÏùåÏãùÏ†ê">ÏùºÎ∞òÏùåÏãùÏ†ê</option>
                                    <option value="Í∏∞ÌÉÄ">Í∏∞ÌÉÄ</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label>Îã¥ÎãπÏûê</label>
                                <input type="text" id="site-contact-person">
                            </div>
                            
                            <div class="form-group">
                                <label>Ïó∞ÎùΩÏ≤ò</label>
                                <input type="text" id="site-contact-phone">
                            </div>
                            
                            <div class="form-group">
                                <label>Ï£ºÏÜå</label>
                                <textarea id="site-address" rows="3"></textarea>
                            </div>
                            
                            <div class="form-group">
                                <label>1Ïù∏Îãπ Ï†úÍ≥µÎüâ (g)</label>
                                <input type="number" id="site-portion-size" min="0">
                            </div>
                            
                            <div class="form-group">
                                <label>ÏÑ§Î™Ö</label>
                                <textarea id="site-description" rows="3"></textarea>
                            </div>
                            
                            <div class="form-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="site-is-active" checked>
                                    ÌôúÏÑ± ÏÉÅÌÉú
                                </label>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn-secondary" onclick="closeSiteModal()">Ï∑®ÏÜå</button>
                        <button type="button" class="btn-primary" onclick="saveSite()">Ï†ÄÏû•</button>
                    </div>
                </div>
            </div>

            <!-- Îß§Ìïë Ï∂îÍ∞Ä/ÏàòÏ†ï Î™®Îã¨ -->
            <div id="mapping-modal" class="modal hidden">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 id="mapping-modal-title">ÏÉà Îß§Ìïë Ï∂îÍ∞Ä</h3>
                        <button class="modal-close" onclick="closeMappingModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <form id="mapping-form">
                            <input type="hidden" id="mapping-id">
                            
                            <!-- ÏÇ¨ÏóÖÏû• ÏÑ†ÌÉù (Í≥µÌÜµ) -->
                            <div class="form-group">
                                <label>ÏÇ¨ÏóÖÏû• ÏÑ†ÌÉù <span style="color: red;">*</span></label>
                                <select id="mapping-customer" required>
                                    <option value="">ÏÇ¨ÏóÖÏû•ÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</option>
                                </select>
                            </div>
                            
                            <!-- ÌòëÎ†•ÏóÖÏ≤¥ Îß§Ìïë Î™©Î°ù -->
                            <div class="form-group">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                    <label>ÌòëÎ†•ÏóÖÏ≤¥ Îß§Ìïë <span style="color: red;">*</span></label>
                                    <button type="button" class="btn-add" onclick="addSupplierRow()" title="ÌòëÎ†•ÏóÖÏ≤¥ Ï∂îÍ∞Ä">
                                        <i class="fas fa-plus"></i> ÌòëÎ†•ÏóÖÏ≤¥ Ï∂îÍ∞Ä
                                    </button>
                                </div>
                                
                                <div class="supplier-mapping-container" style="border: 1px solid #ddd; border-radius: 5px; padding: 10px; max-height: 400px; overflow-y: auto;">
                                    <div id="supplier-rows-container">
                                        <!-- Ï≤´ Î≤àÏß∏ ÌñâÏùÄ JavaScriptÎ°ú Ï∂îÍ∞ÄÎê® -->
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Í≥µÌÜµ ÏÑ§Ï†ï -->
                            <div class="form-group">
                                <label>Í≥ÑÏïΩ Í∏∞Í∞Ñ (Î™®Îì† ÌòëÎ†•ÏóÖÏ≤¥Ïóê Í≥µÌÜµ Ï†ÅÏö©)</label>
                                <div style="display: flex; gap: 10px;">
                                    <div style="flex: 1;">
                                        <label style="font-size: 12px; color: #666;">ÏãúÏûëÏùº</label>
                                        <input type="date" id="mapping-contract-start" style="width: 100%;">
                                    </div>
                                    <div style="flex: 1;">
                                        <label style="font-size: 12px; color: #666;">Ï¢ÖÎ£åÏùº</label>
                                        <input type="date" id="mapping-contract-end" style="width: 100%;">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>ÌäπÏù¥ÏÇ¨Ìï≠ (Î™®Îì† ÌòëÎ†•ÏóÖÏ≤¥Ïóê Í≥µÌÜµ Ï†ÅÏö©)</label>
                                <textarea id="mapping-notes" rows="3" placeholder="Í≥ÑÏïΩ Ï°∞Í±¥, ÌäπÏù¥ÏÇ¨Ìï≠ Îì±ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî"></textarea>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn-secondary" onclick="closeMappingModal()">Ï∑®ÏÜå</button>
                        <button type="button" class="btn-primary" onclick="saveMapping()">Ï†ÄÏû•</button>
                    </div>
                </div>
            </div>


            <!-- ÏãùÏûêÏû¨/ÏóÖÏ≤¥ Í¥ÄÎ¶¨ ÌéòÏù¥ÏßÄ -->
            <div id="ingredients-page" class="page-content hidden">
                <div class="page-header">
                    <h2>ÏãùÏûêÏû¨/ÏóÖÏ≤¥ Í¥ÄÎ¶¨</h2>
                    <div class="header-actions">
                        <button class="btn btn-primary" onclick="showUploadSection()">
                            <span class="icon">üìÅ</span>ÌååÏùº ÏóÖÎ°úÎìú
                        </button>
                        <button class="btn btn-secondary" onclick="downloadTemplate()">
                            <span class="icon">üìã</span>ÏñëÏãù Îã§Ïö¥Î°úÎìú
                        </button>
                        <button class="btn btn-secondary" onclick="initSupplierExtensions()" style="background: #17a2b8; margin-left: 10px;">
                            <span class="icon">‚öôÔ∏è</span>ÏóÖÏ≤¥ Í¥ÄÎ¶¨ ÌôïÏû•
                        </button>
                    </div>
                </div>
                
                <!-- ÌÉ≠ Î©îÎâ¥ -->
                <div class="tab-menu" style="display: flex; margin: 20px 0; border-bottom: 1px solid #ddd;">
                    <button class="tab-button active" onclick="showIngredientTab()" style="padding: 10px 20px; border: none; background: #f8f9fa; cursor: pointer; border-bottom: 2px solid #007bff;">
                        <span class="icon">ü•¨</span>ÏãùÏûêÏû¨ Í¥ÄÎ¶¨
                    </button>
                </div>

                <!-- ÏãùÏûêÏû¨ Í¥ÄÎ¶¨ ÌÉ≠ -->
                <div id="ingredient-tab-content" class="tab-content">
                    <!-- ÏóÖÎ°úÎìú Ï£ºÏùòÏÇ¨Ìï≠ -->
                    <div class="upload-notice">
                    <h3>üìã ÏóëÏÖÄÌååÏùº ÏàòÏ†ï Ï£ºÏùòÏÇ¨Ìï≠!</h3>
                    <div class="notice-content">
                        <p>ÏãùÏûêÏû¨ Îì±Î°ùÏùÑ ÏúÑÌïú Îã§Ïö¥Î°úÎìú ÏñëÏãù Î∞è Í∞Å ÏãùÏûêÏû¨ Ï†ïÎ≥¥Î≥∏ÌåêÎßå Î≥µÏÇ¨Ìï¥ÏÑú Î∂ôÏó¨ÎÑ£Í∏∞Îßå Ìï©ÎãàÎã§. ÏïÑÎûò Ï£ºÏùòÏÇ¨Ìï≠ Íº≠ Ï§ÄÏàòÌïòÏÑ∏Ïöî.</p>
                        
                        <div class="warning-item">
                            <strong>1. Ï≤´Î≤àÏß∏Ìñâ ÏàòÏ†ï Í∏àÏßÄ</strong>
                            <p>Ïª¨ÎüºÎ™Ö, Í∏∞Î≥∏ ÏãùÏûêÏû¨, Í≥†Ïú†ÏΩîÎìú Îì±... Ï†ïÏÑ±Ìïú ÏñëÏãù Í∏∞Ï§ÄÏ†ïÎ≥¥Î•º ÏàòÏ†ïÌïòÎ©¥ ÏïàÎê©ÎãàÎã§.</p>
                        </div>
                        
                        <div class="warning-item">
                            <strong>2. ÏãúÌä∏Î™©Ï†Å, ÏãúÌä∏ Ï∂îÍ∞Ä Îì±.. Í∏àÏßÄ</strong>
                            <p>Îã§Î•∏ Î™©Ï†ÅÏùò ÏóëÏÖÄÍ≥º Ìï©Î≥∏ Î∞è ÏàòÏ†ï ÏïàÎê©ÎãàÎã§ ÏñëÏãùÏùÑ ÏúÑÌïú Íµ¨Ï°∞Í∞Ä Î≥ÄÍ≤ΩÎêòÎ©¥ ÏïàÎê©ÎãàÎã§.</p>
                            <p>Ïù¥ Ïù¥ÏÉÅÏùÄ Í∞úÎ∞úÏûêÏóêÍ≤å Î¨∏ÏùòÌïòÏó¨ ÏùºÍ¥ÑÎ¶¨Ìï©ÎãàÎã§.</p>
                        </div>
                    </div>
                </div>

                <!-- ÌååÏùº ÏóÖÎ°úÎìú ÏÑπÏÖò -->
                <div id="upload-section" class="upload-section" style="display: none;">
                    <div class="upload-container">
                        <div class="upload-area" onclick="document.getElementById('file-input').click()">
                            <div class="upload-icon">üìÅ</div>
                            <div class="upload-text">
                                <h4>ÌååÏùºÏùÑ ÏÑ†ÌÉùÌïòÍ±∞ÎÇò Ïó¨Í∏∞Î°ú ÎìúÎûòÍ∑∏ÌïòÏÑ∏Ïöî</h4>
                                <p>ÏßÄÏõê ÌòïÏãù: .xlsx, .xls (ÏµúÎåÄ 10MB)</p>
                            </div>
                        </div>
                        <input type="file" id="file-input" accept=".xlsx,.xls" multiple style="display: none;">
                        
                        <div class="upload-progress" id="upload-progress" style="display: none;">
                            <div class="progress-bar">
                                <div class="progress-fill" id="progress-fill"></div>
                            </div>
                            <div class="progress-text" id="progress-text">ÏóÖÎ°úÎìú Ï§ë...</div>
                        </div>
                    </div>
                    
                    <div class="upload-actions">
                        <button class="btn btn-primary" onclick="uploadFiles()" id="upload-btn" disabled>
                            ÏóÖÎ°úÎìú ÏãúÏûë
                        </button>
                        <button class="btn btn-secondary" onclick="clearFiles()">
                            ÌååÏùº Ï¥àÍ∏∞Ìôî
                        </button>
                    </div>
                </div>

                <!-- ÏóÖÎ°úÎìú Í≤∞Í≥º -->
                <div id="upload-results" class="upload-results" style="display: none;">
                    <h3>ÏóÖÎ°úÎìú Í≤∞Í≥º</h3>
                    <div class="result-summary">
                        <div class="result-item success">
                            <span class="result-label">ÏÑ±Í≥µ:</span>
                            <span class="result-count" id="success-count">0</span>Í∞ú ÌååÏùº
                        </div>
                        <div class="result-item error">
                            <span class="result-label">Ïã§Ìå®:</span>
                            <span class="result-count" id="error-count">0</span>Í∞ú ÌååÏùº
                        </div>
                    </div>
                    
                    <div class="result-details" id="result-details">
                        <!-- ÏÉÅÏÑ∏ Í≤∞Í≥ºÍ∞Ä Ïó¨Í∏∞Ïóê ÌëúÏãúÎê©ÎãàÎã§ -->
                    </div>
                </div>

                <!-- ÏãùÏûêÏû¨ Î™©Î°ù -->
                <div class="ingredients-list">
                    <h3>Îì±Î°ùÎêú ÏãùÏûêÏû¨ Î™©Î°ù</h3>
                    <div class="list-controls">
                        <input type="text" id="ingredient-search" placeholder="ÏãùÏûêÏû¨Î™ÖÏúºÎ°ú Í≤ÄÏÉâ..." class="search-input">
                        <select id="supplier-filter" class="filter-select">
                            <option value="">Ï†ÑÏ≤¥ ÏóÖÏ≤¥</option>
                        </select>
                        <button class="btn btn-secondary" onclick="loadIngredientsList()">ÏÉàÎ°úÍ≥†Ïπ®</button>
                    </div>
                    
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>ÏãùÏûêÏû¨Î™Ö</th>
                                    <th>ÏóÖÏ≤¥</th>
                                    <th>Îã®ÏúÑ</th>
                                    <th>Îã®Í∞Ä</th>
                                    <th>ÏµúÏÜåÏ£ºÎ¨∏Îüâ</th>
                                    <th>Îì±Î°ùÏùº</th>
                                    <th>Í¥ÄÎ¶¨</th>
                                </tr>
                            </thead>
                            <tbody id="ingredients-tbody">
                                <tr>
                                    <td colspan="7" style="text-align: center; color: #666;">
                                        ÏãùÏûêÏû¨ Î™©Î°ùÏùÑ Î∂àÎü¨Ïò§Îäî Ï§ë...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                </div>
                
            </div>


            <!-- ÏãùÏàò Îì±Î°ù Í¥ÄÎ¶¨ ÌéòÏù¥ÏßÄ -->

            <div id="pricing-page" class="page-content hidden">
                <h2>üí∞ Îã®Í∞Ä Í¥ÄÎ¶¨</h2>
                <p style="color: #666; margin-bottom: 30px;">ÎÅºÎãàÎãπ ÌåêÎß§Í∞ÄÏôÄ Î™©Ìëú ÏãùÏû¨Î£åÎπÑÎ•º ÏÑ§Ï†ïÌïòÏó¨ ÌöåÏÇ¨ ÏàòÏùµÏùÑ Ï∂îÏ†ïÌï† Ïàò ÏûàÏäµÎãàÎã§.</p>
                
                <div class="pricing-controls" style="margin-bottom: 30px; display: flex; gap: 15px; align-items: center;">
                    <select id="pricing-customer-select" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; min-width: 200px;">
                        <option value="">ÏÇ¨ÏóÖÏû• ÏÑ†ÌÉù</option>
                    </select>
                    <select id="pricing-meal-type-filter" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="all">Î™®Îì† Íµ¨Î∂Ñ</option>
                        <option value="ÎèÑÏãúÎùΩ">ÎèÑÏãúÎùΩ</option>
                        <option value="Ïö¥Î∞ò">Ïö¥Î∞ò</option>
                        <option value="ÌïôÍµê">ÌïôÍµê</option>
                        <option value="ÏöîÏñëÏõê">ÏöîÏñëÏõê</option>
                        <option value="ÏúÑÌÉÅ">ÏúÑÌÉÅ</option>
                        <option value="ÏùºÎ∞òÏùåÏãùÏ†ê">ÏùºÎ∞òÏùåÏãùÏ†ê</option>
                        <option value="Í∏∞ÌÉÄ">Í∏∞ÌÉÄ</option>
                    </select>
                    <button onclick="loadPricingData()" style="padding: 8px 16px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        <i class="fas fa-search"></i> Ï°∞Ìöå
                    </button>
                    <button onclick="savePricingData()" style="padding: 8px 16px; background: #27ae60; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        <i class="fas fa-save"></i> Ï†ÄÏû•
                    </button>
                </div>

                <div class="pricing-table-container" style="background: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <div class="pricing-summary" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px;">
                        <div class="summary-card" style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 6px;">
                            <div style="font-size: 14px; color: #666;">Ï¥ù ÏÑ§Ï†ï Ìï≠Î™©</div>
                            <div id="total-items" style="font-size: 24px; font-weight: bold; color: #2c3e50;">0</div>
                        </div>
                        <div class="summary-card" style="text-align: center; padding: 15px; background: #e8f5e8; border-radius: 6px;">
                            <div style="font-size: 14px; color: #666;">ÌèâÍ∑† ÌåêÎß§Í∞Ä</div>
                            <div id="avg-price" style="font-size: 24px; font-weight: bold; color: #27ae60;">0Ïõê</div>
                        </div>
                        <div class="summary-card" style="text-align: center; padding: 15px; background: #fff3cd; border-radius: 6px;">
                            <div style="font-size: 14px; color: #666;">ÌèâÍ∑† Ïû¨Î£åÎπÑ</div>
                            <div id="avg-cost" style="font-size: 24px; font-weight: bold; color: #f39c12;">0Ïõê</div>
                        </div>
                        <div class="summary-card" style="text-align: center; padding: 15px; background: #d1ecf1; border-radius: 6px;">
                            <div style="font-size: 14px; color: #666;">ÌèâÍ∑† ÏàòÏùµÎ•†</div>
                            <div id="avg-margin" style="font-size: 24px; font-weight: bold; color: #17a2b8;">0%</div>
                        </div>
                    </div>

                    <div class="pricing-table-wrapper" style="overflow-x: auto;">
                        <table id="pricing-table" style="width: 100%; border-collapse: collapse; min-width: 800px;">
                            <thead>
                                <tr style="background: #f8f9fa;">
                                    <th style="padding: 12px; border: 1px solid #dee2e6; text-align: left; font-weight: 600;">ÏÇ¨ÏóÖÏû•Î™Ö</th>
                                    <th style="padding: 12px; border: 1px solid #dee2e6; text-align: left; font-weight: 600;">Íµ¨Î∂Ñ</th>
                                    <th style="padding: 12px; border: 1px solid #dee2e6; text-align: left; font-weight: 600;">ÏãùÏÇ¨ Íµ¨Î∂Ñ</th>
                                    <th style="padding: 12px; border: 1px solid #dee2e6; text-align: center; font-weight: 600;">ÌåêÎß§Í∞Ä (Ïõê)</th>
                                    <th style="padding: 12px; border: 1px solid #dee2e6; text-align: center; font-weight: 600;">Î™©Ìëú Ïû¨Î£åÎπÑ (Ïõê)</th>
                                    <th style="padding: 12px; border: 1px solid #dee2e6; text-align: center; font-weight: 600;">ÏàòÏùµÎ•† (%)</th>
                                    <th style="padding: 12px; border: 1px solid #dee2e6; text-align: center; font-weight: 600;">ÏàòÏ†ïÏùº</th>
                                </tr>
                            </thead>
                            <tbody id="pricing-table-body">
                                <tr>
                                    <td colspan="7" style="padding: 40px; text-align: center; color: #666;">
                                        ÏÇ¨ÏóÖÏû•ÏùÑ ÏÑ†ÌÉùÌïòÍ≥† Ï°∞Ìöå Î≤ÑÌäºÏùÑ ÌÅ¥Î¶≠Ìï¥Ï£ºÏÑ∏Ïöî.
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="pricing-help" style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #3498db;">
                    <h4 style="margin: 0 0 10px 0; color: #2c3e50;">üí° ÏÇ¨Ïö© Í∞ÄÏù¥Îìú</h4>
                    <ul style="margin: 0; padding-left: 20px; color: #555;">
                        <li>ÌåêÎß§Í∞Ä: Ìï¥Îãπ ÎÅºÎãàÏùò Ïã§Ï†ú ÌåêÎß§ Í∏àÏï°ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî.</li>
                        <li>Î™©Ìëú Ïû¨Î£åÎπÑ: Ìï¥Îãπ ÌåêÎß§Í∞ÄÏóê ÎßûÎäî Î™©Ìëú ÏãùÏû¨Î£å ÎπÑÏö©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî.</li>
                        <li>ÏàòÏùµÎ•†ÏùÄ ÏûêÎèôÏúºÎ°ú Í≥ÑÏÇ∞Îê©ÎãàÎã§: ((ÌåêÎß§Í∞Ä - Ïû¨Î£åÎπÑ) / ÌåêÎß§Í∞Ä) √ó 100</li>
                        <li>Îπà Í∞íÏúºÎ°ú ÎëêÎ©¥ Ìï¥Îãπ Ìï≠Î™©ÏùÄ Ï†ÄÏû•ÎêòÏßÄ ÏïäÏäµÎãàÎã§.</li>
                        <li>Ïù¥ Îç∞Ïù¥ÌÑ∞Îäî ÌöåÏÇ¨Ïùò ÏàòÏùµ Ï∂îÏ†ïÏùÑ ÏúÑÌïú ÏûêÎ£åÎ°ú ÌôúÏö©Îê©ÎãàÎã§.</li>
                    </ul>
                </div>
            </div>

            <div id="settings-page" class="page-content hidden">
                <div class="page-header">
                    <h2>‚öôÔ∏è ÏãúÏä§ÌÖú ÏÑ§Ï†ï</h2>
                    <p>ÏãúÏä§ÌÖú Ï†ÑÎ∞òÏ†ÅÏù∏ ÏÑ§Ï†ïÏùÑ Í¥ÄÎ¶¨Ìï©ÎãàÎã§.</p>
                </div>

                <div class="settings-container">
                    <!-- Í∏∞Î≥∏ ÏÑ§Ï†ï ÏÑπÏÖò -->
                    <div class="section-card">
                        <h3>üîß Í∏∞Î≥∏ ÏÑ§Ï†ï</h3>
                        <div class="settings-group">
                            <div class="setting-item">
                                <label for="system-name">ÏãúÏä§ÌÖú Ïù¥Î¶Ñ</label>
                                <input type="text" id="system-name" value="Îã§Ìï®ÏãùÎã®Í¥ÄÎ¶¨" />
                            </div>
                            <div class="setting-item">
                                <label for="system-version">Î≤ÑÏ†Ñ Ï†ïÎ≥¥</label>
                                <input type="text" id="system-version" value="v1.0.0" readonly />
                            </div>
                        </div>
                    </div>

                    <!-- ÏÇ¨Ïö©Ïûê ÏÑ§Ï†ï ÏÑπÏÖò -->
                    <div class="section-card">
                        <h3>üë§ ÏÇ¨Ïö©Ïûê ÏÑ§Ï†ï</h3>
                        <div class="settings-group">
                            <div class="setting-item">
                                <label for="default-page">Í∏∞Î≥∏ ÌéòÏù¥ÏßÄ</label>
                                <select id="default-page">
                                    <option value="dashboard">ÎåÄÏãúÎ≥¥Îìú</option>
                                    <option value="users">ÏÇ¨Ïö©Ïûê Í¥ÄÎ¶¨</option>
                                    <option value="suppliers">ÌòëÎ†•ÏóÖÏ≤¥ Í¥ÄÎ¶¨</option>
                                    <option value="business-locations">ÏÇ¨ÏóÖÏû• Í¥ÄÎ¶¨</option>
                                </select>
                            </div>
                            <div class="setting-item">
                                <label for="items-per-page">ÌéòÏù¥ÏßÄÎãπ ÌëúÏãú Ìï≠Î™©</label>
                                <select id="items-per-page">
                                    <option value="10">10Í∞ú</option>
                                    <option value="20" selected>20Í∞ú</option>
                                    <option value="50">50Í∞ú</option>
                                    <option value="100">100Í∞ú</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- ÏãúÏä§ÌÖú Ï†ïÎ≥¥ ÏÑπÏÖò -->
                    <div class="section-card">
                        <h3>‚ÑπÔ∏è ÏãúÏä§ÌÖú Ï†ïÎ≥¥</h3>
                        <div class="settings-group">
                            <div class="info-item">
                                <span class="info-label">Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ ÏÉÅÌÉú:</span>
                                <span class="info-value status-active" id="db-status">Ïó∞Í≤∞Îê®</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">ÎßàÏßÄÎßâ Î∞±ÏóÖ:</span>
                                <span class="info-value" id="last-backup">-</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">ÏÇ¨Ïö©Ïûê Ïàò:</span>
                                <span class="info-value" id="user-count">-</span>
                            </div>
                        </div>
                    </div>

                    <!-- Îç∞Ïù¥ÌÑ∞ Í¥ÄÎ¶¨ ÏÑπÏÖò -->
                    <div class="section-card">
                        <h3>üíæ Îç∞Ïù¥ÌÑ∞ Í¥ÄÎ¶¨</h3>
                        <div class="settings-group">
                            <button onclick="SettingsModule.createBackup()" class="btn btn-primary">
                                <i class="fas fa-save"></i> Îç∞Ïù¥ÌÑ∞ Î∞±ÏóÖ ÏÉùÏÑ±
                            </button>
                            <button onclick="SettingsModule.checkSystemHealth()" class="btn btn-secondary">
                                <i class="fas fa-heartbeat"></i> ÏãúÏä§ÌÖú ÏÉÅÌÉú ÌôïÏù∏
                            </button>
                        </div>
                    </div>

                    <!-- Ï†ÄÏû• Î≤ÑÌäº -->
                    <div class="settings-actions">
                        <button onclick="SettingsModule.saveSettings()" class="btn btn-success">
                            <i class="fas fa-check"></i> ÏÑ§Ï†ï Ï†ÄÏû•
                        </button>
                        <button onclick="SettingsModule.resetSettings()" class="btn btn-warning">
                            <i class="fas fa-undo"></i> Í∏∞Î≥∏Í∞íÏúºÎ°ú Î¶¨ÏÖã
                        </button>
                    </div>
                </div>
            </div>


            <div id="meal-pricing-page" class="page-content hidden">
                <h2>üí∞ ÏãùÎã®Í∞Ä Í¥ÄÎ¶¨</h2>
                <p style="color: #666; margin-bottom: 30px;">Î∂ÄÎ¨∏Î≥Ñ ÏãùÎã®ÌëúÏùò ÏÑ∏Î∂ÄÏãùÎã®ÌëúÎ≥Ñ ÌåêÎß§Í∞Ä Î∞è Ïû¨Î£åÎπÑ Í∞ÄÏù¥ÎìúÎùºÏù∏ÏùÑ ÏÑ§Ï†ïÌï©ÎãàÎã§.</p>
                
                <!-- ÏãùÎã®Ìëú ÏÑ†ÌÉù -->
                <div class="section-card" style="margin-bottom: 30px;">
                    <h3>üçΩÔ∏è ÏÇ¨ÏóÖÏû•Î≥Ñ ÏãùÎã®Ìëú ÏÑ†ÌÉù</h3>
                    <div style="display: flex; gap: 15px; align-items: center; margin-top: 15px; flex-wrap: wrap;">
                        <div style="display: flex; flex-direction: column; gap: 5px;">
                            <label style="font-size: 12px; color: #666; font-weight: 500;">ÏÇ¨ÏóÖÏû• ÏÑ†ÌÉù</label>
                            <select id="businessLocationSelect" onchange="updateMealPlanOptions()" style="padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; min-width: 200px;">
                                <option value="">ÏÇ¨ÏóÖÏû•ÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</option>
                            </select>
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 5px;">
                            <label style="font-size: 12px; color: #666; font-weight: 500;">ÏãùÎã®Ìëú ÌÉÄÏûÖ</label>
                            <select id="mealPlanSelect" style="padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; min-width: 200px;" disabled>
                                <option value="">Î®ºÏ†Ä ÏÇ¨ÏóÖÏû•ÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</option>
                            </select>
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 5px;">
                            <label style="font-size: 12px; color: transparent; font-weight: 500;">Ï°∞Ìöå</label>
                            <button onclick="onMasterMealPlanChange()" style="padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">
                                <i class="fas fa-search"></i> ÏÑ∏Î∂ÄÏãùÎã®Ìëú Ï°∞Ìöå
                            </button>
                        </div>
                    </div>
                </div>

                <!-- ÏÑ∏Î∂ÄÏãùÎã®Ìëú Î™©Î°ù -->
                <div class="section-card">
                    <h3>üìã ÏÑ∏Î∂ÄÏãùÎã®Ìëú Í¥ÄÎ¶¨</h3>
                    <div id="detailedMealPlansContainer" style="margin-top: 20px;">
                        <p style="color: #888; text-align: center; padding: 40px;">ÏúÑÏóêÏÑú ÏãùÎã®ÌëúÎ•º ÏÑ†ÌÉùÌïòÎ©¥ ÏÑ∏Î∂ÄÏãùÎã®Ìëú Î™©Î°ùÏù¥ ÌëúÏãúÎê©ÎãàÎã§.</p>
                    </div>
                </div>

                <!-- ÏÑ∏Î∂ÄÏãùÎã®Ìëú Í∞ÄÍ≤© Î∞è Ïû¨Î£åÎπÑ Í¥ÄÎ¶¨ -->
                <div class="section-card" style="margin-top: 20px;">
                    <h3>üí∞ Í∞ÄÍ≤© Î∞è Ïû¨Î£åÎπÑ Í¥ÄÎ¶¨</h3>
                    <div id="pricingManagementContainer" style="margin-top: 20px;">
                        <p style="color: #888; text-align: center; padding: 40px;">ÏúÑÏóêÏÑú ÏÑ∏Î∂ÄÏãùÎã®ÌëúÎ•º Î∂àÎü¨Ïò® ÌõÑ Í∞ÄÍ≤© Í¥ÄÎ¶¨Í∞Ä Í∞ÄÎä•Ìï©ÎãàÎã§.</p>
                    </div>
                </div>

                <!-- Ï†ÄÏû• Î≤ÑÌäº -->
                <div style="text-align: center; margin-top: 30px;">
                    <button id="saveMealPricingBtn" onclick="saveMealPricing()" 
                            style="padding: 12px 30px; background: #27ae60; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; display: none;">
                        üíæ Í∞ÄÍ≤© Ï†ïÎ≥¥ Ï†ÄÏû•
                    </button>
                </div>
                        <div class="instruction-card" style="background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-left: 4px solid #e74c3c;">
                            <h4>üî™ Ï†ÑÏ≤òÎ¶¨ ÏßÄÏãúÏÑú</h4>
                            <p style="color: #666; margin: 10px 0;">ÏãùÏû¨Î£å Ï†ÑÏ≤òÎ¶¨ ÏûëÏóÖ ÏßÄÏãúÏÑúÎ•º Í¥ÄÎ¶¨Ìï©ÎãàÎã§.</p>
                            <div style="margin-top: 15px;">
                                <button onclick="window.open('preprocessing_management.html', '_blank')" style="padding: 8px 16px; background: #e74c3c; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;">
                                    Í¥ÄÎ¶¨
                                </button>
                                <button onclick="generatePreprocessingInstruction()" style="padding: 8px 16px; background: #95a5a6; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                    ÏùºÍ¥ÑÏÉùÏÑ±
                                </button>
                            </div>
                        </div>
                        
                        <div class="instruction-card" style="background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-left: 4px solid #f39c12;">
                            <h4>üç≥ Ï°∞Î¶¨ ÏßÄÏãúÏÑú</h4>
                            <p style="color: #666; margin: 10px 0;">Ï°∞Î¶¨ ÏûëÏóÖ ÏßÄÏãúÏÑúÎ•º Í¥ÄÎ¶¨Ìï©ÎãàÎã§.</p>
                            <div style="margin-top: 15px;">
                                <button onclick="window.open('cooking_instruction_management.html', '_blank')" style="padding: 8px 16px; background: #f39c12; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;">
                                    Í¥ÄÎ¶¨
                                </button>
                                <button onclick="generateCookingInstruction()" style="padding: 8px 16px; background: #95a5a6; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                    ÏùºÍ¥ÑÏÉùÏÑ±
                                </button>
                            </div>
                        </div>
                        
                        <div class="instruction-card" style="background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-left: 4px solid #27ae60;">
                            <h4>üì¶ ÏÜåÎ∂Ñ ÏßÄÏãúÏÑú</h4>
                            <p style="color: #666; margin: 10px 0;">ÏÜåÎ∂Ñ ÏûëÏóÖ ÏßÄÏãúÏÑúÎ•º Í¥ÄÎ¶¨Ìï©ÎãàÎã§.</p>
                            <div style="margin-top: 15px;">
                                <button onclick="window.open('portion_instruction_management.html', '_blank')" style="padding: 8px 16px; background: #27ae60; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;">
                                    Í¥ÄÎ¶¨
                                </button>
                                <button onclick="generatePortionInstruction()" style="padding: 8px 16px; background: #95a5a6; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                    ÏùºÍ¥ÑÏÉùÏÑ±
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 30px; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <h4>üîÑ ÌÜµÌï© ÏûëÏóÖ ÌùêÎ¶Ñ</h4>
                        <p style="color: #666; margin: 10px 0;">ÎßàÏä§ÌÑ∞ ÏãùÎã®ÌëúÎ•º Í∏∞Ï§ÄÏúºÎ°ú Î™®Îì† ÏßÄÏãúÏÑúÎ•º ÌïúÎ≤àÏóê ÏÉùÏÑ±Ìï† Ïàò ÏûàÏäµÎãàÎã§.</p>
                        <div style="margin-top: 15px;">
                            <button onclick="generateAllInstructions()" style="padding: 12px 24px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;">
                                <i class="fas fa-magic"></i> Î™®Îì† ÏßÄÏãúÏÑú ÏùºÍ¥Ñ ÏÉùÏÑ±
                            </button>
                            <select id="instruction-date-select" style="padding: 12px; border: 1px solid #ddd; border-radius: 4px; margin-right: 10px;">
                                <option>ÏÉùÏÑ±Ìï† ÎÇ†Ïßú ÏÑ†ÌÉù</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- ÏùºÍ¥Ñ ÏÉùÏÑ±/Í¥ÄÎ¶¨ ÌÉ≠ -->
                <div id="batch-tab" class="meal-plan-tab-content hidden">
                    <h3>üöÄ ÏùºÍ¥Ñ ÏÉùÏÑ±/Í¥ÄÎ¶¨</h3>
                    <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin: 20px 0;">
                        <h4>üìÖ Í∏∞Í∞ÑÎ≥Ñ ÏãùÎã®Ìëú ÏùºÍ¥Ñ ÏÉùÏÑ±</h4>
                        <div style="display: flex; gap: 15px; margin: 15px 0; flex-wrap: wrap;">
                            <div>
                                <label>ÏãúÏûëÏùº:</label>
                                <input type="date" id="batch-start-date" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            <div>
                                <label>Ï¢ÖÎ£åÏùº:</label>
                                <input type="date" id="batch-end-date" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            <div>
                                <label>ÎåÄÏÉÅ:</label>
                                <select id="batch-target-type" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    <option value="all">Ï†ÑÏ≤¥</option>
                                    <option value="dosirak">ÎèÑÏãúÎùΩ</option>
                                    <option value="transport">Ïö¥Î∞ò</option>
                                    <option value="school">ÌïôÍµê</option>
                                    <option value="care">ÏöîÏñëÏõê</option>
                                </select>
                            </div>
                            <button onclick="batchGenerateMealPlans()" style="padding: 10px 20px; background: #e74c3c; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                <i class="fas fa-rocket"></i> ÏùºÍ¥Ñ ÏÉùÏÑ±
                            </button>
                        </div>
                    </div>
                    
                    <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <h4>üìä ÌÖúÌîåÎ¶ø Í∏∞Î∞ò ÏÉùÏÑ±</h4>
                        <p style="color: #666; margin-bottom: 15px;">Í∏∞Ï°¥ ÏãùÎã®ÌëúÎ•º ÌÖúÌîåÎ¶øÏúºÎ°ú ÌôúÏö©ÌïòÏó¨ ÏÉàÎ°úÏö¥ ÏãùÎã®ÌëúÎ•º ÏÉùÏÑ±Ìï©ÎãàÎã§.</p>
                        <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                            <select id="template-select" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; min-width: 200px;">
                                <option>ÌÖúÌîåÎ¶ø ÏÑ†ÌÉù...</option>
                            </select>
                            <input type="date" id="template-target-date" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <button onclick="createFromTemplate()" style="padding: 10px 20px; background: #27ae60; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                <i class="fas fa-copy"></i> ÌÖúÌîåÎ¶øÏúºÎ°ú ÏÉùÏÑ±
                            </button>
                        </div>
                    </div>
                </div>
            </div>


            <div id="logs-page" class="page-content hidden">
                <h2>Î°úÍ∑∏ Í¥ÄÎ¶¨ ÌéòÏù¥ÏßÄ</h2>
                <p>Î°úÍ∑∏ Í¥ÄÎ¶¨ Í∏∞Îä•Ïù¥ Ïó¨Í∏∞Ïóê Íµ¨ÌòÑÎê† ÏòàÏ†ïÏûÖÎãàÎã§.</p>
            </div>
        </main>
    </div>

    <!-- <script>
        // ÌéòÏù¥ÏßÄ ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò Í¥ÄÎ¶¨
        function showPage(pageName) {
            // Î™®Îì† ÌéòÏù¥ÏßÄ Ïà®Í∏∞Í∏∞
            document.querySelectorAll('.page-content').forEach(page => {
                page.classList.add('hidden');
            });
            
            // ÏÑ†ÌÉùÎêú ÌéòÏù¥ÏßÄ Î≥¥Ïù¥Í∏∞
            const targetPage = document.getElementById(`${pageName}-page`);
            if (targetPage) {
                targetPage.classList.remove('hidden');
            }
            
            // ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò ÌôúÏÑ± ÏÉÅÌÉú Î≥ÄÍ≤Ω
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            const activeItem = document.querySelector(`[data-page="${pageName}"]`);
            if (activeItem) {
                activeItem.classList.add('active');
            }
            
            // ÌéòÏù¥ÏßÄ Ï†úÎ™© Î≥ÄÍ≤Ω
            const titles = {
                'dashboard': 'Í¥ÄÎ¶¨Ïûê ÎåÄÏãúÎ≥¥Îìú',
                'users': 'ÏÇ¨Ïö©Ïûê Í¥ÄÎ¶¨',
                'suppliers': 'ÏóÖÏ≤¥ Í¥ÄÎ¶¨',
                'business-locations': 'ÏÇ¨ÏóÖÏû• Í¥ÄÎ¶¨',
                'supplier-mapping': 'Îß§Ìïë Í¥ÄÎ¶¨',
                'meal-pricing': 'ÏãùÎã®Í∞Ä Í¥ÄÎ¶¨',
                'ingredients': 'ÏãùÏûêÏû¨ Í¥ÄÎ¶¨',
                'pricing': 'Îã®Í∞Ä Í¥ÄÎ¶¨',
                'settings': 'ÏãúÏä§ÌÖú ÏÑ§Ï†ï',
                'logs': 'Î°úÍ∑∏ Í¥ÄÎ¶¨'
            };
            
            document.getElementById('page-title').textContent = titles[pageName] || 'Í¥ÄÎ¶¨Ïûê ÏãúÏä§ÌÖú';
        }


        // ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', (e) => {
                // target="_blank"Í∞Ä ÏûàÎäî ÎßÅÌÅ¨Îäî ÏÉà ÌÉ≠ÏóêÏÑú Ïó¥Î¶¨ÎèÑÎ°ù ÌóàÏö©
                if (e.currentTarget.getAttribute('target') === '_blank') {
                    return; // Í∏∞Î≥∏ ÎèôÏûë ÌóàÏö©
                }
                
                // hrefÍ∞Ä ÏûàÎäî Ïô∏Î∂Ä ÎßÅÌÅ¨(ÌòëÎ†•ÏóÖÏ≤¥ Í¥ÄÎ¶¨, ÏÇ¨ÏóÖÏû• Í¥ÄÎ¶¨, Í∏âÏãùÍ¥ÄÎ¶¨Î°ú Ïù¥Îèô)Îäî Í∏∞Î≥∏ ÎèôÏûë ÌóàÏö©
                const href = e.currentTarget.getAttribute('href');
                if (href && (href.startsWith('/admin/suppliers') || href.startsWith('/admin/business-locations') || href === '/')) {
                    return; // Í∏∞Î≥∏ ÎèôÏûë ÌóàÏö©
                }
                
                e.preventDefault();
                const pageName = e.currentTarget.getAttribute('data-page');
                showPage(pageName);
                
                // ÌéòÏù¥ÏßÄÎ≥Ñ Ï¥àÍ∏∞Ìôî
                if (pageName === 'users') {
                    loadUsers();
                    loadManagedSites();
                } else if (pageName === 'suppliers') {
                    loadSuppliers();
                } else if (pageName === 'business-locations') {
                    loadSitesTree();
                } else if (pageName === 'ingredients') {
                    loadIngredientsList();
                    loadSupplierFilter();
                }
            });
        });

        // Î°úÍ∑∏ÏïÑÏõÉ Ìï®Ïàò
        async function logout() {
            if (confirm('Î°úÍ∑∏ÏïÑÏõÉ ÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                try {
                    const response = await fetch('/api/auth/logout', {
                        method: 'POST',
                        credentials: 'include'  // Ïø†ÌÇ§ Ìè¨Ìï®
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        window.location.href = result.redirect || '/login';
                    } else {
                        console.error('Î°úÍ∑∏ÏïÑÏõÉ Ïã§Ìå®:', result.message);
                        window.location.href = '/login';  // Ïã§Ìå®Ìï¥ÎèÑ Î°úÍ∑∏Ïù∏ ÌéòÏù¥ÏßÄÎ°ú Ïù¥Îèô
                    }
                } catch (error) {
                    console.error('Î°úÍ∑∏ÏïÑÏõÉ Ï§ë Ïò§Î•ò:', error);
                    window.location.href = '/login';  // Ïò§Î•ò ÏãúÏóêÎèÑ Î°úÍ∑∏Ïù∏ ÌéòÏù¥ÏßÄÎ°ú Ïù¥Îèô
                }
            }
        }

        // ÎåÄÏãúÎ≥¥Îìú Îç∞Ïù¥ÌÑ∞ Î°úÎìú
        async function loadDashboardData() {
            try {
                // ÌÜµÍ≥Ñ Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞
                const response = await fetch('/api/admin/dashboard-stats');
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('total-users').textContent = data.totalUsers || 0;
                    document.getElementById('total-sites').textContent = data.totalSites || 0;
                    document.getElementById('today-menus').textContent = data.todayMenus || 0;
                    document.getElementById('price-updates').textContent = data.priceUpdates || 0;
                }
            } catch (error) {
                console.error('ÎåÄÏãúÎ≥¥Îìú Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®:', error);
            }
        }

        // ÏµúÍ∑º ÌôúÎèô Î°úÍ∑∏ Î°úÎìú
        async function loadRecentActivity() {
            try {
                const response = await fetch('/api/admin/recent-activity');
                const result = await response.json();
                const activities = result.activities || result.data || [];
                
                const activityList = document.getElementById('activity-list');
                if (activities.length === 0) {
                    activityList.innerHTML = '<div class="log-item">ÏµúÍ∑º ÌôúÎèôÏù¥ ÏóÜÏäµÎãàÎã§.</div>';
                    return;
                }
                
                activityList.innerHTML = activities.map(activity => `
                    <div class="log-item">
                        <div class="log-time">${activity.time}</div>
                        <div class="log-message">${activity.message}</div>
                        <div class="log-user">${activity.user}</div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('ÌôúÎèô Î°úÍ∑∏ Î°úÎìú Ïã§Ìå®:', error);
                document.getElementById('activity-list').innerHTML = 
                    '<div class="log-item">ÌôúÎèô Î°úÍ∑∏Î•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.</div>';
            }
        }

        // Ï†ÑÏó≠ Î≥ÄÏàòÎì§
        let pageInitialized = false;
        let allowModalDisplay = false;

        // ÌéòÏù¥ÏßÄ Î°úÎìúÏãú Ï¥àÍ∏∞Ìôî
        document.addEventListener('DOMContentLoaded', () => {
            console.log('ÌéòÏù¥ÏßÄ Ï¥àÍ∏∞Ìôî ÏãúÏûë');
            
            // Í∞ïÏ†úÎ°ú Î™®Îì† Î™®Îã¨ Ïà®ÍπÄ Ï≤òÎ¶¨
            setTimeout(() => {
                const userModal = document.getElementById('user-modal');
                const siteModal = document.getElementById('site-modal');
                
                if (userModal) {
                    userModal.style.display = 'none';
                    userModal.classList.add('hidden');
                    console.log('ÏÇ¨Ïö©Ïûê Î™®Îã¨ Í∞ïÏ†ú Ïà®ÍπÄ');
                }
                if (siteModal) {
                    siteModal.style.display = 'none';
                    siteModal.classList.add('hidden');
                    console.log('ÏÇ¨ÏóÖÏû• Î™®Îã¨ Í∞ïÏ†ú Ïà®ÍπÄ');
                }
                
                // Î≥ÄÏàò Ï¥àÍ∏∞Ìôî
                if (typeof currentEditUserId !== 'undefined') {
                    currentEditUserId = null;
                }
                if (typeof currentEditSiteId !== 'undefined') {
                    currentEditSiteId = null;
                }
                
                console.log('Î™®Îì† Î™®Îã¨ Ïà®ÍπÄ Ï≤òÎ¶¨ ÏôÑÎ£å');
                
                // Ï¥àÍ∏∞Ìôî ÏôÑÎ£å ÌõÑ 1Ï¥à Îí§Ïóê Î™®Îã¨ ÌëúÏãú ÌóàÏö©
                setTimeout(() => {
                    pageInitialized = true;
                    allowModalDisplay = true;
                    console.log('Î™®Îã¨ ÌëúÏãú ÌóàÏö©Îê®');
                }, 1000);
            }, 100);
            
            // Í∏∞Î≥∏ÏúºÎ°ú ÎåÄÏãúÎ≥¥Îìú ÌéòÏù¥ÏßÄ ÌëúÏãú
            console.log('ÎåÄÏãúÎ≥¥Îìú ÌéòÏù¥ÏßÄ ÌëúÏãú');
            showPage('dashboard');
            loadDashboardData();
            loadRecentActivity();
        });

        // ÏÇ¨Ïö©Ïûê Í¥ÄÎ¶¨ Í¥ÄÎ†® Î≥ÄÏàò
        let currentPage = 1;
        let totalPages = 1;
        let currentEditUserId = null;

        // ÏÇ¨Ïö©Ïûê Í¥ÄÎ¶¨ Ìï®ÏàòÎì§

        // ÏÇ¨Ïö©Ïûê Î™©Î°ù Î°úÎìú
        async function loadUsers() {
            try {
                const response = await fetch('/api/admin/users');
                const data = await response.json();
                
                if (data.success) {
                    displayUsers(data.users);
                    updatePagination(data.currentPage, data.totalPages);
                }
            } catch (error) {
                console.error('ÏÇ¨Ïö©Ïûê Î™©Î°ù Î°úÎìú Ïã§Ìå®:', error);
                document.getElementById('users-table-body').innerHTML = 
                    '<tr><td colspan="8">ÏÇ¨Ïö©Ïûê Î™©Î°ùÏùÑ Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.</td></tr>';
            }
        }

        // ÏÇ¨Ïö©Ïûê Î™©Î°ù ÌëúÏãú
        function displayUsers(users) {
            const tbody = document.getElementById('users-table-body');
            
            if (!users || users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8">Îì±Î°ùÎêú ÏÇ¨Ïö©ÏûêÍ∞Ä ÏóÜÏäµÎãàÎã§.</td></tr>';
                return;
            }
            
            tbody.innerHTML = users.map(user => `
                <tr>
                    <td>${user.id}</td>
                    <td>${user.username}</td>
                    <td>${getRoleDisplay(user.role)}</td>
                    <td>${user.department || '-'}</td>
                    <td>${user.phone_number || '-'}</td>
                    <td>${user.managed_site || '-'}</td>
                    <td>${user.assigned_sites_count || 0}Í∞ú ÏÇ¨ÏóÖÏû•</td>
                    <td><span class="${user.is_active ? 'status-active' : 'status-inactive'}">
                        ${user.is_active ? 'ÌôúÏÑ±' : 'ÎπÑÌôúÏÑ±'}
                    </span></td>
                    <td>
                        <button class="btn-small btn-edit" onclick="editUser(${user.id})">ÏàòÏ†ï</button>
                        <button class="btn-small btn-sites" onclick="manageSites(${user.id})" style="background: #17a2b8;">ÏÇ¨ÏóÖÏû•</button>
                        <button class="btn-small btn-reset" onclick="resetPassword(${user.id})" style="background: #fd7e14;">Ï¥àÍ∏∞Ìôî</button>
                        <button class="btn-small" onclick="toggleUserStatus(${user.id}, ${!user.is_active})" style="background: ${user.is_active ? '#dc3545' : '#28a745'};">
                            ${user.is_active ? 'ÎπÑÌôúÏÑ±Ìôî' : 'ÌôúÏÑ±Ìôî'}
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // Ïó≠Ìï† ÌëúÏãúÎ™Ö Î≥ÄÌôò
        function getRoleDisplay(role) {
            const roleMap = {
                'nutritionist': 'ÏòÅÏñëÏÇ¨',
                'admin': 'Í¥ÄÎ¶¨Ïûê', 
                'super_admin': 'ÏµúÍ≥†Í¥ÄÎ¶¨Ïûê'
            };
            return roleMap[role] || role;
        }

        // ÌéòÏù¥ÏßÄÎÑ§Ïù¥ÏÖò ÏóÖÎç∞Ïù¥Ìä∏
        function updatePagination(current, total) {
            currentPage = current;
            totalPages = total;
            document.getElementById('page-info').textContent = `${current} / ${total}`;
        }

        // ÌéòÏù¥ÏßÄ Î≥ÄÍ≤Ω
        function changePage(direction) {
            const newPage = currentPage + direction;
            if (newPage >= 1 && newPage <= totalPages) {
                currentPage = newPage;
                loadUsers();
            }
        }

        // ÏÇ¨Ïö©Ïûê Í≤ÄÏÉâ
        function searchUsers() {
            const keyword = document.getElementById('user-search').value;
            // Ïã§Ï†ú Íµ¨ÌòÑÏóêÏÑúÎäî Í≤ÄÏÉâ API Ìò∏Ï∂ú
            console.log('Í≤ÄÏÉâ ÌÇ§ÏõåÎìú:', keyword);
            loadUsers(); // ÏûÑÏãúÎ°ú Ï†ÑÏ≤¥ Î™©Î°ù Îã§Ïãú Î°úÎìú
        }

        // Îã¥Îãπ ÏÇ¨ÏóÖÏû• Î™©Î°ù Î°úÎìú
        async function loadManagedSites() {
            try {
                const response = await fetch('/api/admin/sites');
                const result = await response.json();
                const sites = result.sites || result.data || [];
                
                const select = document.getElementById('user-managed-site');
                select.innerHTML = '<option value="">ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</option>';
                
                sites.forEach(site => {
                    select.innerHTML += `<option value="${site.name}">${site.name}</option>`;
                });
            } catch (error) {
                console.error('ÏÇ¨ÏóÖÏû• Î™©Î°ù Î°úÎìú Ïã§Ìå®:', error);
            }
        }

        // ÏÉà ÏÇ¨Ïö©Ïûê Ï∂îÍ∞Ä Î™®Îã¨ ÌëúÏãú
        function showAddUserModal() {
            currentEditUserId = null;
            document.getElementById('modal-title').textContent = 'ÏÉà ÏÇ¨Ïö©Ïûê Ï∂îÍ∞Ä';
            document.getElementById('user-form').reset();
            document.getElementById('user-modal').classList.remove('hidden');
        }

        // ÏÇ¨Ïö©Ïûê ÏàòÏ†ï Î™®Îã¨ ÌëúÏãú
        async function editUser(userId) {
            try {
                const response = await fetch(`/api/admin/users/${userId}`);
                const result = await response.json();
                const user = result.user || result;
                
                if (user) {
                    currentEditUserId = userId;
                    document.getElementById('modal-title').textContent = 'ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ ÏàòÏ†ï';
                    
                    // ÌèºÏóê Í∏∞Ï°¥ Îç∞Ïù¥ÌÑ∞ Ï±ÑÏö∞Í∏∞
                    document.getElementById('user-username').value = user.username;
                    document.getElementById('user-password').value = ''; // ÎπÑÎ∞ÄÎ≤àÌò∏Îäî ÎπÑÏõÄ
                    document.getElementById('user-role').value = user.role;
                    document.getElementById('user-contact').value = user.contact_info || '';
                    document.getElementById('user-department').value = user.department || '';
                    document.getElementById('user-position').value = user.position || '';
                    document.getElementById('user-managed-site').value = user.managed_site || '';
                    document.getElementById('user-operator').checked = user.operator || false;
                    document.getElementById('user-semi-operator').checked = user.semi_operator || false;
                    
                    document.getElementById('user-modal').classList.remove('hidden');
                }
            } catch (error) {
                console.error('ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ Î°úÎìú Ïã§Ìå®:', error);
                alert('ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥Î•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.');
            }
        }

        // ÏÇ¨Ïö©Ïûê Î™®Îã¨ Îã´Í∏∞
        function closeUserModal() {
            document.getElementById('user-modal').classList.add('hidden');
            currentEditUserId = null;
        }

        // ÏÇ¨Ïö©Ïûê Ï†ÄÏû•
        async function saveUser() {
            const userData = {
                username: document.getElementById('user-username').value,
                password: document.getElementById('user-password').value,
                role: document.getElementById('user-role').value,
                contact_info: document.getElementById('user-contact').value,
                department: document.getElementById('user-department').value,
                position: document.getElementById('user-position').value,
                managed_site: document.getElementById('user-managed-site').value,
                operator: document.getElementById('user-operator').checked,
                semi_operator: document.getElementById('user-semi-operator').checked
            };

            try {
                const url = currentEditUserId ? 
                    `/api/admin/users/${currentEditUserId}` : 
                    '/api/admin/users';
                
                const method = currentEditUserId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(userData)
                });

                const result = await response.json();
                
                if (result.success) {
                    alert(currentEditUserId ? 'ÏÇ¨Ïö©ÏûêÍ∞Ä ÏàòÏ†ïÎêòÏóàÏäµÎãàÎã§.' : 'ÏÉà ÏÇ¨Ïö©ÏûêÍ∞Ä Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§.');
                    closeUserModal();
                    loadUsers();
                } else {
                    alert(result.message || 'Ï†ÄÏû• Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
                }
            } catch (error) {
                console.error('ÏÇ¨Ïö©Ïûê Ï†ÄÏû• Ïã§Ìå®:', error);
                alert('Ï†ÄÏû• Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
            }
        }

        // ÎπÑÎ∞ÄÎ≤àÌò∏ Ï¥àÍ∏∞Ìôî
        async function resetPassword(userId) {
            if (!confirm('Ïù¥ ÏÇ¨Ïö©ÏûêÏùò ÎπÑÎ∞ÄÎ≤àÌò∏Î•º Ï¥àÍ∏∞ÌôîÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                return;
            }

            try {
                const response = await fetch(`/api/admin/users/${userId}/reset-password`, {
                    method: 'POST'
                });

                const result = await response.json();
                
                if (result.success) {
                    alert(`ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä Ï¥àÍ∏∞ÌôîÎêòÏóàÏäµÎãàÎã§. ÏÉà ÎπÑÎ∞ÄÎ≤àÌò∏: ${result.newPassword}`);
                } else {
                    alert('ÎπÑÎ∞ÄÎ≤àÌò∏ Ï¥àÍ∏∞ÌôîÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
                }
            } catch (error) {
                console.error('ÎπÑÎ∞ÄÎ≤àÌò∏ Ï¥àÍ∏∞Ìôî Ïã§Ìå®:', error);
                alert('ÎπÑÎ∞ÄÎ≤àÌò∏ Ï¥àÍ∏∞Ìôî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
            }
        }

        // ÏÇ¨Ïö©Ïûê ÏÇ≠Ï†ú
        async function deleteUser(userId) {
            if (!confirm('Ïù¥ ÏÇ¨Ïö©ÏûêÎ•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå? Ïù¥ ÏûëÏóÖÏùÄ Ï∑®ÏÜåÌï† Ïàò ÏóÜÏäµÎãàÎã§.')) {
                return;
            }

            try {
                const response = await fetch(`/api/admin/users/${userId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();
                
                if (result.success) {
                    alert('ÏÇ¨Ïö©ÏûêÍ∞Ä ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.');
                    loadUsers();
                } else {
                    alert('ÏÇ¨Ïö©Ïûê ÏÇ≠Ï†úÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
                }
            } catch (error) {
                console.error('ÏÇ¨Ïö©Ïûê ÏÇ≠Ï†ú Ïã§Ìå®:', error);
                alert('ÏÇ¨Ïö©Ïûê ÏÇ≠Ï†ú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
            }
        }

        // ÏÇ¨ÏóÖÏû• Í¥ÄÎ¶¨ Í¥ÄÎ†® Î≥ÄÏàò
        let sitesData = [];
        let selectedSiteId = null;
        let currentEditSiteId = null;

        // ÏÇ¨ÏóÖÏû• Ìä∏Î¶¨ Î°úÎìú
        async function loadSitesTree() {
            try {
                const response = await fetch('/api/admin/sites/tree');
                const data = await response.json();
                
                if (data.success) {
                    sitesData = data.sites;
                    renderSitesTree();
                }
            } catch (error) {
                console.error('ÏÇ¨ÏóÖÏû• Ìä∏Î¶¨ Î°úÎìú Ïã§Ìå®:', error);
                const container = document.getElementById('sites-tree');
                if (container) {
                    container.innerHTML = '<div class="text-center">ÏÇ¨ÏóÖÏû• Ï†ïÎ≥¥Î•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.</div>';
                }
            }
        }

        // ÏÇ¨ÏóÖÏû• Ìä∏Î¶¨ Î†åÎçîÎßÅ
        function renderSitesTree() {
            const container = document.getElementById('sites-tree');
            if (!container) {
                console.log('sites-tree Ïª®ÌÖåÏù¥ÎÑàÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§. ÌòÑÏû¨ ÌéòÏù¥ÏßÄÏóêÏÑúÎäî ÏÇ¨ÏóÖÏû• Ìä∏Î¶¨Í∞Ä ÌïÑÏöîÌïòÏßÄ ÏïäÏäµÎãàÎã§.');
                return;
            }
            
            container.innerHTML = '';
            
            if (sitesData.length === 0) {
                container.innerHTML = '<div class="text-center">Îì±Î°ùÎêú ÏÇ¨ÏóÖÏû•Ïù¥ ÏóÜÏäµÎãàÎã§.</div>';
                return;
            }
            
            // Ìó§Îìú ÏÇ¨ÏóÖÏû•Îì§ Î†åÎçîÎßÅ
            const headSites = sitesData.filter(site => site.site_type === 'head');
            headSites.forEach(site => {
                container.appendChild(createTreeNode(site));
            });
        }

        // Ìä∏Î¶¨ ÎÖ∏Îìú ÏÉùÏÑ±
        function createTreeNode(site) {
            const nodeDiv = document.createElement('div');
            nodeDiv.className = 'tree-node';
            nodeDiv.dataset.siteId = site.id;
            
            const contentDiv = document.createElement('div');
            contentDiv.className = `tree-node-content ${site.site_type}-site`;
            contentDiv.onclick = () => selectSite(site.id);
            
            // ÎìúÎûòÍ∑∏ Ïï§ ÎìúÎ°≠ Ïù¥Î≤§Ìä∏ Ï∂îÍ∞Ä
            setupDragAndDrop(contentDiv, site);
            
            // ÌôïÏû•/Ï∂ïÏÜå Î≤ÑÌäº
            const expandBtn = document.createElement('button');
            expandBtn.className = 'tree-expand-btn';
            const hasChildren = site.children && site.children.length > 0;
            
            if (hasChildren) {
                expandBtn.className += ' expanded';
                expandBtn.onclick = (e) => {
                    e.stopPropagation();
                    toggleNode(site.id);
                };
            } else {
                expandBtn.className += ' no-children';
            }
            
            // ÏïÑÏù¥ÏΩò
            const iconSpan = document.createElement('span');
            iconSpan.className = 'tree-node-icon';
            iconSpan.textContent = getSiteIcon(site.site_type);
            
            // ÎùºÎ≤®
            const labelSpan = document.createElement('span');
            labelSpan.className = 'tree-node-label';
            labelSpan.textContent = site.name;
            
            // ÏÉÅÌÉú
            const statusSpan = document.createElement('span');
            statusSpan.className = `tree-node-status ${site.is_active ? 'active' : 'inactive'}`;
            statusSpan.textContent = site.is_active ? 'ÌôúÏÑ±' : 'ÎπÑÌôúÏÑ±';
            
            // Ïï°ÏÖò Î≤ÑÌäºÎì§
            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'tree-node-actions';
            
            if (site.site_type === 'head') {
                const addDetailBtn = document.createElement('button');
                addDetailBtn.className = 'tree-action-btn add';
                addDetailBtn.textContent = '+ ÏÑ∏Î∂Ä';
                addDetailBtn.onclick = (e) => {
                    e.stopPropagation();
                    showAddSiteModal('detail', site.id);
                };
                actionsDiv.appendChild(addDetailBtn);
            } else if (site.site_type === 'detail') {
                const addPeriodBtn = document.createElement('button');
                addPeriodBtn.className = 'tree-action-btn add';
                addPeriodBtn.textContent = '+ Í∏∞Í∞Ñ';
                addPeriodBtn.onclick = (e) => {
                    e.stopPropagation();
                    showAddSiteModal('period', site.id);
                };
                actionsDiv.appendChild(addPeriodBtn);
            }
            
            const editBtn = document.createElement('button');
            editBtn.className = 'tree-action-btn edit';
            editBtn.textContent = 'ÏàòÏ†ï';
            editBtn.onclick = (e) => {
                e.stopPropagation();
                editSite(site.id);
            };
            
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'tree-action-btn delete';
            deleteBtn.textContent = 'ÏÇ≠Ï†ú';
            deleteBtn.onclick = (e) => {
                e.stopPropagation();
                deleteSite(site.id);
            };
            
            actionsDiv.appendChild(editBtn);
            actionsDiv.appendChild(deleteBtn);
            
            // Ïª®ÌÖêÏ∏† Ï°∞Î¶Ω
            contentDiv.appendChild(expandBtn);
            contentDiv.appendChild(iconSpan);
            contentDiv.appendChild(labelSpan);
            contentDiv.appendChild(statusSpan);
            contentDiv.appendChild(actionsDiv);
            
            nodeDiv.appendChild(contentDiv);
            
            // ÏûêÏãù ÎÖ∏ÎìúÎì§
            if (hasChildren) {
                const childrenDiv = document.createElement('div');
                childrenDiv.className = 'tree-children';
                site.children.forEach(child => {
                    childrenDiv.appendChild(createTreeNode(child));
                });
                nodeDiv.appendChild(childrenDiv);
            }
            
            return nodeDiv;
        }

        // ÏÇ¨ÏóÖÏû• ÏïÑÏù¥ÏΩò Í∞ÄÏ†∏Ïò§Í∏∞
        function getSiteIcon(siteType) {
            switch (siteType) {
                case 'head': return 'üè¢';
                case 'detail': return 'üè´';
                case 'period': return 'üìÖ';
                default: return 'üìç';
            }
        }

        // ÎÖ∏Îìú ÌôïÏû•/Ï∂ïÏÜå
        function toggleNode(siteId) {
            const node = document.querySelector(`[data-site-id="${siteId}"]`);
            if (!node) return;
            
            const expandBtn = node.querySelector('.tree-expand-btn');
            const childrenDiv = node.querySelector('.tree-children');
            
            if (!childrenDiv) return;
            
            if (expandBtn.classList.contains('expanded')) {
                expandBtn.className = expandBtn.className.replace('expanded', 'collapsed');
                childrenDiv.classList.add('hidden');
            } else {
                expandBtn.className = expandBtn.className.replace('collapsed', 'expanded');
                childrenDiv.classList.remove('hidden');
            }
        }

        // Î™®Îì† ÎÖ∏Îìú ÌôïÏû•
        function expandAllSites() {
            document.querySelectorAll('.tree-expand-btn.collapsed').forEach(btn => {
                btn.className = btn.className.replace('collapsed', 'expanded');
            });
            document.querySelectorAll('.tree-children.hidden').forEach(children => {
                children.classList.remove('hidden');
            });
        }

        // Î™®Îì† ÎÖ∏Îìú Ï∂ïÏÜå
        function collapseAllSites() {
            document.querySelectorAll('.tree-expand-btn.expanded').forEach(btn => {
                btn.className = btn.className.replace('expanded', 'collapsed');
            });
            document.querySelectorAll('.tree-children').forEach(children => {
                children.classList.add('hidden');
            });
        }

        // ÏÇ¨ÏóÖÏû• ÏÑ†ÌÉù
        function selectSite(siteId) {
            // Ïù¥Ï†Ñ ÏÑ†ÌÉù Ìï¥Ï†ú
            document.querySelectorAll('.tree-node-content.selected').forEach(node => {
                node.classList.remove('selected');
            });
            
            // ÏÉà ÏÑ†ÌÉù
            const node = document.querySelector(`[data-site-id="${siteId}"] .tree-node-content`);
            if (node) {
                node.classList.add('selected');
                selectedSiteId = siteId;
                showSiteDetails(siteId);
            }
        }

        // ÏÇ¨ÏóÖÏû• ÏÉÅÏÑ∏Ï†ïÎ≥¥ ÌëúÏãú
        async function showSiteDetails(siteId) {
            try {
                const response = await fetch(`/api/admin/sites/${siteId}`);
                const site = await response.json();
                
                const panel = document.getElementById('site-details-panel');
                const content = document.getElementById('site-details-content');
                
                content.innerHTML = `
                    <div class="site-info-group">
                        <div class="site-info-label">ÏÇ¨ÏóÖÏû•Î™Ö</div>
                        <div class="site-info-value">${site.name}</div>
                    </div>
                    <div class="site-info-group">
                        <div class="site-info-label">Íµ¨Î∂Ñ</div>
                        <div class="site-info-value">${getSiteTypeDisplay(site.site_type)}</div>
                    </div>
                    <div class="site-info-group">
                        <div class="site-info-label">Îã¥ÎãπÏûê</div>
                        <div class="site-info-value">${site.contact_person || '-'}</div>
                    </div>
                    <div class="site-info-group">
                        <div class="site-info-label">Ïó∞ÎùΩÏ≤ò</div>
                        <div class="site-info-value">${site.contact_phone || '-'}</div>
                    </div>
                    <div class="site-info-group">
                        <div class="site-info-label">Ï£ºÏÜå</div>
                        <div class="site-info-value">${site.address || '-'}</div>
                    </div>
                    <div class="site-info-group">
                        <div class="site-info-label">1Ïù∏Îãπ Ï†úÍ≥µÎüâ</div>
                        <div class="site-info-value">${site.portion_size || 0}g</div>
                    </div>
                    <div class="site-stats">
                        <div class="stat-box">
                            <div class="stat-number">${site.menu_count || 0}</div>
                            <div class="stat-label">Îì±Î°ùÎêú ÏãùÎã®</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-number">${site.children_count || 0}</div>
                            <div class="stat-label">ÌïòÏúÑ ÏÇ¨ÏóÖÏû•</div>
                        </div>
                    </div>
                `;
                
                panel.classList.remove('hidden');
            } catch (error) {
                console.error('ÏÇ¨ÏóÖÏû• ÏÉÅÏÑ∏Ï†ïÎ≥¥ Î°úÎìú Ïã§Ìå®:', error);
            }
        }

        // ÏÇ¨ÏóÖÏû• Íµ¨Î∂Ñ ÌëúÏãúÎ™Ö
        function getSiteTypeDisplay(siteType) {
            switch (siteType) {
                case 'ÎèÑÏãúÎùΩ': return 'ÎèÑÏãúÎùΩ';
                case 'Ïö¥Î∞ò': return 'Ïö¥Î∞ò';
                case 'ÌïôÍµê': return 'ÌïôÍµê';
                case 'ÏöîÏñëÏõê': return 'ÏöîÏñëÏõê';
                case 'ÏúÑÌÉÅ': return 'ÏúÑÌÉÅ';
                case 'ÏùºÎ∞òÏùåÏãùÏ†ê': return 'ÏùºÎ∞òÏùåÏãùÏ†ê';
                case 'Í∏∞ÌÉÄ': return 'Í∏∞ÌÉÄ';
                // Ïù¥Ï†Ñ Î≤ÑÏ†ÑÍ≥ºÏùò Ìò∏ÌôòÏÑ±
                case 'head': return 'Ìó§Îìú ÏÇ¨ÏóÖÏû•';
                case 'detail': return 'ÏÑ∏Î∂Ä ÏÇ¨ÏóÖÏû•';
                case 'period': return 'Í∏∞Í∞ÑÎ≥Ñ ÏÇ¨ÏóÖÏû•';
                default: return siteType || 'ÎØ∏Î∂ÑÎ•ò';
            }
        }

        // ==============================================================================
        // ÎìúÎûòÍ∑∏ Ïï§ ÎìúÎ°≠ Í∏∞Îä•
        // ==============================================================================
        
        let draggedElement = null;
        let draggedSite = null;

        // ÎìúÎûòÍ∑∏ Ïï§ ÎìúÎ°≠ Ïù¥Î≤§Ìä∏ ÏÑ§Ï†ï
        function setupDragAndDrop(element, site) {
            element.draggable = true;
            
            element.addEventListener('dragstart', (e) => {
                draggedElement = element;
                draggedSite = site;
                element.classList.add('dragging');
                
                // ÎìúÎûòÍ∑∏ Îç∞Ïù¥ÌÑ∞ ÏÑ§Ï†ï
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/plain', site.id);
                
                console.log('ÎìúÎûòÍ∑∏ ÏãúÏûë:', site.name);
            });
            
            element.addEventListener('dragend', (e) => {
                element.classList.remove('dragging');
                // Î™®Îì† ÎìúÎ°≠ Ïù∏ÎîîÏºÄÏù¥ÌÑ∞ Ï†úÍ±∞
                clearDropIndicators();
                draggedElement = null;
                draggedSite = null;
                
                console.log('ÎìúÎûòÍ∑∏ Ï¢ÖÎ£å');
            });
            
            element.addEventListener('dragover', (e) => {
                if (!draggedSite || draggedSite.id === site.id) return;
                
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                
                // Ïú†Ìö®Ìïú ÎìúÎ°≠ ÎåÄÏÉÅÏù∏ÏßÄ ÌôïÏù∏
                if (canDropOn(draggedSite, site)) {
                    element.classList.add('drag-over');
                } else {
                    element.classList.add('drop-invalid');
                }
            });
            
            element.addEventListener('dragleave', (e) => {
                element.classList.remove('drag-over', 'drop-invalid');
            });
            
            element.addEventListener('drop', (e) => {
                e.preventDefault();
                element.classList.remove('drag-over', 'drop-invalid');
                
                if (!draggedSite || draggedSite.id === site.id) return;
                
                // Ïú†Ìö®Ìïú ÎìúÎ°≠Ïù∏ÏßÄ ÌôïÏù∏
                if (canDropOn(draggedSite, site)) {
                    handleDrop(draggedSite, site);
                } else {
                    console.log('Ïú†Ìö®ÌïòÏßÄ ÏïäÏùÄ ÎìúÎ°≠:', draggedSite.name, '->', site.name);
                }
            });
        }

        // ÎìúÎ°≠ Í∞ÄÎä• Ïó¨Î∂Ä ÌôïÏù∏
        function canDropOn(draggedSite, targetSite) {
            // ÏûêÍ∏∞ ÏûêÏã†ÏóêÍ≤åÎäî ÎìúÎ°≠ Î∂àÍ∞Ä
            if (draggedSite.id === targetSite.id) return false;
            
            // Í≥ÑÏ∏µ Íµ¨Ï°∞ Í∑úÏπô ÌôïÏù∏
            // head -> detail ÎòêÎäî detail -> periodÎßå Í∞ÄÎä•
            if (draggedSite.site_type === 'head') {
                // headÎäî Ïù¥Îèô Î∂àÍ∞Ä
                return false;
            } else if (draggedSite.site_type === 'detail') {
                // detailÏùÄ headÏóêÎßå ÎìúÎ°≠ Í∞ÄÎä•
                return targetSite.site_type === 'head';
            } else if (draggedSite.site_type === 'period') {
                // periodÎäî detailÏóêÎßå ÎìúÎ°≠ Í∞ÄÎä•
                return targetSite.site_type === 'detail';
            }
            
            return false;
        }

        // ÎìúÎ°≠ Ï≤òÎ¶¨
        async function handleDrop(draggedSite, targetSite) {
            console.log(`ÎìúÎ°≠ Ï≤òÎ¶¨: ${draggedSite.name} -> ${targetSite.name}`);
            
            // ÌôïÏù∏ ÎåÄÌôîÏÉÅÏûê
            const message = `"${draggedSite.name}"ÏùÑ(Î•º) "${targetSite.name}" ÌïòÏúÑÎ°ú Ïù¥ÎèôÌïòÏãúÍ≤†ÏäµÎãàÍπå?`;
            if (!confirm(message)) {
                return;
            }
            
            try {
                // ÏÑúÎ≤ÑÏóê Ïù¥Îèô ÏöîÏ≤≠
                const response = await fetch(`/api/admin/sites/${draggedSite.id}/move`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        new_parent_id: targetSite.id
                    }),
                });
                
                const result = await response.json();
                
                if (result.success) {
                    console.log('Ïù¥Îèô ÏÑ±Í≥µ:', result.message);
                    // Ìä∏Î¶¨ ÏÉàÎ°úÍ≥†Ïπ®
                    loadSitesTree();
                } else {
                    console.error('Ïù¥Îèô Ïã§Ìå®:', result.message);
                    alert(`Ïù¥Îèô Ïã§Ìå®: ${result.message}`);
                }
            } catch (error) {
                console.error('Ïù¥Îèô ÏöîÏ≤≠ Ïò§Î•ò:', error);
                alert('Ïù¥Îèô Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
            }
        }

        // ÎìúÎ°≠ Ïù∏ÎîîÏºÄÏù¥ÌÑ∞ Ï†ïÎ¶¨
        function clearDropIndicators() {
            document.querySelectorAll('.tree-node-content').forEach(el => {
                el.classList.remove('drag-over', 'drop-invalid');
            });
        }

        // ÏÉÅÏÑ∏Ï†ïÎ≥¥ Ìå®ÎÑê Îã´Í∏∞
        function closeSiteDetails() {
            document.getElementById('site-details-panel').classList.add('hidden');
            selectedSiteId = null;
            
            // ÏÑ†ÌÉù Ìï¥Ï†ú
            document.querySelectorAll('.tree-node-content.selected').forEach(node => {
                node.classList.remove('selected');
            });
        }

        // ÏÇ¨ÏóÖÏû• Ï∂îÍ∞Ä Î™®Îã¨ ÌëúÏãú
        function showAddSiteModal(siteType, parentId = null) {
            console.log('showAddSiteModal Ìò∏Ï∂úÎê®:', siteType, parentId, 'allowModalDisplay:', allowModalDisplay);
            
            // ÌéòÏù¥ÏßÄ Ï¥àÍ∏∞ÌôîÍ∞Ä ÏôÑÎ£åÎêòÏßÄ ÏïäÏïòÏúºÎ©¥ Ïã§ÌñâÌïòÏßÄ ÏïäÏùå
            if (!allowModalDisplay) {
                console.log('ÌéòÏù¥ÏßÄ Ï¥àÍ∏∞Ìôî Ï§ëÏù¥ÎØÄÎ°ú Î™®Îã¨ ÌëúÏãú Ï∑®ÏÜå');
                return;
            }
            
            currentEditSiteId = null;
            
            const modal = document.getElementById('site-modal');
            if (!modal) {
                console.error('ÏÇ¨ÏóÖÏû• Î™®Îã¨ÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏùå');
                return;
            }
            
            document.getElementById('site-modal-title').textContent = `ÏÉà ${getSiteTypeDisplay(siteType)} Ï∂îÍ∞Ä`;
            document.getElementById('site-form').reset();
            document.getElementById('site-parent-id').value = parentId || '';
            document.getElementById('site-type').value = siteType;
            document.getElementById('site-is-active').checked = true;
            
            modal.style.display = 'flex';
            modal.classList.remove('hidden');
            console.log('ÏÇ¨ÏóÖÏû• Î™®Îã¨ ÌëúÏãúÎê®');
        }

        // ÏÇ¨ÏóÖÏû• ÏàòÏ†ï
        async function editSite(siteId) {
            try {
                const response = await fetch(`/api/admin/sites/${siteId}`);
                const site = await response.json();
                
                currentEditSiteId = siteId;
                document.getElementById('site-modal-title').textContent = 'ÏÇ¨ÏóÖÏû• Ï†ïÎ≥¥ ÏàòÏ†ï';
                
                // ÌèºÏóê Í∏∞Ï°¥ Îç∞Ïù¥ÌÑ∞ Ï±ÑÏö∞Í∏∞
                document.getElementById('site-name').value = site.name;
                document.getElementById('site-contact-person').value = site.contact_person || '';
                document.getElementById('site-contact-phone').value = site.contact_phone || '';
                document.getElementById('site-address').value = site.address || '';
                document.getElementById('site-portion-size').value = site.portion_size || '';
                document.getElementById('site-description').value = site.description || '';
                document.getElementById('site-is-active').checked = site.is_active;
                
                document.getElementById('site-modal').classList.remove('hidden');
            } catch (error) {
                console.error('ÏÇ¨ÏóÖÏû• Ï†ïÎ≥¥ Î°úÎìú Ïã§Ìå®:', error);
                alert('ÏÇ¨ÏóÖÏû• Ï†ïÎ≥¥Î•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.');
            }
        }

        // ÏÇ¨ÏóÖÏû• ÏÇ≠Ï†ú
        async function deleteSite(siteId) {
            if (!confirm('Ïù¥ ÏÇ¨ÏóÖÏû•ÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå? ÌïòÏúÑ ÏÇ¨ÏóÖÏû•ÎèÑ Ìï®Íªò ÏÇ≠Ï†úÎê©ÎãàÎã§.')) {
                return;
            }

            try {
                const response = await fetch(`/api/admin/sites/${siteId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();
                
                if (result.success) {
                    alert('ÏÇ¨ÏóÖÏû•Ïù¥ ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.');
                    loadSitesTree();
                    closeSiteDetails();
                } else {
                    alert('ÏÇ¨ÏóÖÏû• ÏÇ≠Ï†úÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
                }
            } catch (error) {
                console.error('ÏÇ¨ÏóÖÏû• ÏÇ≠Ï†ú Ïã§Ìå®:', error);
                alert('ÏÇ¨ÏóÖÏû• ÏÇ≠Ï†ú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
            }
        }

        // ÏÇ¨ÏóÖÏû• Î™®Îã¨ Îã´Í∏∞
        function closeSiteModal() {
            console.log('closeSiteModal Ìò∏Ï∂úÎê®');
            const modal = document.getElementById('site-modal');
            if (modal) {
                modal.style.display = 'none';
                modal.classList.add('hidden');
                console.log('ÏÇ¨ÏóÖÏû• Î™®Îã¨ ÏôÑÏ†ÑÌûà Ïà®ÍπÄ');
            }
            currentEditSiteId = null;
        }

        // ÏÇ¨ÏóÖÏû• Ï†ÄÏû•
        async function saveSite() {
            const siteData = {
                name: document.getElementById('site-name').value,
                contact_person: document.getElementById('site-contact-person').value,
                contact_phone: document.getElementById('site-contact-phone').value,
                address: document.getElementById('site-address').value,
                portion_size: parseInt(document.getElementById('site-portion-size').value) || null,
                description: document.getElementById('site-description').value,
                is_active: document.getElementById('site-is-active').checked
            };

            if (!currentEditSiteId) {
                // ÏÉà ÏÇ¨ÏóÖÏû• Ï∂îÍ∞Ä
                siteData.site_type = document.getElementById('site-type').value;
                siteData.parent_id = document.getElementById('site-parent-id').value || null;
            }

            try {
                const url = currentEditSiteId ? 
                    `/api/admin/sites/${currentEditSiteId}` : 
                    '/api/admin/sites';
                
                const method = currentEditSiteId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(siteData)
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        alert(currentEditSiteId ? 'ÏÇ¨ÏóÖÏû•Ïù¥ ÏàòÏ†ïÎêòÏóàÏäµÎãàÎã§.' : 'ÏÉà ÏÇ¨ÏóÖÏû•Ïù¥ Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§.');
                        closeSiteModal();
                        loadSitesTree();
                    } else {
                        alert('‚ùå ' + (result.message || 'Ï†ÄÏû• Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.'));
                    }
                } else {
                    const errorText = await response.text();
                    console.error('Server error:', errorText);
                    alert(`‚ùå ÏÑúÎ≤Ñ Ïò§Î•ò (${response.status}): ${errorText}`);
                }
            } catch (error) {
                console.error('ÏÇ¨ÏóÖÏû• Ï†ÄÏû• Ïã§Ìå®:', error);
                alert('‚ùå Ï†ÄÏû• Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ' + error.message);
            }
        }

        // ===== ÏãùÏûêÏû¨ ÏóÖÎ°úÎìú Í¥ÄÎ†® Ìï®ÏàòÎì§ =====
        
        let selectedFiles = [];
        
        // ÏóÖÎ°úÎìú ÏÑπÏÖò ÌëúÏãú/Ïà®Í∏∞Í∏∞
        function showUploadSection() {
            const uploadSection = document.getElementById('upload-section');
            const isVisible = uploadSection.style.display !== 'none';
            uploadSection.style.display = isVisible ? 'none' : 'block';
        }

        // ÏñëÏãù Îã§Ïö¥Î°úÎìú
        function downloadTemplate() {
            // ÌÖúÌîåÎ¶ø ÌååÏùº Îã§Ïö¥Î°úÎìú Î°úÏßÅ
            const link = document.createElement('a');
            link.href = '/templates/ingredient_template.xlsx';
            link.download = 'ÏãùÏûêÏû¨_ÏóÖÎ°úÎìú_ÏñëÏãù.xlsx';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // ÌååÏùº ÏÑ†ÌÉù Ïù¥Î≤§Ìä∏ Ï≤òÎ¶¨
        document.addEventListener('DOMContentLoaded', function() {
            const fileInput = document.getElementById('file-input');
            const uploadArea = document.querySelector('.upload-area');
            
            if (fileInput && uploadArea) {
                // ÌååÏùº ÏÑ†ÌÉù Ïù¥Î≤§Ìä∏
                fileInput.addEventListener('change', handleFileSelect);
                
                // ÎìúÎûòÍ∑∏ Ïï§ ÎìúÎ°≠ Ïù¥Î≤§Ìä∏
                uploadArea.addEventListener('dragover', handleDragOver);
                uploadArea.addEventListener('drop', handleDrop);
                uploadArea.addEventListener('dragleave', handleDragLeave);
            }
        });

        function handleFileSelect(event) {
            const files = Array.from(event.target.files);
            addFiles(files);
        }

        function handleDragOver(event) {
            event.preventDefault();
            event.currentTarget.classList.add('dragover');
        }

        function handleDrop(event) {
            event.preventDefault();
            event.currentTarget.classList.remove('dragover');
            const files = Array.from(event.dataTransfer.files);
            addFiles(files);
        }

        function handleDragLeave(event) {
            event.currentTarget.classList.remove('dragover');
        }

        function addFiles(files) {
            // ÌååÏùº ÌòïÏãù Í≤ÄÏ¶ù
            const validFiles = files.filter(file => {
                const isValidType = file.type.includes('sheet') || file.name.endsWith('.xlsx') || file.name.endsWith('.xls');
                const isValidSize = file.size <= 10 * 1024 * 1024; // 10MB
                
                if (!isValidType) {
                    alert(`${file.name}ÏùÄ(Îäî) ÏßÄÏõêÌïòÏßÄ ÏïäÎäî ÌååÏùº ÌòïÏãùÏûÖÎãàÎã§.`);
                    return false;
                }
                
                if (!isValidSize) {
                    alert(`${file.name}ÏùÄ(Îäî) ÌååÏùº ÌÅ¨Í∏∞Í∞Ä 10MBÎ•º Ï¥àÍ≥ºÌï©ÎãàÎã§.`);
                    return false;
                }
                
                return true;
            });

            // Ï§ëÎ≥µ ÌååÏùº Ï≤¥ÌÅ¨
            validFiles.forEach(file => {
                const isDuplicate = selectedFiles.some(selectedFile => 
                    selectedFile.name === file.name && selectedFile.size === file.size
                );
                
                if (!isDuplicate) {
                    selectedFiles.push(file);
                }
            });

            updateFileList();
            updateUploadButton();
        }

        function updateFileList() {
            const uploadText = document.querySelector('.upload-text h4');
            const uploadBtn = document.getElementById('upload-btn');
            
            if (selectedFiles.length > 0) {
                uploadText.textContent = `${selectedFiles.length}Í∞ú ÌååÏùºÏù¥ ÏÑ†ÌÉùÎêòÏóàÏäµÎãàÎã§`;
                uploadBtn.disabled = false;
            } else {
                uploadText.textContent = 'ÌååÏùºÏùÑ ÏÑ†ÌÉùÌïòÍ±∞ÎÇò Ïó¨Í∏∞Î°ú ÎìúÎûòÍ∑∏ÌïòÏÑ∏Ïöî';
                uploadBtn.disabled = true;
            }
        }

        function updateUploadButton() {
            const uploadBtn = document.getElementById('upload-btn');
            uploadBtn.disabled = selectedFiles.length === 0;
        }

        function clearFiles() {
            selectedFiles = [];
            document.getElementById('file-input').value = '';
            updateFileList();
            updateUploadButton();
            hideResults();
        }

        function hideResults() {
            document.getElementById('upload-results').style.display = 'none';
        }

        // ÌååÏùº ÏóÖÎ°úÎìú Ïã§Ìñâ
        async function uploadFiles() {
            if (selectedFiles.length === 0) {
                alert('ÏóÖÎ°úÎìúÌï† ÌååÏùºÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }

            const uploadProgress = document.getElementById('upload-progress');
            const progressFill = document.getElementById('progress-fill');
            const progressText = document.getElementById('progress-text');
            const uploadBtn = document.getElementById('upload-btn');

            // ÏóÖÎ°úÎìú ÏãúÏûë
            uploadProgress.style.display = 'block';
            uploadBtn.disabled = true;
            
            let successCount = 0;
            let errorCount = 0;
            const results = [];

            for (let i = 0; i < selectedFiles.length; i++) {
                const file = selectedFiles[i];
                const formData = new FormData();
                formData.append('file', file);

                try {
                    // ÏßÑÌñâÎ•† ÏóÖÎç∞Ïù¥Ìä∏
                    const progress = ((i + 1) / selectedFiles.length) * 100;
                    progressFill.style.width = `${progress}%`;
                    progressText.textContent = `ÏóÖÎ°úÎìú Ï§ë... ${i + 1}/${selectedFiles.length} (${Math.round(progress)}%)`;

                    const response = await fetch('/api/admin/upload-ingredients', {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();

                    if (result.success) {
                        successCount++;
                        results.push({
                            fileName: file.name,
                            status: 'success',
                            message: `${result.processed_count}Í∞ú ÏãùÏûêÏû¨ Ï≤òÎ¶¨ ÏôÑÎ£å`,
                            details: result.details || {}
                        });
                    } else {
                        errorCount++;
                        results.push({
                            fileName: file.name,
                            status: 'error',
                            message: result.message || 'ÏóÖÎ°úÎìú Ïã§Ìå®',
                            details: result.details || {}
                        });
                    }
                } catch (error) {
                    console.error('ÌååÏùº ÏóÖÎ°úÎìú Ïò§Î•ò:', error);
                    errorCount++;
                    results.push({
                        fileName: file.name,
                        status: 'error',
                        message: 'ÏÑúÎ≤Ñ Ïó∞Í≤∞ Ïò§Î•ò',
                        details: {}
                    });
                }
            }

            // ÏóÖÎ°úÎìú ÏôÑÎ£å
            uploadProgress.style.display = 'none';
            uploadBtn.disabled = false;
            
            // Í≤∞Í≥º ÌëúÏãú
            showUploadResults(successCount, errorCount, results);
            
            // ÏÑ±Í≥µÌïú Í≤ΩÏö∞ ÏãùÏûêÏû¨ Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ®
            if (successCount > 0) {
                loadIngredientsList();
            }
        }

        function showUploadResults(successCount, errorCount, results) {
            document.getElementById('success-count').textContent = successCount;
            document.getElementById('error-count').textContent = errorCount;
            
            const resultDetails = document.getElementById('result-details');
            resultDetails.innerHTML = '';
            
            results.forEach(result => {
                const resultDiv = document.createElement('div');
                resultDiv.className = `result-file ${result.status}`;
                
                resultDiv.innerHTML = `
                    <div class="file-name">${result.fileName}</div>
                    <div class="file-status ${result.status}">
                        <span>${result.status === 'success' ? '‚úì' : '‚úó'}</span>
                        <span>${result.message}</span>
                    </div>
                `;
                
                resultDetails.appendChild(resultDiv);
            });
            
            document.getElementById('upload-results').style.display = 'block';
        }

        // ÏãùÏûêÏû¨ Î™©Î°ù Î°úÎìú
        async function loadIngredientsList() {
            try {
                const response = await fetch('/api/admin/ingredients');
                const result = await response.json();
                const ingredients = result.ingredients || result.data || [];
                
                const tbody = document.getElementById('ingredients-tbody');
                tbody.innerHTML = '';
                
                if (ingredients.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #666;">Îì±Î°ùÎêú ÏãùÏûêÏû¨Í∞Ä ÏóÜÏäµÎãàÎã§.</td></tr>';
                    return;
                }
                
                ingredients.forEach(ingredient => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${ingredient.name}</td>
                        <td>${ingredient.supplier_name || '-'}</td>
                        <td>${ingredient.base_unit}</td>
                        <td>${ingredient.price ? ingredient.price.toLocaleString() + 'Ïõê' : '-'}</td>
                        <td>${ingredient.moq || '1'}</td>
                        <td>${new Date(ingredient.created_at).toLocaleDateString()}</td>
                        <td>
                            <button class="btn-small btn-primary" onclick="editIngredient(${ingredient.id})">ÏàòÏ†ï</button>
                            <button class="btn-small btn-danger" onclick="deleteIngredient(${ingredient.id})">ÏÇ≠Ï†ú</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
                
            } catch (error) {
                console.error('ÏãùÏûêÏû¨ Î™©Î°ù Î°úÎìú Ïã§Ìå®:', error);
                document.getElementById('ingredients-tbody').innerHTML = 
                    '<tr><td colspan="7" style="text-align: center; color: #dc3545;">ÏãùÏûêÏû¨ Î™©Î°ùÏùÑ Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.</td></tr>';
            }
        }

        // Í≥µÍ∏âÏóÖÏ≤¥ ÌïÑÌÑ∞ Î°úÎìú
        async function loadSupplierFilter() {
            try {
                const response = await fetch('/api/admin/suppliers/enhanced');
                const result = await response.json();
                const suppliers = result.suppliers || result.data || [];
                
                const supplierFilter = document.getElementById('supplier-filter');
                supplierFilter.innerHTML = '<option value="">Ï†ÑÏ≤¥ ÏóÖÏ≤¥</option>';
                
                suppliers.forEach(supplier => {
                    const option = document.createElement('option');
                    option.value = supplier.id;
                    option.textContent = supplier.name;
                    supplierFilter.appendChild(option);
                });
                
            } catch (error) {
                console.error('Í≥µÍ∏âÏóÖÏ≤¥ Î™©Î°ù Î°úÎìú Ïã§Ìå®:', error);
            }
        }

        // ÏãùÏûêÏû¨ ÏàòÏ†ï (Ï∂îÌõÑ Íµ¨ÌòÑ)
        function editIngredient(ingredientId) {
            alert(`ÏãùÏûêÏû¨ ID ${ingredientId} ÏàòÏ†ï Í∏∞Îä•ÏùÄ Í≥ß Íµ¨ÌòÑÎê† ÏòàÏ†ïÏûÖÎãàÎã§.`);
        }

        // ÏãùÏûêÏû¨ ÏÇ≠Ï†ú (Ï∂îÌõÑ Íµ¨ÌòÑ)
        function deleteIngredient(ingredientId) {
            if (confirm('Ïù¥ ÏãùÏûêÏû¨Î•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                alert(`ÏãùÏûêÏû¨ ID ${ingredientId} ÏÇ≠Ï†ú Í∏∞Îä•ÏùÄ Í≥ß Íµ¨ÌòÑÎê† ÏòàÏ†ïÏûÖÎãàÎã§.`);
            }
        }

        // ===== ÏãùÏàò Îì±Î°ù Í¥ÄÎ¶¨ Í¥ÄÎ†® Ìï®ÏàòÎì§ =====
        
        // ÏãùÏàò Îì±Î°ù ÌéòÏù¥ÏßÄ Ï¥àÍ∏∞Ìôî
        function initMealCountsPage() {
            // Ïò§Îäò ÎÇ†ÏßúÎ•º Í∏∞Î≥∏Í∞íÏúºÎ°ú ÏÑ§Ï†ï
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('meal-count-date').value = today;
            document.getElementById('form-meal-date').value = today;
        }

        // ÏãùÏàò Îç∞Ïù¥ÌÑ∞ Î°úÎìú
        async function loadMealCounts() {
            try {
                const selectedDate = document.getElementById('meal-count-date').value;
                const url = selectedDate ? `/api/admin/meal-counts?date=${selectedDate}` : '/api/admin/meal-counts';
                
                const response = await fetch(url);
                const mealCounts = await response.json();
                
                updateMealCountsSummary(mealCounts);
                updateMealCountsTable(mealCounts);
                
            } catch (error) {
                console.error('ÏãùÏàò Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®:', error);
                document.getElementById('meal-counts-tbody').innerHTML = 
                    '<tr><td colspan="8" style="text-align: center; color: #dc3545;">ÏãùÏàò Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.</td></tr>';
            }
        }

        // ÏãùÏàò ÌòÑÌô© ÏöîÏïΩ ÏóÖÎç∞Ïù¥Ìä∏
        function updateMealCountsSummary(mealCounts) {
            let totalCount = 0;
            let totalCost = 0;
            let deliverySites = new Set();
            
            mealCounts.forEach(item => {
                totalCount += item.total_count || 0;
                totalCost += (item.target_material_cost || 0) * (item.total_count || 0);
                deliverySites.add(item.delivery_site);
            });
            
            document.getElementById('total-meal-count').textContent = `${totalCount.toLocaleString()}Î™Ö`;
            document.getElementById('avg-material-cost').textContent = 
                totalCount > 0 ? `${Math.round(totalCost / totalCount).toLocaleString()}Ïõê` : '0Ïõê';
            document.getElementById('delivery-sites-count').textContent = `${deliverySites.size}Í∞úÏÜå`;
            document.getElementById('estimated-total-cost').textContent = `${totalCost.toLocaleString()}Ïõê`;
        }

        // ÏãùÏàò Îç∞Ïù¥ÌÑ∞ ÌÖåÏù¥Î∏î ÏóÖÎç∞Ïù¥Ìä∏
        function updateMealCountsTable(mealCounts) {
            const tbody = document.getElementById('meal-counts-tbody');
            tbody.innerHTML = '';
            
            if (mealCounts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #666;">Îì±Î°ùÎêú ÏãùÏàò Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.</td></tr>';
                return;
            }
            
            mealCounts.forEach((item, index) => {
                // Î©îÏù∏ Ìñâ
                const mainRow = document.createElement('tr');
                mainRow.innerHTML = `
                    <td class="delivery-site-cell" rowspan="${item.site_details.length + 1}">${item.delivery_site}</td>
                    <td class="meal-type-cell" rowspan="${item.site_details.length + 1}">${item.meal_type}</td>
                    <td class="cost-cell" rowspan="${item.site_details.length + 1}">${(item.target_material_cost || 0).toLocaleString()}Ïõê</td>
                    <td class="count-cell" rowspan="${item.site_details.length + 1}">${(item.total_count || 0).toLocaleString()}Î™Ö</td>
                    <td colspan="3" style="background: #f0f8ff; font-weight: 500;">${item.menu_info || '-'}</td>
                    <td rowspan="${item.site_details.length + 1}">
                        <div class="btn-group">
                            <button class="btn-small btn-primary" onclick="editMealCount(${item.id})">ÏàòÏ†ï</button>
                            <button class="btn-small btn-warning" onclick="duplicateMealCount(${item.id})">Î≥µÏÇ¨</button>
                        </div>
                    </td>
                `;
                tbody.appendChild(mainRow);
                
                // ÏÇ¨ÏóÖÏû•Î≥Ñ ÏÉÅÏÑ∏ ÌñâÎì§
                item.site_details.forEach(site => {
                    const detailRow = document.createElement('tr');
                    detailRow.className = 'site-detail-row';
                    detailRow.innerHTML = `
                        <td>${site.site_name}</td>
                        <td class="count-cell">${site.count}Î™Ö</td>
                        <td>${site.notes || '-'}</td>
                    `;
                    tbody.appendChild(detailRow);
                });
            });
        }

        // ÏãùÏàò Îì±Î°ù Î™®Îã¨ ÌëúÏãú
        function showAddMealCountModal() {
            document.getElementById('meal-count-modal-title').textContent = 'ÏãùÏàò Îì±Î°ù';
            document.getElementById('meal-count-form').reset();
            document.getElementById('meal-count-id').value = '';
            
            // ÏÑ†ÌÉùÎêú ÎÇ†ÏßúÎ•º ÌèºÏóêÎèÑ Î∞òÏòÅ
            const selectedDate = document.getElementById('meal-count-date').value;
            document.getElementById('form-meal-date').value = selectedDate;
            
            document.getElementById('meal-count-modal').classList.remove('hidden');
        }

        // ÏãùÏàò Îì±Î°ù Î™®Îã¨ Îã´Í∏∞
        function closeMealCountModal() {
            document.getElementById('meal-count-modal').classList.add('hidden');
        }

        // ÏãùÏàò Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•
        async function saveMealCount() {
            try {
                const formData = {
                    meal_date: document.getElementById('form-meal-date').value,
                    delivery_site: document.getElementById('form-delivery-site').value.trim(),
                    meal_type: document.getElementById('form-meal-type').value,
                    target_material_cost: parseInt(document.getElementById('form-target-cost').value) || 0,
                    menu_info: document.getElementById('form-menu-info').value.trim(),
                    site_counts: document.getElementById('form-site-counts').value.trim(),
                    notes: document.getElementById('form-notes').value.trim()
                };

                // Ïú†Ìö®ÏÑ± Í≤ÄÏÇ¨
                if (!formData.meal_date || !formData.delivery_site || !formData.meal_type) {
                    alert('ÌïÑÏàò Ìï≠Î™©ÏùÑ Î™®Îëê ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                    return;
                }

                if (!formData.site_counts) {
                    alert('ÏÇ¨ÏóÖÏû•Î≥Ñ ÏãùÏàòÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                    return;
                }

                const mealCountId = document.getElementById('meal-count-id').value;
                const url = mealCountId ? `/api/admin/meal-counts/${mealCountId}` : '/api/admin/meal-counts';
                const method = mealCountId ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();

                if (result.success) {
                    alert(mealCountId ? 'ÏãùÏàò Ï†ïÎ≥¥Í∞Ä ÏàòÏ†ïÎêòÏóàÏäµÎãàÎã§.' : 'ÏãùÏàò Ï†ïÎ≥¥Í∞Ä Îì±Î°ùÎêòÏóàÏäµÎãàÎã§.');
                    closeMealCountModal();
                    loadMealCounts();
                } else {
                    alert(result.message || 'Ï†ÄÏû• Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
                }
                
            } catch (error) {
                console.error('ÏãùÏàò Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû• Ïã§Ìå®:', error);
                alert('Ï†ÄÏû• Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
            }
        }

        // ÏãùÏàò Îç∞Ïù¥ÌÑ∞ ÏàòÏ†ï
        async function editMealCount(mealCountId) {
            try {
                const response = await fetch(`/api/admin/meal-counts/${mealCountId}`);
                const mealCount = await response.json();
                
                if (mealCount) {
                    document.getElementById('meal-count-modal-title').textContent = 'ÏãùÏàò ÏàòÏ†ï';
                    document.getElementById('meal-count-id').value = mealCount.id;
                    document.getElementById('form-meal-date').value = mealCount.meal_date;
                    document.getElementById('form-delivery-site').value = mealCount.delivery_site;
                    document.getElementById('form-meal-type').value = mealCount.meal_type;
                    document.getElementById('form-target-cost').value = mealCount.target_material_cost;
                    document.getElementById('form-menu-info').value = mealCount.menu_info || '';
                    document.getElementById('form-notes').value = mealCount.notes || '';
                    
                    // ÏÇ¨ÏóÖÏû•Î≥Ñ ÏãùÏàò Îç∞Ïù¥ÌÑ∞ Î≥ÄÌôò
                    const siteCountsText = mealCount.site_details.map(site => 
                        `${site.site_name}:${site.count}`
                    ).join(',');
                    document.getElementById('form-site-counts').value = siteCountsText;
                    
                    document.getElementById('meal-count-modal').classList.remove('hidden');
                }
                
            } catch (error) {
                console.error('ÏãùÏàò Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®:', error);
                alert('ÏãùÏàò Ï†ïÎ≥¥Î•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.');
            }
        }

        // ÏãùÏàò Îç∞Ïù¥ÌÑ∞ Î≥µÏÇ¨
        async function duplicateMealCount(mealCountId) {
            try {
                const response = await fetch(`/api/admin/meal-counts/${mealCountId}`);
                const mealCount = await response.json();
                
                if (mealCount) {
                    document.getElementById('meal-count-modal-title').textContent = 'ÏãùÏàò Î≥µÏÇ¨ Îì±Î°ù';
                    document.getElementById('meal-count-id').value = ''; // ÏÉàÎ°úÏö¥ Îì±Î°ùÏù¥ÎØÄÎ°ú ID ÎπÑÏõÄ
                    
                    // Ïò§Îäò ÎÇ†ÏßúÎ°ú ÏÑ§Ï†ï
                    const today = new Date().toISOString().split('T')[0];
                    document.getElementById('form-meal-date').value = today;
                    
                    document.getElementById('form-delivery-site').value = mealCount.delivery_site;
                    document.getElementById('form-meal-type').value = mealCount.meal_type;
                    document.getElementById('form-target-cost').value = mealCount.target_material_cost;
                    document.getElementById('form-menu-info').value = mealCount.menu_info || '';
                    document.getElementById('form-notes').value = '';
                    
                    // ÏÇ¨ÏóÖÏû•Î≥Ñ ÏãùÏàò Îç∞Ïù¥ÌÑ∞ Î≥ÄÌôò
                    const siteCountsText = mealCount.site_details.map(site => 
                        `${site.site_name}:${site.count}`
                    ).join(',');
                    document.getElementById('form-site-counts').value = siteCountsText;
                    
                    document.getElementById('meal-count-modal').classList.remove('hidden');
                }
                
            } catch (error) {
                console.error('ÏãùÏàò Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®:', error);
                alert('ÏãùÏàò Ï†ïÎ≥¥Î•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.');
            }
        }

        // ÏãùÏàò Îç∞Ïù¥ÌÑ∞ ÏÉàÎ°úÍ≥†Ïπ®
        function refreshMealCounts() {
            loadMealCounts();
        }

        // Î∞úÏ£ºÏÑú Ï∂úÎ†• (Ï∂îÌõÑ Íµ¨ÌòÑ)
        function exportMealCounts() {
            alert('Î∞úÏ£ºÏÑú Ï∂úÎ†• Í∏∞Îä•ÏùÄ Í≥ß Íµ¨ÌòÑÎê† ÏòàÏ†ïÏûÖÎãàÎã§.');
        }

        // ÎÇ†Ïßú Î≥ÄÍ≤Ω Ïù¥Î≤§Ìä∏
        document.addEventListener('DOMContentLoaded', function() {
            const mealCountDateInput = document.getElementById('meal-count-date');
            if (mealCountDateInput) {
                mealCountDateInput.addEventListener('change', loadMealCounts);
            }
        });

        // ===================
        // ÏÇ¨Ïö©Ïûê Í¥ÄÎ¶¨ ÌôïÏû• Í∏∞Îä•
        // ===================
        
        // ÏÇ¨Ïö©Ïûê ÎπÑÎ∞ÄÎ≤àÌò∏ Ï¥àÍ∏∞Ìôî
        async function resetPassword(userId) {
            if (!confirm('Ïù¥ ÏÇ¨Ïö©ÏûêÏùò ÎπÑÎ∞ÄÎ≤àÌò∏Î•º Ï¥àÍ∏∞ÌôîÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/admin/users/${userId}/reset-password`, {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(`ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä Ï¥àÍ∏∞ÌôîÎêòÏóàÏäµÎãàÎã§.\nÏÉà ÎπÑÎ∞ÄÎ≤àÌò∏: ${result.new_password}\nÏÇ¨Ïö©ÏûêÏóêÍ≤å ÏÉà ÎπÑÎ∞ÄÎ≤àÌò∏Î•º Ï†ÑÎã¨Ìï¥Ï£ºÏÑ∏Ïöî.`);
                } else {
                    alert('ÎπÑÎ∞ÄÎ≤àÌò∏ Ï¥àÍ∏∞ÌôîÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
                }
            } catch (error) {
                console.error('ÎπÑÎ∞ÄÎ≤àÌò∏ Ï¥àÍ∏∞Ìôî Ïò§Î•ò:', error);
                alert('ÎπÑÎ∞ÄÎ≤àÌò∏ Ï¥àÍ∏∞Ìôî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
            }
        }
        
        // ÏÇ¨Ïö©Ïûê ÌôúÏÑ± ÏÉÅÌÉú ÌÜ†Í∏Ä
        async function toggleUserStatus(userId, newStatus) {
            const statusText = newStatus ? 'ÌôúÏÑ±Ìôî' : 'ÎπÑÌôúÏÑ±Ìôî';
            if (!confirm(`Ïù¥ ÏÇ¨Ïö©ÏûêÎ•º ${statusText}ÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/admin/users/${userId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ is_active: newStatus })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(`ÏÇ¨Ïö©ÏûêÍ∞Ä ${statusText}ÎêòÏóàÏäµÎãàÎã§.`);
                    loadUsers(); // Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ®
                } else {
                    alert('ÏÉÅÌÉú Î≥ÄÍ≤ΩÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
                }
            } catch (error) {
                console.error('ÏÉÅÌÉú Î≥ÄÍ≤Ω Ïò§Î•ò:', error);
                alert('ÏÉÅÌÉú Î≥ÄÍ≤Ω Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
            }
        }
        
        // ÏÇ¨ÏóÖÏû• Í¥ÄÎ¶¨ Î™®Îã¨ ÌëúÏãú
        async function manageSites(userId) {
            try {
                // ÏÇ¨Ïö©Ïûê ÏÇ¨ÏóÖÏû• Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
                const response = await fetch(`/api/admin/users/${userId}/sites`);
                const data = await response.json();
                
                // Î™®Îì† ÏÇ¨ÏóÖÏû• Ï≤¥ÌÅ¨Î∞ïÏä§ ÏÉùÏÑ±
                const sitesList = document.getElementById('sites-list');
                sitesList.innerHTML = '';
                
                data.all_sites.forEach(site => {
                    const isAssigned = data.assigned_site_ids.includes(site.id);
                    const siteDiv = document.createElement('div');
                    siteDiv.innerHTML = `
                        <label class="checkbox-label" style="margin-bottom: 5px;">
                            <input type="checkbox" 
                                   value="${site.id}" 
                                   ${isAssigned ? 'checked' : ''} 
                                   onchange="updateSitesAllStatus()">
                            ${site.name} (${site.location})
                        </label>
                    `;
                    sitesList.appendChild(siteDiv);
                });
                
                // Ï†ÑÏ≤¥ ÏÑ†ÌÉù Ï≤¥ÌÅ¨Î∞ïÏä§ ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
                updateSitesAllStatus();
                
                // Î™®Îã¨Ïóê ÏÇ¨Ïö©Ïûê ID Ï†ÄÏû•
                document.getElementById('user-sites-container').setAttribute('data-user-id', userId);
                
                // ÏÇ¨ÏóÖÏû• Í¥ÄÎ¶¨ Î™®Îã¨ ÌëúÏãú
                showSitesModal();
                
            } catch (error) {
                console.error('ÏÇ¨ÏóÖÏû• Ï†ïÎ≥¥ Î°úÎìú Ïò§Î•ò:', error);
                alert('ÏÇ¨ÏóÖÏû• Ï†ïÎ≥¥Î•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.');
            }
        }
        
        // ÏÇ¨ÏóÖÏû• Í¥ÄÎ¶¨ Î™®Îã¨ ÌëúÏãú Ìï®Ïàò
        function showSitesModal() {
            // Í∞ÑÎã®Ìïú Î™®Îã¨ HTML ÏÉùÏÑ± (Í∏∞Ï°¥ Î™®Îã¨ Ïû¨ÏÇ¨Ïö©Ìï† ÏàòÎèÑ ÏûàÏùå)
            const modalHtml = `
                <div id="sites-modal" class="modal" style="display: block;">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>ÏÇ¨ÏóÖÏû• Ï†ëÍ∑º Í∂åÌïú Í¥ÄÎ¶¨</h3>
                            <button class="modal-close" onclick="closeSitesModal()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label>Ï†ëÍ∑º Í∞ÄÎä•Ìïú ÏÇ¨ÏóÖÏû•</label>
                                <div id="user-sites-container-modal" style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 4px;">
                                    <label class="checkbox-label" style="margin-bottom: 10px;">
                                        <input type="checkbox" id="sites-all-modal" onchange="toggleAllSitesModal(this)">
                                        <strong>Î™®Îì† ÏÇ¨ÏóÖÏû•</strong>
                                    </label>
                                    <div id="sites-list-modal">
                                        ${document.getElementById('sites-list').innerHTML}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn-primary" onclick="saveSitesAssignment()">Ï†ÄÏû•</button>
                            <button class="btn-secondary" onclick="closeSitesModal()">Ï∑®ÏÜå</button>
                        </div>
                    </div>
                </div>
            `;
            
            // Í∏∞Ï°¥ Î™®Îã¨ Ï†úÍ±∞ ÌõÑ ÏÉà Î™®Îã¨ Ï∂îÍ∞Ä
            const existingModal = document.getElementById('sites-modal');
            if (existingModal) {
                existingModal.remove();
            }
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }
        
        // ÏÇ¨ÏóÖÏû• Î™®Îã¨ Îã´Í∏∞
        function closeSitesModal() {
            const modal = document.getElementById('sites-modal');
            if (modal) {
                modal.remove();
            }
        }
        
        // Î™®Îì† ÏÇ¨ÏóÖÏû• ÏÑ†ÌÉù/Ìï¥Ï†ú
        function toggleAllSites(checkbox) {
            const sitesList = document.getElementById('sites-list');
            const siteCheckboxes = sitesList.querySelectorAll('input[type="checkbox"]');
            
            siteCheckboxes.forEach(cb => {
                cb.checked = checkbox.checked;
            });
        }
        
        // Î™®Îì† ÏÇ¨ÏóÖÏû• ÏÑ†ÌÉù/Ìï¥Ï†ú (Î™®Îã¨Ïö©)
        function toggleAllSitesModal(checkbox) {
            const sitesList = document.getElementById('sites-list-modal');
            const siteCheckboxes = sitesList.querySelectorAll('input[type="checkbox"]');
            
            siteCheckboxes.forEach(cb => {
                cb.checked = checkbox.checked;
            });
        }
        
        // Ï†ÑÏ≤¥ ÏÑ†ÌÉù ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
        function updateSitesAllStatus() {
            const sitesList = document.getElementById('sites-list');
            const allCheckbox = document.getElementById('sites-all');
            
            if (!sitesList || !allCheckbox) return;
            
            const siteCheckboxes = sitesList.querySelectorAll('input[type="checkbox"]');
            const checkedCount = Array.from(siteCheckboxes).filter(cb => cb.checked).length;
            
            allCheckbox.checked = checkedCount === siteCheckboxes.length && siteCheckboxes.length > 0;
        }
        
        // ÏÇ¨ÏóÖÏû• Ìï†Îãπ Ï†ÄÏû•
        async function saveSitesAssignment() {
            const userId = document.getElementById('user-sites-container').getAttribute('data-user-id');
            const sitesList = document.getElementById('sites-list-modal');
            const checkedSites = Array.from(sitesList.querySelectorAll('input[type="checkbox"]:checked'))
                                       .map(cb => parseInt(cb.value));
            
            try {
                const response = await fetch(`/api/admin/users/${userId}/sites`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ site_ids: checkedSites })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('ÏÇ¨ÏóÖÏû• Ìï†ÎãπÏù¥ Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.');
                    closeSitesModal();
                    loadUsers(); // Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ®
                } else {
                    alert('ÏÇ¨ÏóÖÏû• Ìï†Îãπ Ï†ÄÏû•Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
                }
            } catch (error) {
                console.error('ÏÇ¨ÏóÖÏû• Ìï†Îãπ Ï†ÄÏû• Ïò§Î•ò:', error);
                alert('Ï†ÄÏû• Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
            }
        }
        
        // Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ ÌôïÏû• Ï¥àÍ∏∞Ìôî
        async function initUserExtensions() {
            if (!confirm('ÏÇ¨Ïö©Ïûê Í¥ÄÎ¶¨ Í∏∞Îä•ÏùÑ ÌôïÏû•ÌïòÏãúÍ≤†ÏäµÎãàÍπå? (Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ ÏóÖÎç∞Ïù¥Ìä∏)')) {
                return;
            }
            
            try {
                const response = await fetch('/api/admin/init_user_extensions', {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('ÏÇ¨Ïö©Ïûê Í¥ÄÎ¶¨ Í∏∞Îä•Ïù¥ ÌôïÏû•ÎêòÏóàÏäµÎãàÎã§.\nÌéòÏù¥ÏßÄÎ•º ÏÉàÎ°úÍ≥†Ïπ®Ìï©ÎãàÎã§.');
                    window.location.reload();
                } else {
                    alert('Í∏∞Îä• ÌôïÏû•Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
                }
            } catch (error) {
                console.error('Í∏∞Îä• ÌôïÏû• Ïò§Î•ò:', error);
                alert('Í∏∞Îä• ÌôïÏû• Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
            }
        }
        
        // ===========================================
        // Í≥µÍ∏âÏóÖÏ≤¥ Í¥ÄÎ¶¨ ÌôïÏû• Í∏∞Îä•
        // ===========================================
        
        // ÌÉ≠ Ï†ÑÌôò Ìï®ÏàòÎì§
        function showIngredientTab() {
            document.getElementById('ingredient-tab-content').classList.remove('hidden');
            
            // ÌÉ≠ Î≤ÑÌäº Ïä§ÌÉÄÏùº Î≥ÄÍ≤Ω
            const tabButton = document.querySelector('.tab-button');
            if (tabButton) {
                tabButton.style.borderBottomColor = '#007bff';
                tabButton.style.backgroundColor = '#f8f9fa';
            }
        }
        
        
        // Í≥µÍ∏âÏóÖÏ≤¥ Í∏∞Îä• ÌôïÏû• Ï¥àÍ∏∞Ìôî
        async function initSupplierExtensions() {
            if (!confirm('Í≥µÍ∏âÏóÖÏ≤¥ Í¥ÄÎ¶¨ Í∏∞Îä•ÏùÑ ÌôïÏû•ÌïòÏãúÍ≤†ÏäµÎãàÍπå? (Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ ÏóÖÎç∞Ïù¥Ìä∏)')) {
                return;
            }
            
            try {
                const response = await fetch('/api/admin/init_supplier_extensions', {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(result.message + '\nÌéòÏù¥ÏßÄÎ•º ÏÉàÎ°úÍ≥†Ïπ®Ìï©ÎãàÎã§.');
                    window.location.reload();
                } else {
                    alert('Í∏∞Îä• ÌôïÏû•Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§: ' + result.message);
                }
            } catch (error) {
                console.error('Í∏∞Îä• ÌôïÏû• Ïò§Î•ò:', error);
                alert('Í∏∞Îä• ÌôïÏû• Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
            }
        }
        
        // Í≥µÍ∏âÏóÖÏ≤¥ Í¥ÄÎ¶¨ Î≥ÄÏàòÎì§
        let currentSupplierPage = 1;
        let totalSupplierPages = 1;
        let currentEditSupplierId = null;
        
        // Í≥µÍ∏âÏóÖÏ≤¥ Î™©Î°ù Î°úÎìú
        async function loadSuppliers() {
            try {
                const search = document.getElementById('supplier-search')?.value || '';
                const page = currentSupplierPage || 1;
                const response = await fetch(`/api/admin/suppliers/enhanced?page=${page}&limit=20&search=${encodeURIComponent(search)}`);
                const data = await response.json();
                
                if (data.suppliers) {
                    displaySuppliers(data.suppliers);
                    updateSupplierPagination(data.page, data.total_pages);
                }
            } catch (error) {
                console.error('Í≥µÍ∏âÏóÖÏ≤¥ Î™©Î°ù Î°úÎìú Ïã§Ìå®:', error);
                document.getElementById('suppliers-table-body').innerHTML = 
                    '<tr><td colspan="11">Í≥µÍ∏âÏóÖÏ≤¥ Î™©Î°ùÏùÑ Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.</td></tr>';
            }
        }
        
        // Í≥µÍ∏âÏóÖÏ≤¥ Î™©Î°ù ÌëúÏãú
        function displaySuppliers(suppliers) {
            const tbody = document.getElementById('suppliers-table-body');
            
            if (!suppliers || suppliers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="11">Îì±Î°ùÎêú Í≥µÍ∏âÏóÖÏ≤¥Í∞Ä ÏóÜÏäµÎãàÎã§.</td></tr>';
                return;
            }
            
            tbody.innerHTML = suppliers.map(supplier => `
                <tr>
                    <td><strong>${supplier.parent_code || '-'}</strong></td>
                    <td><strong>${supplier.site_code || '-'}</strong></td>
                    <td>${supplier.site_name || '-'}</td>
                    <td><strong>${supplier.name || '-'}</strong></td>
                    <td>${supplier.phone || supplier.contact || '-'}</td>
                    <td>${supplier.email || '-'}</td>
                    <td><span class="${supplier.is_active ? 'status-active' : 'status-inactive'}">
                        ${supplier.is_active ? 'Í±∞ÎûòÏ§ë' : 'Ï§ëÎã®'}
                    </span></td>
                    <td>${supplier.business_number || '-'}</td>
                    <td>${supplier.representative || '-'}</td>
                    <td>${supplier.manager_name || '-'}</td>
                    <td>
                        <button class="btn-small btn-edit" onclick="editSupplier(${supplier.id})" style="background: #28a745; margin-right: 5px;">ÏàòÏ†ï</button>
                        <button class="btn-small btn-toggle" onclick="toggleSupplierStatus(${supplier.id}, ${!supplier.is_active})" 
                                style="background: ${supplier.is_active ? '#dc3545' : '#17a2b8'}; margin-right: 5px;">
                            ${supplier.is_active ? 'Ï§ëÎã®' : 'Ïû¨Í∞ú'}
                        </button>
                        <button class="btn-small btn-delete" onclick="deleteSupplier(${supplier.id})" style="background: #6c757d;">ÏÇ≠Ï†ú</button>
                    </td>
                </tr>
            `).join('');
        }
        
        // Í≥µÍ∏âÏóÖÏ≤¥ ÌéòÏù¥ÏßÄÎÑ§Ïù¥ÏÖò ÏóÖÎç∞Ïù¥Ìä∏
        function updateSupplierPagination(currentPage, totalPages) {
            currentSupplierPage = currentPage;
            totalSupplierPages = totalPages;
            const pageInfoElement = document.getElementById('supplier-page-info');
            if (pageInfoElement) {
                pageInfoElement.textContent = `${currentPage} / ${totalPages}`;
            }
        }
        
        // Í≥µÍ∏âÏóÖÏ≤¥ ÌéòÏù¥ÏßÄ Î≥ÄÍ≤Ω
        function changeSupplierPage(direction) {
            const newPage = currentSupplierPage + direction;
            if (newPage >= 1 && newPage <= totalSupplierPages) {
                currentSupplierPage = newPage;
                loadSuppliers();
            }
        }
        
        // Í≥µÍ∏âÏóÖÏ≤¥ Í≤ÄÏÉâ
        function searchSuppliers() {
            currentSupplierPage = 1;
            loadSuppliers();
        }
        
        // Í≥µÍ∏âÏóÖÏ≤¥ Ï∂îÍ∞Ä Î™®Îã¨ ÌëúÏãú
        function showAddSupplierModal() {
            currentEditSupplierId = null;
            document.getElementById('supplier-modal-title').textContent = 'ÏÉà ÏóÖÏ≤¥ Îì±Î°ù';
            clearSupplierForm();
            document.getElementById('supplier-modal').classList.remove('hidden');
        }
        
        // Í≥µÍ∏âÏóÖÏ≤¥ ÏàòÏ†ï Î™®Îã¨ ÌëúÏãú
        async function editSupplier(supplierId) {
            try {
                const response = await fetch(`/api/admin/suppliers/${supplierId}/detail`);
                const result = await response.json();
                const supplier = result.supplier || result;
                
                if (!response.ok) {
                    throw new Error('Í≥µÍ∏âÏóÖÏ≤¥ Ï†ïÎ≥¥Î•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.');
                }
                
                currentEditSupplierId = supplierId;
                document.getElementById('supplier-modal-title').textContent = 'ÏóÖÏ≤¥ Ï†ïÎ≥¥ ÏàòÏ†ï';
                
                // ÌèºÏóê Îç∞Ïù¥ÌÑ∞ Ï±ÑÏö∞Í∏∞
                document.getElementById('supplier-name').value = supplier.name || '';
                document.getElementById('supplier-parent-code').value = supplier.parent_code || '';
                document.getElementById('supplier-site-code').value = supplier.site_code || '';
                document.getElementById('supplier-site-name').value = supplier.site_name || '';
                document.getElementById('supplier-representative').value = supplier.representative || '';
                document.getElementById('supplier-contact').value = supplier.contact || '';
                document.getElementById('supplier-phone').value = supplier.phone || '';
                document.getElementById('supplier-fax').value = supplier.fax || '';
                document.getElementById('supplier-email').value = supplier.email || '';
                document.getElementById('supplier-address').value = supplier.address || '';
                document.getElementById('supplier-business-number').value = supplier.business_number || '';
                document.getElementById('supplier-business-type').value = supplier.business_type || '';
                document.getElementById('supplier-business-item').value = supplier.business_item || '';
                document.getElementById('supplier-manager-name').value = supplier.manager_name || '';
                document.getElementById('supplier-manager-phone').value = supplier.manager_phone || '';
                document.getElementById('supplier-update-frequency').value = supplier.update_frequency || 'weekly';
                document.getElementById('supplier-is-active').checked = supplier.is_active !== false;
                document.getElementById('supplier-notes').value = supplier.notes || '';
                
                document.getElementById('supplier-modal').classList.remove('hidden');
                
            } catch (error) {
                console.error('Í≥µÍ∏âÏóÖÏ≤¥ Ï†ïÎ≥¥ Î°úÎìú Ïò§Î•ò:', error);
                alert('Í≥µÍ∏âÏóÖÏ≤¥ Ï†ïÎ≥¥Î•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.');
            }
        }
        
        // Í≥µÍ∏âÏóÖÏ≤¥ Ìèº Ï¥àÍ∏∞Ìôî
        function clearSupplierForm() {
            document.getElementById('supplier-form').reset();
            document.getElementById('supplier-is-active').checked = true;
        }
        
        // Í≥µÍ∏âÏóÖÏ≤¥ Ï†ÄÏû•
        async function saveSupplier() {
            const supplierData = {
                name: document.getElementById('supplier-name').value.trim(),
                parent_code: document.getElementById('supplier-parent-code').value.trim(),
                site_code: document.getElementById('supplier-site-code').value.trim(),
                site_name: document.getElementById('supplier-site-name').value.trim(),
                representative: document.getElementById('supplier-representative').value,
                contact: document.getElementById('supplier-contact').value,
                phone: document.getElementById('supplier-phone').value.trim(),
                fax: document.getElementById('supplier-fax').value,
                email: document.getElementById('supplier-email').value.trim(),
                address: document.getElementById('supplier-address').value.trim(),
                business_number: document.getElementById('supplier-business-number').value,
                business_type: document.getElementById('supplier-business-type').value,
                business_item: document.getElementById('supplier-business-item').value,
                manager_name: document.getElementById('supplier-manager-name').value,
                manager_phone: document.getElementById('supplier-manager-phone').value,
                update_frequency: document.getElementById('supplier-update-frequency').value,
                is_active: document.getElementById('supplier-is-active').checked,
                notes: document.getElementById('supplier-notes').value
            };
            
            // ÌïÑÏàò ÌïÑÎìú Í≤ÄÏ¶ù
            const parentCode = document.getElementById('supplier-parent-code').value.trim();
            const siteName = document.getElementById('supplier-site-name').value.trim();
            const siteCode = document.getElementById('supplier-site-code').value.trim();
            
            
            if (!supplierData.name) {
                alert('ÏãùÏûêÏû¨ÏóÖÏ≤¥Î™ÖÏùÄ ÌïÑÏàòÏûÖÎãàÎã§.');
                return;
            }
            
            if (!supplierData.address) {
                alert('Ï£ºÏÜåÎäî ÌïÑÏàòÏûÖÎãàÎã§.');
                return;
            }
            
            if (!supplierData.phone && !supplierData.email) {
                alert('Ïó∞ÎùΩÏ≤ò ÎòêÎäî Ïù¥Î©îÏùº Ï§ë ÌïòÎÇòÎäî Î∞òÎìúÏãú ÏûÖÎ†•Ìï¥Ïïº Ìï©ÎãàÎã§.');
                return;
            }
            
            // ÏÉàÎ°úÏö¥ ÌïÑÎìú Ï∂îÍ∞Ä
            supplierData.parent_code = parentCode;
            supplierData.site_name = siteName;
            supplierData.site_code = siteCode;
            
            try {
                const url = currentEditSupplierId 
                    ? `/api/admin/suppliers/${currentEditSupplierId}/update`
                    : '/api/admin/suppliers/create';
                const method = currentEditSupplierId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(supplierData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(currentEditSupplierId ? 'ÏóÖÏ≤¥ Ï†ïÎ≥¥Í∞Ä ÏàòÏ†ïÎêòÏóàÏäµÎãàÎã§.' : 'ÏÉà ÏóÖÏ≤¥Í∞Ä Îì±Î°ùÎêòÏóàÏäµÎãàÎã§.');
                    closeSupplierModal();
                    loadSuppliers();
                } else {
                    alert('Ï†ÄÏû•Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§: ' + (result.message || 'Ïïå Ïàò ÏóÜÎäî Ïò§Î•ò'));
                }
            } catch (error) {
                console.error('Í≥µÍ∏âÏóÖÏ≤¥ Ï†ÄÏû• Ïò§Î•ò:', error);
                alert('Ï†ÄÏû• Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
            }
        }
        
        // Í≥µÍ∏âÏóÖÏ≤¥ Í±∞Îûò ÏÉÅÌÉú ÌÜ†Í∏Ä
        async function toggleSupplierStatus(supplierId, newStatus) {
            const statusText = newStatus ? 'Í±∞ÎûòÎ•º Ïû¨Í∞ú' : 'Í±∞ÎûòÎ•º Ï§ëÎã®';
            if (!confirm(`Ïù¥ ÏóÖÏ≤¥ÏôÄÏùò ${statusText}ÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/admin/suppliers/${supplierId}/update`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ is_active: newStatus })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(`ÏóÖÏ≤¥ Í±∞Îûò ÏÉÅÌÉúÍ∞Ä Î≥ÄÍ≤ΩÎêòÏóàÏäµÎãàÎã§.`);
                    loadSuppliers();
                } else {
                    alert('ÏÉÅÌÉú Î≥ÄÍ≤ΩÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
                }
            } catch (error) {
                console.error('ÏÉÅÌÉú Î≥ÄÍ≤Ω Ïò§Î•ò:', error);
                alert('ÏÉÅÌÉú Î≥ÄÍ≤Ω Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
            }
        }
        
        // Í≥µÍ∏âÏóÖÏ≤¥ ÏÇ≠Ï†ú
        async function deleteSupplier(supplierId) {
            if (!confirm('Ïù¥ ÏóÖÏ≤¥Î•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?\nÏó∞Í¥ÄÎêú ÏãùÏûêÏû¨Í∞Ä ÏûàÎäî Í≤ΩÏö∞ ÏÇ≠Ï†úÎêòÏßÄ ÏïäÏäµÎãàÎã§.')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/admin/suppliers/${supplierId}/delete`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('ÏóÖÏ≤¥Í∞Ä ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.');
                    loadSuppliers();
                } else {
                    alert(result.message || 'ÏÇ≠Ï†úÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
                }
            } catch (error) {
                console.error('ÏóÖÏ≤¥ ÏÇ≠Ï†ú Ïò§Î•ò:', error);
                alert('ÏÇ≠Ï†ú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
            }
        }
        
        // Í≥µÍ∏âÏóÖÏ≤¥ Î™®Îã¨ Îã´Í∏∞
        function closeSupplierModal() {
            document.getElementById('supplier-modal').classList.add('hidden');
            currentEditSupplierId = null;
        }
        
        // ÏûêÏΩîÎìú ÏûêÎèô ÏÉùÏÑ± Ìï®Ïàò
        async function suggestSiteCode() {
            const parentCode = document.getElementById('supplier-parent-code').value.trim();
            if (!parentCode) {
                document.getElementById('supplier-site-code').value = '';
                return;
            }
            
            try {
                // Í∏∞Ï°¥ ÏûêÏΩîÎìúÎì§ Ï°∞Ìöå
                const response = await fetch(`/api/admin/suppliers/enhanced?search=${parentCode}`);
                const result = await response.json();
                
                if (result.success && result.suppliers) {
                    const existingSiteCodes = result.suppliers
                        .filter(s => s.parent_code === parentCode)
                        .map(s => s.site_code)
                        .filter(code => code && code.includes('-'));
                    
                    // Îã§Ïùå ÏàúÎ≤à Í≥ÑÏÇ∞
                    let nextNumber = 1;
                    if (existingSiteCodes.length > 0) {
                        const numbers = existingSiteCodes.map(code => {
                            const parts = code.split('-');
                            return parseInt(parts[parts.length - 1]) || 0;
                        });
                        nextNumber = Math.max(...numbers) + 1;
                    }
                    
                    // ÏûêÏΩîÎìú ÏûêÎèô ÏÉùÏÑ±
                    const suggestedCode = `${parentCode}-${String(nextNumber).padStart(2, '0')}`;
                    document.getElementById('supplier-site-code').value = suggestedCode;
                    
                    // Í∏∞Ï°¥ ÏÇ¨ÏóÖÏû• Ï†ïÎ≥¥ ÌëúÏãú (existing-sites-info ÏöîÏÜåÍ∞Ä ÏûàÎäî Í≤ΩÏö∞ÏóêÎßå)
                    const infoElement = document.getElementById('existing-sites-info');
                    if (infoElement && existingSiteCodes.length > 0) {
                        infoElement.innerHTML = 
                            `<span style="color: #28a745;">Í∏∞Ï°¥ ÏÇ¨ÏóÖÏû• ${existingSiteCodes.length}Í∞ú | Ïã†Í∑ú: ${suggestedCode}</span>`;
                    }
                } else {
                    // Ï≤´ Î≤àÏß∏ ÏûêÏΩîÎìú
                    const suggestedCode = `${parentCode}-01`;
                    document.getElementById('supplier-site-code').value = suggestedCode;
                }
            } catch (error) {
                console.error('ÏûêÏΩîÎìú ÏÉùÏÑ± Ïò§Î•ò:', error);
                // Ïò§Î•ò Ïãú Í∏∞Î≥∏ ÏûêÏΩîÎìú ÏÉùÏÑ±
                const suggestedCode = `${parentCode}-01`;
                document.getElementById('supplier-site-code').value = suggestedCode;
            }
        }
        
        // ÏûêÏΩîÎìú ÏßÅÏ†ë ÏàòÏ†ï Í∏∞Îä•
        function editSiteCode() {
            const siteCodeInput = document.getElementById('supplier-site-code');
            if (siteCodeInput.readOnly) {
                siteCodeInput.readOnly = false;
                siteCodeInput.style.backgroundColor = '#ffffff';
                siteCodeInput.focus();
            }
        }

        // ===== ÌÜµÌï© ÏãùÎã®Ìëú Í¥ÄÎ¶¨ Í¥ÄÎ†® Ìï®ÏàòÎì§ =====
        
        // ÏãùÎã®Ìëú ÌÉ≠ Ï†ÑÌôò
        function showMealPlanTab(tabName) {
            // Î™®Îì† ÌÉ≠ Î≤ÑÌäº ÎπÑÌôúÏÑ±Ìôî
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Î™®Îì† ÌÉ≠ Ïª®ÌÖêÏ∏† Ïà®ÍπÄ
            document.querySelectorAll('.meal-plan-tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            // ÏÑ†ÌÉùÎêú ÌÉ≠ ÌôúÏÑ±Ìôî
            const activeBtn = document.querySelector(`[data-tab="${tabName}"]`);
            if (activeBtn) activeBtn.classList.add('active');
            
            const activeTab = document.getElementById(`${tabName}-tab`);
            if (activeTab) activeTab.classList.remove('hidden');
            
            // ÌÉ≠Î≥Ñ Ï¥àÍ∏∞Ìôî Î°úÏßÅ
            if (tabName === 'master') {
                loadMasterMealPlans();
            } else if (tabName === 'batch') {
                initializeBatchTab();
            }
        }

        // ÎßàÏä§ÌÑ∞ ÏãùÎã®Ìëú Î™©Î°ù Î°úÎìú
        function loadMasterMealPlans() {
            const listContainer = document.getElementById('master-meal-plan-list');
            if (listContainer) {
                listContainer.innerHTML = `
                    <div style="display: grid; gap: 15px;">
                        <div style="border: 1px solid #ddd; border-radius: 8px; padding: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <h4>üç± ÎèÑÏãúÎùΩ ÎßàÏä§ÌÑ∞ ÏãùÎã®Ìëú</h4>
                                    <p style="color: #666; margin: 5px 0;">2025ÎÖÑ 9Ïõî 2Ï£ºÏ∞®</p>
                                </div>
                                <div>
                                    <button onclick="editMasterMealPlan('dosirak')" style="padding: 6px 12px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 5px;">Ìé∏Ïßë</button>
                                </div>
                            </div>
                        </div>
                        
                        <div style="border: 1px solid #ddd; border-radius: 8px; padding: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <h4>üöö Ïö¥Î∞ò ÎßàÏä§ÌÑ∞ ÏãùÎã®Ìëú</h4>
                                    <p style="color: #666; margin: 5px 0;">2025ÎÖÑ 9Ïõî 2Ï£ºÏ∞®</p>
                                </div>
                                <div>
                                    <button onclick="editMasterMealPlan('transport')" style="padding: 6px 12px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 5px;">Ìé∏Ïßë</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        // ÏùºÍ¥Ñ ÌÉ≠ Ï¥àÍ∏∞Ìôî
        function initializeBatchTab() {
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];
            const weekLater = new Date(today);
            weekLater.setDate(today.getDate() + 7);
            const weekLaterStr = weekLater.toISOString().split('T')[0];
            
            const startDateEl = document.getElementById('batch-start-date');
            const endDateEl = document.getElementById('batch-end-date');
            if (startDateEl) startDateEl.value = todayStr;
            if (endDateEl) endDateEl.value = weekLaterStr;
        }

        // ÏãùÎã®Ìëú Ïú†ÌòïÎ≥Ñ Í¥ÄÎ¶¨
        function manageMealPlanType(type) {
            const typeNames = {
                'dosirak': 'ÎèÑÏãúÎùΩ',
                'transport': 'Ïö¥Î∞ò',
                'school': 'ÌïôÍµê',
                'care': 'ÏöîÏñëÏõê'
            };
            alert(`${typeNames[type]} ÏãùÎã®Ìëú Í¥ÄÎ¶¨ Í∏∞Îä•ÏùÑ Íµ¨ÌòÑ Ï§ëÏûÖÎãàÎã§.`);
        }

        // ÎßàÏä§ÌÑ∞ ÏãùÎã®Ìëú ÏÉùÏÑ±
        function createMasterMealPlan() {
            alert('ÎßàÏä§ÌÑ∞ ÏãùÎã®Ìëú ÏÉùÏÑ± Í∏∞Îä•ÏùÑ Íµ¨ÌòÑ Ï§ëÏûÖÎãàÎã§.');
        }

        // ÎßàÏä§ÌÑ∞ ÏãùÎã®Ìëú Ìé∏Ïßë
        function editMasterMealPlan(type) {
            window.open('meal_plan_management.html', '_blank');
        }

        // ÏßÄÏãúÏÑú ÏÉùÏÑ± Ìï®ÏàòÎì§
        function generatePreprocessingInstruction() {
            alert('Ï†ÑÏ≤òÎ¶¨ ÏßÄÏãúÏÑú ÏùºÍ¥Ñ ÏÉùÏÑ± Í∏∞Îä•ÏùÑ Íµ¨ÌòÑ Ï§ëÏûÖÎãàÎã§.');
        }

        function generateCookingInstruction() {
            alert('Ï°∞Î¶¨ ÏßÄÏãúÏÑú ÏùºÍ¥Ñ ÏÉùÏÑ± Í∏∞Îä•ÏùÑ Íµ¨ÌòÑ Ï§ëÏûÖÎãàÎã§.');
        }

        function generatePortionInstruction() {
            alert('ÏÜåÎ∂Ñ ÏßÄÏãúÏÑú ÏùºÍ¥Ñ ÏÉùÏÑ± Í∏∞Îä•ÏùÑ Íµ¨ÌòÑ Ï§ëÏûÖÎãàÎã§.');
        }

        function generateAllInstructions() {
            const dateSelect = document.getElementById('instruction-date-select');
            const selectedDate = dateSelect ? dateSelect.value : '';
            
            if (!selectedDate || selectedDate === 'ÏÉùÏÑ±Ìï† ÎÇ†Ïßú ÏÑ†ÌÉù') {
                alert('ÏÉùÏÑ±Ìï† ÎÇ†ÏßúÎ•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }
            
            if (confirm(`${selectedDate}Ïóê ÎåÄÌïú Î™®Îì† ÏßÄÏãúÏÑú(Ï†ÑÏ≤òÎ¶¨, Ï°∞Î¶¨, ÏÜåÎ∂Ñ)Î•º ÏùºÍ¥Ñ ÏÉùÏÑ±ÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) {
                alert('Î™®Îì† ÏßÄÏãúÏÑú ÏùºÍ¥Ñ ÏÉùÏÑ± Í∏∞Îä•ÏùÑ Íµ¨ÌòÑ Ï§ëÏûÖÎãàÎã§.');
            }
        }

        // ÏùºÍ¥Ñ ÏÉùÏÑ± Ìï®ÏàòÎì§
        function batchGenerateMealPlans() {
            const startDate = document.getElementById('batch-start-date')?.value;
            const endDate = document.getElementById('batch-end-date')?.value;
            const targetType = document.getElementById('batch-target-type')?.value;
            
            if (!startDate || !endDate) {
                alert('ÏãúÏûëÏùºÍ≥º Ï¢ÖÎ£åÏùºÏùÑ Î™®Îëê ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }
            
            const typeNames = {
                'all': 'Ï†ÑÏ≤¥',
                'dosirak': 'ÎèÑÏãúÎùΩ',
                'transport': 'Ïö¥Î∞ò',
                'school': 'ÌïôÍµê',
                'care': 'ÏöîÏñëÏõê'
            };
            
            if (confirm(`${startDate}Î∂ÄÌÑ∞ ${endDate}ÍπåÏßÄ ${typeNames[targetType]} ÏãùÎã®ÌëúÎ•º ÏùºÍ¥Ñ ÏÉùÏÑ±ÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) {
                alert('ÏùºÍ¥Ñ ÏÉùÏÑ± Í∏∞Îä•ÏùÑ Íµ¨ÌòÑ Ï§ëÏûÖÎãàÎã§.');
            }
        }

        function createFromTemplate() {
            alert('ÌÖúÌîåÎ¶ø Í∏∞Î∞ò ÏÉùÏÑ± Í∏∞Îä•ÏùÑ Íµ¨ÌòÑ Ï§ëÏûÖÎãàÎã§.');
        }

        function showWeeklyMealPlans() {
            alert('Ï£ºÍ∞Ñ ÏãùÎã®Ìëú Î≥¥Í∏∞ Í∏∞Îä•ÏùÑ Íµ¨ÌòÑ Ï§ëÏûÖÎãàÎã§.');
        }

        // Îã®Í∞ÄÍ¥ÄÎ¶¨ Í¥ÄÎ†® Ìï®ÏàòÎì§
        let pricingData = [];

        async function loadPricingCustomers() {
            try {
                const response = await fetch('/api/customers');
                const result = await response.json();
                const customers = result.customers || result.data || [];
                
                const select = document.getElementById('pricing-customer-select');
                select.innerHTML = '<option value="">ÏÇ¨ÏóÖÏû• ÏÑ†ÌÉù</option>';
                
                customers.forEach(customer => {
                    const option = document.createElement('option');
                    option.value = customer.id;
                    option.textContent = customer.name;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('ÏÇ¨ÏóÖÏû• Î™©Î°ù Î°úÎìú Ïã§Ìå®:', error);
                alert('ÏÇ¨ÏóÖÏû• Î™©Î°ùÏùÑ Î∂àÎü¨Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
            }
        }

        async function loadPricingData() {
            const customerId = document.getElementById('pricing-customer-select').value;
            const mealTypeFilter = document.getElementById('pricing-meal-type-filter').value;
            
            if (!customerId) {
                alert('ÏÇ¨ÏóÖÏû•ÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }

            try {
                // Ìï¥Îãπ ÏÇ¨ÏóÖÏû•Ïùò ÏãùÎã®Ìëú Î™©Î°ùÏùÑ Í∞ÄÏ†∏ÏôÄÏÑú Îã®Í∞Ä Ï†ïÎ≥¥ ÏÉùÏÑ±
                const response = await fetch(`/api/diet-plans?customer_id=${customerId}`);
                const dietPlans = await response.json();
                
                // Îã®Í∞Ä Ï†ïÎ≥¥ ÌÖåÏù¥Î∏î ÏÉùÏÑ±
                const tableBody = document.getElementById('pricing-table-body');
                tableBody.innerHTML = '';
                
                if (dietPlans.length === 0) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="7" style="padding: 40px; text-align: center; color: #666;">
                                Ìï¥Îãπ ÏÇ¨ÏóÖÏû•Ïóê ÏãùÎã®ÌëúÍ∞Ä ÏóÜÏäµÎãàÎã§. Î®ºÏ†Ä ÏãùÎã®ÌëúÎ•º ÏÉùÏÑ±Ìï¥Ï£ºÏÑ∏Ïöî.
                            </td>
                        </tr>
                    `;
                    return;
                }

                pricingData = [];
                
                // ÏãùÎã®ÌëúÎ≥ÑÎ°ú ÏïÑÏπ®, Ï†êÏã¨, Ï†ÄÎÖÅÏóê ÎåÄÌïú Îã®Í∞Ä Ï†ïÎ≥¥ ÏÉùÏÑ±
                dietPlans.forEach(plan => {
                    ['ÏïÑÏπ®', 'Ï†êÏã¨', 'Ï†ÄÎÖÅ'].forEach(mealTime => {
                        if (mealTypeFilter === 'all' || plan.meal_type === mealTypeFilter) {
                            const pricingItem = {
                                customer_name: plan.customer_name,
                                meal_type: plan.meal_type,
                                meal_time: mealTime,
                                sales_price: '',
                                target_cost: '',
                                profit_margin: 0,
                                updated_date: ''
                            };
                            
                            pricingData.push(pricingItem);
                            
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td style="padding: 8px; border: 1px solid #dee2e6;">${plan.customer_name}</td>
                                <td style="padding: 8px; border: 1px solid #dee2e6;">${plan.meal_type}</td>
                                <td style="padding: 8px; border: 1px solid #dee2e6;">${mealTime}</td>
                                <td style="padding: 8px; border: 1px solid #dee2e6; text-align: center;">
                                    <input type="number" class="pricing-input sales-price" 
                                           style="width: 80px; padding: 4px; border: 1px solid #ddd; border-radius: 3px; text-align: right;"
                                           placeholder="0" data-index="${pricingData.length - 1}" onchange="updateProfitMargin(this)">
                                </td>
                                <td style="padding: 8px; border: 1px solid #dee2e6; text-align: center;">
                                    <input type="number" class="pricing-input target-cost" 
                                           style="width: 80px; padding: 4px; border: 1px solid #ddd; border-radius: 3px; text-align: right;"
                                           placeholder="0" data-index="${pricingData.length - 1}" onchange="updateProfitMargin(this)">
                                </td>
                                <td style="padding: 8px; border: 1px solid #dee2e6; text-align: center;">
                                    <span class="profit-margin" data-index="${pricingData.length - 1}" style="font-weight: bold;">-</span>
                                </td>
                                <td style="padding: 8px; border: 1px solid #dee2e6; text-align: center; color: #666;">
                                    <span class="updated-date" data-index="${pricingData.length - 1}">-</span>
                                </td>
                            `;
                            tableBody.appendChild(row);
                        }
                    });
                });
                
                updatePricingSummary();
                
            } catch (error) {
                console.error('Îã®Í∞Ä Ï†ïÎ≥¥ Î°úÎìú Ïã§Ìå®:', error);
                alert('Îã®Í∞Ä Ï†ïÎ≥¥Î•º Î∂àÎü¨Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
            }
        }

        function updateProfitMargin(input) {
            const index = input.dataset.index;
            const row = input.closest('tr');
            const salesPriceInput = row.querySelector('.sales-price');
            const targetCostInput = row.querySelector('.target-cost');
            const profitMarginSpan = row.querySelector('.profit-margin');
            
            const salesPrice = parseFloat(salesPriceInput.value) || 0;
            const targetCost = parseFloat(targetCostInput.value) || 0;
            
            if (salesPrice > 0 && targetCost > 0) {
                const margin = ((salesPrice - targetCost) / salesPrice * 100).toFixed(1);
                profitMarginSpan.textContent = margin + '%';
                profitMarginSpan.style.color = margin > 0 ? '#27ae60' : '#e74c3c';
                
                // Îç∞Ïù¥ÌÑ∞ ÏóÖÎç∞Ïù¥Ìä∏
                if (pricingData[index]) {
                    pricingData[index].sales_price = salesPrice;
                    pricingData[index].target_cost = targetCost;
                    pricingData[index].profit_margin = parseFloat(margin);
                }
            } else {
                profitMarginSpan.textContent = '-';
                profitMarginSpan.style.color = '#666';
            }
            
            updatePricingSummary();
        }

        function updatePricingSummary() {
            const validItems = pricingData.filter(item => item.sales_price > 0 && item.target_cost > 0);
            const totalItems = validItems.length;
            
            if (totalItems === 0) {
                document.getElementById('total-items').textContent = '0';
                document.getElementById('avg-price').textContent = '0Ïõê';
                document.getElementById('avg-cost').textContent = '0Ïõê';
                document.getElementById('avg-margin').textContent = '0%';
                return;
            }
            
            const avgPrice = Math.round(validItems.reduce((sum, item) => sum + item.sales_price, 0) / totalItems);
            const avgCost = Math.round(validItems.reduce((sum, item) => sum + item.target_cost, 0) / totalItems);
            const avgMargin = (validItems.reduce((sum, item) => sum + item.profit_margin, 0) / totalItems).toFixed(1);
            
            document.getElementById('total-items').textContent = totalItems;
            document.getElementById('avg-price').textContent = avgPrice.toLocaleString() + 'Ïõê';
            document.getElementById('avg-cost').textContent = avgCost.toLocaleString() + 'Ïõê';
            document.getElementById('avg-margin').textContent = avgMargin + '%';
        }

        async function savePricingData() {
            const validItems = pricingData.filter(item => item.sales_price > 0 && item.target_cost > 0);
            
            if (validItems.length === 0) {
                alert('Ï†ÄÏû•Ìï† Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§. ÌåêÎß§Í∞ÄÏôÄ Î™©Ìëú Ïû¨Î£åÎπÑÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }
            
            try {
                // Ïã§Ï†úÎ°úÎäî ÏÑúÎ≤ÑÏóê Ï†ÄÏû•ÌïòÎäî APIÎ•º Ìò∏Ï∂úÌï¥Ïïº ÌïòÏßÄÎßå, ÌòÑÏû¨Îäî Î°úÏª¨ Ï†ÄÏû•ÏÜåÏóê Ï†ÄÏû•
                localStorage.setItem('pricingData', JSON.stringify(validItems));
                
                // ÏàòÏ†ïÏùº ÏóÖÎç∞Ïù¥Ìä∏
                const currentDate = new Date().toLocaleDateString('ko-KR');
                document.querySelectorAll('.updated-date').forEach((span, index) => {
                    if (pricingData[index] && pricingData[index].sales_price > 0) {
                        span.textContent = currentDate;
                        pricingData[index].updated_date = currentDate;
                    }
                });
                
                alert(`${validItems.length}Í∞úÏùò Îã®Í∞Ä Ï†ïÎ≥¥Í∞Ä Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.`);
                
            } catch (error) {
                console.error('Îã®Í∞Ä Ï†ïÎ≥¥ Ï†ÄÏû• Ïã§Ìå®:', error);
                alert('Îã®Í∞Ä Ï†ïÎ≥¥ Ï†ÄÏû•Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
            }
        }

        // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Îã®Í∞ÄÍ¥ÄÎ¶¨Ïö© ÏÇ¨ÏóÖÏû• Î™©Î°ù Î°úÎìú
        document.addEventListener('DOMContentLoaded', function() {
            // Îã®Í∞ÄÍ¥ÄÎ¶¨ ÌéòÏù¥ÏßÄÍ∞Ä ÌëúÏãúÎê† Îïå ÏÇ¨ÏóÖÏû• Î™©Î°ù Î°úÎìú
            const pricingPage = document.getElementById('pricing-page');
            if (pricingPage) {
                const observer = new MutationObserver(function(mutations) {
                    mutations.forEach(function(mutation) {
                        if (mutation.attributeName === 'class') {
                            if (!pricingPage.classList.contains('hidden')) {
                                loadPricingCustomers();
                            }
                        }
                    });
                });
                observer.observe(pricingPage, { attributes: true });
            }

            // Îß§Ìïë Í¥ÄÎ¶¨ ÌéòÏù¥ÏßÄÍ∞Ä ÌëúÏãúÎê† Îïå Îç∞Ïù¥ÌÑ∞ Î°úÎìú
            const mappingPage = document.getElementById('supplier-mapping-page');
            if (mappingPage) {
                const mappingObserver = new MutationObserver(function(mutations) {
                    mutations.forEach(function(mutation) {
                        if (mutation.attributeName === 'class') {
                            if (!mappingPage.classList.contains('hidden')) {
                                loadSupplierMappingPage();
                            }
                        }
                    });
                });
                mappingObserver.observe(mappingPage, { attributes: true });
            }
        });

        // ============================
        // Îß§Ìïë Í¥ÄÎ¶¨ Í¥ÄÎ†® Ìï®ÏàòÎì§
        // ============================
        
        let mappingData = [];
        let customersData = [];
        let suppliersData = [];

        // Îß§Ìïë ÌéòÏù¥ÏßÄ Î°úÎìú
        async function loadSupplierMappingPage() {
            try {
                // Î≥ëÎ†¨Î°ú Îç∞Ïù¥ÌÑ∞ Î°úÎìú
                await Promise.all([
                    loadMappingData(),
                    loadCustomersForMapping(),
                    loadSuppliersForMapping()
                ]);
                
                // ÌïÑÌÑ∞ ÏòµÏÖò ÏóÖÎç∞Ïù¥Ìä∏
                updateMappingFilters();
                
                // ÌÜµÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏
                updateMappingStats();
                
            } catch (error) {
                console.error('Îß§Ìïë ÌéòÏù¥ÏßÄ Î°úÎìú Ïò§Î•ò:', error);
            }
        }

        // Îß§Ìïë Îç∞Ïù¥ÌÑ∞ Î°úÎìú
        async function loadMappingData() {
            try {
                console.log('Îß§Ìïë Îç∞Ïù¥ÌÑ∞ Î°úÎìú ÏãúÏûë...');
                const response = await fetch('/api/admin/customer-supplier-mappings');
                const result = await response.json();
                console.log('Îß§Ìïë API ÏùëÎãµ:', result);
                
                if (result.success) {
                    mappingData = result.mappings || [];
                    console.log('Îß§Ìïë Îç∞Ïù¥ÌÑ∞ ÏÑ§Ï†ïÎê®:', mappingData.length, 'Í∞ú');
                    displayMappings(mappingData);
                } else {
                    console.error('Îß§Ìïë Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®:', result.message);
                    mappingData = [];
                }
            } catch (error) {
                console.error('Îß§Ìïë Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïò§Î•ò:', error);
                mappingData = [];
                displayMappings([]);
            }
        }

        // ÏÇ¨ÏóÖÏû• Îç∞Ïù¥ÌÑ∞ Î°úÎìú (Îß§ÌïëÏö©)
        async function loadCustomersForMapping() {
            try {
                const response = await fetch('/api/admin/sites');
                const result = await response.json();
                customersData = result.sites || [];
            } catch (error) {
                console.error('ÏÇ¨ÏóÖÏû• Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïò§Î•ò:', error);
                customersData = [];
            }
        }

        // ÌòëÎ†•ÏóÖÏ≤¥ Îç∞Ïù¥ÌÑ∞ Î°úÎìú (Îß§ÌïëÏö©)
        async function loadSuppliersForMapping() {
            try {
                const response = await fetch('/api/admin/suppliers/enhanced');
                const result = await response.json();
                if (result.success) {
                    suppliersData = result.suppliers || [];
                } else {
                    suppliersData = [];
                }
            } catch (error) {
                console.error('ÌòëÎ†•ÏóÖÏ≤¥ Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïò§Î•ò:', error);
                suppliersData = [];
            }
        }

        // Îß§Ìïë Îç∞Ïù¥ÌÑ∞ ÌëúÏãú
        function displayMappings(mappings) {
            console.log('displayMappings Ìò∏Ï∂úÎê®, Îß§Ìïë Í∞úÏàò:', mappings ? mappings.length : 0);
            console.log('Ï≤´ Î≤àÏß∏ Îß§Ìïë Îç∞Ïù¥ÌÑ∞:', mappings && mappings[0] ? mappings[0] : null);
            
            const tbody = document.getElementById('mappings-table-body');
            
            if (!mappings || mappings.length === 0) {
                tbody.innerHTML = '<tr><td colspan="14" class="no-data">Îß§Ìïë Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.</td></tr>';
                return;
            }

            console.log('customersData Í∏∏Ïù¥:', customersData ? customersData.length : 'undefined');
            console.log('suppliersData Í∏∏Ïù¥:', suppliersData ? suppliersData.length : 'undefined');
            
            tbody.innerHTML = mappings.map(mapping => {
                const customer = customersData.find(c => c.id === mapping.customer_id);
                const supplier = suppliersData.find(s => s.id === mapping.supplier_id);
                
                console.log(`Îß§Ìïë ID ${mapping.id}: Í≥†Í∞ù ${customer ? customer.name : 'ÏóÜÏùå'}, ÌòëÎ†•ÏóÖÏ≤¥ ${supplier ? supplier.name : 'ÏóÜÏùå'}`);
                
                return `
                    <tr>
                        <td>${mapping.id}</td>
                        <td>${customer ? customer.name : 'ÏÇ≠Ï†úÎêú ÏÇ¨ÏóÖÏû•'}</td>
                        <td>${customer ? customer.site_code || '-' : '-'}</td>
                        <td>
                            ${customer ? `<span class="status-badge ${customer.is_active !== false ? 'status-active' : 'status-inactive'}">
                                ${customer.is_active !== false ? 'Ïö¥ÏòÅÏ§ë' : 'Ï§ëÎã®'}
                            </span>` : '<span class="status-badge status-inactive">ÏÇ≠Ï†úÎê®</span>'}
                        </td>
                        <td>${supplier ? supplier.name : 'ÏÇ≠Ï†úÎêú ÏóÖÏ≤¥'}</td>
                        <td>${supplier ? supplier.parent_code || '-' : '-'}</td>
                        <td><strong>${mapping.delivery_code || '-'}</strong></td>
                        <td>${mapping.priority_order || '-'}</td>
                        <td>
                            <span class="status-badge ${mapping.is_primary_supplier ? 'status-active' : 'status-inactive'}">
                                ${mapping.is_primary_supplier ? 'Ï£ºÏöî' : 'ÏùºÎ∞ò'}
                            </span>
                        </td>
                        <td>${mapping.contract_start_date || '-'}</td>
                        <td>${mapping.contract_end_date || '-'}</td>
                        <td>
                            <span class="status-badge ${mapping.is_active ? 'status-active' : 'status-inactive'}">
                                ${mapping.is_active ? 'ÌôúÏÑ±' : 'ÎπÑÌôúÏÑ±'}
                            </span>
                        </td>
                        <td>
                            ${customer ? 
                                '<div style="display: flex; gap: 4px; justify-content: center;">' +
                                    '<button onclick="editBusinessLocation(' + customer.id + ')" class="btn-edit" title="ÏÇ¨ÏóÖÏû• Ìé∏Ïßë" style="margin: 2px; padding: 4px 8px;">' +
                                        '<i class="fas fa-edit"></i>' +
                                    '</button>' +
                                    (customer.is_active !== false ? 
                                        '<button onclick="deleteBusinessLocation(' + customer.id + ')" class="btn-delete" title="ÏÇ¨ÏóÖÏû• ÏÇ≠Ï†ú" style="margin: 2px; padding: 4px 8px;">' +
                                            '<i class="fas fa-trash"></i>' +
                                        '</button>' : 
                                        '<button onclick="restoreBusinessLocation(' + customer.id + ')" class="btn-success" title="ÏÇ¨ÏóÖÏû• Î≥µÏõê" style="margin: 2px; padding: 4px 8px; background: #28a745; color: white;">' +
                                            '<i class="fas fa-undo"></i>' +
                                        '</button>'
                                    ) +
                                '</div>'
                            : '<button onclick="cleanupOrphanedMapping(' + mapping.id + ', ' + mapping.customer_id + ')" class="btn-warning" title="Í≥†ÏïÑ Îß§Ìïë Ï†ïÎ¶¨" style="margin: 2px; background: #ffc107; color: #212529;">' +
                                '<i class="fas fa-broom"></i> Ï†ïÎ¶¨' +
                            '</button>'}
                        </td>
                        <td>
                            <button onclick="editMapping(${mapping.id})" class="btn-edit" title="Îß§Ìïë ÏàòÏ†ï" style="margin: 2px;">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteMapping(${mapping.id})" class="btn-delete" title="Îß§Ìïë ÏÇ≠Ï†ú" style="margin: 2px;">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Îß§Ìïë ÌïÑÌÑ∞ ÏóÖÎç∞Ïù¥Ìä∏
        function updateMappingFilters() {
            // ÏÇ¨ÏóÖÏû• ÌïÑÌÑ∞
            const customerFilter = document.getElementById('mapping-customer-filter');
            customerFilter.innerHTML = '<option value="">Ï†ÑÏ≤¥ ÏÇ¨ÏóÖÏû•</option>' +
                customersData.map(customer => 
                    `<option value="${customer.id}">${customer.name}</option>`
                ).join('');

            // ÌòëÎ†•ÏóÖÏ≤¥ ÌïÑÌÑ∞
            const supplierFilter = document.getElementById('mapping-supplier-filter');
            supplierFilter.innerHTML = '<option value="">Ï†ÑÏ≤¥ ÌòëÎ†•ÏóÖÏ≤¥</option>' +
                suppliersData.map(supplier => 
                    `<option value="${supplier.id}">${supplier.name}</option>`
                ).join('');
        }

        // Îß§Ìïë ÌÜµÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏
        function updateMappingStats() {
            const totalMappings = mappingData.length;
            const activeMappings = mappingData.filter(m => m.is_active).length;
            const mappedCustomers = new Set(mappingData.map(m => m.customer_id)).size;
            const mappedSuppliers = new Set(mappingData.map(m => m.supplier_id)).size;

            document.getElementById('total-mappings').textContent = totalMappings;
            document.getElementById('active-mappings').textContent = activeMappings;
            document.getElementById('mapped-customers').textContent = mappedCustomers;
            document.getElementById('mapped-suppliers').textContent = mappedSuppliers;
        }

        // Îß§Ìïë ÌïÑÌÑ∞ÎßÅ
        function filterMappings() {
            const customerFilter = document.getElementById('mapping-customer-filter').value;
            const supplierFilter = document.getElementById('mapping-supplier-filter').value;
            const statusFilter = document.getElementById('mapping-status-filter').value;

            let filteredMappings = mappingData;

            if (customerFilter) {
                filteredMappings = filteredMappings.filter(m => m.customer_id == customerFilter);
            }

            if (supplierFilter) {
                filteredMappings = filteredMappings.filter(m => m.supplier_id == supplierFilter);
            }

            if (statusFilter !== '') {
                const isActive = statusFilter === 'true';
                filteredMappings = filteredMappings.filter(m => m.is_active === isActive);
            }

            displayMappings(filteredMappings);
        }

        // Îß§Ìïë ÌïÑÌÑ∞ Ï¥àÍ∏∞Ìôî
        function clearMappingFilters() {
            document.getElementById('mapping-customer-filter').value = '';
            document.getElementById('mapping-supplier-filter').value = '';
            document.getElementById('mapping-status-filter').value = '';
            displayMappings(mappingData);
        }

        // Îß§Ìïë Î™®Îã¨ Ïó¥Í∏∞
        function openMappingModal(mappingId = null) {
            const modal = document.getElementById('mapping-modal');
            const title = document.getElementById('mapping-modal-title');
            
            // Ìèº Ï¥àÍ∏∞Ìôî
            document.getElementById('mapping-form').reset();
            document.getElementById('mapping-id').value = '';

            // Í∏∞Ï°¥ ÌñâÎì§ Ï¥àÍ∏∞Ìôî
            supplierRowCounter = 0;
            const container = document.getElementById('supplier-rows-container');
            container.innerHTML = '';

            if (mappingId) {
                title.textContent = 'Îß§Ìïë ÏàòÏ†ï';
                loadMappingForEdit(mappingId);
            } else {
                title.textContent = 'ÌòëÎ†•ÏóÖÏ≤¥ Îß§Ìïë Ï∂îÍ∞Ä';
                // Ï≤´ Î≤àÏß∏ Ìñâ Ï∂îÍ∞Ä
                addSupplierRow();
            }

            // ÏÑ†ÌÉù ÏòµÏÖò ÏóÖÎç∞Ïù¥Ìä∏
            updateMappingModalOptions();

            modal.classList.remove('hidden');
        }

        // Îß§Ìïë Î™®Îã¨ ÏòµÏÖò ÏóÖÎç∞Ïù¥Ìä∏
        function updateMappingModalOptions() {
            // ÏÇ¨ÏóÖÏû• ÏòµÏÖò
            const customerSelect = document.getElementById('mapping-customer');
            if (customerSelect) {
                customerSelect.innerHTML = '<option value="">ÏÇ¨ÏóÖÏû•ÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</option>' +
                    customersData.map(customer => {
                        const codeText = customer.site_code ? `ÏΩîÎìú: ${customer.site_code}` : '‚ö†Ô∏è ÏΩîÎìú ÏóÜÏùå';
                        return `<option value="${customer.id}">${customer.name} (${codeText})</option>`;
                    }).join('');
            }

            // ÌòëÎ†•ÏóÖÏ≤¥ ÏòµÏÖò - ÎèôÏ†ÅÏúºÎ°ú ÏÉùÏÑ±Îêú Î™®Îì† supplier-select ÏöîÏÜåÎì§ ÏóÖÎç∞Ïù¥Ìä∏
            const supplierSelects = document.querySelectorAll('.supplier-select');
            supplierSelects.forEach(supplierSelect => {
                if (supplierSelect) {
                    supplierSelect.innerHTML = '<option value="">ÌòëÎ†•ÏóÖÏ≤¥Î•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</option>' +
                        suppliersData.map(supplier => {
                            const codeText = supplier.parent_code ? `ÏΩîÎìú: ${supplier.parent_code}` : '‚ö†Ô∏è ÏΩîÎìú ÏóÜÏùå';
                            return `<option value="${supplier.id}">${supplier.name} (${codeText})</option>`;
                        }).join('');
                }
            });
        }

        // Îß§Ìïë Ìé∏Ïßë
        function loadMappingForEdit(mappingId) {
            const mapping = mappingData.find(m => m.id === mappingId);
            if (!mapping) {
                alert('Îß§Ìïë Îç∞Ïù¥ÌÑ∞Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');
                return;
            }

            // Í∏∞Î≥∏ Ï†ïÎ≥¥ ÏÑ§Ï†ï
            document.getElementById('mapping-id').value = mapping.id;
            document.getElementById('mapping-customer').value = mapping.customer_id;
            document.getElementById('mapping-contract-start').value = mapping.contract_start_date || '';
            document.getElementById('mapping-contract-end').value = mapping.contract_end_date || '';

            // ÌòëÎ†•ÏóÖÏ≤¥ Ìñâ Ï∂îÍ∞Ä
            addSupplierRow({
                supplier_id: mapping.supplier_id,
                delivery_code: mapping.delivery_code,
                priority: mapping.priority_order,
                is_primary: mapping.is_primary_supplier,
                is_active: mapping.is_active
            });

            // ÏòµÏÖò ÏóÖÎç∞Ïù¥Ìä∏ ÌõÑ Í∞í Îã§Ïãú ÏÑ§Ï†ï
            setTimeout(() => {
                document.getElementById('mapping-customer').value = mapping.customer_id;
                const supplierSelect = document.querySelector('.supplier-select');
                if (supplierSelect) {
                    supplierSelect.value = mapping.supplier_id;
                    // ÏÑ†ÌÉù Î≥ÄÍ≤Ω Ïù¥Î≤§Ìä∏ Ìä∏Î¶¨Í±∞
                    supplierSelect.dispatchEvent(new Event('change'));
                }
            }, 100);
        }

        // Îß§Ìïë Ï†ÄÏû•
        async function saveMapping() {
            const customerElement = document.getElementById('mapping-customer');
            if (!customerElement) {
                console.error('mapping-customer element not found');
                alert('ÏÇ¨ÏóÖÏû• ÏÑ†ÌÉù ÏöîÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');
                return;
            }
            const customerId = parseInt(customerElement.value);
            
            // Í∏∞Î≥∏ Ïú†Ìö®ÏÑ± Í≤ÄÏÇ¨
            if (!customerId) {
                alert('ÏÇ¨ÏóÖÏû•ÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.');
                return;
            }

            // ÌòëÎ†•ÏóÖÏ≤¥ Ìñâ Îç∞Ïù¥ÌÑ∞ ÏàòÏßë
            const supplierRows = document.querySelectorAll('.supplier-row');
            const mappingsToSave = [];
            
            for (let row of supplierRows) {
                const supplierSelect = row.querySelector('.supplier-select');
                const deliveryCodeInput = row.querySelector('.delivery-code-input');
                const priorityInput = row.querySelector('.priority-input');
                const primaryCheckbox = row.querySelector('.primary-checkbox');
                
                const supplierId = parseInt(supplierSelect.value);
                const deliveryCode = deliveryCodeInput.value.trim();
                const priority = parseInt(priorityInput.value) || 1;
                const isPrimary = primaryCheckbox.checked;
                
                if (!supplierId) {
                    alert('Î™®Îì† ÌòëÎ†•ÏóÖÏ≤¥Î•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.');
                    return;
                }
                
                if (!deliveryCode) {
                    alert('Î™®Îì† Î∞∞ÏÜ°ÏΩîÎìúÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî.');
                    return;
                }
                
                // Ï§ëÎ≥µ ÌòëÎ†•ÏóÖÏ≤¥ Í≤ÄÏÇ¨
                const duplicateSupplier = mappingsToSave.find(m => m.supplier_id === supplierId);
                if (duplicateSupplier) {
                    const supplierName = suppliersData.find(s => s.id === supplierId)?.name || 'Ïïå Ïàò ÏóÜÏùå';
                    alert(`ÌòëÎ†•ÏóÖÏ≤¥ '${supplierName}'Í∞Ä Ï§ëÎ≥µÏúºÎ°ú ÏÑ†ÌÉùÎêòÏóàÏäµÎãàÎã§.`);
                    return;
                }
                
                mappingsToSave.push({
                    customer_id: customerId,
                    supplier_id: supplierId,
                    delivery_code: deliveryCode,
                    priority_order: priority,
                    is_primary_supplier: isPrimary,
                    contract_start_date: document.getElementById('mapping-contract-start').value || null,
                    contract_end_date: document.getElementById('mapping-contract-end').value || null,
                    notes: document.getElementById('mapping-notes').value.trim() || null,
                    is_active: true
                });
            }
            
            if (mappingsToSave.length === 0) {
                alert('Ï†ÄÏû•Ìï† Îß§ÌïëÏù¥ ÏóÜÏäµÎãàÎã§.');
                return;
            }

            // Ï†ÄÏû• Ï≤òÎ¶¨
            try {
                let successCount = 0;
                let errorMessages = [];
                
                // Ìé∏Ïßë Î™®ÎìúÏù∏ÏßÄ ÌôïÏù∏
                const mappingId = document.getElementById('mapping-id').value;
                const isEditMode = mappingId && mappingId.trim() !== '';
                
                if (isEditMode && mappingsToSave.length > 1) {
                    alert('Ìé∏Ïßë Î™®ÎìúÏóêÏÑúÎäî ÌïòÎÇòÏùò Îß§ÌïëÎßå ÏàòÏ†ïÌï† Ïàò ÏûàÏäµÎãàÎã§.');
                    return;
                }
                
                for (let mappingData of mappingsToSave) {
                    try {
                        let url = '/api/admin/customer-supplier-mappings';
                        let method = 'POST';
                        
                        if (isEditMode) {
                            url += `/${mappingId}`;
                            method = 'PUT';
                        }
                        
                        const response = await fetch(url, {
                            method: method,
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(mappingData)
                        });

                        const result = await response.json();
                        
                        if (result.success) {
                            successCount++;
                        } else {
                            const supplierName = suppliersData.find(s => s.id === mappingData.supplier_id)?.name || 'Ïïå Ïàò ÏóÜÏùå';
                            errorMessages.push(`${supplierName}: ${result.message}`);
                        }
                    } catch (error) {
                        const supplierName = suppliersData.find(s => s.id === mappingData.supplier_id)?.name || 'Ïïå Ïàò ÏóÜÏùå';
                        errorMessages.push(`${supplierName}: Ï†ÄÏû• Ï§ë Ïò§Î•ò Î∞úÏÉù`);
                    }
                }
                
                let message = `${successCount}Í∞úÏùò Îß§ÌïëÏù¥ ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.`;
                if (errorMessages.length > 0) {
                    message += `\n\nÏã§Ìå®Ìïú Îß§Ìïë:\n${errorMessages.join('\n')}`;
                }
                
                alert(message);
                
                if (successCount > 0) {
                    closeMappingModal();
                    loadMappingData();
                }
                
            } catch (error) {
                console.error('Îß§Ìïë Ï†ÄÏû• Ïò§Î•ò:', error);
                alert('Ï†ÄÏû• Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
            }
        }

        // Îß§Ìïë Ìé∏Ïßë
        function editMapping(mappingId) {
            openMappingModal(mappingId);
        }

        // Îß§Ìïë ÏÇ≠Ï†ú
        async function deleteMapping(mappingId) {
            if (!confirm('Ïù¥ Îß§ÌïëÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                return;
            }

            try {
                const response = await fetch(`/api/admin/customer-supplier-mappings/${mappingId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (result.success) {
                    alert('Îß§ÌïëÏù¥ ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.');
                    loadMappingData();
                } else {
                    alert(result.message || 'ÏÇ≠Ï†úÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
                }
            } catch (error) {
                console.error('Îß§Ìïë ÏÇ≠Ï†ú Ïò§Î•ò:', error);
                alert('ÏÇ≠Ï†ú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
            }
        }

        // ÏÇ¨ÏóÖÏû• ÏÇ≠Ï†ú (ÏÜåÌîÑÌä∏ ÏÇ≠Ï†ú)
        async function deleteBusinessLocation(customerId) {
            const customer = customersData.find(c => c.id === customerId);
            if (!customer) return;

            if (!confirm(`'${customer.name}' ÏÇ¨ÏóÖÏû•ÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?\nÍ¥ÄÎ†®Îêú Îß§ÌïëÏùÄ Ïú†ÏßÄÎêòÏßÄÎßå ÏÇ¨ÏóÖÏû•ÏùÄ ÎπÑÌôúÏÑ±ÌôîÎê©ÎãàÎã§.`)) {
                return;
            }

            try {
                const response = await fetch(`/api/admin/customers/${customerId}/update`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: customer.name,
                        code: customer.code,
                        site_code: customer.site_code,
                        site_type: customer.site_type,
                        contact_person: customer.contact_person,
                        contact_phone: customer.contact_phone,
                        address: customer.address,
                        description: customer.description,
                        portion_size: customer.portion_size,
                        is_active: false
                    })
                });

                const result = await response.json();

                if (result.success || response.ok) {
                    alert('ÏÇ¨ÏóÖÏû•Ïù¥ ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.');
                    // Îç∞Ïù¥ÌÑ∞ ÏÉàÎ°úÍ≥†Ïπ®
                    await loadCustomersData();
                    displayMappings(mappingData);
                } else {
                    alert(result.message || 'ÏÇ¨ÏóÖÏû• ÏÇ≠Ï†úÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
                }
            } catch (error) {
                console.error('ÏÇ¨ÏóÖÏû• ÏÇ≠Ï†ú Ïò§Î•ò:', error);
                alert('ÏÇ≠Ï†ú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
            }
        }

        // ÏÇ¨ÏóÖÏû• Î≥µÏõê
        async function restoreBusinessLocation(customerId) {
            const customer = customersData.find(c => c.id === customerId);
            if (!customer) return;

            if (!confirm(`'${customer.name}' ÏÇ¨ÏóÖÏû•ÏùÑ Î≥µÏõêÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) {
                return;
            }

            try {
                const response = await fetch(`/api/admin/customers/${customerId}/update`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: customer.name,
                        code: customer.code,
                        site_code: customer.site_code,
                        site_type: customer.site_type,
                        contact_person: customer.contact_person,
                        contact_phone: customer.contact_phone,
                        address: customer.address,
                        description: customer.description,
                        portion_size: customer.portion_size,
                        is_active: true
                    })
                });

                const result = await response.json();

                if (result.success || response.ok) {
                    alert('ÏÇ¨ÏóÖÏû•Ïù¥ Î≥µÏõêÎêòÏóàÏäµÎãàÎã§.');
                    // Îç∞Ïù¥ÌÑ∞ ÏÉàÎ°úÍ≥†Ïπ®
                    await loadCustomersData();
                    displayMappings(mappingData);
                } else {
                    alert(result.message || 'ÏÇ¨ÏóÖÏû• Î≥µÏõêÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
                }
            } catch (error) {
                console.error('ÏÇ¨ÏóÖÏû• Î≥µÏõê Ïò§Î•ò:', error);
                alert('Î≥µÏõê Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
            }
        }

        // Í≥†ÏïÑ Îß§Ìïë Ï†ïÎ¶¨ (ÏÇ¨ÏóÖÏû• Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÎäî Îß§Ìïë)
        async function cleanupOrphanedMapping(mappingId, customerId) {
            if (!confirm(`ÏÇ¨ÏóÖÏû• ID ${customerId}Ïóê Ìï¥ÎãπÌïòÎäî Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.\nÏù¥ Îß§ÌïëÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) {
                return;
            }

            try {
                const response = await fetch(`/api/admin/customer-supplier-mappings/${mappingId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (result.success) {
                    alert('Í≥†ÏïÑ Îß§ÌïëÏù¥ Ï†ïÎ¶¨ÎêòÏóàÏäµÎãàÎã§.');
                    loadMappingData();
                } else {
                    alert(result.message || 'Ï†ïÎ¶¨Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
                }
            } catch (error) {
                console.error('Í≥†ÏïÑ Îß§Ìïë Ï†ïÎ¶¨ Ïò§Î•ò:', error);
                alert('Ï†ïÎ¶¨ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
            }
        }

        // Îß§Ìïë Î™®Îã¨ Îã´Í∏∞
        // Îã§Ï§ë Ìñâ Í¥ÄÎ†® Î≥ÄÏàò
        let supplierRowCounter = 0;

        // ÌòëÎ†•ÏóÖÏ≤¥ Ìñâ Ï∂îÍ∞Ä
        function addSupplierRow(supplierData = null) {
            supplierRowCounter++;
            const container = document.getElementById('supplier-rows-container');
            
            const rowDiv = document.createElement('div');
            rowDiv.className = 'supplier-row';
            rowDiv.id = `supplier-row-${supplierRowCounter}`;
            
            rowDiv.innerHTML = `
                <div>
                    <label>ÌòëÎ†•ÏóÖÏ≤¥</label>
                    <select class="supplier-select" data-row="${supplierRowCounter}" onchange="onSupplierChangeMulti(${supplierRowCounter})" required>
                        <option value="">ÌòëÎ†•ÏóÖÏ≤¥Î•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</option>
                        ${suppliersData.map(supplier => {
                            const codeText = supplier.parent_code ? `ÏΩîÎìú: ${supplier.parent_code}` : '‚ö†Ô∏è ÏΩîÎìú ÏóÜÏùå';
                            const selected = supplierData && supplier.id === supplierData.supplier_id ? 'selected' : '';
                            return `<option value="${supplier.id}" ${selected}>${supplier.name} (${codeText})</option>`;
                        }).join('')}
                    </select>
                </div>
                <div>
                    <label>Î∞∞ÏÜ°ÏΩîÎìú(ÏÇ¨ÏóÖÏû•ÏΩîÎìú)</label>
                    <input type="text" class="delivery-code-input" data-row="${supplierRowCounter}" 
                           value="${supplierData ? (supplierData.delivery_code || '') : ''}" 
                           placeholder="ÏûêÎèô ÏÉùÏÑ±Îê®" maxlength="20" required>
                </div>
                <div>
                    <label>Ïö∞ÏÑ†ÏàúÏúÑ</label>
                    <input type="number" class="priority-input" data-row="${supplierRowCounter}" 
                           value="${supplierData ? (supplierData.priority || 1) : 1}" 
                           min="1" max="10">
                </div>
                <div>
                    <label class="checkbox-label" style="margin-bottom: 0;">
                        <input type="checkbox" class="primary-checkbox" data-row="${supplierRowCounter}" 
                               ${supplierData && supplierData.is_primary ? 'checked' : ''}>
                        Ï£ºÏöîÏóÖÏ≤¥
                    </label>
                </div>
                <div>
                    <button type="button" class="btn-remove" onclick="removeSupplierRow(${supplierRowCounter})" title="ÏÇ≠Ï†ú">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
            
            container.appendChild(rowDiv);
            
            // Ï≤´ Î≤àÏß∏ ÌñâÏù¥Î©¥ ÏÇ≠Ï†ú Î≤ÑÌäº Ïà®Í∏∞Í∏∞
            if (container.children.length === 1) {
                rowDiv.querySelector('.btn-remove').style.display = 'none';
            } else {
                // Ï≤´ Î≤àÏß∏ ÌñâÏùò ÏÇ≠Ï†ú Î≤ÑÌäº Îã§Ïãú Î≥¥Ïù¥Í∏∞
                const firstRow = container.children[0];
                if (firstRow) {
                    const firstRemoveBtn = firstRow.querySelector('.btn-remove');
                    if (firstRemoveBtn) firstRemoveBtn.style.display = 'block';
                }
            }
            
            return rowDiv;
        }

        // ÌòëÎ†•ÏóÖÏ≤¥ Ìñâ ÏÇ≠Ï†ú
        function removeSupplierRow(rowId) {
            const row = document.getElementById(`supplier-row-${rowId}`);
            if (row) {
                row.remove();
                
                const container = document.getElementById('supplier-rows-container');
                // ÌñâÏù¥ ÌïòÎÇòÎßå ÎÇ®ÏúºÎ©¥ ÏÇ≠Ï†ú Î≤ÑÌäº Ïà®Í∏∞Í∏∞
                if (container.children.length === 1) {
                    const lastRow = container.children[0];
                    if (lastRow) {
                        const removeBtn = lastRow.querySelector('.btn-remove');
                        if (removeBtn) removeBtn.style.display = 'none';
                    }
                }
            }
        }

        // Îã§Ï§ë ÌñâÏóêÏÑú ÌòëÎ†•ÏóÖÏ≤¥ ÏÑ†ÌÉù Ïãú Î∞∞ÏÜ°ÏΩîÎìú ÏûêÎèô ÏûÖÎ†•
        function onSupplierChangeMulti(rowId) {
            const supplierSelect = document.querySelector(`select[data-row="${rowId}"]`);
            const deliveryCodeInput = document.querySelector(`input.delivery-code-input[data-row="${rowId}"]`);
            
            const selectedSupplierId = parseInt(supplierSelect.value);
            
            if (selectedSupplierId && suppliersData) {
                const selectedSupplier = suppliersData.find(s => s.id === selectedSupplierId);
                if (selectedSupplier && selectedSupplier.parent_code) {
                    // ÏÇ¨ÏóÖÏû•ÏΩîÎìú Í∞ÄÏ†∏Ïò§Í∏∞
                    const customerElement = document.getElementById('mapping-customer');
                    if (!customerElement) return;
                    const customerId = parseInt(customerElement.value);
                    const selectedCustomer = customersData.find(c => c.id === customerId);
                    const siteCode = selectedCustomer?.site_code;
                    
                    // Î∞∞ÏÜ°ÏΩîÎìú ÏÉùÏÑ±: Î™®ÏΩîÎìú-ÏÇ¨ÏóÖÏû•ÏΩîÎìú (ÏÇ¨ÏóÖÏû•ÏΩîÎìúÍ∞Ä ÏóÜÏúºÎ©¥ Î™®ÏΩîÎìúÎßå)
                    const deliveryCode = siteCode ? 
                        `${selectedSupplier.parent_code}-${siteCode}` : 
                        selectedSupplier.parent_code;
                    
                    deliveryCodeInput.value = deliveryCode;
                    deliveryCodeInput.focus();
                    deliveryCodeInput.setSelectionRange(deliveryCodeInput.value.length, deliveryCodeInput.value.length);
                } else {
                    deliveryCodeInput.value = '';
                }
            } else {
                deliveryCodeInput.value = '';
            }
        }

        function closeMappingModal() {
            document.getElementById('mapping-modal').classList.add('hidden');
        }

    </script> -->
    <script src="/static/admin-dashboard.js"></script>
    
    <!-- Settings Module JavaScript -->
    <script>
    /**
     * Settings Module - ÏãúÏä§ÌÖú ÏÑ§Ï†ï Í¥ÄÎ¶¨
     */
    class SettingsModule {
        constructor() {
            this.settings = {
                systemName: 'Îã§Ìï®ÏãùÎã®Í¥ÄÎ¶¨',
                systemVersion: 'v1.0.0',
                defaultPage: 'dashboard',
                itemsPerPage: 20
            };
        }

        init() {
            if (document.getElementById('settings-page')) {
                this.loadSettings();
                this.updateSystemInfo();
                console.log('[Settings] Î™®Îìà Ï¥àÍ∏∞Ìôî ÏôÑÎ£å');
            }
        }

        loadSettings() {
            try {
                const savedSettings = localStorage.getItem('dahamsSettings');
                if (savedSettings) {
                    this.settings = { ...this.settings, ...JSON.parse(savedSettings) };
                }
                this.applySettingsToUI();
            } catch (error) {
                console.error('[Settings] ÏÑ§Ï†ï Î°úÎìú Ïã§Ìå®:', error);
            }
        }

        applySettingsToUI() {
            const systemNameInput = document.getElementById('system-name');
            const systemVersionInput = document.getElementById('system-version');
            const defaultPageSelect = document.getElementById('default-page');
            const itemsPerPageSelect = document.getElementById('items-per-page');

            if (systemNameInput) systemNameInput.value = this.settings.systemName;
            if (systemVersionInput) systemVersionInput.value = this.settings.systemVersion;
            if (defaultPageSelect) defaultPageSelect.value = this.settings.defaultPage;
            if (itemsPerPageSelect) itemsPerPageSelect.value = this.settings.itemsPerPage;
        }

        async updateSystemInfo() {
            try {
                const dbStatus = document.getElementById('db-status');
                if (dbStatus) {
                    dbStatus.textContent = 'Ïó∞Í≤∞Îê®';
                    dbStatus.className = 'info-value status-active';
                }

                const lastBackup = document.getElementById('last-backup');
                if (lastBackup) {
                    const backupTime = localStorage.getItem('lastBackupTime');
                    lastBackup.textContent = backupTime || 'Î∞±ÏóÖ Ï†ïÎ≥¥ ÏóÜÏùå';
                }

                const userCountElement = document.getElementById('user-count');
                if (userCountElement) {
                    try {
                        const response = await fetch('/api/users');
                        if (response.ok) {
                            const data = await response.json();
                            userCountElement.textContent = `${data.length || 0}Î™Ö`;
                        } else {
                            userCountElement.textContent = 'Ï°∞Ìöå Ïã§Ìå®';
                        }
                    } catch (error) {
                        userCountElement.textContent = 'Ï°∞Ìöå Ïã§Ìå®';
                    }
                }
            } catch (error) {
                console.error('[Settings] ÏãúÏä§ÌÖú Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏ Ïã§Ìå®:', error);
            }
        }

        async saveSettings() {
            try {
                this.collectSettingsFromUI();
                localStorage.setItem('dahamsSettings', JSON.stringify(this.settings));
                this.showNotification('ÏÑ§Ï†ïÏù¥ Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.', 'success');
                console.log('[Settings] ÏÑ§Ï†ï Ï†ÄÏû• ÏôÑÎ£å:', this.settings);
            } catch (error) {
                console.error('[Settings] ÏÑ§Ï†ï Ï†ÄÏû• Ïã§Ìå®:', error);
                this.showNotification('ÏÑ§Ï†ï Ï†ÄÏû•Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.', 'error');
            }
        }

        collectSettingsFromUI() {
            const systemName = document.getElementById('system-name')?.value;
            const defaultPage = document.getElementById('default-page')?.value;
            const itemsPerPage = document.getElementById('items-per-page')?.value;

            if (systemName) this.settings.systemName = systemName;
            if (defaultPage) this.settings.defaultPage = defaultPage;
            if (itemsPerPage) this.settings.itemsPerPage = parseInt(itemsPerPage);
        }

        resetSettings() {
            if (confirm('Î™®Îì† ÏÑ§Ï†ïÏùÑ Í∏∞Î≥∏Í∞íÏúºÎ°ú Î¶¨ÏÖãÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                this.settings = {
                    systemName: 'Îã§Ìï®ÏãùÎã®Í¥ÄÎ¶¨',
                    systemVersion: 'v1.0.0',
                    defaultPage: 'dashboard',
                    itemsPerPage: 20
                };
                
                localStorage.removeItem('dahamsSettings');
                this.applySettingsToUI();
                this.showNotification('ÏÑ§Ï†ïÏù¥ Í∏∞Î≥∏Í∞íÏúºÎ°ú Î¶¨ÏÖãÎêòÏóàÏäµÎãàÎã§.', 'info');
                console.log('[Settings] ÏÑ§Ï†ï Î¶¨ÏÖã ÏôÑÎ£å');
            }
        }

        async createBackup() {
            try {
                this.showNotification('Î∞±ÏóÖÏùÑ ÏÉùÏÑ±ÌïòÍ≥† ÏûàÏäµÎãàÎã§...', 'info');
                
                // Î∞±ÏóÖ ÏãúÎÆ¨Î†àÏù¥ÏÖò (Ïã§Ï†úÎ°úÎäî ÏÑúÎ≤Ñ API Ìò∏Ï∂ú)
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                localStorage.setItem('lastBackupTime', new Date().toLocaleString());
                this.updateSystemInfo();
                this.showNotification('Î∞±ÏóÖÏù¥ ÏÑ±Í≥µÏ†ÅÏúºÎ°ú ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§.', 'success');
            } catch (error) {
                console.error('[Settings] Î∞±ÏóÖ ÏÉùÏÑ± Ïã§Ìå®:', error);
                this.showNotification('Î∞±ÏóÖ ÏÉùÏÑ±Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.', 'error');
            }
        }

        async checkSystemHealth() {
            try {
                this.showNotification('ÏãúÏä§ÌÖú ÏÉÅÌÉúÎ•º ÌôïÏù∏ÌïòÍ≥† ÏûàÏäµÎãàÎã§...', 'info');
                
                // ÏãúÏä§ÌÖú ÏÉÅÌÉú ÌôïÏù∏ ÏãúÎÆ¨Î†àÏù¥ÏÖò
                await new Promise(resolve => setTimeout(resolve, 800));
                
                this.showNotification('ÏãúÏä§ÌÖúÏù¥ Ï†ïÏÉÅÏ†ÅÏúºÎ°ú ÏûëÎèôÌïòÍ≥† ÏûàÏäµÎãàÎã§.', 'success');
                this.updateSystemInfo();
                
            } catch (error) {
                console.error('[Settings] ÏãúÏä§ÌÖú ÏÉÅÌÉú ÌôïÏù∏ Ïã§Ìå®:', error);
                this.showNotification('ÏãúÏä§ÌÖú ÏÉÅÌÉú ÌôïÏù∏Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.', 'error');
            }
        }

        showNotification(message, type = 'info') {
            const existingAlert = document.querySelector('.settings-alert');
            if (existingAlert) existingAlert.remove();

            const alert = document.createElement('div');
            alert.className = `settings-alert alert-${type}`;
            alert.innerHTML = `
                <span>${message}</span>
                <button onclick="this.parentElement.remove()" style="background: none; border: none; font-size: 16px; cursor: pointer;">&times;</button>
            `;

            const settingsPage = document.getElementById('settings-page');
            if (settingsPage) {
                settingsPage.insertBefore(alert, settingsPage.firstChild);
                
                setTimeout(() => {
                    if (alert.parentElement) alert.remove();
                }, 3000);
            }
        }

        getSetting(key) {
            return this.settings[key];
        }

        setSetting(key, value) {
            this.settings[key] = value;
            localStorage.setItem('dahamsSettings', JSON.stringify(this.settings));
        }
    }

    // Ï†ÑÏó≠ Ïù∏Ïä§ÌÑ¥Ïä§ ÏÉùÏÑ±
    window.SettingsModule = new SettingsModule();

    // DOM Î°úÎìú ÏôÑÎ£å Ïãú Ï¥àÍ∏∞Ìôî
    document.addEventListener('DOMContentLoaded', function() {
        if (window.SettingsModule) {
            window.SettingsModule.init();
        }
    });

    console.log('[Settings] ÏÑ§Ï†ï Î™®Îìà Î°úÎìú ÏôÑÎ£å');
    </script>
    
    <!-- Dashboard Module JavaScript -->
    <script>
    /**
     * Dashboard Module - ÎåÄÏãúÎ≥¥Îìú Îç∞Ïù¥ÌÑ∞ Í¥ÄÎ¶¨
     */
    class DashboardModule {
        constructor() {
            this.refreshInterval = null;
            this.autoRefreshEnabled = true;
            this.refreshIntervalTime = 30000; // 30Ï¥à
        }

        init() {
            if (document.getElementById('dashboard-page')) {
                console.log('[Dashboard] Î™®Îìà Ï¥àÍ∏∞Ìôî ÏãúÏûë');
                this.loadDashboardData();
                this.loadRecentActivity();
                this.startAutoRefresh();
            }
        }

        async loadDashboardData() {
            try {
                const response = await fetch('/api/admin/dashboard-stats');
                const data = await response.json();
                
                if (data.success) {
                    this.updateStatistics(data);
                } else {
                    this.showFallbackStats();
                }
            } catch (error) {
                console.error('[Dashboard] ÌÜµÍ≥Ñ Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®:', error);
                this.showFallbackStats();
            }
        }

        updateStatistics(data) {
            const stats = {
                'total-users': data.totalUsers || 0,
                'total-sites': data.totalSites || 0,
                'today-menus': data.todayMenus || 0,
                'price-updates': data.priceUpdates || 0
            };

            Object.entries(stats).forEach(([elementId, value]) => {
                const element = document.getElementById(elementId);
                if (element) {
                    this.animateCounter(element, value);
                }
            });
        }

        animateCounter(element, targetValue) {
            const startValue = parseInt(element.textContent) || 0;
            const difference = targetValue - startValue;
            const steps = 30;
            const stepValue = difference / steps;
            let currentStep = 0;

            const timer = setInterval(() => {
                currentStep++;
                const currentValue = Math.round(startValue + (stepValue * currentStep));
                element.textContent = currentValue;

                if (currentStep >= steps) {
                    clearInterval(timer);
                    element.textContent = targetValue;
                }
            }, 30);
        }

        showFallbackStats() {
            const fallbackStats = {
                'total-users': 1,
                'total-sites': 5,
                'today-menus': 0,
                'price-updates': 0
            };

            Object.entries(fallbackStats).forEach(([elementId, value]) => {
                const element = document.getElementById(elementId);
                if (element) {
                    element.textContent = value;
                }
            });
        }

        async loadRecentActivity() {
            try {
                const response = await fetch('/api/admin/recent-activity');
                
                if (response.ok) {
                    const result = await response.json();
                    const activities = result.activities || result.data || [];
                    this.displayActivities(activities);
                } else {
                    this.showFallbackActivities();
                }
            } catch (error) {
                console.error('[Dashboard] ÏµúÍ∑º ÌôúÎèô Î°úÎìú Ïã§Ìå®:', error);
                this.showFallbackActivities();
            }
        }

        displayActivities(activities) {
            const activityList = document.getElementById('activity-list');
            if (!activityList) return;

            if (activities.length === 0) {
                activityList.innerHTML = '<div class="log-item">ÏµúÍ∑º ÌôúÎèôÏù¥ ÏóÜÏäµÎãàÎã§.</div>';
                return;
            }

            activityList.innerHTML = activities.map(activity => `
                <div class="log-item">
                    <div class="log-time">${this.formatTime(activity.timestamp)}</div>
                    <div class="log-message">${this.escapeHtml(activity.message)}</div>
                    <div class="log-user">${this.escapeHtml(activity.user)}</div>
                </div>
            `).join('');
        }

        showFallbackActivities() {
            const fallbackActivities = [
                {
                    timestamp: new Date().toISOString(),
                    message: 'Dashboard Î™®ÎìàÏù¥ ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Î°úÎìúÎêòÏóàÏäµÎãàÎã§.',
                    user: 'System'
                },
                {
                    timestamp: new Date(Date.now() - 300000).toISOString(),
                    message: 'Settings Î™®ÎìàÏù¥ ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Î°úÎìúÎêòÏóàÏäµÎãàÎã§.',
                    user: 'System'
                },
                {
                    timestamp: new Date(Date.now() - 600000).toISOString(),
                    message: 'ÏãúÏä§ÌÖúÏù¥ ÏãúÏûëÎêòÏóàÏäµÎãàÎã§.',
                    user: 'System'
                }
            ];

            this.displayActivities(fallbackActivities);
        }

        async refreshActivity() {
            const refreshBtn = document.querySelector('.btn-refresh i');
            if (refreshBtn) {
                refreshBtn.classList.add('fa-spin');
            }

            await this.loadRecentActivity();
            
            setTimeout(() => {
                if (refreshBtn) {
                    refreshBtn.classList.remove('fa-spin');
                }
            }, 500);
        }

        startAutoRefresh() {
            if (this.refreshInterval) {
                clearInterval(this.refreshInterval);
            }

            if (this.autoRefreshEnabled) {
                this.refreshInterval = setInterval(() => {
                    const dashboardPage = document.getElementById('dashboard-page');
                    if (dashboardPage && !dashboardPage.classList.contains('hidden')) {
                        this.loadDashboardData();
                        this.loadRecentActivity();
                    }
                }, this.refreshIntervalTime);
            }
        }

        stopAutoRefresh() {
            if (this.refreshInterval) {
                clearInterval(this.refreshInterval);
                this.refreshInterval = null;
            }
        }

        formatTime(timestamp) {
            try {
                const date = new Date(timestamp);
                const now = new Date();
                const diff = now - date;

                if (diff < 60000) {
                    return 'Î∞©Í∏à Ï†Ñ';
                } else if (diff < 3600000) {
                    return Math.floor(diff / 60000) + 'Î∂Ñ Ï†Ñ';
                } else if (diff < 86400000) {
                    return Math.floor(diff / 3600000) + 'ÏãúÍ∞Ñ Ï†Ñ';
                } else {
                    return date.toLocaleDateString();
                }
            } catch (error) {
                return timestamp;
            }
        }

        escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        onPageShow() {
            this.loadDashboardData();
            this.loadRecentActivity();
            this.startAutoRefresh();
        }

        onPageHide() {
            this.stopAutoRefresh();
        }
    }

    // Ï†ÑÏó≠ Ïù∏Ïä§ÌÑ¥Ïä§ ÏÉùÏÑ±
    window.DashboardModule = new DashboardModule();

    // DOM Î°úÎìú ÏôÑÎ£å Ïãú Ï¥àÍ∏∞Ìôî
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
            window.DashboardModule.init();
        });
    } else {
        window.DashboardModule.init();
    }

    console.log('[Dashboard] ÎåÄÏãúÎ≥¥Îìú Î™®Îìà Î°úÎìú ÏôÑÎ£å');
    </script>
    
    <!-- Users Module JavaScript -->
    <script>
    /**
     * Users Module - ÏÇ¨Ïö©Ïûê Í¥ÄÎ¶¨
     */
    class UsersModule {
        constructor() {
            this.currentPage = 1;
            this.totalPages = 1;
            this.pageSize = 20;
            this.users = [];
            this.filteredUsers = [];
            this.selectedUsers = new Set();
        }

        init() {
            if (document.getElementById('users-page')) {
                console.log('[Users] Î™®Îìà Ï¥àÍ∏∞Ìôî ÏãúÏûë');
                this.setupEventListeners();
            }
        }

        setupEventListeners() {
            const searchInput = document.getElementById('user-search');
            if (searchInput) {
                searchInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.searchUsers();
                    }
                });
            }
        }

        async loadUsers() {
            try {
                console.log('[Users] ÏÇ¨Ïö©Ïûê Î™©Î°ù Î°úÎìú ÏãúÏûë');
                
                const response = await fetch('/api/admin/users');
                const data = await response.json();
                
                if (data.success) {
                    this.users = data.users || [];
                    this.filteredUsers = [...this.users];
                    this.displayUsers();
                    this.loadUserStats();
                    console.log(`[Users] ÏÇ¨Ïö©Ïûê ${this.users.length}Î™Ö Î°úÎìú ÏôÑÎ£å`);
                } else {
                    throw new Error(data.message || 'ÏÇ¨Ïö©Ïûê Î™©Î°ù Î°úÎìú Ïã§Ìå®');
                }
            } catch (error) {
                console.error('[Users] ÏÇ¨Ïö©Ïûê Î™©Î°ù Î°úÎìú Ïã§Ìå®:', error);
                this.showErrorState();
            }
        }

        loadUserStats() {
            const stats = this.calculateStats();
            this.updateStatsDisplay(stats);
        }

        calculateStats() {
            const total = this.users.length;
            const active = this.users.filter(user => user.is_active).length;
            const admin = this.users.filter(user => user.role === 'admin').length;
            const inactive = total - active;

            return { total, active, admin, inactive };
        }

        updateStatsDisplay(stats) {
            const elements = {
                'total-users-count': stats.total,
                'active-users-count': stats.active,
                'admin-users-count': stats.admin,
                'inactive-users-count': stats.inactive
            };

            Object.entries(elements).forEach(([id, value]) => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = value;
                }
            });
        }

        displayUsers() {
            const tbody = document.getElementById('users-table-body');
            if (!tbody) return;
            
            if (!this.filteredUsers || this.filteredUsers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="11" class="loading-row">Îì±Î°ùÎêú ÏÇ¨Ïö©ÏûêÍ∞Ä ÏóÜÏäµÎãàÎã§.</td></tr>';
                return;
            }
            
            const startIndex = (this.currentPage - 1) * this.pageSize;
            const endIndex = startIndex + this.pageSize;
            const pageUsers = this.filteredUsers.slice(startIndex, endIndex);
            
            tbody.innerHTML = pageUsers.map(user => `
                <tr class="${this.selectedUsers.has(user.id) ? 'selected-row' : ''}">
                    <td>
                        <input type="checkbox" class="user-checkbox" 
                               value="${user.id}" 
                               ${this.selectedUsers.has(user.id) ? 'checked' : ''}
                               onchange="UsersModule.toggleUserSelection(${user.id})">
                    </td>
                    <td>${user.id}</td>
                    <td>
                        <div class="user-info">
                            <span class="username">${this.escapeHtml(user.username)}</span>
                            <div class="user-email">${this.escapeHtml(user.email || '-')}</div>
                        </div>
                    </td>
                    <td><span class="role-badge role-${user.role}">${this.getRoleDisplay(user.role)}</span></td>
                    <td>${this.escapeHtml(user.department || '-')}</td>
                    <td>${this.escapeHtml(user.phone_number || '-')}</td>
                    <td>${this.escapeHtml(user.managed_site || '-')}</td>
                    <td>${user.assigned_sites_count || 0}Í∞ú ÏÇ¨ÏóÖÏû•</td>
                    <td>
                        <span class="status-badge ${user.is_active ? 'status-active' : 'status-inactive'}">
                            ${user.is_active ? 'ÌôúÏÑ±' : 'ÎπÑÌôúÏÑ±'}
                        </span>
                    </td>
                    <td>${this.formatLastLogin(user.last_login)}</td>
                    <td class="actions-cell">
                        <button class="btn-small btn-edit" onclick="UsersModule.editUser(${user.id})" title="Ìé∏Ïßë">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn-small btn-sites" onclick="UsersModule.manageSites(${user.id})" title="ÏÇ¨ÏóÖÏû• Í¥ÄÎ¶¨">
                            <i class="fas fa-building"></i>
                        </button>
                        <button class="btn-small btn-reset" onclick="UsersModule.resetPassword(${user.id})" title="ÎπÑÎ∞ÄÎ≤àÌò∏ Ï¥àÍ∏∞Ìôî">
                            <i class="fas fa-key"></i>
                        </button>
                        <button class="btn-small ${user.is_active ? 'btn-danger' : 'btn-success'}" 
                                onclick="UsersModule.toggleUserStatus(${user.id}, ${!user.is_active})" 
                                title="${user.is_active ? 'ÎπÑÌôúÏÑ±Ìôî' : 'ÌôúÏÑ±Ìôî'}">
                            <i class="fas fa-${user.is_active ? 'times' : 'check'}"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
            
            this.updatePaginationInfo();
        }

        showErrorState() {
            const tbody = document.getElementById('users-table-body');
            if (tbody) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="11" class="loading-row" style="color: #dc3545;">
                            <i class="fas fa-exclamation-triangle"></i> 
                            ÏÇ¨Ïö©Ïûê Î™©Î°ùÏùÑ Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§. Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.
                            <br>
                            <button onclick="UsersModule.loadUsers()" class="btn-secondary" style="margin-top: 10px;">
                                Îã§Ïãú ÏãúÎèÑ
                            </button>
                        </td>
                    </tr>
                `;
            }
        }

        getRoleDisplay(role) {
            const roleMap = {
                'admin': 'Í¥ÄÎ¶¨Ïûê',
                'manager': 'Îã¥ÎãπÏûê',
                'viewer': 'Ïó¥ÎûåÏûê'
            };
            return roleMap[role] || role;
        }

        formatLastLogin(lastLogin) {
            if (!lastLogin) return 'Î°úÍ∑∏Ïù∏ Í∏∞Î°ù ÏóÜÏùå';
            
            try {
                const date = new Date(lastLogin);
                const now = new Date();
                const diff = now - date;
                
                if (diff < 60000) {
                    return 'Î∞©Í∏à Ï†Ñ';
                } else if (diff < 3600000) {
                    return Math.floor(diff / 60000) + 'Î∂Ñ Ï†Ñ';
                } else if (diff < 86400000) {
                    return Math.floor(diff / 3600000) + 'ÏãúÍ∞Ñ Ï†Ñ';
                } else {
                    return date.toLocaleDateString();
                }
            } catch (error) {
                return lastLogin;
            }
        }

        searchUsers() {
            const keyword = document.getElementById('user-search')?.value?.toLowerCase() || '';
            
            if (!keyword) {
                this.filteredUsers = [...this.users];
            } else {
                this.filteredUsers = this.users.filter(user => 
                    user.username?.toLowerCase().includes(keyword) ||
                    user.email?.toLowerCase().includes(keyword) ||
                    user.department?.toLowerCase().includes(keyword) ||
                    user.phone_number?.includes(keyword)
                );
            }
            
            this.currentPage = 1;
            this.displayUsers();
            console.log(`[Users] Í≤ÄÏÉâ Í≤∞Í≥º: ${this.filteredUsers.length}Î™Ö`);
        }

        filterUsers() {
            const roleFilter = document.getElementById('role-filter')?.value || '';
            const statusFilter = document.getElementById('status-filter')?.value || '';
            
            this.filteredUsers = this.users.filter(user => {
                const roleMatch = !roleFilter || user.role === roleFilter;
                const statusMatch = !statusFilter || 
                    (statusFilter === 'active' && user.is_active) ||
                    (statusFilter === 'inactive' && !user.is_active);
                
                return roleMatch && statusMatch;
            });
            
            const keyword = document.getElementById('user-search')?.value?.toLowerCase() || '';
            if (keyword) {
                this.filteredUsers = this.filteredUsers.filter(user => 
                    user.username?.toLowerCase().includes(keyword) ||
                    user.email?.toLowerCase().includes(keyword) ||
                    user.department?.toLowerCase().includes(keyword)
                );
            }
            
            this.currentPage = 1;
            this.displayUsers();
        }

        clearFilters() {
            document.getElementById('user-search').value = '';
            document.getElementById('role-filter').value = '';
            document.getElementById('status-filter').value = '';
            
            this.filteredUsers = [...this.users];
            this.currentPage = 1;
            this.displayUsers();
        }

        changePage(direction) {
            const newPage = this.currentPage + direction;
            const maxPages = Math.ceil(this.filteredUsers.length / this.pageSize);
            
            if (newPage >= 1 && newPage <= maxPages) {
                this.currentPage = newPage;
                this.displayUsers();
            }
        }

        changePageSize() {
            const pageSize = parseInt(document.getElementById('page-size')?.value || 20);
            this.pageSize = pageSize;
            this.currentPage = 1;
            this.displayUsers();
        }

        updatePaginationInfo() {
            const maxPages = Math.ceil(this.filteredUsers.length / this.pageSize);
            const pageInfo = document.getElementById('page-info');
            if (pageInfo) {
                pageInfo.textContent = `${this.currentPage} / ${maxPages}`;
            }
            
            const prevBtn = document.getElementById('prev-page-btn');
            const nextBtn = document.getElementById('next-page-btn');
            
            if (prevBtn) prevBtn.disabled = this.currentPage <= 1;
            if (nextBtn) nextBtn.disabled = this.currentPage >= maxPages;
        }

        toggleSelectAll() {
            const selectAllCheckbox = document.getElementById('select-all-users');
            const isChecked = selectAllCheckbox?.checked || false;
            
            if (isChecked) {
                const startIndex = (this.currentPage - 1) * this.pageSize;
                const endIndex = startIndex + this.pageSize;
                const pageUsers = this.filteredUsers.slice(startIndex, endIndex);
                
                pageUsers.forEach(user => this.selectedUsers.add(user.id));
            } else {
                this.selectedUsers.clear();
            }
            
            this.displayUsers();
        }

        toggleUserSelection(userId) {
            if (this.selectedUsers.has(userId)) {
                this.selectedUsers.delete(userId);
            } else {
                this.selectedUsers.add(userId);
            }
            
            this.displayUsers();
        }

        escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        showAddUserModal() {
            console.log('[Users] ÏÉà ÏÇ¨Ïö©Ïûê Ï∂îÍ∞Ä Î™®Îã¨');
            alert('ÏÉà ÏÇ¨Ïö©Ïûê Ï∂îÍ∞Ä Î™®Îã¨ (Íµ¨ÌòÑ ÏòàÏ†ï)');
        }

        editUser(userId) {
            console.log('[Users] ÏÇ¨Ïö©Ïûê Ìé∏Ïßë:', userId);
            alert(`ÏÇ¨Ïö©Ïûê ${userId} Ìé∏Ïßë (Íµ¨ÌòÑ ÏòàÏ†ï)`);
        }

        manageSites(userId) {
            console.log('[Users] ÏÇ¨ÏóÖÏû• Í¥ÄÎ¶¨:', userId);
            alert(`ÏÇ¨Ïö©Ïûê ${userId} ÏÇ¨ÏóÖÏû• Í¥ÄÎ¶¨ (Íµ¨ÌòÑ ÏòàÏ†ï)`);
        }

        async resetPassword(userId) {
            if (!confirm('Ïù¥ ÏÇ¨Ïö©ÏûêÏùò ÎπÑÎ∞ÄÎ≤àÌò∏Î•º Ï¥àÍ∏∞ÌôîÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                return;
            }
            
            console.log('[Users] ÎπÑÎ∞ÄÎ≤àÌò∏ Ï¥àÍ∏∞Ìôî:', userId);
            alert(`ÏÇ¨Ïö©Ïûê ${userId} ÎπÑÎ∞ÄÎ≤àÌò∏ Ï¥àÍ∏∞Ìôî (Íµ¨ÌòÑ ÏòàÏ†ï)`);
        }

        async toggleUserStatus(userId, newStatus) {
            const action = newStatus ? 'ÌôúÏÑ±Ìôî' : 'ÎπÑÌôúÏÑ±Ìôî';
            
            if (!confirm(`Ïù¥ ÏÇ¨Ïö©ÏûêÎ•º ${action}ÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) {
                return;
            }
            
            console.log('[Users] ÏÇ¨Ïö©Ïûê ÏÉÅÌÉú Î≥ÄÍ≤Ω:', userId, '‚Üí', newStatus);
            
            const user = this.users.find(u => u.id === userId);
            if (user) {
                user.is_active = newStatus;
                this.displayUsers();
                this.loadUserStats();
            }
        }

        exportUsers() {
            console.log('[Users] ÏÇ¨Ïö©Ïûê Î™©Î°ù ÎÇ¥Î≥¥ÎÇ¥Í∏∞');
            alert('ÏÇ¨Ïö©Ïûê Î™©Î°ù ÎÇ¥Î≥¥ÎÇ¥Í∏∞ (Íµ¨ÌòÑ ÏòàÏ†ï)');
        }

        onPageShow() {
            this.loadUsers();
        }

        onPageHide() {
            this.selectedUsers.clear();
        }
    }

    // Ï†ÑÏó≠ Ïù∏Ïä§ÌÑ¥Ïä§ ÏÉùÏÑ±
    window.UsersModule = new UsersModule();

    // DOM Î°úÎìú ÏôÑÎ£å Ïãú Ï¥àÍ∏∞Ìôî
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
            window.UsersModule.init();
        });
    } else {
        window.UsersModule.init();
    }

    console.log('[Users] ÏÇ¨Ïö©Ïûê Î™®Îìà Î°úÎìú ÏôÑÎ£å');
    </script>

    <!-- ÏÇ¨ÏóÖÏû• Ìé∏Ïßë Î™®Îã¨ -->
    <div id="business-location-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
        <div style="background: white; border-radius: 10px; padding: 30px; max-width: 600px; width: 90%; max-height: 80%; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3>ÏÇ¨ÏóÖÏû• Ï†ïÎ≥¥ Ìé∏Ïßë</h3>
                <button onclick="closeBusinessLocationModal()" style="background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
            </div>
            
            <form id="business-location-form">
                <input type="hidden" id="edit-customer-id" />
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>ÏÇ¨ÏóÖÏû•Î™Ö *</label>
                        <input type="text" id="edit-customer-name" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" required />
                    </div>
                    
                    <div class="form-group">
                        <label>ÏÇ¨ÏóÖÏû•ÏΩîÎìú</label>
                        <input type="text" id="edit-customer-code" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />
                    </div>
                    
                    <div class="form-group">
                        <label>ÏÇ¨ÏóÖÏû•Ïú†Ìòï</label>
                        <select id="edit-customer-type" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <option value="">ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</option>
                            <option value="Î≥∏ÏÇ¨">Î≥∏ÏÇ¨</option>
                            <option value="ÏßÄÏÇ¨">ÏßÄÏÇ¨</option>
                            <option value="Í≥µÏû•">ÌïôÍµê</option>
                            <option value="ÏúÑÌÉÅ">Í≥µÏû•</option>
                            <option value="Í∏∞ÌÉÄ">Í∏∞ÌÉÄ</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Îã¥ÎãπÏûê</label>
                        <input type="text" id="edit-customer-contact" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />
                    </div>
                    
                    <div class="form-group">
                        <label>Ïó∞ÎùΩÏ≤ò</label>
                        <input type="tel" id="edit-customer-phone" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />
                    </div>
                    
                    <div class="form-group">
                        <label>Í∏âÏãùÏù∏Ïõê</label>
                        <input type="number" id="edit-customer-portion" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" min="0" />
                    </div>
                </div>
                
                <div class="form-group" style="margin-top: 15px;">
                    <label>Ï£ºÏÜå</label>
                    <textarea id="edit-customer-address" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" rows="2"></textarea>
                </div>
                
                <div class="form-group" style="margin-top: 15px;">
                    <label>ÏÑ§Î™Ö</label>
                    <textarea id="edit-customer-description" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" rows="3"></textarea>
                </div>
                
                <div class="form-group" style="margin-top: 15px;">
                    <label>
                        <input type="checkbox" id="edit-customer-active" style="margin-right: 8px;" />
                        Ïö¥ÏòÅÏ§ë
                    </label>
                </div>
                
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 30px;">
                    <button type="button" onclick="closeBusinessLocationModal()" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer;">
                        Ï∑®ÏÜå
                    </button>
                    <button type="button" onclick="saveBusinessLocation()" style="padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">
                        <i class="fas fa-save"></i> Ï†ÄÏû•
                    </button>
                </div>
            </form>
        </div>
    </div>

</body>
</html>