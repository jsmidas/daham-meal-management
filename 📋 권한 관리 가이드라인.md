# 🔐 다함 식단관리 시스템 권한 관리 가이드라인

## 📊 현재 권한 시스템 현황

### 1. 사용자 역할 (RoleEnum)
- **관리자 (admin)**: 전체 시스템 관리 권한
- **영양사 (nutritionist)**: 식단/메뉴 관리 권한

### 2. 사용자 속성
```python
class User:
    - role: 기본 역할 (관리자/영양사)
    - operator: 운영자 권한 (True/False)
    - semi_operator: 반운영자 권한 (True/False)
    - managed_site: 관리 사업장
    - department: 소속 부서
    - position: 직책
```

## 🎯 권한 관리 전략

### 권한 레벨 정의

#### 🟥 Level 1: 시스템 관리자
- **대상**: `role=admin` + `operator=True`
- **권한**: 모든 기능 접근 가능
- **기능**:
  - 사용자 관리 (추가/수정/삭제)
  - 시스템 설정 변경
  - 모든 사업장 데이터 접근
  - 백업/복원
  - 로그 관리

#### 🟨 Level 2: 사업장 관리자
- **대상**: `role=admin` + 특정 `managed_site`
- **권한**: 담당 사업장 전체 관리
- **기능**:
  - 담당 사업장 모든 데이터 CRUD
  - 협력업체 관리
  - 직원 관리 (하위 권한만)
  - 발주/입고 승인

#### 🟩 Level 3: 영양사
- **대상**: `role=nutritionist`
- **권한**: 식단/메뉴 관리
- **기능**:
  - 식단 계획 작성/수정
  - 메뉴/레시피 관리
  - 식재료 관리
  - 영양 분석

#### 🟦 Level 4: 운영 담당자
- **대상**: `semi_operator=True`
- **권한**: 일일 운영 업무
- **기능**:
  - 발주 생성
  - 입고 처리
  - 재고 관리
  - 전처리 지시서 작성

#### ⬜ Level 5: 조회 전용
- **대상**: 기본 사용자
- **권한**: 읽기 전용
- **기능**:
  - 식단표 조회
  - 메뉴 조회
  - 기본 통계 조회

## 🛡️ 보안 정책

### 1. 세션 관리
- **세션 만료**: 8시간 (현재 설정)
- **자동 로그아웃**: 비활성 2시간
- **동시 세션**: 사용자당 최대 3개

### 2. 데이터 접근 제어
```python
# 사업장별 데이터 접근 제한
def check_site_access(user, target_site):
    if user.role == "admin" and user.operator:
        return True  # 시스템 관리자
    if user.managed_site == target_site:
        return True  # 담당 사업장
    return False
```

### 3. API 권한 체크 데코레이터
```python
from functools import wraps

def require_permission(required_role=None, require_operator=False):
    def decorator(func):
        @wraps(func)
        def wrapper(*args, **kwargs):
            # 권한 체크 로직
            user = get_current_user()
            if required_role and user.role != required_role:
                raise HTTPException(401, "권한이 없습니다")
            if require_operator and not user.operator:
                raise HTTPException(401, "운영자 권한이 필요합니다")
            return func(*args, **kwargs)
        return wrapper
    return decorator
```

## 📋 권한별 기능 매트릭스

| 기능 모듈 | 시스템관리자 | 사업장관리자 | 영양사 | 운영담당자 | 조회전용 |
|-----------|:------------:|:------------:|:------:|:----------:|:--------:|
| **사용자 관리** | ✅ | ⚠️(하위만) | ❌ | ❌ | ❌ |
| **사업장 관리** | ✅ | ✅(담당만) | 👁️ | 👁️ | 👁️ |
| **협력업체 관리** | ✅ | ✅ | 👁️ | ✅ | 👁️ |
| **식재료 관리** | ✅ | ✅ | ✅ | ✅ | 👁️ |
| **메뉴/레시피** | ✅ | ✅ | ✅ | 👁️ | 👁️ |
| **식단 관리** | ✅ | ✅ | ✅ | 👁️ | 👁️ |
| **발주 관리** | ✅ | ✅(승인) | 👁️ | ✅ | 👁️ |
| **입고 관리** | ✅ | ✅ | 👁️ | ✅ | 👁️ |
| **전처리 지시서** | ✅ | ✅ | ✅ | ✅ | 👁️ |
| **통계/보고서** | ✅ | ✅(담당만) | ✅ | ✅ | 👁️ |

**범례**: ✅ 모든권한 | ⚠️ 제한적권한 | 👁️ 조회만 | ❌ 접근불가

## 🔧 구현 권장사항

### 1. 권한 체크 미들웨어 추가
```python
# app/middleware/auth.py
class AuthMiddleware:
    async def __call__(self, request: Request, call_next):
        # JWT 토큰 검증
        # 세션 유효성 검사
        # 권한 레벨 설정
        pass
```

### 2. API 라우터별 권한 설정
```python
# 예시: 사업장 관리 API
@router.post("/business-locations")
@require_permission(required_role="admin", require_operator=False)
async def create_business_location(data):
    pass

# 예시: 식단 관리 API  
@router.post("/meal-plans")
@require_permission(required_role="nutritionist", require_site_access=True)
async def create_meal_plan(data):
    pass
```

### 3. 프론트엔드 UI 제어
- 권한에 따른 메뉴 표시/숨김
- 버튼 활성화/비활성화
- 데이터 필터링

### 4. 감사 로그 (Audit Log)
- 모든 중요한 작업 로깅
- 사용자별 활동 추적
- 보안 이벤트 모니터링

## 🚀 실제 구현 단계

### Phase 1: 기본 권한 체계
1. 권한 데코레이터 구현
2. API별 권한 설정
3. 기본 UI 권한 제어

### Phase 2: 고급 보안 기능
1. 사업장별 데이터 접근 제어
2. 역할 기반 메뉴 시스템
3. 세션 관리 강화

### Phase 3: 감사 및 모니터링
1. 활동 로그 시스템
2. 보안 대시보드
3. 권한 위반 알림

이 가이드라인을 바탕으로 단계적으로 권한 시스템을 강화해 나가시기 바랍니다.