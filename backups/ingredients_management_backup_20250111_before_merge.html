<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>다함 식자재 관리</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.4;
        }
        
        .container {
            display: flex;
            min-height: 100vh;
        }
        
        /* 사이드바 */
        .sidebar {
            width: 180px;
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 15px 0;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }
        
        .logo {
            text-align: center;
            padding: 0 15px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            margin-bottom: 20px;
        }
        
        .logo h1 {
            font-size: 18px;
            font-weight: bold;
            color: #3498db;
        }
        
        .nav-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            color: rgba(255,255,255,0.8);
            text-decoration: none;
            transition: all 0.3s;
            font-size: 13px;
        }
        
        .nav-item:hover, .nav-item.active {
            background-color: rgba(52, 152, 219, 0.2);
            color: white;
            border-right: 3px solid #3498db;
        }
        
        .nav-item i {
            margin-right: 10px;
            font-size: 14px;
            width: 16px;
        }
        
        .nav-divider {
            height: 1px;
            background: rgba(255,255,255,0.1);
            margin: 15px 15px;
        }
        
        .admin-item {
            background-color: rgba(231, 76, 60, 0.1);
            border-left: 3px solid #e74c3c;
        }
        
        .admin-item:hover {
            background-color: rgba(231, 76, 60, 0.2);
            border-right: 3px solid #e74c3c;
        }

        /* 메인 컨텐츠 */
        .main-content {
            flex: 1;
            padding: 20px;
        }
        
        .header {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 25px;
        }
        
        .header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 28px;
        }
        
        .content-section {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 15px;
            overflow-x: auto;
        }
        
        /* 테이블 컸테이너 */
        .table-container {
            overflow-x: auto;
            overflow-y: auto;
            max-height: 70vh;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .ingredients-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 11px;
            font-family: 'Malgun Gothic', Arial, sans-serif;
        }
        
        .ingredients-table th,
        .ingredients-table td {
            padding: 4px 6px;
            text-align: left;
            border: 1px solid #ddd;
            vertical-align: top;
            line-height: 1.2;
        }
        
        .ingredients-table th {
            background: #f0f0f0;
            font-weight: bold;
            color: #333;
            font-size: 10px;
            text-align: center;
            white-space: nowrap;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .ingredients-table td {
            font-size: 10px;
            max-width: 120px;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        
        .ingredients-table tbody tr {
            cursor: pointer;
        }
        
        .ingredients-table tbody tr:hover {
            background: #e8f4fd;
        }
        
        .ingredients-table tbody tr:nth-child(even) {
            background: #fafafa;
        }
        
        .ingredients-table tbody tr:nth-child(even):hover {
            background: #e8f4fd;
        }
        
        /* 컬럼별 크기 조정 */
        .ingredients-table th:nth-child(1),
        .ingredients-table td:nth-child(1) { width: 8%; max-width: 80px; } /* 분류 */
        .ingredients-table th:nth-child(2),
        .ingredients-table td:nth-child(2) { width: 8%; max-width: 80px; } /* 세분류 */
        .ingredients-table th:nth-child(3),
        .ingredients-table td:nth-child(3) { width: 8%; max-width: 70px; } /* 고유코드 */
        .ingredients-table th:nth-child(4),
        .ingredients-table td:nth-child(4) { width: 12%; max-width: 100px; } /* 식자재명 */
        .ingredients-table th:nth-child(5),
        .ingredients-table td:nth-child(5) { width: 6%; max-width: 60px; } /* 원산지 */
        .ingredients-table th:nth-child(6),
        .ingredients-table td:nth-child(6) { width: 6%; max-width: 60px; } /* 계산유무 */
        .ingredients-table th:nth-child(7),
        .ingredients-table td:nth-child(7) { width: 8%; max-width: 80px; } /* 규격 */
        .ingredients-table th:nth-child(8),
        .ingredients-table td:nth-child(8) { width: 4%; max-width: 40px; } /* 단위 */
        .ingredients-table th:nth-child(9),
        .ingredients-table td:nth-child(9) { width: 4%; max-width: 40px; } /* 면세 */
        .ingredients-table th:nth-child(10),
        .ingredients-table td:nth-child(10) { width: 6%; max-width: 60px; } /* 선별주문 */
        .ingredients-table th:nth-child(11),
        .ingredients-table td:nth-child(11) { width: 8%; max-width: 70px; text-align: right; } /* 입고가 */
        .ingredients-table th:nth-child(12),
        .ingredients-table td:nth-child(12) { width: 8%; max-width: 70px; text-align: right; } /* 판매가 */
        .ingredients-table th:nth-child(13),
        .ingredients-table td:nth-child(13) { width: 10%; max-width: 90px; } /* 거래처명 */
        .ingredients-table th:nth-child(14),
        .ingredients-table td:nth-child(14) { width: 10%; max-width: 100px; } /* 비고 */
        
        /* 가격 표시 스타일 */
        .price {
            font-family: 'Consolas', monospace;
            font-weight: bold;
            color: #2e7d32;
        }
        
        /* 테이블 스크롤바 스타일링 */
        .table-container::-webkit-scrollbar {
            width: 12px;
            height: 12px;
        }
        
        .table-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 6px;
        }
        
        .table-container::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 6px;
        }
        
        .table-container::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        
        /* 헤더 고정 스타일 개선 */
        .ingredients-table thead th {
            position: sticky;
            top: 0;
            background: #f0f0f0;
            z-index: 100;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        /* 반응형 대응 */
        @media (max-width: 1200px) {
            .ingredients-table {
                font-size: 9px;
            }
            
            .ingredients-table th,
            .ingredients-table td {
                padding: 3px 4px;
            }
        }
        
        /* 추가 Excel 스타일 개선 */
        .ingredients-table td strong {
            color: #1565c0;
            font-weight: 600;
        }
        
        /* 인쇄 친화적 스타일 */
        @media print {
            .ingredients-table {
                font-size: 8px;
            }
            
            .ingredients-table th,
            .ingredients-table td {
                padding: 2px 3px;
                border: 1px solid #000;
            }
            
            .sidebar, .header {
                display: none;
            }
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #3498db;
            color: white;
        }
        
        .btn-primary:hover {
            background: #2980b9;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 6px;
            margin: 20px 0;
        }
        
        /* 대시보드 카드 스타일 */
        .dashboard-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .dashboard-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 20px;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .dashboard-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .total-ingredients { border-left: 5px solid #8e44ad; }
        .total-suppliers { border-left: 5px solid #f39c12; }
        .avg-price { border-left: 5px solid #27ae60; }
        .recent-updates { border-left: 5px solid #e67e22; }
        
        .card-icon {
            font-size: 35px;
            padding: 15px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .total-ingredients .card-icon {
            background: rgba(142, 68, 173, 0.1);
            color: #8e44ad;
        }
        
        .total-suppliers .card-icon {
            background: rgba(243, 156, 18, 0.1);
            color: #f39c12;
        }
        
        .avg-price .card-icon {
            background: rgba(39, 174, 96, 0.1);
            color: #27ae60;
        }
        
        .recent-updates .card-icon {
            background: rgba(230, 126, 34, 0.1);
            color: #e67e22;
        }
        
        .card-content {
            flex: 1;
        }
        
        .card-number {
            font-size: 32px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .card-label {
            color: #7f8c8d;
            font-size: 16px;
            font-weight: 500;
        }
        
        /* 업체별 그리드 스타일 */
        .suppliers-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .supplier-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            border-left: 4px solid #3498db;
            transition: all 0.3s;
        }
        
        .supplier-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.12);
        }
        
        .supplier-name {
            font-size: 16px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .supplier-stats {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .supplier-stat {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
        }
        
        .stat-label {
            color: #7f8c8d;
        }
        
        .stat-value {
            color: #2c3e50;
            font-weight: 500;
        }
        
        /* 모달 스타일 */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s;
        }
        
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 0;
            border-radius: 10px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideIn 0.3s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .modal-header {
            padding: 20px 25px;
            background: #f8f9fa;
            border-bottom: 1px solid #eee;
            border-radius: 10px 10px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h3 {
            margin: 0;
            color: #2c3e50;
        }
        
        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover {
            color: #000;
        }
        
        .modal-body {
            padding: 25px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-group label {
            margin-bottom: 5px;
            font-weight: 500;
            color: #2c3e50;
        }
        
        .form-group input {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }
        
        .modal-footer {
            padding: 20px 25px;
            background: #f8f9fa;
            border-top: 1px solid #eee;
            border-radius: 0 0 10px 10px;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 사이드바 -->
        <nav class="sidebar">
            <div class="logo">
                <h1>다함 급식관리</h1>
            </div>
            <a href="/" class="nav-item"><i class="fas fa-home"></i>대시보드</a>
            <a href="/meal-plan" class="nav-item"><i class="fas fa-calendar-alt"></i>식단 관리</a>
            <a href="/meal-count" class="nav-item"><i class="fas fa-users"></i>식수 관리</a>
            <a href="/ingredients" class="nav-item active"><i class="fas fa-carrot"></i>식자재 관리</a>
            <a href="/ordering" class="nav-item"><i class="fas fa-shopping-cart"></i>발주 관리</a>
            <a href="/receiving" class="nav-item"><i class="fas fa-truck"></i>입고명세서 관리</a>
            <a href="#" class="nav-item"><i class="fas fa-book"></i>각종 일지</a>
            <a href="/preprocessing-demo" class="nav-item"><i class="fas fa-cut"></i>전처리지시서</a>
            <a href="/cooking" class="nav-item"><i class="fas fa-fire"></i>조리지시서</a>
            <a href="/portion" class="nav-item"><i class="fas fa-chart-bar"></i>소분지시서</a>
            <div class="nav-divider"></div>
            <a href="/admin" class="nav-item admin-item"><i class="fas fa-cog"></i>ADMIN</a>
        </nav>
        
        <!-- 메인 컨텐츠 -->
        <div class="main-content">
            <div class="header">
                <h1><i class="fas fa-carrot"></i> 식자재 관리</h1>
                <p>식자재 목록 조회 및 관리</p>
            </div>
            
            <!-- 대시보드 카드 섹션 -->
            <div class="dashboard-cards">
                <div class="dashboard-card total-ingredients">
                    <div class="card-icon">
                        <i class="fas fa-carrot"></i>
                    </div>
                    <div class="card-content">
                        <div class="card-number" id="totalIngredients">0</div>
                        <div class="card-label">총 식자재</div>
                    </div>
                </div>
                
                <div class="dashboard-card total-suppliers">
                    <div class="card-icon">
                        <i class="fas fa-building"></i>
                    </div>
                    <div class="card-content">
                        <div class="card-number" id="totalSuppliers">0</div>
                        <div class="card-label">협력업체</div>
                    </div>
                </div>
                
                <div class="dashboard-card avg-price">
                    <div class="card-icon">
                        <i class="fas fa-won-sign"></i>
                    </div>
                    <div class="card-content">
                        <div class="card-number" id="avgPrice">₩0</div>
                        <div class="card-label">평균 판매가</div>
                    </div>
                </div>
                
                <div class="dashboard-card recent-updates">
                    <div class="card-icon">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="card-content">
                        <div class="card-number" id="recentUpdates">0</div>
                        <div class="card-label">최근 등록</div>
                    </div>
                </div>
            </div>
            
            <!-- 업체별 박스 섹션 -->
            <div class="suppliers-section" style="margin: 25px 0;">
                <h3 style="margin-bottom: 15px; color: #2c3e50;">업체별 식자재 현황</h3>
                <div id="suppliersGrid" class="suppliers-grid">
                    <!-- 동적으로 생성됨 -->
                </div>
            </div>
            
            <div class="content-section">
                <div class="section-header">
                    <h3>등록된 식자재 목록</h3>
                    <div style="margin: 15px 0; display: flex; gap: 10px;">
                        <button class="btn btn-primary" onclick="addIngredient()">
                            <i class="fas fa-plus"></i>
                            식자재 추가
                        </button>
                        <button class="btn btn-primary" onclick="showUploadModal()">
                            <i class="fas fa-upload"></i>
                            Excel 업로드
                        </button>
                    </div>
                </div>
                
                <div id="loadingDiv" class="loading">
                    <i class="fas fa-spinner fa-spin"></i> 식자재 목록을 불러오는 중...
                </div>
                
                <div id="errorDiv" class="error" style="display: none;"></div>
                
                <div class="table-container">
                    <table id="ingredientsTable" class="ingredients-table" style="display: none;">
                        <thead>
                            <tr>
                                <th>분류(대분류)</th>
                                <th>기본식자재(세분류)</th>
                                <th>고유코드</th>
                                <th>식자재명</th>
                                <th>원산지</th>
                                <th>계산유무</th>
                                <th>규격</th>
                                <th>단위</th>
                                <th>면세</th>
                                <th>선별주문</th>
                                <th>입고가</th>
                                <th>판매가</th>
                                <th>거래처명</th>
                                <th>비고</th>
                            </tr>
                        </thead>
                        <tbody id="ingredientsTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Excel 업로드 모달 -->
    <div id="uploadModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>식자재 Excel 업로드</h3>
                <span class="close" onclick="closeUploadModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="excelFile">Excel 파일 선택 (.xlsx, .xls)</label>
                    <input type="file" id="excelFile" accept=".xlsx,.xls" style="margin-bottom: 15px;">
                </div>
                
                <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 15px 0;">
                    <h4 style="margin-bottom: 10px; color: #2c3e50;">업로드 파일 형식 안내</h4>
                    <p>업로드할 Excel 파일은 다음 열 순서를 따라야 합니다:</p>
                    <ul style="margin: 10px 0; padding-left: 20px; line-height: 1.6;">
                        <li>A열: 분류(대분류)</li>
                        <li>B열: 기본식자재(세분류)</li>
                        <li>C열: 고유코드</li>
                        <li>D열: 식자재명</li>
                        <li>E열: 원산지</li>
                        <li>F열: 계산유무</li>
                        <li>G열: 규격</li>
                        <li>H열: 단위</li>
                        <li>I열: 면세</li>
                        <li>J열: 선별주문</li>
                        <li>K열: 입고가</li>
                        <li>L열: 판매가</li>
                        <li>M열: 거래처명</li>
                        <li>N열: 비고</li>
                    </ul>
                    <p style="color: #e74c3c; font-size: 14px;">※ 첫 번째 행은 헤더로 처리되어 제외됩니다.</p>
                </div>
                
                <div id="uploadProgress" style="display: none; margin: 15px 0;">
                    <div style="background: #f0f0f0; border-radius: 10px; overflow: hidden;">
                        <div id="uploadProgressBar" style="background: #3498db; height: 20px; width: 0%; transition: width 0.3s;"></div>
                    </div>
                    <p id="uploadStatus" style="text-align: center; margin-top: 10px; font-size: 14px;"></p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeUploadModal()">취소</button>
                <button type="button" class="btn btn-primary" onclick="uploadExcel()">업로드</button>
            </div>
        </div>
    </div>
    
    <!-- 식자재 수정 모달 -->
    <div id="ingredientModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">식자재 수정</h3>
                <span class="close" onclick="closeIngredientModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="ingredientForm">
                    <input type="hidden" id="ingredientId">
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="ingredientCategory">분류(대분류)</label>
                            <input type="text" id="ingredientCategory">
                        </div>
                        <div class="form-group">
                            <label for="ingredientSubcategory">기본식자재(세분류)</label>
                            <input type="text" id="ingredientSubcategory">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="ingredientCode">고유코드</label>
                            <input type="text" id="ingredientCode">
                        </div>
                        <div class="form-group">
                            <label for="ingredientName">식자재명 *</label>
                            <input type="text" id="ingredientName" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="ingredientOrigin">원산지</label>
                            <input type="text" id="ingredientOrigin">
                        </div>
                        <div class="form-group">
                            <label for="ingredientCalculation">계산유무</label>
                            <input type="text" id="ingredientCalculation">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="ingredientSpecification">규격</label>
                            <input type="text" id="ingredientSpecification">
                        </div>
                        <div class="form-group">
                            <label for="ingredientUnit">단위</label>
                            <input type="text" id="ingredientUnit">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="ingredientTaxFree">면세</label>
                            <input type="text" id="ingredientTaxFree">
                        </div>
                        <div class="form-group">
                            <label for="ingredientSelectiveOrder">선별주문</label>
                            <input type="text" id="ingredientSelectiveOrder">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="ingredientPurchasePrice">입고가 (원)</label>
                            <input type="number" id="ingredientPurchasePrice" min="0">
                        </div>
                        <div class="form-group">
                            <label for="ingredientPrice">판매가 (원)</label>
                            <input type="number" id="ingredientPrice" min="0">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="ingredientSupplier">거래처명</label>
                            <input type="text" id="ingredientSupplier">
                        </div>
                        <div class="form-group">
                            <label for="ingredientMemo">비고</label>
                            <input type="text" id="ingredientMemo">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeIngredientModal()">취소</button>
                <button type="button" class="btn btn-primary" onclick="saveIngredient()">저장</button>
                <button type="button" class="btn btn-danger" onclick="deleteIngredient()">삭제</button>
            </div>
        </div>
    </div>
    
    <script>
        // 페이지 로드 시 식자재 목록 불러오기
        document.addEventListener('DOMContentLoaded', function() {
            loadIngredients();
        });
        
        async function loadIngredients() {
            try {
                const response = await fetch('/api/admin/ingredients?page=1&limit=1000');
                const data = await response.json();
                
                let ingredients = [];
                if (data.success) {
                    ingredients = data.ingredients || [];
                } else {
                    // 오류시 기본 데이터 사용
                    ingredients = [
                    {
                        category: '가금류',
                        subcategory: '기타가금류',
                        code: '1000067464',
                        name: '밀가루대만두,주고슈빵,150G/PAC',
                        origin: '',
                        calculation: '',
                        specification: '종합빝,15CPAC',
                        base_unit: 'Full tax',
                        tax_free: 'D-1',
                        selective_order: '490',
                        purchase_price: '540',
                        price: '삼양식품주주',
                        supplier_name: '',
                        memo: ''
                    },
                    {
                        category: '가금류', 
                        subcategory: '기타가금류',
                        code: '1000067461',
                        name: '주붕색피자,왕시중국식,우유통 284G/PAC',
                        origin: '',
                        calculation: '',
                        specification: '주획,284G/PAC', 
                        base_unit: 'Full tax',
                        tax_free: 'D-1',
                        selective_order: '4020',
                        purchase_price: '4430',
                        price: '삼양식품주주',
                        supplier_name: '',
                        memo: ''
                    },
                    {
                        category: '뇁신거',
                        subcategory: '과실',
                        code: '영역자자',
                        name: '쉐(20KG)',
                        origin: '유',
                        calculation: '무',
                        specification: '20kg',
                        base_unit: 'EA',
                        tax_free: '유',
                        selective_order: '2',
                        purchase_price: '수자',
                        price: '수자',
                        supplier_name: '',
                        memo: ''
                    }
                    ];
                }
                
                // 대시보드 카드 업데이트
                updateDashboardCards(ingredients);
                
                // 업체별 박스 업데이트
                updateSuppliersGrid(ingredients);
                
                document.getElementById('loadingDiv').style.display = 'none';
                document.getElementById('ingredientsTable').style.display = 'table';
                document.querySelector('.table-container').style.display = 'block';
                
                const tbody = document.getElementById('ingredientsTableBody');
                tbody.innerHTML = '';
                
                if (ingredients.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="15" style="text-align: center; padding: 40px; color: #666;">등록된 식자재가 없습니다.</td></tr>';
                    return;
                }
                
                ingredients.forEach(ingredient => {
                    const row = document.createElement('tr');
                    row.style.cursor = 'pointer';
                    row.onclick = () => openIngredientModal(ingredient);
                    
                    // 텍스트 줄이기 함수
                    const truncate = (text, maxLength = 10) => {
                        if (!text || text === '-') return text || '-';
                        return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
                    };
                    
                    // 가격 포매팅 함수
                    const formatPrice = (price) => {
                        if (!price || price === 0) return '-';
                        return Number(price).toLocaleString();
                    };
                    
                    row.innerHTML = `
                        <td title="${ingredient.category || ''}">${truncate(ingredient.category, 8)}</td>
                        <td title="${ingredient.subcategory || ''}">${truncate(ingredient.subcategory, 8)}</td>
                        <td title="${ingredient.code || ''}">${truncate(ingredient.code, 7)}</td>
                        <td title="${ingredient.name || ''}" style="font-weight: 500;">${truncate(ingredient.name, 12)}</td>
                        <td title="${ingredient.origin || ''}">${truncate(ingredient.origin, 5)}</td>
                        <td title="${ingredient.calculation || ''}">${truncate(ingredient.calculation, 4)}</td>
                        <td title="${ingredient.specification || ''}">${truncate(ingredient.specification, 8)}</td>
                        <td>${truncate(ingredient.base_unit, 4)}</td>
                        <td>${truncate(ingredient.tax_free, 3)}</td>
                        <td title="${ingredient.selective_order || ''}">${truncate(ingredient.selective_order, 5)}</td>
                        <td class="price" title="₩${formatPrice(ingredient.purchase_price)}">${formatPrice(ingredient.purchase_price)}</td>
                        <td class="price" title="₩${formatPrice(ingredient.price)}">${formatPrice(ingredient.price)}</td>
                        <td title="${ingredient.supplier_name || ''}">${truncate(ingredient.supplier_name, 10)}</td>
                        <td title="${ingredient.memo || ''}">${truncate(ingredient.memo, 12)}</td>
                    `;
                    tbody.appendChild(row);
                });
                
            } catch (error) {
                console.error('Error loading ingredients:', error);
                document.getElementById('loadingDiv').style.display = 'none';
                
                // 오류 대신 기본 데이터 사용
                const ingredients = [
                    {
                        id: 1,
                        category: '채소류',
                        subcategory: '엽채류',
                        code: 'VEG001',
                        name: '시금치',
                        origin: '국산',
                        calculation: 'Y',
                        specification: '1kg',
                        base_unit: 'kg',
                        tax_free: 'N',
                        selective_order: '1',
                        purchase_price: 3000,
                        price: 3500,
                        supplier_name: '테스트업체',
                        memo: '테스트 데이터'
                    }
                ];
                
                updateDashboardCards(ingredients);
                updateSuppliersGrid(ingredients);
                
                const tbody = document.getElementById('ingredientsTableBody');
                tbody.innerHTML = '';
                
                ingredients.forEach(ingredient => {
                    const row = document.createElement('tr');
                    row.style.cursor = 'pointer';
                    row.onclick = () => openIngredientModal(ingredient);
                    
                    // Excel처럼 짧게 자르고 tooltip로 전체 내용 표시
                    const truncate = (text, maxLength = 15) => {
                        if (!text || text === '-' || text === '') return text || '';
                        return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
                    };
                    
                    row.innerHTML = `
                        <td title="${ingredient.category || ''}">${ingredient.category || ''}</td>
                        <td title="${ingredient.subcategory || ''}">${truncate(ingredient.subcategory, 10)}</td>
                        <td title="${ingredient.code || ''}">${ingredient.code || ''}</td>
                        <td title="${ingredient.name || ''}">${truncate(ingredient.name, 25)}</td>
                        <td title="${ingredient.origin || ''}">${ingredient.origin || ''}</td>
                        <td title="${ingredient.calculation || ''}">${ingredient.calculation || ''}</td>
                        <td title="${ingredient.specification || ''}">${truncate(ingredient.specification, 12)}</td>
                        <td>${ingredient.base_unit || ''}</td>
                        <td>${ingredient.tax_free || ''}</td>
                        <td title="${ingredient.selective_order || ''}">${ingredient.selective_order || ''}</td>
                        <td style="text-align: right;">${ingredient.purchase_price || ''}</td>
                        <td style="text-align: right;">${ingredient.price || ''}</td>
                        <td title="${ingredient.supplier_name || ''}">${truncate(ingredient.supplier_name, 12)}</td>
                        <td title="${ingredient.memo || ''}">${ingredient.memo || ''}</td>
                    `;
                    tbody.appendChild(row);
                });
                
                document.getElementById('ingredientsTable').style.display = 'table';
                document.querySelector('.table-container').style.display = 'block';
            }
        }
        
        function updateDashboardCards(ingredients) {
            const totalIngredients = ingredients.length;
            const suppliers = [...new Set(ingredients.map(i => i.supplier_name).filter(s => s && s !== '미지정'))];
            const totalSuppliers = suppliers.length;
            
            const validPrices = ingredients.map(i => i.price).filter(p => p && p > 0);
            const avgPrice = validPrices.length > 0 ? 
                Math.round(validPrices.reduce((sum, price) => sum + price, 0) / validPrices.length) : 0;
            
            // 최근 7일 내 등록된 것들 (created_date가 있다고 가정)
            const recentCount = ingredients.filter(i => {
                if (!i.created_date) return false;
                const createdDate = new Date(i.created_date);
                const weekAgo = new Date();
                weekAgo.setDate(weekAgo.getDate() - 7);
                return createdDate > weekAgo;
            }).length;
            
            document.getElementById('totalIngredients').textContent = totalIngredients.toLocaleString();
            document.getElementById('totalSuppliers').textContent = totalSuppliers.toLocaleString();
            document.getElementById('avgPrice').textContent = avgPrice > 0 ? '₩' + avgPrice.toLocaleString() : '₩0';
            document.getElementById('recentUpdates').textContent = recentCount.toLocaleString();
        }
        
        function updateSuppliersGrid(ingredients) {
            const suppliersMap = new Map();
            
            ingredients.forEach(ingredient => {
                const supplierName = ingredient.supplier_name || '미지정';
                if (!suppliersMap.has(supplierName)) {
                    suppliersMap.set(supplierName, {
                        name: supplierName,
                        count: 0,
                        lastUpdate: null
                    });
                }
                
                const supplier = suppliersMap.get(supplierName);
                supplier.count++;
                
                // 가장 최근 업데이트 날짜 찾기 (updated_date 또는 created_date)
                const updateDate = ingredient.updated_date || ingredient.created_date;
                if (updateDate) {
                    const date = new Date(updateDate);
                    if (!supplier.lastUpdate || date > supplier.lastUpdate) {
                        supplier.lastUpdate = date;
                    }
                }
            });
            
            const suppliersGrid = document.getElementById('suppliersGrid');
            suppliersGrid.innerHTML = '';
            
            Array.from(suppliersMap.values()).forEach(supplier => {
                const supplierCard = document.createElement('div');
                supplierCard.className = 'supplier-card';
                
                const lastUpdateText = supplier.lastUpdate ? 
                    supplier.lastUpdate.toLocaleDateString('ko-KR') : '미확인';
                
                supplierCard.innerHTML = `
                    <div class="supplier-name">${supplier.name}</div>
                    <div class="supplier-stats">
                        <div class="supplier-stat">
                            <span class="stat-label">식자재 수:</span>
                            <span class="stat-value">${supplier.count}개</span>
                        </div>
                        <div class="supplier-stat">
                            <span class="stat-label">갱신일:</span>
                            <span class="stat-value">${lastUpdateText}</span>
                        </div>
                    </div>
                `;
                suppliersGrid.appendChild(supplierCard);
            });
        }
        
        function addIngredient() {
            // 새 식자재 추가를 위한 모달 열기
            document.getElementById('modalTitle').textContent = '새 식자재 추가';
            document.getElementById('ingredientForm').reset();
            document.getElementById('ingredientId').value = '';
            // 모든 필드 초기화
            document.getElementById('ingredientCategory').value = '';
            document.getElementById('ingredientSubcategory').value = '';
            document.getElementById('ingredientCode').value = '';
            document.getElementById('ingredientName').value = '';
            document.getElementById('ingredientOrigin').value = '';
            document.getElementById('ingredientCalculation').value = '';
            document.getElementById('ingredientSpecification').value = '';
            document.getElementById('ingredientUnit').value = '';
            document.getElementById('ingredientTaxFree').value = '';
            document.getElementById('ingredientSelectiveOrder').value = '';
            document.getElementById('ingredientPurchasePrice').value = '';
            document.getElementById('ingredientPrice').value = '';
            document.getElementById('ingredientSupplier').value = '';
            document.getElementById('ingredientMemo').value = '';
            document.getElementById('ingredientModal').style.display = 'block';
        }
        
        function openIngredientModal(ingredient) {
            document.getElementById('modalTitle').textContent = '식자재 수정';
            document.getElementById('ingredientId').value = ingredient.id;
            document.getElementById('ingredientCategory').value = ingredient.category || '';
            document.getElementById('ingredientSubcategory').value = ingredient.subcategory || '';
            document.getElementById('ingredientCode').value = ingredient.code || '';
            document.getElementById('ingredientName').value = ingredient.name || '';
            document.getElementById('ingredientOrigin').value = ingredient.origin || '';
            document.getElementById('ingredientCalculation').value = ingredient.calculation || '';
            document.getElementById('ingredientSpecification').value = ingredient.specification || '';
            document.getElementById('ingredientUnit').value = ingredient.base_unit || '';
            document.getElementById('ingredientTaxFree').value = ingredient.tax_free || '';
            document.getElementById('ingredientSelectiveOrder').value = ingredient.selective_order || '';
            document.getElementById('ingredientPurchasePrice').value = ingredient.purchase_price || '';
            document.getElementById('ingredientPrice').value = ingredient.price || '';
            document.getElementById('ingredientSupplier').value = ingredient.supplier_name || '';
            document.getElementById('ingredientMemo').value = ingredient.memo || '';
            
            document.getElementById('ingredientModal').style.display = 'block';
        }
        
        function closeIngredientModal() {
            document.getElementById('ingredientModal').style.display = 'none';
        }
        
        async function saveIngredient() {
            const id = document.getElementById('ingredientId').value;
            const data = {
                category: document.getElementById('ingredientCategory').value,
                subcategory: document.getElementById('ingredientSubcategory').value,
                code: document.getElementById('ingredientCode').value,
                name: document.getElementById('ingredientName').value,
                origin: document.getElementById('ingredientOrigin').value,
                calculation: document.getElementById('ingredientCalculation').value,
                specification: document.getElementById('ingredientSpecification').value,
                base_unit: document.getElementById('ingredientUnit').value,
                tax_free: document.getElementById('ingredientTaxFree').value,
                selective_order: document.getElementById('ingredientSelectiveOrder').value,
                purchase_price: document.getElementById('ingredientPurchasePrice').value || null,
                price: document.getElementById('ingredientPrice').value || null,
                supplier_name: document.getElementById('ingredientSupplier').value,
                memo: document.getElementById('ingredientMemo').value
            };
            
            try {
                let response;
                if (id) {
                    // 수정
                    response = await fetch(`/api/admin/ingredients/${id}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(data)
                    });
                } else {
                    // 새로 추가
                    response = await fetch('/api/admin/ingredients', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(data)
                    });
                }
                
                if (response.ok) {
                    closeIngredientModal();
                    loadIngredients(); // 목록 새로고침
                    alert(id ? '식자재가 수정되었습니다.' : '식자재가 추가되었습니다.');
                } else {
                    const result = await response.json();
                    alert('저장 실패: ' + (result.error || '알 수 없는 오류'));
                }
            } catch (error) {
                console.error('Error saving ingredient:', error);
                alert('저장 중 오류가 발생했습니다: ' + error.message);
            }
        }
        
        async function deleteIngredient() {
            const id = document.getElementById('ingredientId').value;
            if (!id) {
                alert('삭제할 식자재가 선택되지 않았습니다.');
                return;
            }
            
            if (!confirm('정말로 이 식자재를 삭제하시겠습니까?')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/admin/ingredients/${id}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    closeIngredientModal();
                    loadIngredients(); // 목록 새로고침
                    alert('식자재가 삭제되었습니다.');
                } else {
                    const result = await response.json();
                    alert('삭제 실패: ' + (result.error || '알 수 없는 오류'));
                }
            } catch (error) {
                console.error('Error deleting ingredient:', error);
                alert('삭제 중 오류가 발생했습니다: ' + error.message);
            }
        }
        
        // Excel 업로드 모달 열기
        function showUploadModal() {
            document.getElementById('uploadModal').style.display = 'block';
            document.getElementById('excelFile').value = '';
            document.getElementById('uploadProgress').style.display = 'none';
        }
        
        // Excel 업로드 모달 닫기
        function closeUploadModal() {
            document.getElementById('uploadModal').style.display = 'none';
        }
        
        // Excel 파일 업로드
        async function uploadExcel() {
            const fileInput = document.getElementById('excelFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('파일을 선택해주세요.');
                return;
            }
            
            const formData = new FormData();
            formData.append('file', file);
            
            try {
                // 진행 표시
                document.getElementById('uploadProgress').style.display = 'block';
                document.getElementById('uploadStatus').textContent = '업로드 중...';
                document.getElementById('uploadProgressBar').style.width = '0%';
                
                const response = await fetch('/api/admin/upload-ingredients', {
                    method: 'POST',
                    body: formData
                });
                
                document.getElementById('uploadProgressBar').style.width = '100%';
                
                if (response.ok) {
                    const result = await response.json();
                    document.getElementById('uploadStatus').textContent = 
                        `업로드 완료! 총 ${result.total || 0}건 중 ${result.success || 0}건 성공, ${result.errors || 0}건 오류`;
                    
                    setTimeout(() => {
                        closeUploadModal();
                        loadIngredients(); // 목록 새로고침
                    }, 2000);
                } else {
                    const error = await response.json();
                    document.getElementById('uploadStatus').textContent = '업로드 실패: ' + (error.error || '알 수 없는 오류');
                    document.getElementById('uploadStatus').style.color = '#e74c3c';
                }
            } catch (error) {
                console.error('Error uploading file:', error);
                document.getElementById('uploadStatus').textContent = '업로드 중 오류가 발생했습니다: ' + error.message;
                document.getElementById('uploadStatus').style.color = '#e74c3c';
            }
        }
        
        // 모달 외부 클릭시 닫기
        window.onclick = function(event) {
            const ingredientModal = document.getElementById('ingredientModal');
            const uploadModal = document.getElementById('uploadModal');
            
            if (event.target === ingredientModal) {
                closeIngredientModal();
            } else if (event.target === uploadModal) {
                closeUploadModal();
            }
        }
    </script>
</body>
</html>