<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>테스트 급식관리 시스템 - Fortress Admin</title>
    <style>
        /* 최소한의 스타일만 포함 - 모듈별 CSS는 각자 로드 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Malgun Gothic', sans-serif;
            background-color: #f5f5f5;
            min-height: 100vh;
        }

        .fortress-loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            z-index: 9999;
        }

        .fortress-logo {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .fortress-status {
            font-size: 1.2rem;
            margin-bottom: 2rem;
        }

        .fortress-progress {
            width: 300px;
            height: 4px;
            background: rgba(255,255,255,0.3);
            border-radius: 2px;
            overflow: hidden;
        }

        .fortress-progress-bar {
            height: 100%;
            background: #ffd700;
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 2px;
        }

        .fortress-error {
            background: #dc3545 !important;
            text-align: center;
        }

        .fortress-error h2 {
            margin-bottom: 1rem;
            font-size: 2rem;
        }

        .fortress-main {
            display: none;
            min-height: 100vh;
        }

        .fortress-sidebar {
            width: 250px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }

        .fortress-content {
            margin-left: 250px;
            min-height: 100vh;
            padding: 0;
        }

        .fortress-module-container {
            width: 100%;
            height: 100vh;
        }

        #fortress-system-status {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            z-index: 1000;
        }

        .fortress-protected {
            border: 2px solid #ffd700;
            position: relative;
        }

        .fortress-protected::before {
            content: '🛡️';
            position: absolute;
            top: -10px;
            right: -10px;
            background: #ffd700;
            color: black;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <!-- 로딩 화면 -->
    <div id="fortress-loading" class="fortress-loading">
        <div class="fortress-logo">🏰</div>
        <div class="fortress-status" id="fortress-status">Fortress 시스템 초기화 중...</div>
        <div class="fortress-progress">
            <div class="fortress-progress-bar" id="fortress-progress"></div>
        </div>
        <div style="margin-top: 1rem; font-size: 0.9rem; opacity: 0.8;" id="fortress-details">
            보호된 아키텍처를 로딩하고 있습니다...
        </div>
    </div>

    <!-- 메인 애플리케이션 -->
    <div id="fortress-main" class="fortress-main">
        <!-- 사이드바 모듈 -->
        <div id="fortress-sidebar" class="fortress-sidebar fortress-protected">
            <!-- 사이드바 내용은 navigation 모듈이 로드 -->
        </div>

        <!-- 메인 컨텐츠 -->
        <div class="fortress-content">
            <div id="fortress-module-container" class="fortress-module-container">
                <!-- 활성 모듈이 여기에 로드됩니다 -->
            </div>
        </div>
    </div>

    <!-- 시스템 상태 표시 -->
    <div id="fortress-system-status">
        🏰 Fortress v1.0.0 | 모듈: 0 | 상태: 초기화중
    </div>

    <!-- 핵심 프레임워크 로드 (순서 중요!) -->
    <script src="/system/core/framework.js"></script>
    <script src="/system/core/module-registry.js"></script>
    <script src="/system/core/api-gateway.js"></script>
    <script src="/system/core/protection.js"></script>
    
    <!-- 비즈니스 모듈들 -->
    <script src="/system/modules/ingredients/ingredients-module.js"></script>

    <!-- 부트스트랩 스크립트 -->
    <script>
        /**
         * Fortress Admin Bootstrap
         * AI-resistant initialization sequence
         */
        class FortressBootstrap {
            constructor() {
                this.loadingSteps = [
                    { name: '코어 프레임워크', progress: 20, delay: 100 },
                    { name: '모듈 레지스트리', progress: 40, delay: 100 },
                    { name: 'API 게이트웨이', progress: 60, delay: 100 },
                    { name: '시스템 모듈', progress: 80, delay: 200 },
                    { name: '사용자 인터페이스', progress: 100, delay: 100 }
                ];
                this.currentStep = 0;
                this.startTime = Date.now();
            }

            async boot() {
                try {
                    console.log('🏰 Starting Fortress Admin System...');
                    
                    // 로딩 애니메이션 시작
                    await this.showLoadingAnimation();

                    // 시스템 무결성 검증
                    if (!this.validateSystem()) {
                        throw new Error('System integrity check failed');
                    }

                    // API Gateway 초기화
                    window.APIGateway.initialize();

                    // 시스템 모듈들 정의
                    this.defineSystemModules();

                    // 비즈니스 모듈들 정의
                    await this.defineBusinessModules();

                    // 모든 모듈 로드
                    await window.ModuleRegistry.loadAllModules();

                    // UI 표시
                    await this.showMainInterface();

                    // 시스템 상태 업데이트
                    this.updateSystemStatus();

                    console.log('🎉 Fortress Admin System Ready!');

                } catch (error) {
                    console.error('💥 Fortress boot failed:', error);
                    this.showError(error);
                }
            }

            async showLoadingAnimation() {
                for (const step of this.loadingSteps) {
                    document.getElementById('fortress-status').textContent = 
                        `${step.name} 로딩 중...`;
                    document.getElementById('fortress-details').textContent = 
                        `${step.name}을(를) 초기화하고 있습니다...`;
                    document.getElementById('fortress-progress').style.width = 
                        `${step.progress}%`;
                    
                    await new Promise(resolve => setTimeout(resolve, step.delay));
                    this.currentStep++;
                }
            }

            validateSystem() {
                const required = ['Fortress', 'ModuleRegistry', 'APIGateway'];
                const missing = required.filter(name => !window[name]);
                
                if (missing.length > 0) {
                    console.error('❌ Missing required systems:', missing);
                    return false;
                }

                return window.Fortress.validateIntegrity();
            }

            defineSystemModules() {
                // Navigation 모듈
                define('navigation', [], () => ({
                    name: 'navigation',
                    version: '1.0.0',
                    
                    async init() {
                        console.log('🧭 Navigation module initializing...');
                        await this.renderSidebar();
                    },
                    
                    async renderSidebar() {
                        const sidebar = document.getElementById('fortress-sidebar');
                        sidebar.innerHTML = `
                            <div style="padding: 20px; border-bottom: 1px solid rgba(255,255,255,0.2);">
                                <h2 style="font-size: 18px; font-weight: 600;">🏰 Fortress Admin</h2>
                                <p style="font-size: 12px; opacity: 0.8; margin-top: 5px;">보호된 관리 시스템</p>
                            </div>
                            <nav style="padding: 20px 0;">
                                <a href="#dashboard" class="fortress-nav-item" data-module="dashboard">
                                    📊 대시보드
                                </a>
                                <a href="#ingredients" class="fortress-nav-item" data-module="ingredients-fortress">
                                    🥬 식자재 관리 (Fortress)
                                </a>
                                <a href="#users" class="fortress-nav-item" data-module="users">
                                    👥 사용자 관리
                                </a>
                                <a href="#suppliers" class="fortress-nav-item" data-module="suppliers">
                                    🏪 협력업체 관리
                                </a>
                                <a href="#settings" class="fortress-nav-item" data-module="settings">
                                    ⚙️ 설정
                                </a>
                            </nav>
                        `;

                        // 네비게이션 스타일
                        const style = document.createElement('style');
                        style.textContent = `
                            .fortress-nav-item {
                                display: block;
                                padding: 15px 25px;
                                color: white;
                                text-decoration: none;
                                transition: all 0.3s;
                                border-left: 3px solid transparent;
                            }
                            .fortress-nav-item:hover, .fortress-nav-item.active {
                                background: rgba(255,255,255,0.1);
                                border-left-color: #ffd700;
                            }
                        `;
                        document.head.appendChild(style);

                        // 이벤트 리스너
                        sidebar.addEventListener('click', (e) => {
                            const navItem = e.target.closest('.fortress-nav-item');
                            if (navItem) {
                                e.preventDefault();
                                const module = navItem.dataset.module;
                                this.switchModule(module);
                            }
                        });
                    },

                    switchModule(moduleName) {
                        // 기존 활성 메뉴 제거
                        document.querySelectorAll('.fortress-nav-item.active')
                            .forEach(item => item.classList.remove('active'));
                        
                        // 새 메뉴 활성화
                        const newItem = document.querySelector(`[data-module="${moduleName}"]`);
                        if (newItem) newItem.classList.add('active');

                        // 모듈 로드
                        window.Fortress.sendMessage('navigation', moduleName, 'activate');
                        
                        // 컨테이너 업데이트
                        const container = document.getElementById('fortress-module-container');
                        container.innerHTML = `<div style="padding: 20px; text-align: center;">
                            <h2>🔄 ${moduleName} 모듈 로딩 중...</h2>
                        </div>`;
                    },

                    destroy() {
                        console.log('🧭 Navigation module destroyed');
                    }
                }));
            }

            async defineBusinessModules() {
                // Dashboard 모듈
                define('dashboard', ['navigation'], () => ({
                    name: 'dashboard',
                    version: '1.0.0',
                    
                    async init() {
                        console.log('📊 Dashboard module ready');
                        
                        // 메시지 리스너
                        window.Fortress.eventBus.addEventListener('moduleMessage', (e) => {
                            if (e.detail.to === 'dashboard' && e.detail.message === 'activate') {
                                this.render();
                            }
                        });
                    },

                    async render() {
                        const container = document.getElementById('fortress-module-container');
                        container.innerHTML = `
                            <div style="padding: 20px;">
                                <h1>📊 대시보드</h1>
                                <div style="margin-top: 20px; padding: 20px; background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                                    <p>🏰 Fortress 보호 시스템이 활성화되었습니다.</p>
                                    <p>모든 모듈이 안전하게 격리되어 동작합니다.</p>
                                    <div style="margin-top: 20px;">
                                        <strong>시스템 정보:</strong><br>
                                        - 프레임워크: Fortress v1.0.0<br>
                                        - 로드된 모듈: ${Object.keys(window.ModuleRegistry.getModuleStatus()).length}개<br>
                                        - 가동 시간: ${Math.round((Date.now() - this.startTime) / 1000)}초<br>
                                        - 보호 상태: ✅ 활성화됨
                                    </div>
                                </div>
                            </div>
                        `;
                    },

                    destroy() {
                        console.log('📊 Dashboard module destroyed');
                    }
                }));

                // ingredients-fortress 모듈은 별도 파일에서 로드됨
            }

            async showMainInterface() {
                document.getElementById('fortress-loading').style.display = 'none';
                document.getElementById('fortress-main').style.display = 'block';
                
                // 기본 대시보드 활성화
                setTimeout(() => {
                    const dashboardNav = document.querySelector('[data-module="dashboard"]');
                    if (dashboardNav) dashboardNav.click();
                }, 100);
            }

            updateSystemStatus() {
                const status = document.getElementById('fortress-system-status');
                const moduleCount = Object.keys(window.ModuleRegistry.getModuleStatus()).length;
                
                status.textContent = 
                    `🏰 Fortress v1.0.0 | 모듈: ${moduleCount} | 상태: 정상`;
                
                // 주기적 업데이트
                setInterval(() => {
                    const uptime = Math.round((Date.now() - this.startTime) / 1000);
                    status.textContent = 
                        `🏰 Fortress v1.0.0 | 모듈: ${moduleCount} | 가동: ${uptime}s`;
                }, 5000);
            }

            showError(error) {
                document.getElementById('fortress-loading').className = 'fortress-loading fortress-error';
                document.getElementById('fortress-loading').innerHTML = `
                    <h2>🚨 시스템 오류</h2>
                    <p>Fortress 시스템을 초기화할 수 없습니다.</p>
                    <div style="margin: 20px; padding: 20px; background: rgba(255,255,255,0.2); border-radius: 10px; font-family: monospace; text-align: left;">
                        ${error.message}
                    </div>
                    <button onclick="location.reload()" style="padding: 10px 20px; background: white; color: #dc3545; border: none; border-radius: 5px; cursor: pointer;">
                        시스템 재시작
                    </button>
                `;
            }
        }

        // 시스템 부팅
        document.addEventListener('DOMContentLoaded', async () => {
            const bootstrap = new FortressBootstrap();
            await bootstrap.boot();
        });

        // 전역 에러 핸들링
        window.addEventListener('error', (e) => {
            console.error('🚨 Global error:', e.error);
            
            if (window.Fortress) {
                window.Fortress.validateIntegrity();
            }
        });

        // 보호 메시지
        console.log(`
🏰 ==========================================
   FORTRESS ADMIN SYSTEM
   AI-Resistant Architecture
   
   ⚠️  이 시스템은 AI 어시스턴트의 
       무차별적 수정으로부터 보호됩니다.
       
   📋 구조 변경 시 반드시 문서를 확인하세요.
==========================================
        `);
    </script>
</body>
</html>