<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>식자재 관리 시스템 - 관리자 대시보드</title>
    
    <!-- 외부 CSS -->
    <link rel="stylesheet" href="static/css/admin-dashboard-main.css">
</head>
<body>
    <!-- 메인 컨테이너 -->
    <div class="admin-container">
        <!-- 사이드바 -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <h2>🍽️ 식자재 관리 시스템</h2>
                <p>관리자 시스템</p>
            </div>
            
            <div class="nav-menu">
                <a href="#" class="nav-item active" data-page="dashboard">
                    <span class="icon">📊</span>대시보드
                </a>
                <a href="#" class="nav-item" data-page="users">
                    <span class="icon">👥</span>사용자 관리
                </a>
                <a href="#" class="nav-item" data-page="suppliers">
                    <span class="icon">🚛</span>협력업체 관리
                </a>
                <a href="#" class="nav-item" data-page="business-locations">
                    <span class="icon">🏢</span>사업장 관리
                </a>
                <a href="#" class="nav-item" data-page="meal-pricing">
                    <span class="icon">💰</span>식단가 관리
                </a>
                <a href="#" class="nav-item" data-page="ingredients">
                    <span class="icon">📦</span>식자재 관리
                </a>
            </div>
            
            <div class="sidebar-footer" style="margin-top: auto; padding: 20px;">
                <div style="border-top: 1px solid rgba(255,255,255,0.2); padding-top: 20px;">
                    <a href="/" class="nav-item" style="background: #e8f5e8; color: #4caf50;">
                        <span class="icon">🍽️</span>급식관리로 이동
                    </a>
                </div>
            </div>
        </nav>

        <!-- 메인 컨텐츠 -->
        <main class="main-content">
            <!-- 헤더 -->
            <div class="header">
                <h1 id="page-title">관리자 대시보드</h1>
                <div class="header-info">
                    <div class="user-info">
                        관리자님, 안녕하세요! | 오늘: <span id="current-date"></span>
                    </div>
                    <button class="logout-btn" onclick="logout()">로그아웃</button>
                </div>
            </div>

            <!-- 페이지별 컨텐츠 영역 -->
            <div id="content-area">
                <!-- 대시보드 기본 컨텐츠 -->
                <div id="dashboard-content" class="page-content">
                    <div class="dashboard-grid">
                        <div class="dashboard-card">
                            <div class="card-header">
                                <span class="icon">👥</span>
                                <h3 class="card-title">전체 사용자</h3>
                            </div>
                            <div class="card-content">
                                <div class="stat-number" id="total-users">-</div>
                                <div class="stat-label">등록된 사용자 수</div>
                            </div>
                        </div>
                        
                        <div class="dashboard-card">
                            <div class="card-header">
                                <span class="icon">🏢</span>
                                <h3 class="card-title">사업장</h3>
                            </div>
                            <div class="card-content">
                                <div class="stat-number" id="total-sites">-</div>
                                <div class="stat-label">관리 중인 사업장</div>
                            </div>
                        </div>
                        
                        <div class="dashboard-card">
                            <div class="card-header">
                                <span class="icon">📦</span>
                                <h3 class="card-title">식자재</h3>
                            </div>
                            <div class="card-content">
                                <div class="stat-number" id="total-ingredients">-</div>
                                <div class="stat-label">등록된 식자재</div>
                            </div>
                        </div>
                        
                        <div class="dashboard-card">
                            <div class="card-header">
                                <span class="icon">🚛</span>
                                <h3 class="card-title">협력업체</h3>
                            </div>
                            <div class="card-content">
                                <div class="stat-number" id="total-suppliers">-</div>
                                <div class="stat-label">등록된 협력업체</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 최근 활동 로그 -->
                    <div class="activity-log">
                        <h3 style="margin-bottom: 20px;">📈 최근 활동</h3>
                        <div id="activity-list">
                            <div class="log-item">
                                <div class="log-time">로딩 중...</div>
                                <div class="log-message">시스템 데이터를 불러오고 있습니다.</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 다른 페이지 컨텐츠들은 동적으로 로드 -->
                <div id="users-content" class="page-content" style="display: none;">
                    <!-- 사용자 관리 모듈이 여기에 로드됩니다 -->
                </div>
                
                <div id="suppliers-content" class="page-content" style="display: none;">
                    <!-- 협력업체 관리 모듈이 여기에 로드됩니다 -->
                </div>
                
                <div id="business-locations-content" class="page-content" style="display: none;">
                    <!-- 사업장 관리 모듈이 여기에 로드됩니다 -->
                </div>
                
                <div id="meal-pricing-content" class="page-content" style="display: none;">
                    <!-- 식단가 관리 모듈이 여기에 로드됩니다 -->
                </div>
                
                <div id="ingredients-content" class="page-content" style="display: none;">
                    <!-- 식자재 관리 모듈이 여기에 로드됩니다 -->
                </div>
            </div>
        </main>
    </div>

    <!-- 간단한 대시보드 스크립트 (모듈 시스템 제거) -->
    <script>
        const API_BASE = 'http://127.0.0.1:8006';
        let currentPage = 'dashboard';
        
        // 페이지 정보
        const pages = {
            'dashboard': '관리자 대시보드',
            'users': '사용자 관리',
            'suppliers': '협력업체 관리', 
            'business-locations': '사업장 관리',
            'meal-pricing': '식단가 관리',
            'ingredients': '식자재 관리'
        };

        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 식자재 관리 시스템 시작');
            
            // 날짜 표시
            updateDateTime();
            setInterval(updateDateTime, 1000);
            
            // 네비게이션 설정
            setupNavigation();
            
            // 대시보드 데이터 로드
            loadDashboardStats();
            loadRecentActivity();
        });

        function updateDateTime() {
            const currentDateElement = document.getElementById('current-date');
            if (currentDateElement) {
                const now = new Date();
                currentDateElement.textContent = now.toLocaleDateString('ko-KR', {
                    year: 'numeric',
                    month: 'long', 
                    day: 'numeric',
                    weekday: 'short'
                });
            }
        }

        function setupNavigation() {
            const navItems = document.querySelectorAll('.nav-item[data-page]');
            navItems.forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    const page = this.dataset.page;
                    if (page) {
                        loadPage(page);
                    }
                });
            });
        }

        function loadPage(pageName) {
            console.log(`📄 페이지 로드: ${pageName}`);
            
            // 네비게이션 활성화
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`[data-page="${pageName}"]`).classList.add('active');

            // 페이지 타이틀 업데이트
            document.getElementById('page-title').textContent = pages[pageName] || pageName;

            // 모든 페이지 숨기기
            document.querySelectorAll('.page-content').forEach(content => {
                content.style.display = 'none';
            });

            currentPage = pageName;

            // 해당 페이지 표시 및 데이터 로드
            switch(pageName) {
                case 'dashboard':
                    document.getElementById('dashboard-content').style.display = 'block';
                    loadDashboardStats();
                    loadRecentActivity();
                    break;
                case 'users':
                    document.getElementById('users-content').style.display = 'block';
                    loadUsersPage();
                    break;
                case 'suppliers':
                    document.getElementById('suppliers-content').style.display = 'block';
                    loadSuppliersPage();
                    break;
                case 'business-locations':
                    document.getElementById('business-locations-content').style.display = 'block';
                    loadBusinessLocationsPage();
                    break;
                case 'meal-pricing':
                    document.getElementById('meal-pricing-content').style.display = 'block';
                    loadMealPricingPage();
                    break;
                case 'ingredients':
                    document.getElementById('ingredients-content').style.display = 'block';
                    loadIngredientsPage();
                    break;
            }
        }

        async function loadDashboardStats() {
            try {
                console.log('📊 대시보드 통계 로딩...');
                const response = await fetch(`${API_BASE}/api/admin/dashboard-stats`);
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('total-users').textContent = data.totalUsers || 0;
                    document.getElementById('total-sites').textContent = data.totalSites || 0;
                    document.getElementById('total-ingredients').textContent = data.totalIngredients || 0;
                    document.getElementById('total-suppliers').textContent = data.totalSuppliers || 0;
                    console.log('✅ 대시보드 통계 로드 완료');
                } else {
                    throw new Error(data.error || '통계 데이터 로드 실패');
                }
            } catch (error) {
                console.error('❌ 대시보드 통계 로드 실패:', error);
                // 기본값 설정
                document.getElementById('total-users').textContent = '0';
                document.getElementById('total-sites').textContent = '0';
                document.getElementById('total-ingredients').textContent = '0';
                document.getElementById('total-suppliers').textContent = '0';
            }
        }

        async function loadRecentActivity() {
            try {
                const response = await fetch(`${API_BASE}/api/admin/recent-activity`);
                const data = await response.json();
                
                if (data.success && data.activities) {
                    const activityList = document.getElementById('activity-list');
                    activityList.innerHTML = data.activities.map(activity => `
                        <div class="log-item">
                            <div class="log-time">${activity.time}</div>
                            <div class="log-message">${activity.user} - ${activity.action}</div>
                        </div>
                    `).join('');
                } else {
                    // 기본 활동 표시
                    document.getElementById('activity-list').innerHTML = `
                        <div class="log-item">
                            <div class="log-time">방금 전</div>
                            <div class="log-message">관리자 - 시스템 시작</div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('최근 활동 로드 실패:', error);
            }
        }

        async function loadUsersPage() {
            const container = document.getElementById('users-content');
            container.innerHTML = '<div style="padding: 20px; text-align: center;">사용자 데이터 로딩 중...</div>';
            
            try {
                const response = await fetch(`${API_BASE}/api/admin/users`);
                const data = await response.json();
                
                if (data.success) {
                    container.innerHTML = `
                        <h2 style="margin-bottom: 20px;">👥 사용자 관리</h2>
                        <div style="overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                                <thead style="background: #f8f9fa;">
                                    <tr>
                                        <th style="padding: 15px; text-align: left; border-bottom: 1px solid #e1e5e9;">ID</th>
                                        <th style="padding: 15px; text-align: left; border-bottom: 1px solid #e1e5e9;">사용자명</th>
                                        <th style="padding: 15px; text-align: left; border-bottom: 1px solid #e1e5e9;">연락처</th>
                                        <th style="padding: 15px; text-align: left; border-bottom: 1px solid #e1e5e9;">역할</th>
                                        <th style="padding: 15px; text-align: left; border-bottom: 1px solid #e1e5e9;">상태</th>
                                        <th style="padding: 15px; text-align: left; border-bottom: 1px solid #e1e5e9;">등록일</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.users.map(user => `
                                        <tr style="border-bottom: 1px solid #f1f3f4;">
                                            <td style="padding: 15px;">${user.id}</td>
                                            <td style="padding: 15px; font-weight: 500;">${user.username || '-'}</td>
                                            <td style="padding: 15px;">${user.contact_info || '-'}</td>
                                            <td style="padding: 15px;">
                                                <span style="padding: 4px 8px; border-radius: 4px; font-size: 12px; background: ${user.role === 'admin' ? '#e3f2fd' : '#f3e5f5'}; color: ${user.role === 'admin' ? '#1976d2' : '#7b1fa2'};">
                                                    ${user.role || '-'}
                                                </span>
                                            </td>
                                            <td style="padding: 15px;">
                                                <span style="padding: 4px 8px; border-radius: 4px; font-size: 12px; background: ${user.is_active ? '#e8f5e8' : '#ffebee'}; color: ${user.is_active ? '#4caf50' : '#f44336'};">
                                                    ${user.is_active ? '활성' : '비활성'}
                                                </span>
                                            </td>
                                            <td style="padding: 15px; color: #666; font-size: 14px;">${user.created_at ? user.created_at.split(' ')[0] : '-'}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                        <p style="margin-top: 15px; color: #666; font-size: 14px;">총 ${data.users.length}명의 사용자가 등록되어 있습니다.</p>
                    `;
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                container.innerHTML = `<div style="padding: 20px; color: #f44336; text-align: center;">❌ 사용자 데이터 로드 실패: ${error.message}</div>`;
            }
        }

        async function loadSuppliersPage() {
            const container = document.getElementById('suppliers-content');
            container.innerHTML = '<div style="padding: 20px; text-align: center;">협력업체 데이터 로딩 중...</div>';
            
            try {
                const response = await fetch(`${API_BASE}/api/admin/suppliers/enhanced`);
                const data = await response.json();
                
                if (data.success) {
                    container.innerHTML = `
                        <h2 style="margin-bottom: 20px;">🚛 협력업체 관리</h2>
                        <div style="overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                                <thead style="background: #f8f9fa;">
                                    <tr>
                                        <th style="padding: 15px; text-align: left; border-bottom: 1px solid #e1e5e9;">업체명</th>
                                        <th style="padding: 15px; text-align: left; border-bottom: 1px solid #e1e5e9;">식자재 수</th>
                                        <th style="padding: 15px; text-align: left; border-bottom: 1px solid #e1e5e9;">평균 단가</th>
                                        <th style="padding: 15px; text-align: left; border-bottom: 1px solid #e1e5e9;">상태</th>
                                        <th style="padding: 15px; text-align: left; border-bottom: 1px solid #e1e5e9;">최종 업데이트</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.suppliers.map(supplier => `
                                        <tr style="border-bottom: 1px solid #f1f3f4;">
                                            <td style="padding: 15px; font-weight: 500;">${supplier.name}</td>
                                            <td style="padding: 15px;">${supplier.ingredient_count}개</td>
                                            <td style="padding: 15px;">${supplier.avg_price}원</td>
                                            <td style="padding: 15px;">
                                                <span style="padding: 4px 8px; border-radius: 4px; font-size: 12px; background: #e8f5e8; color: #4caf50;">
                                                    ${supplier.status}
                                                </span>
                                            </td>
                                            <td style="padding: 15px; color: #666; font-size: 14px;">${supplier.last_updated}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                        <p style="margin-top: 15px; color: #666; font-size: 14px;">총 ${data.suppliers.length}개의 협력업체가 등록되어 있습니다.</p>
                    `;
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                container.innerHTML = `<div style="padding: 20px; color: #f44336; text-align: center;">❌ 협력업체 데이터 로드 실패: ${error.message}</div>`;
            }
        }

        async function loadBusinessLocationsPage() {
            const container = document.getElementById('business-locations-content');
            container.innerHTML = '<div style="padding: 20px; text-align: center;">사업장 데이터 로딩 중...</div>';
            
            try {
                const response = await fetch(`${API_BASE}/api/admin/sites`);
                const data = await response.json();
                
                if (data.success) {
                    container.innerHTML = `
                        <h2 style="margin-bottom: 20px;">🏢 사업장 관리</h2>
                        <div style="overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                                <thead style="background: #f8f9fa;">
                                    <tr>
                                        <th style="padding: 15px; text-align: left; border-bottom: 1px solid #e1e5e9;">ID</th>
                                        <th style="padding: 15px; text-align: left; border-bottom: 1px solid #e1e5e9;">사업장명</th>
                                        <th style="padding: 15px; text-align: left; border-bottom: 1px solid #e1e5e9;">타입</th>
                                        <th style="padding: 15px; text-align: left; border-bottom: 1px solid #e1e5e9;">주소</th>
                                        <th style="padding: 15px; text-align: left; border-bottom: 1px solid #e1e5e9;">연락처</th>
                                        <th style="padding: 15px; text-align: left; border-bottom: 1px solid #e1e5e9;">상태</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.sites.map(site => `
                                        <tr style="border-bottom: 1px solid #f1f3f4;">
                                            <td style="padding: 15px;">${site.id}</td>
                                            <td style="padding: 15px; font-weight: 500;">${site.name}</td>
                                            <td style="padding: 15px;">${site.type}</td>
                                            <td style="padding: 15px;">${site.address || '-'}</td>
                                            <td style="padding: 15px;">${site.contact_info || '-'}</td>
                                            <td style="padding: 15px;">
                                                <span style="padding: 4px 8px; border-radius: 4px; font-size: 12px; background: #e8f5e8; color: #4caf50;">
                                                    ${site.status}
                                                </span>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                        <p style="margin-top: 15px; color: #666; font-size: 14px;">총 ${data.sites.length}개의 사업장이 등록되어 있습니다.</p>
                    `;
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                container.innerHTML = `<div style="padding: 20px; color: #f44336; text-align: center;">❌ 사업장 데이터 로드 실패: ${error.message}</div>`;
            }
        }

        function loadMealPricingPage() {
            const container = document.getElementById('meal-pricing-content');
            container.innerHTML = `
                <h2 style="margin-bottom: 20px;">💰 식단가 관리</h2>
                <div style="padding: 40px; text-align: center; background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                    <h3 style="color: #667eea; margin-bottom: 15px;">🚧 준비 중인 기능</h3>
                    <p style="color: #666; line-height: 1.6;">
                        식단가 관리 기능을 준비 중입니다.<br>
                        곧 다양한 식단 가격 관리 기능을 만나보실 수 있습니다.
                    </p>
                </div>
            `;
        }

        async function loadIngredientsPage() {
            const container = document.getElementById('ingredients-content');
            container.innerHTML = '<div style="padding: 20px; text-align: center;">식자재 데이터 로딩 중...</div>';
            
            try {
                const response = await fetch(`${API_BASE}/api/admin/ingredients-new?limit=20`);
                const data = await response.json();
                
                if (data.success) {
                    container.innerHTML = `
                        <h2 style="margin-bottom: 20px;">📦 식자재 관리</h2>
                        <div style="overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                                <thead style="background: #f8f9fa;">
                                    <tr>
                                        <th style="padding: 15px; text-align: left; border-bottom: 1px solid #e1e5e9;">ID</th>
                                        <th style="padding: 15px; text-align: left; border-bottom: 1px solid #e1e5e9;">식자재명</th>
                                        <th style="padding: 15px; text-align: left; border-bottom: 1px solid #e1e5e9;">카테고리</th>
                                        <th style="padding: 15px; text-align: left; border-bottom: 1px solid #e1e5e9;">공급업체</th>
                                        <th style="padding: 15px; text-align: left; border-bottom: 1px solid #e1e5e9;">구매가</th>
                                        <th style="padding: 15px; text-align: left; border-bottom: 1px solid #e1e5e9;">판매가</th>
                                        <th style="padding: 15px; text-align: left; border-bottom: 1px solid #e1e5e9;">단위</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.ingredients.map(ingredient => `
                                        <tr style="border-bottom: 1px solid #f1f3f4;">
                                            <td style="padding: 15px;">${ingredient.id}</td>
                                            <td style="padding: 15px; font-weight: 500;">${ingredient.name}</td>
                                            <td style="padding: 15px;">${ingredient.category}</td>
                                            <td style="padding: 15px;">${ingredient.supplier}</td>
                                            <td style="padding: 15px; color: #1976d2;">${ingredient.purchase_price}원</td>
                                            <td style="padding: 15px; color: #388e3c;">${ingredient.selling_price}원</td>
                                            <td style="padding: 15px;">${ingredient.unit}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                        <p style="margin-top: 15px; color: #666; font-size: 14px;">
                            처음 ${data.ingredients.length}개 항목을 표시합니다. 
                            <span style="font-weight: 500;">전체 ${data.pagination ? data.pagination.total_items : 'N/A'}개 항목</span>
                        </p>
                    `;
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                container.innerHTML = `<div style="padding: 20px; color: #f44336; text-align: center;">❌ 식자재 데이터 로드 실패: ${error.message}</div>`;
            }
        }

        function logout() {
            if (confirm('로그아웃하시겠습니까?')) {
                console.log('🚪 로그아웃');
                window.location.href = '/';
            }
        }

        console.log('🎉 식자재 관리 시스템 초기화 완료');
    </script>
</body>
</html>