<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>테스트푸드 식자재 등록</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
            color: #333;
            line-height: 1.2;
            font-size: 12px;
        }
        
        .container {
            max-width: 100%;
            margin: 0;
            padding: 10px;
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }
        
        .header p {
            font-size: 14px;
            opacity: 0.9;
        }
        
        /* 업로드 섹션 */
        .upload-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .upload-notice {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .upload-notice h3 {
            color: #856404;
            font-size: 16px;
            margin-bottom: 10px;
        }
        
        .upload-notice ul {
            color: #856404;
            margin-left: 20px;
        }
        
        .upload-notice li {
            margin-bottom: 5px;
            font-size: 13px;
        }
        
        .upload-area {
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            background: #f8f9fa;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .upload-area:hover {
            border-color: #3498db;
            background: #e3f2fd;
        }
        
        .upload-area.dragover {
            border-color: #2980b9;
            background: #bbdefb;
        }
        
        .upload-area i {
            font-size: 48px;
            color: #6c757d;
            margin-bottom: 15px;
        }
        
        .upload-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        .btn-primary {
            background: #3498db;
            color: white;
        }
        
        .btn-primary:hover {
            background: #2980b9;
        }
        
        .btn-success {
            background: #27ae60;
            color: white;
        }
        
        .btn-success:hover {
            background: #229954;
        }
        
        .btn-warning {
            background: #f39c12;
            color: white;
        }
        
        .btn-warning:hover {
            background: #e67e22;
        }
        
        /* 테이블 스타일 - 엑셀 같은 형태 */
        .table-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden;
            margin-bottom: 20px;
        }
        
        .table-header {
            background: #ecf0f1;
            padding: 15px 20px;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .table-header h2 {
            font-size: 18px;
            color: #2c3e50;
        }
        
        .table-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .search-box {
            padding: 6px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
            width: 200px;
        }
        
        .ingredients-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 9px;
            background: white;
            table-layout: fixed;
        }
        
        .ingredients-table th {
            background: #34495e;
            color: white;
            padding: 5px 2px;
            text-align: center;
            border: 1px solid #2c3e50;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 10;
            font-size: 8px;
            white-space: nowrap;
        }
        
        .ingredients-table td {
            padding: 2px;
            border: 1px solid #dee2e6;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 8px;
        }
        
        .ingredients-table tbody tr {
            transition: background-color 0.2s ease;
        }
        
        .ingredients-table tbody tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        
        .ingredients-table tbody tr:hover {
            background-color: #e3f2fd;
            cursor: pointer;
        }
        
        /* 특정 컬럼 너비 조정 - 모든 내용이 한줄에 보이도록 */
        .col-category { width: 6%; }
        .col-subcategory { width: 8%; }
        .col-code { width: 7%; }
        .col-name { width: 12%; text-align: left; }
        .col-origin { width: 5%; }
        .col-posting { width: 5%; }
        .col-spec { width: 10%; text-align: left; }
        .col-unit { width: 4%; }
        .col-tax { width: 4%; }
        .col-delivery { width: 5%; }
        .col-price { width: 7%; text-align: right; }
        .col-supplier { width: 10%; text-align: left; }
        .col-notes { width: 10%; text-align: left; }
        .col-date { width: 7%; font-size: 8px; }
        
        /* 페이지네이션 */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 5px;
            margin-top: 20px;
        }
        
        .pagination button {
            padding: 5px 10px;
            border: 1px solid #dee2e6;
            background: white;
            cursor: pointer;
            border-radius: 3px;
            font-size: 12px;
        }
        
        .pagination button:hover {
            background: #e9ecef;
        }
        
        .pagination button.active {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }
        
        .pagination button:disabled {
            cursor: not-allowed;
            opacity: 0.5;
        }
        
        /* 통계 정보 - 작은 박스 8개 이상 */
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .stat-card {
            background: white;
            border-radius: 6px;
            padding: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-left: 3px solid #3498db;
        }
        
        .stat-card h4 {
            font-size: 12px;
            color: #2c3e50;
            margin-bottom: 3px;
            font-weight: bold;
        }
        
        .stat-card .stat-value {
            font-size: 16px;
            color: #3498db;
            font-weight: bold;
            margin-bottom: 2px;
        }
        
        .stat-card .stat-date {
            color: #7f8c8d;
            font-size: 10px;
        }
        
        /* 로딩 */
        .loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }
        
        .loading i {
            font-size: 24px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* 테이블 스크롤 */
        .table-scroll {
            overflow-x: auto;
            overflow-y: auto;
            max-height: 70vh;
        }
        
        /* 반응형 */
        @media (max-width: 768px) {
            .container {
                padding: 5px;
            }
            
            .ingredients-table th,
            .ingredients-table td {
                font-size: 9px;
                padding: 2px;
            }
            
            .upload-section {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-leaf"></i> 테스트푸드 식자재 등록</h1>
            <p>Excel 파일을 통한 식자재 대량 등록</p>
        </div>

        <!-- 통계 정보 -->
        <div class="stats-container" id="supplierStats">
            <!-- 동적으로 생성됨 -->
        </div>

        <!-- 업로드 섹션 이동 -->
        <div class="upload-section">
            <div class="upload-notice">
                <h3><i class="fas fa-exclamation-triangle"></i> 엑셀파일 업로드 주의사항!</h3>
                <ul>
                    <li><strong>필수 컬럼:</strong> 분류, 기본식자재, 고유코드, 식자재명, 단위, 선발주일, 입고가, 판매가, 거래처명</li>
                    <li><strong>파일 형식:</strong> .xlsx 또는 .xls 파일만 업로드 가능</li>
                    <li><strong>최대 용량:</strong> 한 번에 최대 20,000행까지 처리 가능</li>
                    <li><strong>데이터 형식:</strong> 입고가/판매가는 숫자, 선발주일은 D-1, D-2 형태 또는 숫자</li>
                    <li><strong>중복 처리:</strong> 고유코드가 같으면 기존 데이터 업데이트, 없으면 신규 생성</li>
                    <li><strong>오류 처리:</strong> 필수 데이터 누락시 오류 파일로 별도 다운로드 가능</li>
                </ul>
            </div>
            
            <div class="upload-area" id="uploadArea">
                <i class="fas fa-cloud-upload-alt"></i>
                <h3>Excel 파일을 여기로 드래그하거나 클릭하여 업로드</h3>
                <p>지원 형식: .xlsx, .xls</p>
                <input type="file" id="fileInput" accept=".xlsx,.xls" style="display: none;">
            </div>
            
            <div class="upload-buttons">
                <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
                    <i class="fas fa-file-upload"></i> 파일 선택
                </button>
                <button class="btn btn-success" id="uploadBtn" style="display: none;">
                    <i class="fas fa-upload"></i> 업로드 시작
                </button>
                <button class="btn btn-warning" id="downloadErrorBtn" style="display: none;">
                    <i class="fas fa-download"></i> 오류 파일 다운로드
                </button>
            </div>
            
            <div id="uploadProgress" style="display: none; margin-top: 15px;">
                <div style="background: #e9ecef; height: 20px; border-radius: 10px; overflow: hidden;">
                    <div id="progressBar" style="background: #28a745; height: 100%; width: 0%; transition: width 0.3s ease;"></div>
                </div>
                <div id="progressText" style="text-align: center; margin-top: 5px; font-size: 12px;"></div>
            </div>
        </div>

        <!-- 테이블 섹션 -->
        <div class="table-container">
            <div class="table-header">
                <h2><i class="fas fa-table"></i> 등록된 식자재 목록</h2>
                <div class="table-controls">
                    <input type="text" class="search-box" id="searchInput" placeholder="식자재명 또는 고유코드 검색...">
                    <select id="categoryFilter" class="search-box" style="width: 150px;">
                        <option value="">전체 분류</option>
                    </select>
                    <button class="btn btn-primary" onclick="loadIngredients()">
                        <i class="fas fa-sync"></i> 새로고침
                    </button>
                </div>
            </div>
            
            <div class="table-scroll">
                <table class="ingredients-table" id="ingredientsTable">
                    <thead>
                        <tr>
                            <th class="col-category">분류</th>
                            <th class="col-subcategory">기본식자재</th>
                            <th class="col-code">고유코드</th>
                            <th class="col-name">식자재명</th>
                            <th class="col-origin">원산지</th>
                            <th class="col-posting">게시유무</th>
                            <th class="col-spec">규격</th>
                            <th class="col-unit">단위</th>
                            <th class="col-tax">면세</th>
                            <th class="col-delivery">선발주일</th>
                            <th class="col-price">입고가</th>
                            <th class="col-price">판매가</th>
                            <th class="col-supplier">거래처명</th>
                            <th class="col-notes">비고</th>
                            <th class="col-date">등록일</th>
                        </tr>
                    </thead>
                    <tbody id="ingredientsTableBody">
                        <tr>
                            <td colspan="15" class="loading">
                                <i class="fas fa-spinner"></i><br>
                                데이터를 불러오는 중...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <div class="pagination" id="pagination">
                <!-- 페이지네이션 버튼들이 여기에 동적으로 생성됩니다 -->
            </div>
        </div>
    </div>

    <script>
        // 전역 변수
        let currentPage = 1;
        let totalPages = 1;
        let selectedFile = null;
        let lastUploadId = null;

        // 페이지 로드시 초기화
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            loadIngredients();
            loadStatistics();
            loadCategories();
        });

        // 이벤트 리스너 설정
        function setupEventListeners() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');
            const uploadBtn = document.getElementById('uploadBtn');
            const searchInput = document.getElementById('searchInput');
            const categoryFilter = document.getElementById('categoryFilter');

            // 파일 드래그 앤 드롭
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFileSelect(files[0]);
                }
            });

            uploadArea.addEventListener('click', () => {
                fileInput.click();
            });

            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleFileSelect(e.target.files[0]);
                }
            });

            uploadBtn.addEventListener('click', uploadFile);

            // 검색 및 필터
            searchInput.addEventListener('keyup', debounce(loadIngredients, 500));
            categoryFilter.addEventListener('change', loadIngredients);
        }

        // 파일 선택 처리
        function handleFileSelect(file) {
            if (!file.name.match(/\.(xlsx|xls)$/)) {
                alert('Excel 파일만 업로드 가능합니다. (.xlsx, .xls)');
                return;
            }

            selectedFile = file;
            document.getElementById('uploadBtn').style.display = 'inline-flex';
            
            const uploadArea = document.getElementById('uploadArea');
            uploadArea.innerHTML = `
                <i class="fas fa-file-excel"></i>
                <h3>선택된 파일: ${file.name}</h3>
                <p>크기: ${(file.size / 1024 / 1024).toFixed(2)} MB</p>
            `;
        }

        // 파일 업로드
        async function uploadFile() {
            if (!selectedFile) {
                alert('파일을 선택해주세요.');
                return;
            }

            const formData = new FormData();
            formData.append('file', selectedFile);

            const uploadBtn = document.getElementById('uploadBtn');
            const progressDiv = document.getElementById('uploadProgress');
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');

            uploadBtn.disabled = true;
            progressDiv.style.display = 'block';
            progressText.textContent = '업로드 중...';

            try {
                const response = await fetch('/api/admin/upload-ingredients', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    progressBar.style.width = '100%';
                    progressText.innerHTML = `
                        ✅ 업로드 완료!<br>
                        총 ${result.data.total_rows}행 처리 | 
                        성공: ${result.data.processed_count}개 | 
                        오류: ${result.data.error_count}개
                    `;

                    if (result.data.error_count > 0) {
                        document.getElementById('downloadErrorBtn').style.display = 'inline-flex';
                        lastUploadId = result.data.upload_id;
                    }

                    // 테이블 새로고침
                    setTimeout(() => {
                        loadIngredients();
                        loadStatistics();
                    }, 2000);
                } else {
                    progressText.textContent = `❌ 업로드 실패: ${result.message}`;
                }
            } catch (error) {
                progressText.textContent = `❌ 업로드 오류: ${error.message}`;
            } finally {
                uploadBtn.disabled = false;
            }
        }

        // 식자재 목록 로드
        async function loadIngredients() {
            const search = document.getElementById('searchInput').value;
            const category = document.getElementById('categoryFilter').value;
            
            try {
                let url = `/api/admin/ingredients?page=${currentPage}&limit=100`;
                if (search) url += `&search=${encodeURIComponent(search)}`;
                if (category) url += `&category=${encodeURIComponent(category)}`;

                const response = await fetch(url);
                const data = await response.json();

                if (data.success) {
                    displayIngredients(data.ingredients || []);
                    updatePagination(data.currentPage || 1, data.totalPages || 1);
                }
            } catch (error) {
                console.error('데이터 로드 오류:', error);
                document.getElementById('ingredientsTableBody').innerHTML = 
                    '<tr><td colspan="15">데이터를 불러올 수 없습니다.</td></tr>';
            }
        }

        // 식자재 표시
        function displayIngredients(ingredients) {
            const tbody = document.getElementById('ingredientsTableBody');
            
            if (ingredients.length === 0) {
                tbody.innerHTML = '<tr><td colspan="15">등록된 식자재가 없습니다.</td></tr>';
                return;
            }

            tbody.innerHTML = ingredients.map(ingredient => `
                <tr onclick="editIngredient(${ingredient.id})">
                    <td class="col-category">${ingredient['분류(대분류)'] || ingredient.category || ''}</td>
                    <td class="col-subcategory">${ingredient['기본식자재(세분류)'] || ingredient.sub_category || ''}</td>
                    <td class="col-code">${ingredient['고유코드'] || ingredient.ingredient_code || ''}</td>
                    <td class="col-name" title="${ingredient['식자재명'] || ingredient.ingredient_name || ''}">${ingredient['식자재명'] || ingredient.ingredient_name || ''}</td>
                    <td class="col-origin">${ingredient['원산지'] || ingredient.origin || ''}</td>
                    <td class="col-posting">${ingredient['게시유무'] || ingredient.posting_status || ''}</td>
                    <td class="col-spec" title="${ingredient['규격'] || ingredient.specification || ''}">${ingredient['규격'] || ingredient.specification || ''}</td>
                    <td class="col-unit">${ingredient['단위'] || ingredient.unit || ''}</td>
                    <td class="col-tax">${ingredient['면세'] || ingredient.tax_type || ''}</td>
                    <td class="col-delivery">${ingredient['선발주일'] || ingredient.delivery_days || ''}</td>
                    <td class="col-price">${ingredient['입고가'] || ingredient.purchase_price ? Number(ingredient['입고가'] || ingredient.purchase_price).toLocaleString() : ''}</td>
                    <td class="col-price">${ingredient['판매가'] || ingredient.selling_price ? Number(ingredient['판매가'] || ingredient.selling_price).toLocaleString() : ''}</td>
                    <td class="col-supplier" title="${ingredient['거래처명'] || ingredient.supplier_name || ''}">${ingredient['거래처명'] || ingredient.supplier_name || ''}</td>
                    <td class="col-notes" title="${ingredient['비고'] || ingredient.notes || ''}">${ingredient['비고'] || ingredient.notes || ''}</td>
                    <td class="col-date">${ingredient['등록일'] || (ingredient.created_at ? new Date(ingredient.created_at).toLocaleDateString('ko-KR') : '')}</td>
                </tr>
            `).join('');
        }

        // 페이지네이션 업데이트
        function updatePagination(current, total) {
            currentPage = current;
            totalPages = total;
            
            const pagination = document.getElementById('pagination');
            let paginationHTML = '';

            // 이전 버튼
            paginationHTML += `<button onclick="changePage(${current - 1})" ${current <= 1 ? 'disabled' : ''}><i class="fas fa-chevron-left"></i></button>`;

            // 페이지 번호들
            const startPage = Math.max(1, current - 2);
            const endPage = Math.min(total, current + 2);

            if (startPage > 1) {
                paginationHTML += `<button onclick="changePage(1)">1</button>`;
                if (startPage > 2) paginationHTML += `<span>...</span>`;
            }

            for (let i = startPage; i <= endPage; i++) {
                paginationHTML += `<button onclick="changePage(${i})" ${i === current ? 'class="active"' : ''}>${i}</button>`;
            }

            if (endPage < total) {
                if (endPage < total - 1) paginationHTML += `<span>...</span>`;
                paginationHTML += `<button onclick="changePage(${total})">${total}</button>`;
            }

            // 다음 버튼
            paginationHTML += `<button onclick="changePage(${current + 1})" ${current >= total ? 'disabled' : ''}><i class="fas fa-chevron-right"></i></button>`;

            pagination.innerHTML = paginationHTML;
        }

        // 페이지 변경
        function changePage(page) {
            if (page >= 1 && page <= totalPages) {
                currentPage = page;
                loadIngredients();
            }
        }

        // 통계 로드
        async function loadStatistics() {
            try {
                const response = await fetch('/api/admin/ingredients?page=1&limit=10000');
                const data = await response.json();

                if (data.success && data.ingredients) {
                    // 업체별 통계 계산
                    const supplierMap = {};
                    data.ingredients.forEach(item => {
                        const supplier = item['거래처명'] || item.supplier_name || '미지정';
                        if (!supplierMap[supplier]) {
                            supplierMap[supplier] = {
                                count: 0,
                                lastDate: null
                            };
                        }
                        supplierMap[supplier].count++;
                        
                        const date = item['등록일'] || item.created_at;
                        if (date && (!supplierMap[supplier].lastDate || new Date(date) > new Date(supplierMap[supplier].lastDate))) {
                            supplierMap[supplier].lastDate = date;
                        }
                    });

                    // 통계 박스 생성
                    const statsContainer = document.getElementById('supplierStats');
                    statsContainer.innerHTML = '';
                    
                    Object.entries(supplierMap).slice(0, 8).forEach(([name, stats]) => {
                        const statCard = document.createElement('div');
                        statCard.className = 'stat-card';
                        
                        const dateStr = stats.lastDate ? 
                            new Date(stats.lastDate).toLocaleDateString('ko-KR', {month: 'numeric', day: 'numeric'}) : 
                            '-';
                        
                        statCard.innerHTML = `
                            <h4>${name}</h4>
                            <div class="stat-value">${stats.count.toLocaleString()}개</div>
                            <div class="stat-date">등록: ${dateStr}</div>
                        `;
                        statsContainer.appendChild(statCard);
                    });
                }
            } catch (error) {
                console.error('통계 로드 오류:', error);
            }
        }

        // 카테고리 로드
        async function loadCategories() {
            try {
                const response = await fetch('/api/admin/ingredients?page=1&limit=1000');
                const data = await response.json();

                if (data.success) {
                    const categories = [...new Set(data.ingredients.map(item => item.category).filter(Boolean))];
                    const categoryFilter = document.getElementById('categoryFilter');
                    
                    categoryFilter.innerHTML = '<option value="">전체 분류</option>' +
                        categories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
                }
            } catch (error) {
                console.error('카테고리 로드 오류:', error);
            }
        }

        // 식자재 편집 (클릭시)
        function editIngredient(id) {
            alert(`식자재 ID ${id} 편집 기능은 추후 구현됩니다.`);
        }

        // 디바운스 함수
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
    </script>
</body>
</html>