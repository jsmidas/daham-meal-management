<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>식자재 관리 시스템 - 관리자 대시보드</title>

    <!-- 외부 CSS -->
    <link rel="stylesheet" href="static/css/admin-dashboard-main.css">

    <!-- 페이지별 콘텐츠 가시성 보장 CSS -->
    <style>
        /* 중요: 모든 페이지 콘텐츠는 기본적으로 숨김 */
        .page-content {
            display: none !important;
        }

        /* 활성화된 페이지만 표시 */
        .page-content.active {
            display: block !important;
        }

        /* 대시보드는 초기에 활성화 */
        #dashboard-content {
            display: block !important;
        }

        /* ModuleLoader 에러 시 폴백 스타일 */
        .module-loading {
            padding: 20px;
            text-align: center;
            color: #6c757d;
        }

        .module-error {
            padding: 20px;
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 5px;
            color: #856404;
            margin: 20px;
        }
    </style>
</head>
<body>
    <!-- 메인 컨테이너 -->
    <div class="admin-container">
        <!-- 사이드바 -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <h2>🍽️ 식자재 관리</h2>
                <p>관리자 시스템</p>
            </div>

            <div class="nav-menu">
                <a href="#" class="nav-item active" data-page="dashboard">
                    <span class="icon">📊</span>대시보드
                </a>
                <a href="#" class="nav-item" data-page="users">
                    <span class="icon">👥</span>사용자 관리
                </a>
                <a href="#" class="nav-item" data-page="suppliers">
                    <span class="icon">🚛</span>협력업체 관리
                </a>
                <a href="#" class="nav-item" data-page="business-locations">
                    <span class="icon">🏢</span>사업장 관리
                </a>
                <a href="#" class="nav-item" data-page="meal-pricing">
                    <span class="icon">💰</span>식단가 관리
                </a>
                <a href="#" class="nav-item" data-page="ingredients">
                    <span class="icon">📦</span>식자재 관리
                </a>
            </div>

            <div class="sidebar-footer" style="margin-top: auto; padding: 20px;">
                <div style="border-top: 1px solid rgba(255,255,255,0.2); padding-top: 20px;">
                    <a href="/" class="nav-item" style="background: #e8f5e8; color: #4caf50;">
                        <span class="icon">🍽️</span>급식관리로 이동
                    </a>
                </div>
            </div>
        </nav>

        <!-- 메인 컨텐츠 -->
        <main class="main-content">
            <!-- 헤더 -->
            <div class="header">
                <h1 id="page-title">관리자 대시보드</h1>
                <div class="header-info">
                    <div class="user-info">
                        관리자님, 안녕하세요! | 오늘: <span id="current-date"></span>
                    </div>
                    <button class="logout-btn" onclick="logout()">로그아웃</button>
                </div>
            </div>

            <!-- 페이지별 컨텐츠 영역 -->
            <div id="content-area">
                <!-- 대시보드 기본 컨텐츠 -->
                <div id="dashboard-content" class="page-content active">
                    <div class="dashboard-grid">
                        <div class="dashboard-card">
                            <div class="card-header">
                                <span class="icon">👥</span>
                                <h3 class="card-title">전체 사용자</h3>
                            </div>
                            <div class="card-content">
                                <div class="stat-number" id="total-users">-</div>
                                <div class="stat-label">등록된 사용자 수</div>
                            </div>
                        </div>

                        <div class="dashboard-card">
                            <div class="card-header">
                                <span class="icon">🏢</span>
                                <h3 class="card-title">사업장</h3>
                            </div>
                            <div class="card-content">
                                <div class="stat-number" id="total-sites">-</div>
                                <div class="stat-label">관리 중인 사업장</div>
                            </div>
                        </div>

                        <div class="dashboard-card">
                            <div class="card-header">
                                <span class="icon">📦</span>
                                <h3 class="card-title">식자재</h3>
                            </div>
                            <div class="card-content">
                                <div class="stat-number" id="total-ingredients">84,215</div>
                                <div class="stat-label">등록된 식자재</div>
                            </div>
                        </div>

                        <div class="dashboard-card">
                            <div class="card-header">
                                <span class="icon">🚛</span>
                                <h3 class="card-title">협력업체</h3>
                            </div>
                            <div class="card-content">
                                <div class="stat-number" id="total-suppliers">5</div>
                                <div class="stat-label">등록된 협력업체</div>
                            </div>
                        </div>
                    </div>

                    <!-- 최근 활동 로그 -->
                    <div class="activity-log">
                        <h3 style="margin-bottom: 20px;">📈 최근 활동</h3>
                        <div id="activity-list">
                            <div class="log-item">
                                <div class="log-time">방금 전</div>
                                <div class="log-message">시스템이 정상적으로 시작되었습니다.</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 사용자 관리 페이지 -->
                <div id="users-content" class="page-content">
                    <div class="content-wrapper">
                        <div class="module-loading">사용자 관리 모듈을 로딩 중...</div>
                    </div>
                </div>

                <!-- 협력업체 관리 페이지 -->
                <div id="suppliers-content" class="page-content">
                    <div class="content-wrapper">
                        <div class="module-loading">협력업체 관리 모듈을 로딩 중...</div>
                    </div>
                </div>

                <!-- 사업장 관리 페이지 -->
                <div id="business-locations-content" class="page-content">
                    <div class="content-wrapper">
                        <div class="module-loading">사업장 관리 모듈을 로딩 중...</div>
                    </div>
                </div>

                <!-- 식단가 관리 페이지 -->
                <div id="meal-pricing-content" class="page-content">
                    <div class="content-wrapper">
                        <div class="module-loading">식단가 관리 모듈을 로딩 중...</div>
                    </div>
                </div>

                <!-- 식자재 관리 페이지 -->
                <div id="ingredients-content" class="page-content">
                    <div class="content-wrapper">
                        <div class="module-loading">식자재 관리 모듈을 로딩 중...</div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- CONFIG 설정 (가장 먼저 로드) -->
    <script src="config.js"></script>

    <!-- 🚀 안정적인 시스템 초기화 -->
    <script>
        // 전역 상태 관리
        window.AppState = {
            currentPage: 'dashboard',
            modules: {},
            initialized: false,
            moduleLoader: null
        };

        // 스크립트 동적 로드 헬퍼
        function loadScript(src) {
            return new Promise((resolve, reject) => {
                // 이미 로드된 스크립트 확인
                if (document.querySelector(`script[src="${src}"]`)) {
                    console.log(`✅ ${src} 이미 로드됨`);
                    resolve();
                    return;
                }

                const script = document.createElement('script');
                script.src = src;
                script.onload = () => {
                    console.log(`✅ ${src} 로드 완료`);
                    resolve();
                };
                script.onerror = () => {
                    console.error(`❌ ${src} 로드 실패`);
                    reject(new Error(`Failed to load ${src}`));
                };
                document.head.appendChild(script);
            });
        }

        // ModuleLoader 안전 로드 (옵션)
        async function tryLoadModuleLoader() {
            try {
                await loadScript('static/utils/module-loader.js');

                // ModuleLoader 사용 가능 확인
                if (window.ModuleLoader) {
                    window.AppState.moduleLoader = window.ModuleLoader;
                    console.log('✅ ModuleLoader 시스템 활성화');
                    return true;
                }
            } catch (error) {
                console.warn('⚠️ ModuleLoader 로드 실패, 폴백 모드 사용:', error);
            }
            return false;
        }

        // 모듈 로드 (ModuleLoader 또는 직접 로드)
        async function loadModule(moduleInfo) {
            try {
                // ModuleLoader 사용 가능한 경우
                if (window.AppState.moduleLoader && moduleInfo.loaderName) {
                    console.log(`📦 ModuleLoader로 ${moduleInfo.loaderName} 로딩...`);
                    try {
                        const module = await window.AppState.moduleLoader.loadModule(moduleInfo.loaderName);
                        window.AppState.modules[moduleInfo.name] = module;
                        return module;
                    } catch (loaderError) {
                        console.warn(`⚠️ ModuleLoader 실패, 직접 로드 시도:`, loaderError);
                    }
                }

                // 직접 로드 폴백
                console.log(`📦 직접 로드: ${moduleInfo.name} (${moduleInfo.path})`);
                await loadScript(moduleInfo.path);

                // 전역 객체 확인 (잠시 대기)
                await new Promise(resolve => setTimeout(resolve, 100));

                if (moduleInfo.global && window[moduleInfo.global]) {
                    window.AppState.modules[moduleInfo.name] = window[moduleInfo.global];

                    // 모듈 초기화
                    if (typeof window[moduleInfo.global].init === 'function') {
                        await window[moduleInfo.global].init();
                    }

                    return window[moduleInfo.global];
                }

                console.log(`✅ ${moduleInfo.name} 로드 완료`);
                return true;

            } catch (error) {
                console.error(`❌ ${moduleInfo.name} 로드 실패:`, error);
                throw error;
            }
        }

        // 페이지별 모듈 매핑
        const MODULE_MAP = {
            'users': {
                name: 'users',
                path: 'static/modules/users/users-complete.js',
                global: 'UsersModule',
                loaderName: 'users'  // ModuleLoader에서 사용할 이름
            },
            'suppliers': {
                name: 'suppliers',
                path: 'static/modules/suppliers/suppliers.js',
                global: 'SupplierManagement',
                loaderName: 'suppliers'
            },
            'business-locations': {
                name: 'sites',
                path: 'static/modules/sites/sites-complete.js',
                global: 'SitesModule',
                loaderName: 'sites'  // ModuleLoader는 'sites'로 인식
            },
            'meal-pricing': {
                name: 'meal-pricing',
                path: 'static/modules/meal-pricing/meal-pricing.js',
                global: 'MealPricingManagement',
                loaderName: 'meal-pricing'
            },
            'ingredients': {
                name: 'ingredients',
                path: 'static/modules/ingredients/ingredients.js',
                global: 'IngredientManagement',
                loaderName: 'ingredients'
            }
        };

        // 페이지 전환
        async function switchToPage(pageName) {
            console.log(`🔄 페이지 전환: ${pageName}`);

            // 네비게이션 상태 업데이트
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });

            const activeNavItem = document.querySelector(`[data-page="${pageName}"]`);
            if (activeNavItem) {
                activeNavItem.classList.add('active');
            }

            // 페이지 제목 업데이트
            const titles = {
                'dashboard': '관리자 대시보드',
                'users': '사용자 관리',
                'suppliers': '협력업체 관리',
                'business-locations': '사업장 관리',
                'meal-pricing': '식단가 관리',
                'ingredients': '식자재 관리'
            };

            document.getElementById('page-title').textContent = titles[pageName] || '관리자 대시보드';

            // 모든 콘텐츠 숨김
            document.querySelectorAll('.page-content').forEach(content => {
                content.classList.remove('active');
            });

            // 대상 콘텐츠 표시
            const targetContent = document.getElementById(`${pageName}-content`);
            if (targetContent) {
                targetContent.classList.add('active');

                // 대시보드가 아닌 경우 모듈 로드
                if (pageName !== 'dashboard' && MODULE_MAP[pageName]) {
                    const moduleInfo = MODULE_MAP[pageName];

                    // 이미 로드된 모듈 확인
                    if (!window.AppState.modules[moduleInfo.name]) {
                        const contentWrapper = targetContent.querySelector('.content-wrapper');
                        if (contentWrapper) {
                            try {
                                contentWrapper.innerHTML = '<div class="module-loading">모듈을 로딩 중입니다...</div>';
                                await loadModule(moduleInfo);

                                // 모듈 로드 성공 후 콘텐츠 업데이트
                                if (window[moduleInfo.global]) {
                                    if (typeof window[moduleInfo.global].getHTML === 'function') {
                                        contentWrapper.innerHTML = window[moduleInfo.global].getHTML();
                                    } else {
                                        // 기본 콘텐츠 템플릿
                                        contentWrapper.innerHTML = getDefaultContent(pageName, titles[pageName]);
                                    }

                                    // 모듈 특정 초기화 실행
                                    if (typeof window[moduleInfo.global].onPageLoad === 'function') {
                                        await window[moduleInfo.global].onPageLoad();
                                    }
                                }
                            } catch (error) {
                                contentWrapper.innerHTML = `
                                    <div class="module-error">
                                        <h3>⚠️ 모듈 로드 실패</h3>
                                        <p>${error.message}</p>
                                        <button onclick="switchToPage('${pageName}')" style="margin-top: 10px; padding: 5px 10px;">
                                            다시 시도
                                        </button>
                                    </div>
                                `;
                            }
                        }
                    } else {
                        // 이미 로드된 모듈 재활성화
                        const module = window.AppState.modules[moduleInfo.name];
                        if (module && typeof module.onPageLoad === 'function') {
                            await module.onPageLoad();
                        }
                    }
                }
            }

            window.AppState.currentPage = pageName;
        }

        // 네비게이션 설정
        function setupNavigation() {
            console.log('🧭 네비게이션 설정 중...');

            document.querySelectorAll('.nav-item').forEach(navItem => {
                navItem.addEventListener('click', function(e) {
                    e.preventDefault();
                    const targetPage = this.getAttribute('data-page');
                    if (targetPage) {
                        switchToPage(targetPage);
                    }
                });
            });
        }

        // 날짜 표시
        function updateDate() {
            const currentDateElement = document.getElementById('current-date');
            if (currentDateElement) {
                currentDateElement.textContent = new Date().toLocaleDateString('ko-KR', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    weekday: 'short'
                });
            }
        }

        // 로그아웃
        function logout() {
            if (confirm('로그아웃하시겠습니까?')) {
                console.log('🚪 로그아웃...');
                window.location.href = '/';
            }
        }

        // 대시보드 통계 로드
        async function loadDashboardStats() {
            try {
                // API 호출 시뮬레이션 (실제로는 CONFIG.API.BASE_URL 사용)
                console.log('📊 대시보드 통계 로딩...');

                // 실제 데이터로 업데이트 (현재는 하드코딩)
                document.getElementById('total-users').textContent = '12';
                document.getElementById('total-sites').textContent = '45';
                document.getElementById('total-ingredients').textContent = '84,215';
                document.getElementById('total-suppliers').textContent = '5';

            } catch (error) {
                console.error('대시보드 통계 로드 실패:', error);
            }
        }

        // 메인 초기화 함수
        async function initializeApp() {
            console.log('🚀 애플리케이션 초기화 시작...');

            try {
                // 1. 날짜 업데이트
                updateDate();

                // 2. ModuleLoader 시도 (옵션)
                const hasModuleLoader = await tryLoadModuleLoader();
                console.log(`ModuleLoader 상태: ${hasModuleLoader ? '활성' : '비활성 (폴백 모드)'}`);

                // 3. 네비게이션 설정
                setupNavigation();

                // 4. 대시보드 통계 로드
                await loadDashboardStats();

                // 5. 초기화 완료
                window.AppState.initialized = true;
                console.log('✅ 애플리케이션 초기화 완료');

            } catch (error) {
                console.error('❌ 초기화 실패:', error);
                document.getElementById('content-area').innerHTML = `
                    <div style="padding: 40px; text-align: center;">
                        <h2>⚠️ 시스템 초기화 실패</h2>
                        <p>${error.message}</p>
                        <button onclick="location.reload()" style="margin-top: 20px; padding: 10px 20px;">
                            새로고침
                        </button>
                    </div>
                `;
            }
        }

        // 각 페이지별 기본 콘텐츠 템플릿
        function getDefaultContent(pageName, title) {
            const templates = {
                'users': `
                    <div class="page-header">
                        <h2>${title}</h2>
                        <button class="btn btn-primary">+ 새 사용자 추가</button>
                    </div>
                    <div class="stats-grid" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin: 20px 0;">
                        <div class="stat-card" style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <h3>12</h3>
                            <p>전체 사용자</p>
                        </div>
                        <div class="stat-card" style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <h3>10</h3>
                            <p>활성 사용자</p>
                        </div>
                        <div class="stat-card" style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <h3>3</h3>
                            <p>관리자</p>
                        </div>
                        <div class="stat-card" style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <h3>9</h3>
                            <p>영양사</p>
                        </div>
                    </div>
                    <div class="table-container" style="background: white; padding: 20px; border-radius: 8px;">
                        <table style="width: 100%;">
                            <thead>
                                <tr>
                                    <th>사용자명</th>
                                    <th>권한</th>
                                    <th>부서</th>
                                    <th>상태</th>
                                    <th>작업</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="5" style="text-align: center; padding: 20px;">데이터 로딩 중...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                `,
                'suppliers': `
                    <div class="page-header">
                        <h2>${title}</h2>
                        <button class="btn btn-primary">+ 새 협력업체 추가</button>
                    </div>
                    <div class="suppliers-grid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin: 20px 0;">
                        <div class="supplier-card" style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <h3>삼성웰스토리</h3>
                            <p>식자재: 18,928개</p>
                        </div>
                        <div class="supplier-card" style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <h3>현대그린푸드</h3>
                            <p>식자재: 18,469개</p>
                        </div>
                        <div class="supplier-card" style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <h3>CJ프레시웨이</h3>
                            <p>식자재: 16,606개</p>
                        </div>
                    </div>
                `,
                'business-locations': `
                    <div class="page-header">
                        <h2>${title}</h2>
                        <button class="btn btn-primary">+ 새 사업장 추가</button>
                    </div>
                    <div class="locations-list" style="background: white; padding: 20px; border-radius: 8px; margin-top: 20px;">
                        <p>등록된 사업장: 45개</p>
                        <ul style="list-style: none; padding: 0;">
                            <li style="padding: 10px; border-bottom: 1px solid #eee;">도시락 사업장 (15개)</li>
                            <li style="padding: 10px; border-bottom: 1px solid #eee;">학교 급식 (12개)</li>
                            <li style="padding: 10px; border-bottom: 1px solid #eee;">요양원 (10개)</li>
                            <li style="padding: 10px; border-bottom: 1px solid #eee;">기업체 (8개)</li>
                        </ul>
                    </div>
                `,
                'meal-pricing': `
                    <div class="page-header">
                        <h2>${title}</h2>
                        <button class="btn btn-primary">+ 새 식단가 설정</button>
                    </div>
                    <div class="pricing-overview" style="background: white; padding: 20px; border-radius: 8px; margin-top: 20px;">
                        <h3>식단가 개요</h3>
                        <p>평균 식단가: 5,500원</p>
                        <p>최저가: 3,800원 | 최고가: 8,200원</p>
                    </div>
                `,
                'ingredients': `
                    <div class="page-header">
                        <h2>${title}</h2>
                        <button class="btn btn-primary">+ 새 식자재 추가</button>
                    </div>
                    <div class="ingredients-stats" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin: 20px 0;">
                        <div class="stat-card" style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <h3>84,215</h3>
                            <p>전체 식자재</p>
                        </div>
                        <div class="stat-card" style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <h3>5</h3>
                            <p>협력업체</p>
                        </div>
                    </div>
                `
            };

            return templates[pageName] || `
                <div style="padding: 20px;">
                    <h2>${title}</h2>
                    <p>페이지 콘텐츠를 준비 중입니다.</p>
                </div>
            `;
        }

        // DOMContentLoaded 이벤트 (단일 핸들러)
        document.addEventListener('DOMContentLoaded', initializeApp);

        // 디버그 도구
        window.debugApp = {
            state: () => window.AppState,
            reload: () => location.reload(),
            switchPage: (page) => switchToPage(page),
            modules: () => Object.keys(window.AppState.modules)
        };

        console.log('📌 디버그 명령어:');
        console.log('  debugApp.state() - 앱 상태 확인');
        console.log('  debugApp.modules() - 로드된 모듈 목록');
        console.log('  debugApp.switchPage("users") - 페이지 전환');
        console.log('  debugApp.reload() - 새로고침');
    </script>
</body>
</html>