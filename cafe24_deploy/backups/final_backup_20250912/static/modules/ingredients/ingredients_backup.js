/**
 * ÏãùÏû¨Î£å Í¥ÄÎ¶¨ Î™®Îìà
 * - ÏãùÏû¨Î£å CRUD ÏûëÏóÖ
 * - ÏãùÏû¨Î£å Í≤ÄÏÉâ Î∞è ÌïÑÌÑ∞ÎßÅ
 * - ÏãùÏû¨Î£å Ïû¨Í≥† Í¥ÄÎ¶¨
 */

window.IngredientsModule = {
    currentPage: 1,
    pageSize: 20,
    totalPages: 0,
    editingIngredientId: null,

    async load() {
        console.log('ü•¨ Ingredients Module Î°úÎî© ÏãúÏûë...');
        await this.render();
        await this.loadIngredients();
        this.setupEventListeners();
        console.log('ü•¨ Ingredients Module Î°úÎìúÎê®');
    },

    async render() {
        const container = document.getElementById('ingredients-module');
        if (!container) return;

        container.innerHTML = `
            <style>
            .ingredients-container {
                max-width: 1200px;
                margin: 0 auto;
                padding: 20px;
            }

            .ingredients-header {
                background: white;
                padding: 25px;
                border-radius: 12px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.08);
                margin-bottom: 25px;
            }

            .ingredients-header h1 {
                margin: 0 0 10px 0;
                color: #2c3e50;
                font-size: 28px;
                font-weight: 600;
            }

            .ingredients-header p {
                margin: 0;
                color: #7f8c8d;
                font-size: 16px;
            }

            .ingredients-toolbar {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 20px;
                gap: 15px;
                flex-wrap: wrap;
            }

            .search-box {
                display: flex;
                align-items: center;
                gap: 10px;
                flex: 1;
                max-width: 400px;
            }

            .search-box input {
                flex: 1;
                padding: 12px 15px;
                border: 2px solid #e1e8ed;
                border-radius: 8px;
                font-size: 14px;
                transition: border-color 0.3s;
            }

            .search-box input:focus {
                outline: none;
                border-color: #667eea;
            }

            .ingredients-content {
                background: white;
                border-radius: 12px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.08);
                overflow: hidden;
            }

            .ingredients-table {
                width: 100%;
                border-collapse: collapse;
                margin: 0;
            }

            .ingredients-table th,
            .ingredients-table td {
                padding: 15px;
                text-align: left;
                border-bottom: 1px solid #f1f3f4;
                vertical-align: middle;
            }

            .ingredients-table th {
                background: #f8f9fa;
                font-weight: 600;
                color: #333;
            }

            .ingredients-table tr:hover {
                background: #f8f9fa;
            }

            .loading-cell {
                text-align: center;
                color: #666;
                font-style: italic;
            }

            .btn {
                padding: 8px 16px;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-weight: 500;
                text-decoration: none;
                display: inline-block;
            }

            .btn-primary {
                background: #667eea;
                color: white;
            }

            .btn-secondary {
                background: #6c757d;
                color: white;
            }

            .btn-danger {
                background: #dc3545;
                color: white;
            }

            .btn-warning {
                background: #ffc107;
                color: #333;
            }

            .btn:hover {
                opacity: 0.9;
            }

            .btn-sm {
                padding: 4px 8px;
                font-size: 12px;
            }

            .stock-badge {
                padding: 4px 8px;
                border-radius: 12px;
                font-size: 12px;
                font-weight: 500;
            }

            .stock-high {
                background: #d4edda;
                color: #155724;
            }

            .stock-medium {
                background: #fff3cd;
                color: #856404;
            }

            .stock-low {
                background: #f8d7da;
                color: #721c24;
            }

            .modal {
                position: fixed;
                z-index: 1000;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
            }

            .modal-content {
                background: white;
                margin: 5% auto;
                padding: 0;
                border-radius: 8px;
                width: 90%;
                max-width: 600px;
                box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            }

            .modal-header {
                padding: 20px;
                border-bottom: 1px solid #eee;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            .modal-close {
                font-size: 28px;
                font-weight: bold;
                color: #aaa;
                cursor: pointer;
            }

            .modal-close:hover {
                color: #000;
            }

            .modal-body {
                padding: 20px;
            }

            .form-row {
                display: flex;
                gap: 15px;
                align-items: flex-end;
            }

            .form-group {
                margin-bottom: 15px;
                flex: 1;
            }

            .form-group label {
                display: block;
                margin-bottom: 5px;
                font-weight: 500;
                color: #333;
            }

            .form-group input,
            .form-group select,
            .form-group textarea {
                width: 100%;
                padding: 8px 12px;
                border: 1px solid #ddd;
                border-radius: 4px;
                font-size: 14px;
            }

            .form-group textarea {
                height: 80px;
                resize: vertical;
            }

            .form-actions {
                display: flex;
                justify-content: flex-end;
                gap: 10px;
                margin-top: 20px;
            }

            .pagination {
                display: flex;
                justify-content: center;
                align-items: center;
                padding: 20px;
                gap: 10px;
            }

            .pagination button {
                padding: 8px 12px;
                border: 1px solid #ddd;
                background: white;
                cursor: pointer;
                border-radius: 4px;
            }

            .pagination button:hover {
                background: #f8f9fa;
            }

            .pagination button.active {
                background: #667eea;
                color: white;
                border-color: #667eea;
            }

            .pagination button:disabled {
                opacity: 0.5;
                cursor: not-allowed;
            }

            .stats-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 15px;
                margin-bottom: 20px;
            }

            .stat-card {
                background: white;
                padding: 20px;
                border-radius: 8px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                text-align: center;
            }

            .stat-card h3 {
                margin: 0 0 10px 0;
                font-size: 24px;
                color: #667eea;
            }

            .stat-card p {
                margin: 0;
                color: #666;
                font-size: 14px;
            }

            .price-cell {
                text-align: right;
                font-weight: 500;
            }

            .quantity-cell {
                text-align: center;
            }
            </style>

            <div class="ingredients-container">
                <!-- Ìó§Îçî -->
                <div class="ingredients-header">
                    <h1>ü•¨ ÏãùÏû¨Î£å Í¥ÄÎ¶¨</h1>
                    <p>ÏãùÏû¨Î£å Ï†ïÎ≥¥Î•º Îì±Î°ùÌïòÍ≥† Ïû¨Í≥†Î•º Í¥ÄÎ¶¨Ìï©ÎãàÎã§</p>
                </div>

                <!-- ÌÜµÍ≥Ñ -->
                <div class="stats-grid" id="ingredients-stats">
                    <div class="stat-card">
                        <h3 id="total-ingredients">-</h3>
                        <p>Ï†ÑÏ≤¥ ÏãùÏû¨Î£å</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="low-stock-ingredients">-</h3>
                        <p>Ïû¨Í≥† Î∂ÄÏ°±</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="total-value">-</h3>
                        <p>Ï¥ù Ïû¨Í≥† Í∞ÄÏπò</p>
                    </div>
                </div>

                <!-- Ìà¥Î∞î -->
                <div class="ingredients-toolbar">
                    <div class="search-box">
                        <input type="text" id="ingredient-search" placeholder="ÏãùÏû¨Î£åÎ™Ö, Î∂ÑÎ•òÎ°ú Í≤ÄÏÉâ...">
                        <button class="btn btn-secondary" onclick="IngredientsModule.searchIngredients()">üîç</button>
                    </div>
                    <button class="btn btn-primary" onclick="IngredientsModule.showCreateModal()">+ ÏÉà ÏãùÏû¨Î£å</button>
                </div>

                <!-- ÏãùÏû¨Î£å Î™©Î°ù -->
                <div class="ingredients-content">
                    <table class="ingredients-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>ÏãùÏû¨Î£åÎ™Ö</th>
                                <th>Î∂ÑÎ•ò</th>
                                <th>Îã®ÏúÑ</th>
                                <th>ÌòÑÏû¨Í≥†</th>
                                <th>Îã®Í∞Ä</th>
                                <th>Ï¥ùÍ∞ÄÏπò</th>
                                <th>Ïû¨Í≥†ÏÉÅÌÉú</th>
                                <th>ÏûëÏóÖ</th>
                            </tr>
                        </thead>
                        <tbody id="ingredients-table-body">
                            <tr>
                                <td colspan="9" class="loading-cell">ÏãùÏû¨Î£å Î™©Î°ùÏùÑ Î∂àÎü¨Ïò§Îäî Ï§ë...</td>
                            </tr>
                        </tbody>
                    </table>
                    
                    <!-- ÌéòÏù¥ÏßÄÎÑ§Ïù¥ÏÖò -->
                    <div class="pagination" id="ingredients-pagination">
                        <!-- ÌéòÏù¥ÏßÄÎÑ§Ïù¥ÏÖò Î≤ÑÌäºÎì§Ïù¥ Ïó¨Í∏∞Ïóê ÎèôÏ†ÅÏúºÎ°ú ÏÉùÏÑ±Îê©ÎãàÎã§ -->
                    </div>
                </div>
            </div>

            <!-- ÏãùÏû¨Î£å ÏÉùÏÑ±/ÏàòÏ†ï Î™®Îã¨ -->
            <div id="ingredient-modal" class="modal" style="display: none;">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 id="modal-title">ÏÉà ÏãùÏû¨Î£å</h3>
                        <span class="modal-close" onclick="IngredientsModule.closeModal()">&times;</span>
                    </div>
                    <div class="modal-body">
                        <form id="ingredient-form" onsubmit="IngredientsModule.saveIngredient(event)">
                            <div class="form-group">
                                <label for="name">ÏãùÏû¨Î£åÎ™Ö *</label>
                                <input type="text" id="name" name="name" required>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="category">Î∂ÑÎ•ò</label>
                                    <select id="category" name="category">
                                        <option value="Ï±ÑÏÜåÎ•ò">Ï±ÑÏÜåÎ•ò</option>
                                        <option value="Ïú°Î•ò">Ïú°Î•ò</option>
                                        <option value="ÏàòÏÇ∞Î¨º">ÏàòÏÇ∞Î¨º</option>
                                        <option value="Í≥°Î¨ºÎ•ò">Í≥°Î¨ºÎ•ò</option>
                                        <option value="Ï°∞ÎØ∏Î£å">Ï°∞ÎØ∏Î£å</option>
                                        <option value="Ïú†Ï†úÌíà">Ïú†Ï†úÌíà</option>
                                        <option value="Í∏∞ÌÉÄ">Í∏∞ÌÉÄ</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="unit">Îã®ÏúÑ</label>
                                    <select id="unit" name="unit">
                                        <option value="kg">kg</option>
                                        <option value="g">g</option>
                                        <option value="Í∞ú">Í∞ú</option>
                                        <option value="Ìè¨">Ìè¨</option>
                                        <option value="Î∞ïÏä§">Î∞ïÏä§</option>
                                        <option value="L">L</option>
                                        <option value="ml">ml</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="current_stock">ÌòÑÏû¨Í≥†</label>
                                    <input type="number" id="current_stock" name="current_stock" step="0.1" min="0" value="0">
                                </div>
                                <div class="form-group">
                                    <label for="unit_price">Îã®Í∞Ä (Ïõê)</label>
                                    <input type="number" id="unit_price" name="unit_price" step="0.01" min="0" value="0">
                                </div>
                                <div class="form-group">
                                    <label for="minimum_stock">ÏµúÏÜå Ïû¨Í≥†</label>
                                    <input type="number" id="minimum_stock" name="minimum_stock" step="0.1" min="0" value="0">
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="supplier_info">Í≥µÍ∏âÏóÖÏ≤¥</label>
                                <input type="text" id="supplier_info" name="supplier_info" placeholder="Í≥µÍ∏âÏóÖÏ≤¥ Ï†ïÎ≥¥">
                            </div>
                            <div class="form-group">
                                <label for="notes">Î©îÎ™®</label>
                                <textarea id="notes" name="notes" placeholder="Ï∂îÍ∞Ä Î©îÎ™®..."></textarea>
                            </div>
                            <div class="form-actions">
                                <button type="submit" class="btn btn-primary">Ï†ÄÏû•</button>
                                <button type="button" class="btn btn-secondary" onclick="IngredientsModule.closeModal()">Ï∑®ÏÜå</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        `;
    },

    setupEventListeners() {
        // Í≤ÄÏÉâ ÏóîÌÑ∞ÌÇ§ Ï≤òÎ¶¨
        const searchInput = document.getElementById('ingredient-search');
        if (searchInput) {
            searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    this.searchIngredients();
                }
            });
        }

        // Î™®Îã¨ Ïô∏Î∂Ä ÌÅ¥Î¶≠Ïãú Îã´Í∏∞
        const modal = document.getElementById('ingredient-modal');
        if (modal) {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    this.closeModal();
                }
            });
        }
    },

    async loadIngredients() {
        try {
            const search = document.getElementById('ingredient-search')?.value || '';
            
            console.log(`Loading ingredients - page: ${this.currentPage}, search: "${search}"`);
            
            const response = await apiGet(`/api/admin/ingredients?page=${this.currentPage}&limit=${this.pageSize}&search=${encodeURIComponent(search)}`);
            
            console.log('Ingredients response:', response);
            
            if (response.success) {
                this.renderIngredients(response.ingredients || []);
                this.updatePagination(response.total, response.page, response.limit);
                await this.loadIngredientStats();
            } else {
                showMessage('ÏãùÏû¨Î£å Î™©Î°ùÏùÑ Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.', 'error');
                this.renderIngredients([]);
            }
        } catch (error) {
            console.error('ÏãùÏû¨Î£å Î°úÎìú Ï§ë Ïò§Î•ò:', error);
            console.error('Error message:', error.message);
            console.error('Error stack:', error.stack);
            showMessage('ÏãùÏû¨Î£å Î™©Î°ùÏùÑ Î∂àÎü¨Ïò§Îäî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'error');
            this.renderIngredients([]);
        }
    },

    async loadIngredientStats() {
        try {
            const response = await apiGet('/api/admin/ingredient-stats');
            if (response.success) {
                const stats = response.stats;
                document.getElementById('total-ingredients').textContent = stats.total_ingredients || 0;
                document.getElementById('low-stock-ingredients').textContent = stats.low_stock_ingredients || 0;
                document.getElementById('total-value').textContent = 
                    stats.total_value ? `‚Ç©${Number(stats.total_value).toLocaleString()}` : '‚Ç©0';
            }
        } catch (error) {
            console.error('ÏãùÏû¨Î£å ÌÜµÍ≥Ñ Î°úÎìú Ï§ë Ïò§Î•ò:', error);
        }
    },

    renderIngredients(ingredients) {
        const tbody = document.getElementById('ingredients-table-body');
        if (!tbody) return;

        if (ingredients.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="9" class="loading-cell">Îì±Î°ùÎêú ÏãùÏû¨Î£åÍ∞Ä ÏóÜÏäµÎãàÎã§.</td>
                </tr>
            `;
            return;
        }

        tbody.innerHTML = ingredients.map(ingredient => {
            const totalValue = (ingredient.current_stock || 0) * (ingredient.unit_price || 0);
            const stockLevel = this.getStockLevel(ingredient.current_stock, ingredient.minimum_stock);
            
            return `
                <tr>
                    <td>${ingredient.id}</td>
                    <td><strong>${ingredient.name}</strong></td>
                    <td>${ingredient.category || '-'}</td>
                    <td>${ingredient.unit || '-'}</td>
                    <td class="quantity-cell">${ingredient.current_stock || 0}</td>
                    <td class="price-cell">‚Ç©${Number(ingredient.unit_price || 0).toLocaleString()}</td>
                    <td class="price-cell">‚Ç©${Number(totalValue).toLocaleString()}</td>
                    <td>
                        <span class="stock-badge ${stockLevel.class}">${stockLevel.text}</span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-warning" onclick="IngredientsModule.editIngredient(${ingredient.id})">ÏàòÏ†ï</button>
                        <button class="btn btn-sm btn-danger" onclick="IngredientsModule.deleteIngredient(${ingredient.id})">ÏÇ≠Ï†ú</button>
                    </td>
                </tr>
            `;
        }).join('');
    },

    getStockLevel(currentStock, minimumStock) {
        const current = Number(currentStock || 0);
        const minimum = Number(minimumStock || 0);
        
        if (minimum === 0) {
            return { class: 'stock-high', text: 'Ï†ïÏÉÅ' };
        }
        
        if (current <= minimum) {
            return { class: 'stock-low', text: 'Î∂ÄÏ°±' };
        } else if (current <= minimum * 2) {
            return { class: 'stock-medium', text: 'Î≥¥ÌÜµ' };
        } else {
            return { class: 'stock-high', text: 'Ï∂©Î∂Ñ' };
        }
    },

    updatePagination(total, page, limit) {
        this.totalPages = Math.ceil(total / limit);
        this.currentPage = page;

        const paginationContainer = document.getElementById('ingredients-pagination');
        if (!paginationContainer) return;

        let paginationHTML = '';

        // Ïù¥Ï†Ñ ÌéòÏù¥ÏßÄ
        paginationHTML += `
            <button ${this.currentPage <= 1 ? 'disabled' : ''} onclick="IngredientsModule.goToPage(${this.currentPage - 1})">
                Ïù¥Ï†Ñ
            </button>
        `;

        // ÌéòÏù¥ÏßÄ Î≤àÌò∏Îì§
        for (let i = Math.max(1, this.currentPage - 2); i <= Math.min(this.totalPages, this.currentPage + 2); i++) {
            paginationHTML += `
                <button class="${i === this.currentPage ? 'active' : ''}" onclick="IngredientsModule.goToPage(${i})">
                    ${i}
                </button>
            `;
        }

        // Îã§Ïùå ÌéòÏù¥ÏßÄ
        paginationHTML += `
            <button ${this.currentPage >= this.totalPages ? 'disabled' : ''} onclick="IngredientsModule.goToPage(${this.currentPage + 1})">
                Îã§Ïùå
            </button>
        `;

        paginationContainer.innerHTML = paginationHTML;
    },

    goToPage(page) {
        if (page >= 1 && page <= this.totalPages) {
            this.currentPage = page;
            this.loadIngredients();
        }
    },

    searchIngredients() {
        this.currentPage = 1;
        this.loadIngredients();
    },

    showCreateModal() {
        document.getElementById('modal-title').textContent = 'ÏÉà ÏãùÏû¨Î£å';
        document.getElementById('ingredient-form').reset();
        
        // Í∏∞Î≥∏Í∞í ÏÑ§Ï†ï
        document.getElementById('category').value = 'Ï±ÑÏÜåÎ•ò';
        document.getElementById('unit').value = 'kg';
        
        document.getElementById('ingredient-modal').style.display = 'block';
        this.editingIngredientId = null;
    },

    closeModal() {
        document.getElementById('ingredient-modal').style.display = 'none';
        document.getElementById('ingredient-form').reset();
        this.editingIngredientId = null;
    },

    async saveIngredient(event) {
        event.preventDefault();
        
        const formData = new FormData(event.target);
        const ingredientData = {
            name: formData.get('name'),
            category: formData.get('category'),
            unit: formData.get('unit'),
            current_stock: parseFloat(formData.get('current_stock')) || 0,
            unit_price: parseFloat(formData.get('unit_price')) || 0,
            minimum_stock: parseFloat(formData.get('minimum_stock')) || 0,
            supplier_info: formData.get('supplier_info'),
            notes: formData.get('notes')
        };

        try {
            let response;
            if (this.editingIngredientId) {
                response = await apiPut(`/api/admin/ingredients/${this.editingIngredientId}`, ingredientData);
            } else {
                console.log('Sending ingredient data:', ingredientData);
                response = await apiPost('/api/admin/ingredients', ingredientData);
            }

            if (response.success !== false) {
                showMessage(this.editingIngredientId ? 'ÏãùÏû¨Î£åÍ∞Ä ÏàòÏ†ïÎêòÏóàÏäµÎãàÎã§.' : 'ÏãùÏû¨Î£åÍ∞Ä Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§.', 'success');
                this.closeModal();
                this.loadIngredients();
            } else {
                showMessage(response.message || 'Ï†ÄÏû• Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'error');
            }
        } catch (error) {
            console.error('ÏãùÏû¨Î£å Ï†ÄÏû• Ï§ë Ïò§Î•ò:', error);
            
            if (error.message.includes('422')) {
                showMessage('ÏûÖÎ†• Îç∞Ïù¥ÌÑ∞Î•º ÌôïÏù∏Ìï¥ Ï£ºÏÑ∏Ïöî.', 'error');
            } else if (error.message.includes('400')) {
                showMessage('Ïù¥ÎØ∏ Ï°¥Ïû¨ÌïòÎäî ÏãùÏû¨Î£åÎ™ÖÏûÖÎãàÎã§.', 'error');
            } else {
                showMessage('ÏãùÏû¨Î£å Ï†ÄÏû• Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'error');
            }
        }
    },

    async editIngredient(ingredientId) {
        try {
            const response = await apiGet(`/api/admin/ingredients/${ingredientId}`);
            
            if (response.success !== false) {
                const ingredient = response.ingredient || response;
                
                document.getElementById('modal-title').textContent = 'ÏãùÏû¨Î£å ÏàòÏ†ï';
                document.getElementById('name').value = ingredient.name;
                document.getElementById('category').value = ingredient.category || 'Ï±ÑÏÜåÎ•ò';
                document.getElementById('unit').value = ingredient.unit || 'kg';
                document.getElementById('current_stock').value = ingredient.current_stock || 0;
                document.getElementById('unit_price').value = ingredient.unit_price || 0;
                document.getElementById('minimum_stock').value = ingredient.minimum_stock || 0;
                document.getElementById('supplier_info').value = ingredient.supplier_info || '';
                document.getElementById('notes').value = ingredient.notes || '';
                
                this.editingIngredientId = ingredientId;
                document.getElementById('ingredient-modal').style.display = 'block';
            } else {
                showMessage('ÏãùÏû¨Î£å Ï†ïÎ≥¥Î•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.', 'error');
            }
        } catch (error) {
            console.error('ÏãùÏû¨Î£å Î°úÎìú Ï§ë Ïò§Î•ò:', error);
            showMessage('ÏãùÏû¨Î£å Ï†ïÎ≥¥Î•º Î∂àÎü¨Ïò§Îäî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'error');
        }
    },

    async deleteIngredient(ingredientId) {
        if (!confirm('Ï†ïÎßêÎ°ú Ïù¥ ÏãùÏû¨Î£åÎ•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
            return;
        }

        try {
            const response = await apiDelete(`/api/admin/ingredients/${ingredientId}`);
            
            if (response.success !== false) {
                showMessage('ÏãùÏû¨Î£åÍ∞Ä ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.', 'success');
                this.loadIngredients();
            } else {
                showMessage('ÏãùÏû¨Î£å ÏÇ≠Ï†ú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'error');
            }
        } catch (error) {
            console.error('ÏãùÏû¨Î£å ÏÇ≠Ï†ú Ï§ë Ïò§Î•ò:', error);
            showMessage('ÏãùÏû¨Î£å ÏÇ≠Ï†ú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'error');
        }
    }
};

console.log('ü•¨ Ingredients Module Ï†ïÏùòÎê®');
    uploadSection.style.display = isVisible ? 'none' : 'block';
    
    if (!isVisible) {
        showNotification('üìÅ ÌååÏùº ÏóÖÎ°úÎìú ÏÑπÏÖòÏù¥ Ïó¥Î†∏ÏäµÎãàÎã§.', 'info');
    }
}

// ÏñëÏãù Îã§Ïö¥Î°úÎìú
function downloadTemplate() {
    try {
        // ÏÉòÌîå Excel ÌååÏùº Îã§Ïö¥Î°úÎìú Î°úÏßÅ
        const link = document.createElement('a');
        link.href = '/static/sample data/food_sample.xls';
        link.download = 'ÏãùÏûêÏû¨_ÏóÖÎ°úÎìú_ÏñëÏãù_ÏÉòÌîå.xls';
        link.target = '_blank';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        // Îã§Ïö¥Î°úÎìú ÏÑ±Í≥µ Î©îÏãúÏßÄ
        showNotification('üìã ÏñëÏãù Îã§Ïö¥Î°úÎìúÍ∞Ä ÏãúÏûëÎêòÏóàÏäµÎãàÎã§.', 'success');
    } catch (error) {
        console.error('ÏñëÏãù Îã§Ïö¥Î°úÎìú Ïã§Ìå®:', error);
        showNotification('‚ùå ÏñëÏãù Îã§Ïö¥Î°úÎìúÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.', 'error');
    }
}

// ÏóÖÎ°úÎìú Í≤∞Í≥º Ï°∞Ìöå ÌëúÏãú
function showUploadHistory() {
    const historySection = document.getElementById('upload-history-section');
    const uploadSection = document.getElementById('upload-section');
    
    if (!historySection) return;
    
    // Îã§Î•∏ ÏÑπÏÖò Ïà®Í∏∞Í∏∞
    if (uploadSection && uploadSection.style.display !== 'none') {
        uploadSection.style.display = 'none';
    }
    
    historySection.style.display = 'block';
    loadUploadHistory();
    showNotification('üìä ÏóÖÎ°úÎìú Í≤∞Í≥ºÎ•º Ï°∞ÌöåÌï©ÎãàÎã§.', 'info');
}

// ÏóÖÎ°úÎìú Í≤∞Í≥º Ï°∞Ìöå Ïà®Í∏∞Í∏∞
function hideUploadHistory() {
    const historySection = document.getElementById('upload-history-section');
    const detailsSection = document.getElementById('upload-details-section');
    
    if (historySection) historySection.style.display = 'none';
    if (detailsSection) detailsSection.style.display = 'none';
}

// ÌååÏùº ÏÑ†ÌÉù Ï≤òÎ¶¨
function handleFileSelect(event) {
    const files = Array.from(event.target.files);
    processSelectedFiles(files);
}

// ÎìúÎûòÍ∑∏ Ïò§Î≤Ñ Ï≤òÎ¶¨
function handleDragOver(event) {
    event.preventDefault();
    event.currentTarget.style.borderColor = '#007bff';
    event.currentTarget.style.backgroundColor = '#e7f3ff';
}

// ÎìúÎûòÍ∑∏ Îñ†ÎÇ® Ï≤òÎ¶¨
function handleDragLeave(event) {
    event.preventDefault();
    event.currentTarget.style.borderColor = '#4a90e2';
    event.currentTarget.style.backgroundColor = '#f8f9fa';
}

// ÌååÏùº ÎìúÎ°≠ Ï≤òÎ¶¨
function handleFileDrop(event) {
    event.preventDefault();
    event.currentTarget.style.borderColor = '#4a90e2';
    event.currentTarget.style.backgroundColor = '#f8f9fa';
    
    const files = Array.from(event.dataTransfer.files);
    processSelectedFiles(files);
}

// ÏÑ†ÌÉùÎêú ÌååÏùº Ï≤òÎ¶¨
function processSelectedFiles(files) {
    const validFiles = files.filter(file => {
        const isExcel = file.type === 'application/vnd.ms-excel' || 
                       file.type === 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' ||
                       file.name.endsWith('.xls') || file.name.endsWith('.xlsx');
        const isValidSize = file.size <= 10 * 1024 * 1024; // 10MB
        
        if (!isExcel) {
            showNotification(`‚ùå ${file.name}: Excel ÌååÏùºÎßå ÏóÖÎ°úÎìú Í∞ÄÎä•Ìï©ÎãàÎã§.`, 'error');
            return false;
        }
        
        if (!isValidSize) {
            showNotification(`‚ùå ${file.name}: ÌååÏùº ÌÅ¨Í∏∞Îäî 10MB Ïù¥ÌïòÏó¨Ïïº Ìï©ÎãàÎã§.`, 'error');
            return false;
        }
        
        return true;
    });
    
    if (validFiles.length > 0) {
        uploadedFiles = validFiles;
        updateFileList();
        enableUploadButton();
        showNotification(`‚úÖ ${validFiles.length}Í∞ú ÌååÏùºÏù¥ ÏÑ†ÌÉùÎêòÏóàÏäµÎãàÎã§.`, 'success');
    }
}

// ÌååÏùº ÏÑ†ÌÉù Ï≤òÎ¶¨ (input change Ïù¥Î≤§Ìä∏Ïö©)
function handleFileSelect(event) {
    const files = Array.from(event.target.files);
    processSelectedFiles(files);
}

// ÌååÏùº Ï¥àÍ∏∞Ìôî
function clearFiles() {
    uploadedFiles = [];
    const fileInput = document.getElementById('file-input');
    if (fileInput) {
        fileInput.value = '';
    }
    updateFileList();
    disableUploadButton();
    showNotification('üìÅ ÏÑ†ÌÉùÎêú ÌååÏùºÏù¥ Ï¥àÍ∏∞ÌôîÎêòÏóàÏäµÎãàÎã§.', 'info');
}

// ÌååÏùº Î™©Î°ù ÏóÖÎç∞Ïù¥Ìä∏
function updateFileList() {
    const fileListDiv = document.getElementById('selected-files-list');
    if (!fileListDiv) {
        console.log('ÏÑ†ÌÉùÎêú ÌååÏùºÎì§:', uploadedFiles.map(f => f.name));
        return;
    }
    
    if (uploadedFiles.length === 0) {
        fileListDiv.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">ÏÑ†ÌÉùÎêú ÌååÏùºÏù¥ ÏóÜÏäµÎãàÎã§.</p>';
        return;
    }
    
    const listHTML = uploadedFiles.map((file, index) => `
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 8px; background: #f8f9fa;">
            <div>
                <strong>${file.name}</strong>
                <small style="color: #666; margin-left: 10px;">(${(file.size / 1024 / 1024).toFixed(2)} MB)</small>
            </div>
            <button onclick="removeFile(${index})" style="background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 12px;">
                ÏÇ≠Ï†ú
            </button>
        </div>
    `).join('');
    
    fileListDiv.innerHTML = listHTML;
}

// Í∞úÎ≥Ñ ÌååÏùº ÏÇ≠Ï†ú
function removeFile(index) {
    uploadedFiles.splice(index, 1);
    updateFileList();
    if (uploadedFiles.length === 0) {
        disableUploadButton();
    } else {
        enableUploadButton();
    }
}

// ÏóÖÎ°úÎìú Î≤ÑÌäº ÌôúÏÑ±Ìôî
function enableUploadButton() {
    const uploadBtn = document.getElementById('upload-btn');
    if (uploadBtn) {
        uploadBtn.disabled = false;
        uploadBtn.style.opacity = '1';
    }
}

// ÏóÖÎ°úÎìú Î≤ÑÌäº ÎπÑÌôúÏÑ±Ìôî
function disableUploadButton() {
    const uploadBtn = document.getElementById('upload-btn');
    if (uploadBtn) {
        uploadBtn.disabled = true;
        uploadBtn.style.opacity = '0.5';
    }
}

// ÌååÏùº ÏóÖÎ°úÎìú Ïã§Ìñâ
async function uploadFiles() {
    console.log('‚òÖ‚òÖ‚òÖ MODULAR uploadFiles Ìï®Ïàò Ìò∏Ï∂úÎê® - Ïã§Ï†ú ÏÑúÎ≤Ñ ÏóÖÎ°úÎìú ÏãúÏûë ‚òÖ‚òÖ‚òÖ');
    if (uploadedFiles.length === 0) {
        showNotification('‚ùå ÏóÖÎ°úÎìúÌï† ÌååÏùºÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.', 'error');
        return;
    }
    
    const progressSection = document.getElementById('upload-progress');
    const progressFill = document.getElementById('progress-fill');
    const progressText = document.getElementById('progress-text');
    
    try {
        // ÏßÑÌñâÎ•† ÌëúÏãú
        if (progressSection) progressSection.style.display = 'block';
        
        let totalProcessedRows = 0;
        let totalSuccessRows = 0;
        let totalFailedRows = 0;
        const uploadResults = [];
        
        for (let i = 0; i < uploadedFiles.length; i++) {
            const file = uploadedFiles[i];
            const progress = ((i + 1) / uploadedFiles.length) * 100;
            
            if (progressFill) progressFill.style.width = progress + '%';
            if (progressText) progressText.textContent = `ÏóÖÎ°úÎìú Ï§ë... ${file.name} (${i + 1}/${uploadedFiles.length})`;
            
            // Ïã§Ï†ú ÏÑúÎ≤Ñ ÏóÖÎ°úÎìú
            const result = await uploadFileToServer(file);
            
            // Í≤∞Í≥º ÎàÑÏ†Å
            totalProcessedRows += result.processedRows;
            totalSuccessRows += result.successRows;
            totalFailedRows += result.failedRows;
            uploadResults.push({
                fileName: file.name,
                success: true,
                processedRows: result.processedRows,
                successRows: result.successRows,
                failedRows: result.failedRows
            });
        }
        
        // ÏóÖÎ°úÎìú ÏôÑÎ£å Ï≤òÎ¶¨
        if (progressText) {
            progressText.textContent = `ÏóÖÎ°úÎìú ÏôÑÎ£å! Ï¥ù ${totalProcessedRows.toLocaleString()}Í∞ú ÏãùÏûêÏû¨ Îç∞Ïù¥ÌÑ∞ Ï≤òÎ¶¨Îê® (ÏÑ±Í≥µ: ${totalSuccessRows.toLocaleString()})`;
        }
        
        // ÎåÄÎüâ ÏóÖÎ°úÎìú Í≤∞Í≥º ÌëúÏãú
        displayBulkUploadResults(uploadResults, uploadedFiles.length, totalSuccessRows, 0);
        
        showNotification(`‚úÖ ${uploadedFiles.length}Í∞ú ÌååÏùº ÏóÖÎ°úÎìú ÏôÑÎ£å! Ï¥ù ${totalProcessedRows.toLocaleString()}Í∞ú ÏãùÏûêÏû¨ Îç∞Ïù¥ÌÑ∞Í∞Ä Ï≤òÎ¶¨ÎêòÏóàÏäµÎãàÎã§.`, 'success');
        
        // Ï¥àÍ∏∞Ìôî (3Ï¥à ÌõÑ)
        setTimeout(() => {
            uploadedFiles = [];
            updateFileList();
            disableUploadButton();
            if (progressSection) progressSection.style.display = 'none';
        }, 3000);
        
        // ÏóÖÎ°úÎìú ÌûàÏä§ÌÜ†Î¶¨ Í∞±Ïã†
        loadUploadHistory();
        
    } catch (error) {
        console.error('ÏóÖÎ°úÎìú Ïã§Ìå®:', error);
        showNotification('‚ùå ÌååÏùº ÏóÖÎ°úÎìú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'error');
        
        if (progressSection) progressSection.style.display = 'none';
    }
}

// ÎåÄÏö©Îüâ ÏóÖÎ°úÎìú Í≤∞Í≥º ÌëúÏãú (18,000Í∞ú Ïù¥ÏÉÅ ÏãùÏûêÏû¨ Îç∞Ïù¥ÌÑ∞ Ï≤òÎ¶¨Ïö©)
function displayBulkUploadResults(uploadResults, totalProcessed, totalSuccess, totalFailed) {
    // ÏÉÅÏÑ∏ Í≤∞Í≥º ÏÑπÏÖòÏù¥ ÏûàÎäîÏßÄ ÌôïÏù∏ÌïòÍ≥† ÏóÜÏúºÎ©¥ ÏÉùÏÑ±
    let resultsSection = document.getElementById('bulk-upload-results');
    if (!resultsSection) {
        resultsSection = document.createElement('div');
        resultsSection.id = 'bulk-upload-results';
        resultsSection.style.cssText = 'margin-top: 20px; background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);';
        
        const uploadSection = document.getElementById('upload-section');
        if (uploadSection) {
            uploadSection.appendChild(resultsSection);
        }
    }
    
    // ÏöîÏïΩ ÌÜµÍ≥Ñ
    const summaryHTML = `
        <div style="padding: 20px; border-bottom: 1px solid #eee;">
            <h3 style="margin: 0 0 15px 0; color: #007bff;">üìä ÎåÄÏö©Îüâ ÏóÖÎ°úÎìú Í≤∞Í≥º</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                <div style="background: #e7f3ff; padding: 15px; border-radius: 5px; text-align: center;">
                    <div style="font-size: 24px; font-weight: bold; color: #007bff;">${totalProcessed}</div>
                    <div style="font-size: 14px; color: #666;">Ï≤òÎ¶¨Îêú ÌååÏùº</div>
                </div>
                <div style="background: #e8f5e8; padding: 15px; border-radius: 5px; text-align: center;">
                    <div style="font-size: 24px; font-weight: bold; color: #28a745;">${totalSuccess.toLocaleString()}</div>
                    <div style="font-size: 14px; color: #666;">ÏÑ±Í≥µÌïú ÏãùÏûêÏû¨</div>
                </div>
                <div style="background: ${totalFailed > 0 ? '#ffe6e6' : '#f8f9fa'}; padding: 15px; border-radius: 5px; text-align: center;">
                    <div style="font-size: 24px; font-weight: bold; color: ${totalFailed > 0 ? '#dc3545' : '#666'};">${totalFailed}</div>
                    <div style="font-size: 14px; color: #666;">Ïã§Ìå®Ìïú ÌååÏùº</div>
                </div>
            </div>
        </div>
    `;
    
    // ÌååÏùºÎ≥Ñ ÏÉÅÏÑ∏ Í≤∞Í≥º
    let detailsHTML = '';
    if (uploadResults.length > 0) {
        detailsHTML = `
            <div style="padding: 20px;">
                <h4 style="margin: 0 0 15px 0;">üìã ÌååÏùºÎ≥Ñ Ï≤òÎ¶¨ Í≤∞Í≥º</h4>
                <div style="max-height: 300px; overflow-y: auto;">
                    ${uploadResults.map(result => {
                        const isSuccess = result.success;
                        const statusColor = isSuccess ? '#28a745' : '#dc3545';
                        const statusIcon = isSuccess ? '‚úÖ' : '‚ùå';
                        
                        return `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; border: 1px solid #eee; border-radius: 4px; margin-bottom: 8px; background: ${isSuccess ? '#f8fff8' : '#fff8f8'};">
                                <div style="flex: 1;">
                                    <div style="font-weight: 500;">${statusIcon} ${result.fileName}</div>
                                    ${isSuccess 
                                        ? `<small style="color: #666;">ÏÑ±Í≥µ: ${(result.successRows || 0).toLocaleString()}Í∞ú, Ïã§Ìå®: ${(result.failedRows || 0).toLocaleString()}Í∞ú</small>`
                                        : `<small style="color: #dc3545;">${result.error}</small>`
                                    }
                                </div>
                                <div style="text-align: right;">
                                    <div style="color: ${statusColor}; font-weight: bold;">
                                        ${isSuccess ? `${(result.processedRows || 0).toLocaleString()}Í∞ú Ï≤òÎ¶¨Îê®` : 'Ï≤òÎ¶¨ Ïã§Ìå®'}
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
                ${uploadResults.length > 10 ? `<div style="text-align: center; padding-top: 10px; color: #666; font-size: 12px;">Ï¥ù ${uploadResults.length}Í∞ú ÌååÏùº Ï§ë Ï≤òÎ¶¨ ÏôÑÎ£å</div>` : ''}
            </div>
        `;
    }
    
    resultsSection.innerHTML = summaryHTML + detailsHTML;
    
    // Í≤∞Í≥º ÏÑπÏÖòÏúºÎ°ú Ïä§ÌÅ¨Î°§
    resultsSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

// ÌååÏùº ÏóÖÎ°úÎìú ÏãúÎÆ¨Î†àÏù¥ÏÖò (ÎåÄÎüâ Îç∞Ïù¥ÌÑ∞ Ï≤òÎ¶¨ ÏãúÎÆ¨Î†àÏù¥ÏÖò)
// Ïã§Ï†ú ÏÑúÎ≤Ñ ÏóÖÎ°úÎìú Ìï®Ïàò
async function uploadFileToServer(file) {
    console.log('üöÄ uploadFileToServer Ìï®Ïàò ÏãúÏûë - ÌååÏùº:', file.name);
    const formData = new FormData();
    formData.append('file', file);
    
    try {
        console.log('üåê ÏÑúÎ≤Ñ ÏöîÏ≤≠ ÏãúÏûë - /api/admin/upload-ingredients');
        const response = await fetch('/api/admin/upload-ingredients', {
            method: 'POST',
            body: formData,
            credentials: 'include'
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const result = await response.json();
        
        if (result.success) {
            console.log(`ÌååÏùº ÏóÖÎ°úÎìú ÏôÑÎ£å: ${file.name} - ${result.details.total_rows}Ìñâ Ï≤òÎ¶¨Îê® (Ïã†Í∑ú: ${result.details.new_count}, ÏóÖÎç∞Ïù¥Ìä∏: ${result.details.updated_count}, Ïã§Ìå®: ${result.details.error_count})`);
            return {
                processedRows: result.details.total_rows,
                successRows: result.details.new_count + result.details.updated_count,
                failedRows: result.details.error_count
            };
        } else {
            throw new Error(result.message || 'ÏóÖÎ°úÎìú Ïã§Ìå®');
        }
    } catch (error) {
        console.error('ÏóÖÎ°úÎìú Ïò§Î•ò:', error);
        throw error;
    }
}

// simulateFileUpload Ìï®ÏàòÍ∞Ä Ï†úÍ±∞Îê® - Ïã§Ï†ú ÏÑúÎ≤Ñ ÏóÖÎ°úÎìúÎßå ÏÇ¨Ïö©

// ÏóÖÎ°úÎìú ÌûàÏä§ÌÜ†Î¶¨ Î°úÎìú
function loadUploadHistory() {
    // Ïã§Ï†ú Íµ¨ÌòÑÏóêÏÑúÎäî APIÏóêÏÑú Îç∞Ïù¥ÌÑ∞Î•º Í∞ÄÏ†∏Ïò¥
    console.log('ÏóÖÎ°úÎìú ÌûàÏä§ÌÜ†Î¶¨ Î°úÎìúÎê®');
}

// ÏóÖÏ≤¥Î≥Ñ ÌïÑÌÑ∞ÎßÅ
function filterUploadHistory() {
    const supplierFilter = document.getElementById('supplier-filter')?.value;
    console.log('ÏóÖÏ≤¥Î≥Ñ ÌïÑÌÑ∞:', supplierFilter);
    showNotification('ÏóÖÏ≤¥Î≥Ñ ÌïÑÌÑ∞Í∞Ä Ï†ÅÏö©ÎêòÏóàÏäµÎãàÎã§.', 'info');
}

// ÏóÖÎ°úÎìú Ïù¥Î†• Í≤ÄÏÉâ
function searchUploadHistory() {
    const supplierFilter = document.getElementById('supplier-filter')?.value;
    const dateFrom = document.getElementById('date-from')?.value;
    const dateTo = document.getElementById('date-to')?.value;
    
    console.log('ÏóÖÎ°úÎìú Ïù¥Î†• Í≤ÄÏÉâ:', { supplierFilter, dateFrom, dateTo });
    showNotification('ÏóÖÎ°úÎìú Ïù¥Î†•ÏùÑ Ï°∞ÌöåÌñàÏäµÎãàÎã§.', 'success');
}

// ÏóÖÎ°úÎìú ÏÉÅÏÑ∏ Í≤∞Í≥º ÌëúÏãú
function showUploadDetails(uploadId) {
    const detailsSection = document.getElementById('upload-details-section');
    const detailsContent = document.getElementById('upload-details-content');
    
    if (!detailsSection || !detailsContent) return;
    
    // ÏÉòÌîå ÏÉÅÏÑ∏ Îç∞Ïù¥ÌÑ∞
    const sampleDetails = {
        1: {
            fileName: 'food_sample_20241210.xls',
            supplier: 'Ïõ∞Ïä§ÌÜ†Î¶¨',
            uploadDate: '2024-12-10',
            totalRows: 150,
            successRows: 148,
            failedRows: 2,
            validationErrors: [
                { row: 15, column: 'C', field: 'Í≥†Ïú†ÏΩîÎìú', error: 'ÏòÅÎ¨∏+Ïà´ÏûêÎßå ÌóàÏö©Îê®', value: 'ÌïúÍ∏ÄÏΩîÎìú123' },
                { row: 67, column: 'N', field: 'ÎπÑÍ≥†', error: 'NÏó¥ Î≤îÏúÑ Ï¥àÍ≥º', value: 'Îß§Ïö∞ Í∏¥ ÎπÑÍ≥† ÎÇ¥Ïö©...' }
            ],
            outOfRangeData: [
                { row: 67, column: 'O', value: 'Î≤îÏúÑÏ¥àÍ≥ºÎç∞Ïù¥ÌÑ∞' },
                { row: 67, column: 'P', value: 'Ï∂îÍ∞ÄÎç∞Ïù¥ÌÑ∞' }
            ]
        },
        2: {
            fileName: 'samsung_ingredients.xlsx',
            supplier: 'ÏÇºÏÑ±Ïõ∞Ïä§ÌÜ†Î¶¨',
            uploadDate: '2024-12-08',
            totalRows: 200,
            successRows: 195,
            failedRows: 5,
            validationErrors: [
                { row: 23, column: 'E', field: 'ÏõêÏÇ∞ÏßÄ', error: 'ÌäπÏàòÎ¨∏Ïûê ÏÇ¨Ïö©Î∂àÍ∞Ä', value: 'ÌïúÍµ≠@#$' },
                { row: 45, column: 'I', field: 'Î©¥ÏÑ∏', error: 'ÌóàÏö©Í∞í: Full tax, No tax', value: 'Î∂ÄÍ∞ÄÏÑ∏ÏûàÏùå' },
                { row: 78, column: 'J', field: 'ÏÑ†Î∞úÏ£ºÏùº', error: 'ÌòïÏãù Ïò§Î•ò', value: 'D+5Ïùº' },
                { row: 123, column: 'K', field: 'ÏûÖÍ≥†Í∞Ä', error: 'Ïà´ÏûêÎßå ÏûÖÎ†•', value: 'Ï≤úÏõê' },
                { row: 156, column: 'L', field: 'ÌåêÎß§Í∞Ä', error: 'ÏùåÏàò Î∂àÍ∞Ä', value: '-1500' }
            ],
            outOfRangeData: []
        }
    };
    
    const details = sampleDetails[uploadId];
    if (!details) return;
    
    let detailsHTML = generateUploadDetailsHTML(details);
    
    detailsContent.innerHTML = detailsHTML;
    detailsSection.style.display = 'block';
    
    // ÏÉÅÏÑ∏ Í≤∞Í≥º ÏÑπÏÖòÏúºÎ°ú Ïä§ÌÅ¨Î°§
    detailsSection.scrollIntoView({ behavior: 'smooth' });
}

// ÏóÖÎ°úÎìú ÏÉÅÏÑ∏ HTML ÏÉùÏÑ±
function generateUploadDetailsHTML(details) {
    let html = `
        <div style="display: flex; gap: 20px; margin-bottom: 20px;">
            <div style="flex: 1; background: white; padding: 15px; border-radius: 5px; border-left: 4px solid #007bff;">
                <h5 style="margin-top: 0; color: #007bff;">üìä ÏóÖÎ°úÎìú ÏöîÏïΩ</h5>
                <p><strong>ÌååÏùºÎ™Ö:</strong> ${details.fileName}</p>
                <p><strong>Í±∞ÎûòÏ≤ò:</strong> ${details.supplier}</p>
                <p><strong>ÏóÖÎ°úÎìúÏùº:</strong> ${details.uploadDate}</p>
                <p><strong>Ï¥ù Ìï≠Î™©Ïàò:</strong> ${details.totalRows}Í∞ú</p>
                <p><strong>ÏÑ±Í≥µ:</strong> <span style="color: #28a745; font-weight: bold;">${details.successRows}Í∞ú</span></p>
                <p><strong>Ïã§Ìå®:</strong> <span style="color: #dc3545; font-weight: bold;">${details.failedRows}Í∞ú</span></p>
            </div>
        </div>
    `;
    
    if (details.validationErrors.length > 0) {
        html += generateValidationErrorsTable(details.validationErrors);
    }
    
    if (details.outOfRangeData.length > 0) {
        html += generateOutOfRangeDataTable(details.outOfRangeData);
    }
    
    return html;
}

// Í≤ÄÏ¶ù Ïã§Ìå® ÌÖåÏù¥Î∏î ÏÉùÏÑ±
function generateValidationErrorsTable(errors) {
    return `
        <div style="margin-bottom: 20px;">
            <h5 style="color: #dc3545;">‚ùå Í≤ÄÏ¶ù Ïã§Ìå® Ìï≠Î™© (${errors.length}Í∞ú)</h5>
            <div style="overflow-x: auto;">
                <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                    <thead>
                        <tr style="background: #f8d7da;">
                            <th style="border: 1px solid #f5c6cb; padding: 8px;">Ìñâ</th>
                            <th style="border: 1px solid #f5c6cb; padding: 8px;">Ïó¥</th>
                            <th style="border: 1px solid #f5c6cb; padding: 8px;">ÌïÑÎìúÎ™Ö</th>
                            <th style="border: 1px solid #f5c6cb; padding: 8px;">Ïò§Î•òÎÇ¥Ïö©</th>
                            <th style="border: 1px solid #f5c6cb; padding: 8px;">ÏûÖÎ†•Í∞í</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${errors.map(error => `
                            <tr>
                                <td style="border: 1px solid #f5c6cb; padding: 8px; text-align: center;">${error.row}</td>
                                <td style="border: 1px solid #f5c6cb; padding: 8px; text-align: center;">${error.column}</td>
                                <td style="border: 1px solid #f5c6cb; padding: 8px;">${error.field}</td>
                                <td style="border: 1px solid #f5c6cb; padding: 8px; color: #721c24;">${error.error}</td>
                                <td style="border: 1px solid #f5c6cb; padding: 8px; font-family: monospace; background: #f8f9fa;">${error.value}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        </div>
    `;
}

// Î≤îÏúÑ Ï¥àÍ≥º Îç∞Ïù¥ÌÑ∞ ÌÖåÏù¥Î∏î ÏÉùÏÑ±
function generateOutOfRangeDataTable(outOfRangeData) {
    return `
        <div style="margin-bottom: 20px;">
            <h5 style="color: #856404;">‚ö†Ô∏è NÏó¥ Î≤îÏúÑ Ï¥àÍ≥º Îç∞Ïù¥ÌÑ∞ (${outOfRangeData.length}Í∞ú)</h5>
            <div style="overflow-x: auto;">
                <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                    <thead>
                        <tr style="background: #fff3cd;">
                            <th style="border: 1px solid #ffeaa7; padding: 8px;">Ìñâ</th>
                            <th style="border: 1px solid #ffeaa7; padding: 8px;">Ïó¥</th>
                            <th style="border: 1px solid #ffeaa7; padding: 8px;">Î≤îÏúÑÏ¥àÍ≥º Îç∞Ïù¥ÌÑ∞</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${outOfRangeData.map(data => `
                            <tr>
                                <td style="border: 1px solid #ffeaa7; padding: 8px; text-align: center;">${data.row}</td>
                                <td style="border: 1px solid #ffeaa7; padding: 8px; text-align: center;">${data.column}</td>
                                <td style="border: 1px solid #ffeaa7; padding: 8px; font-family: monospace; background: #f8f9fa;">${data.value}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        </div>
    `;
}

// ÏïåÎ¶º Î©îÏãúÏßÄ ÌëúÏãú
function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed; top: 20px; right: 20px; z-index: 10000;
        padding: 15px 20px; border-radius: 5px; color: white; font-weight: 500;
        ${type === 'success' ? 'background: #28a745;' : 
          type === 'error' ? 'background: #dc3545;' : 'background: #007bff;'}
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        transition: opacity 0.3s ease;
    `;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.opacity = '0';
        setTimeout(() => {
            if (notification.parentNode) {
                document.body.removeChild(notification);
            }
        }, 300);
    }, 3000);
}

// Ï†ÑÏó≠ Ìï®ÏàòÎ°ú ÎÇ¥Î≥¥ÎÇ¥Í∏∞
window.initializeIngredientsPage = initializeIngredientsPage;
window.showUploadSection = showUploadSection;
window.downloadTemplate = downloadTemplate;
window.showUploadHistory = showUploadHistory;
window.hideUploadHistory = hideUploadHistory;
window.filterUploadHistory = filterUploadHistory;
window.searchUploadHistory = searchUploadHistory;
window.showUploadDetails = showUploadDetails;
window.uploadFiles = uploadFiles;
window.handleFileSelect = handleFileSelect;
window.clearFiles = clearFiles;
window.removeFile = removeFile;
window.processSelectedFiles = processSelectedFiles;
window.displayBulkUploadResults = displayBulkUploadResults;

//  Ïù∏Í∑∏Î¶¨ÎîîÏñ∏Ìä∏ Î™®Îìà ÎûòÌçº Ï∂îÍ∞Ä
window.IngredientsModule = {
    async load() {
        const container = document.getElementById('ingredients-module');
        if (!container) return;

        container.innerHTML = `
            <div style="padding: 20px;">
                <h2>ü•¨ ÏãùÏû¨Î£å Í¥ÄÎ¶¨</h2>
                <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <p>ÏãùÏû¨Î£å Í¥ÄÎ¶¨ Î™®ÎìàÏù¥ Î°úÎìúÎêòÏóàÏäµÎãàÎã§.</p>
                    <p><em>Í∏∞Ï°¥ ÏãùÏû¨Î£å Í¥ÄÎ¶¨ Í∏∞Îä•Ïù¥ ÌÜµÌï©ÎêòÏñ¥ ÏûàÏäµÎãàÎã§.</em></p>
                    <button onclick="initializeIngredientsPage()" 
                            style="padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        ÏãùÏû¨Î£å Í¥ÄÎ¶¨ Ï¥àÍ∏∞Ìôî
                    </button>
                </div>
            </div>
        `;

        console.log('ü•¨ Ingredients Module Î°úÎìúÎê® (Í∏∞Ï°¥ Í∏∞Îä• ÌÜµÌï©)');
    }
};

})(); // IIFE Ï¢ÖÎ£å