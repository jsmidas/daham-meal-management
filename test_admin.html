<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‹¤í•¨ì‹ë‹¨ê´€ë¦¬ - ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Malgun Gothic', sans-serif;
            background-color: #f5f5f5;
        }

        .admin-container {
            display: flex;
            height: 100vh;
        }

        /* ì‚¬ì´ë“œë°” */
        .sidebar {
            width: 250px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 0;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }

        .sidebar-header {
            text-align: center;
            padding: 0 20px 30px;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }

        .sidebar-header h2 {
            font-size: 18px;
            font-weight: 600;
        }

        .sidebar-header p {
            font-size: 12px;
            opacity: 0.8;
            margin-top: 5px;
        }

        .nav-menu {
            padding: 20px 0;
        }

        .nav-item {
            display: block;
            padding: 15px 25px;
            color: white;
            text-decoration: none;
            transition: all 0.3s;
            border-left: 3px solid transparent;
        }

        .nav-item:hover, .nav-item.active {
            background: rgba(255,255,255,0.1);
            border-left-color: #ffd700;
        }

        .nav-item .icon {
            margin-right: 10px;
            font-size: 16px;
        }

        /* ë©”ì¸ ì»¨í…ì¸  */
        .main-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .header h1 {
            color: #333;
            font-size: 24px;
        }

        .header-info {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-top: 10px;
        }

        .user-info {
            color: #666;
            font-size: 14px;
        }

        .logout-btn {
            background: #ff6b6b;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .logout-btn:hover {
            background: #ff5252;
        }

        /* ëŒ€ì‹œë³´ë“œ ì¹´ë“œë“¤ */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .dashboard-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .card-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .card-header .icon {
            font-size: 24px;
            margin-right: 10px;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }

        .card-content {
            color: #666;
        }

        .stat-number {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
            margin: 10px 0;
        }

        .stat-label {
            font-size: 14px;
            color: #999;
        }

        /* ìµœê·¼ í™œë™ ë¡œê·¸ */
        .activity-log {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .log-item {
            padding: 12px 0;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
        }

        .log-item:last-child {
            border-bottom: none;
        }

        .log-time {
            font-size: 12px;
            color: #999;
            margin-right: 15px;
            min-width: 100px;
        }

        .log-message {
            color: #666;
            flex: 1;
        }

        .log-user {
            font-size: 12px;
            color: #667eea;
            margin-left: 10px;
        }

        /* ë°˜ì‘í˜• */
        @media (max-width: 768px) {
            .admin-container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: auto;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }

        .hidden {
            display: none;
        }

        /* ì‚¬ìš©ì ê´€ë¦¬ í˜ì´ì§€ ìŠ¤íƒ€ì¼ */
        .page-header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .header-actions {
            display: flex;
            justify-content: between;
            align-items: center;
            gap: 20px;
        }

        .search-box {
            display: flex;
            align-items: center;
            flex: 1;
        }

        .search-box input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px 0 0 5px;
            outline: none;
        }

        .search-box button {
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-left: none;
            border-radius: 0 5px 5px 0;
            background: #f8f9fa;
            cursor: pointer;
        }

        .btn-primary {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.3s;
        }

        .btn-primary:hover {
            background: #5a6fd8;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.3s;
        }

        .btn-secondary:hover {
            background: #545b62;
        }

        .btn-small {
            padding: 5px 10px;
            font-size: 12px;
            border-radius: 3px;
            border: none;
            cursor: pointer;
            margin-right: 5px;
        }

        .btn-edit {
            background: #28a745;
            color: white;
        }

        .btn-delete {
            background: #dc3545;
            color: white;
        }

        .btn-reset {
            background: #ffc107;
            color: black;
        }

        /* í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
        .table-container {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th {
            background: #f8f9fa;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid #dee2e6;
        }

        .data-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #dee2e6;
        }

        .data-table tbody tr:hover {
            background: #f8f9fa;
        }

        .status-active {
            color: #28a745;
            font-weight: 500;
        }

        .status-inactive {
            color: #dc3545;
            font-weight: 500;
        }

        /* í˜ì´ì§€ë„¤ì´ì…˜ */
        .pagination {
            text-align: center;
            padding: 20px;
        }

        .pagination button {
            background: white;
            border: 1px solid #dee2e6;
            padding: 8px 16px;
            margin: 0 5px;
            border-radius: 5px;
            cursor: pointer;
        }

        .pagination button:hover {
            background: #e9ecef;
        }

        .pagination button:disabled {
            background: #f8f9fa;
            color: #6c757d;
            cursor: not-allowed;
        }

        /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            border-radius: 10px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            justify-content: between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
            color: #333;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }

        .modal-close:hover {
            color: #333;
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 20px;
            border-top: 1px solid #dee2e6;
            text-align: right;
        }

        .modal-footer button {
            margin-left: 10px;
        }

        /* í¼ ìŠ¤íƒ€ì¼ */
        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #333;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            outline: none;
        }

        .form-group input:focus,
        .form-group select:focus {
            border-color: #667eea;
        }

        .form-group small {
            display: block;
            margin-top: 5px;
            color: #6c757d;
            font-size: 12px;
        }

        .checkbox-label {
            display: flex !important;
            align-items: center;
            cursor: pointer;
        }

        .checkbox-label input[type="checkbox"] {
            width: auto !important;
            margin-right: 8px;
        }

        /* ì‚¬ì—…ì¥ ê´€ë¦¬ í˜ì´ì§€ ìŠ¤íƒ€ì¼ */
        .action-buttons {
            display: flex;
            gap: 10px;
        }

        .sites-container {
            display: flex;
            gap: 20px;
        }

        .sites-tree {
            flex: 2;
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-height: 600px;
            overflow-y: auto;
        }

        .site-details-panel {
            flex: 1;
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-height: 600px;
            overflow-y: auto;
        }

        .panel-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #dee2e6;
        }

        .panel-header h3 {
            margin: 0;
            color: #333;
        }

        .panel-close {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #999;
        }

        .panel-close:hover {
            color: #333;
        }

        /* íŠ¸ë¦¬ ë…¸ë“œ ìŠ¤íƒ€ì¼ */
        .tree-node {
            margin: 5px 0;
            user-select: none;
        }

        .tree-node-content {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.2s;
            position: relative;
        }

        .tree-node-content:hover {
            background: #f8f9fa;
        }

        .tree-node-content.selected {
            background: #e7f3ff;
            border: 1px solid #b3d9ff;
        }

        .tree-node-content.head-site {
            background: #e8f5e8;
            border-left: 4px solid #28a745;
        }

        .tree-node-content.detail-site {
            background: #fff8e1;
            border-left: 4px solid #ffc107;
        }

        .tree-node-content.period-site {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
        }

        .tree-expand-btn {
            width: 20px;
            height: 20px;
            border: none;
            background: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 5px;
            border-radius: 3px;
        }

        .tree-expand-btn:hover {
            background: #e9ecef;
        }

        .tree-expand-btn.expanded::before {
            content: 'â–¼';
        }

        .tree-expand-btn.collapsed::before {
            content: 'â–¶';
        }

        .tree-expand-btn.no-children {
            visibility: hidden;
        }

        .tree-node-icon {
            margin-right: 8px;
            font-size: 16px;
        }

        .tree-node-label {
            flex: 1;
            font-weight: 500;
            color: #333;
        }

        .tree-node-status {
            font-size: 12px;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 10px;
        }

        .tree-node-status.active {
            background: #d4edda;
            color: #155724;
        }

        .tree-node-status.inactive {
            background: #f8d7da;
            color: #721c24;
        }

        .tree-node-actions {
            display: none;
            margin-left: 10px;
            gap: 5px;
        }

        .tree-node-content:hover .tree-node-actions {
            display: flex;
        }

        .tree-action-btn {
            padding: 2px 6px;
            border: none;
            border-radius: 3px;
            font-size: 12px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .tree-action-btn.add {
            background: #d4edda;
            color: #155724;
        }

        .tree-action-btn.edit {
            background: #cce5ff;
            color: #004085;
        }

        .tree-action-btn.delete {
            background: #f8d7da;
            color: #721c24;
        }

        .tree-action-btn:hover {
            opacity: 0.8;
        }

        /* ìì‹ ë…¸ë“œ ë“¤ì—¬ì“°ê¸° */
        .tree-children {
            margin-left: 25px;
            border-left: 1px solid #dee2e6;
            padding-left: 10px;
        }

        .tree-children.hidden {
            display: none;
        }

        /* ì‚¬ì—…ì¥ ìƒì„¸ ì •ë³´ ìŠ¤íƒ€ì¼ */
        .site-info-group {
            margin-bottom: 15px;
        }

        .site-info-label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 5px;
        }

        .site-info-value {
            color: #333;
            background: #f8f9fa;
            padding: 8px 12px;
            border-radius: 5px;
        }

        .site-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }

        .stat-box {
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            font-size: 12px;
            color: #6c757d;
            margin-top: 5px;
        }

        /* ë“œë˜ê·¸ ì•¤ ë“œë¡­ ìŠ¤íƒ€ì¼ */
        .tree-node-content.dragging {
            opacity: 0.5;
        }

        .tree-node-content.drop-target {
            background: #e7f3ff;
            border: 2px dashed #007bff;
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <!-- ì‚¬ì´ë“œë°” -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <h2>ê´€ë¦¬ì ì‹œìŠ¤í…œ</h2>
                <p>ë‹¤í•¨ì‹ë‹¨ê´€ë¦¬</p>
            </div>
            
            <div class="nav-menu">
                <a href="#" class="nav-item active" data-page="dashboard">
                    <span class="icon">ğŸ“Š</span>ëŒ€ì‹œë³´ë“œ
                </a>
                <a href="#" class="nav-item" data-page="users">
                    <span class="icon">ğŸ‘¥</span>ì‚¬ìš©ì ê´€ë¦¬
                </a>
                <a href="#" class="nav-item" data-page="sites">
                    <span class="icon">ğŸ¢</span>ì‚¬ì—…ì¥ ê´€ë¦¬
                </a>
                <a href="#" class="nav-item" data-page="ingredients">
                    <span class="icon">ğŸ“¦</span>ì‹ìì¬/ì—…ì²´ ê´€ë¦¬
                </a>
                <a href="#" class="nav-item" data-page="pricing">
                    <span class="icon">ğŸ’°</span>ë‹¨ê°€ ê´€ë¦¬
                </a>
                <a href="#" class="nav-item" data-page="settings">
                    <span class="icon">âš™ï¸</span>ì‹œìŠ¤í…œ ì„¤ì •
                </a>
                <a href="#" class="nav-item" data-page="logs">
                    <span class="icon">ğŸ“‹</span>ë¡œê·¸ ê´€ë¦¬
                </a>
            </div>
        </nav>

        <!-- ë©”ì¸ ì»¨í…ì¸  -->
        <main class="main-content">
            <!-- í—¤ë” -->
            <div class="header">
                <div class="header-info">
                    <div>
                        <h1 id="page-title">ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</h1>
                        <div class="user-info">
                            ê´€ë¦¬ìë‹˜, ì•ˆë…•í•˜ì„¸ìš”! | ë§ˆì§€ë§‰ ì ‘ì†: 2025-08-30 12:00
                        </div>
                    </div>
                    <button class="logout-btn" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
                </div>
            </div>

            <!-- ëŒ€ì‹œë³´ë“œ í˜ì´ì§€ -->
            <div id="dashboard-page" class="page-content">
                <div class="dashboard-grid">
                    <div class="dashboard-card">
                        <div class="card-header">
                            <span class="icon">ğŸ‘¥</span>
                            <span class="card-title">ì „ì²´ ì‚¬ìš©ì</span>
                        </div>
                        <div class="card-content">
                            <div class="stat-number" id="total-users">-</div>
                            <div class="stat-label">í™œì„± ì‚¬ìš©ì</div>
                        </div>
                    </div>

                    <div class="dashboard-card">
                        <div class="card-header">
                            <span class="icon">ğŸ¢</span>
                            <span class="card-title">ì‚¬ì—…ì¥ ìˆ˜</span>
                        </div>
                        <div class="card-content">
                            <div class="stat-number" id="total-sites">-</div>
                            <div class="stat-label">ë“±ë¡ëœ ì‚¬ì—…ì¥</div>
                        </div>
                    </div>

                    <div class="dashboard-card">
                        <div class="card-header">
                            <span class="icon">ğŸ“‹</span>
                            <span class="card-title">ì˜¤ëŠ˜ì˜ ì‹ë‹¨</span>
                        </div>
                        <div class="card-content">
                            <div class="stat-number" id="today-menus">-</div>
                            <div class="stat-label">ì˜¤ëŠ˜ í¸ì„±ëœ ì‹ë‹¨</div>
                        </div>
                    </div>

                    <div class="dashboard-card">
                        <div class="card-header">
                            <span class="icon">ğŸ’°</span>
                            <span class="card-title">ë‹¨ê°€ ì—…ë°ì´íŠ¸</span>
                        </div>
                        <div class="card-content">
                            <div class="stat-number" id="price-updates">-</div>
                            <div class="stat-label">ìµœê·¼ 7ì¼ê°„ ì—…ë°ì´íŠ¸</div>
                        </div>
                    </div>
                </div>

                <!-- ìµœê·¼ í™œë™ ë¡œê·¸ -->
                <div class="activity-log">
                    <div class="card-header">
                        <span class="icon">ğŸ“‹</span>
                        <span class="card-title">ìµœê·¼ í™œë™</span>
                    </div>
                    <div id="activity-list">
                        <!-- ë™ì ìœ¼ë¡œ ë¡œë“œë  í™œë™ ë¡œê·¸ -->
                    </div>
                </div>
            </div>

            <!-- ë‹¤ë¥¸ í˜ì´ì§€ë“¤ì€ hidden ìƒíƒœë¡œ ì‹œì‘ -->
            <div id="users-page" class="page-content hidden">
                <!-- ì‚¬ìš©ì ê´€ë¦¬ í—¤ë” -->
                <div class="page-header">
                    <div class="header-actions">
                        <div class="search-box">
                            <input type="text" id="user-search" placeholder="ì‚¬ìš©ì ê²€ìƒ‰ (ì´ë¦„, ì•„ì´ë””, ë¶€ì„œ)">
                            <button onclick="searchUsers()">ğŸ”</button>
                        </div>
                        <button class="btn-primary" onclick="showAddUserModal()">+ ìƒˆ ì‚¬ìš©ì</button>
                    </div>
                </div>

                <!-- ì‚¬ìš©ì ëª©ë¡ í…Œì´ë¸” -->
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>ì‚¬ìš©ìëª…</th>
                                <th>ì—­í• </th>
                                <th>ë¶€ì„œ</th>
                                <th>ë‹´ë‹¹ ì‚¬ì—…ì¥</th>
                                <th>ìƒíƒœ</th>
                                <th>ë§ˆì§€ë§‰ ì ‘ì†</th>
                                <th>ê´€ë¦¬</th>
                            </tr>
                        </thead>
                        <tbody id="users-table-body">
                            <!-- ë™ì ìœ¼ë¡œ ë¡œë“œë  ì‚¬ìš©ì ëª©ë¡ -->
                        </tbody>
                    </table>
                </div>

                <!-- í˜ì´ì§€ë„¤ì´ì…˜ -->
                <div class="pagination">
                    <button onclick="changePage(-1)">ì´ì „</button>
                    <span id="page-info">1 / 1</span>
                    <button onclick="changePage(1)">ë‹¤ìŒ</button>
                </div>
            </div>

            <!-- ì‚¬ìš©ì ì¶”ê°€/ìˆ˜ì • ëª¨ë‹¬ -->
            <div id="user-modal" class="modal hidden">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 id="modal-title">ìƒˆ ì‚¬ìš©ì ì¶”ê°€</h3>
                        <button class="modal-close" onclick="closeUserModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <form id="user-form">
                            <div class="form-group">
                                <label>ì‚¬ìš©ì ID</label>
                                <input type="text" id="user-username" required>
                            </div>
                            <div class="form-group">
                                <label>ë¹„ë°€ë²ˆí˜¸</label>
                                <input type="password" id="user-password">
                                <small>ìˆ˜ì • ì‹œ ë¹„ì›Œë‘ë©´ ë³€ê²½í•˜ì§€ ì•ŠìŒ</small>
                            </div>
                            <div class="form-group">
                                <label>ì—­í• </label>
                                <select id="user-role" required>
                                    <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                                    <option value="nutritionist">ì˜ì–‘ì‚¬</option>
                                    <option value="admin">ê´€ë¦¬ì</option>
                                    <option value="super_admin">ìµœê³ ê´€ë¦¬ì</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>ì—°ë½ì²˜</label>
                                <input type="text" id="user-contact">
                            </div>
                            <div class="form-group">
                                <label>ë¶€ì„œ</label>
                                <input type="text" id="user-department">
                            </div>
                            <div class="form-group">
                                <label>ì§ì±…</label>
                                <input type="text" id="user-position">
                            </div>
                            <div class="form-group">
                                <label>ë‹´ë‹¹ ì‚¬ì—…ì¥</label>
                                <select id="user-managed-site">
                                    <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                                    <!-- ë™ì ìœ¼ë¡œ ë¡œë“œë  ì‚¬ì—…ì¥ ëª©ë¡ -->
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="user-operator">
                                    ìš´ì˜ì ê¶Œí•œ
                                </label>
                            </div>
                            <div class="form-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="user-semi-operator">
                                    ë¶€ìš´ì˜ì ê¶Œí•œ
                                </label>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn-secondary" onclick="closeUserModal()">ì·¨ì†Œ</button>
                        <button type="button" class="btn-primary" onclick="saveUser()">ì €ì¥</button>
                    </div>
                </div>
            </div>

            <div id="sites-page" class="page-content hidden">
                <!-- ì‚¬ì—…ì¥ ê´€ë¦¬ í—¤ë” -->
                <div class="page-header">
                    <div class="header-actions">
                        <div class="action-buttons">
                            <button class="btn-primary" onclick="showAddSiteModal('head')">+ í—¤ë“œ ì‚¬ì—…ì¥</button>
                            <button class="btn-secondary" onclick="expandAllSites()">ì „ì²´ í¼ì¹˜ê¸°</button>
                            <button class="btn-secondary" onclick="collapseAllSites()">ì „ì²´ ì ‘ê¸°</button>
                        </div>
                    </div>
                </div>

                <!-- ì‚¬ì—…ì¥ íŠ¸ë¦¬ êµ¬ì¡° -->
                <div class="sites-container">
                    <div class="sites-tree" id="sites-tree">
                        <!-- ë™ì ìœ¼ë¡œ ë¡œë“œë  ì‚¬ì—…ì¥ íŠ¸ë¦¬ -->
                    </div>
                </div>

                <!-- ì‚¬ì—…ì¥ ìƒì„¸ ì •ë³´ íŒ¨ë„ -->
                <div class="site-details-panel hidden" id="site-details-panel">
                    <div class="panel-header">
                        <h3 id="site-details-title">ì‚¬ì—…ì¥ ìƒì„¸ì •ë³´</h3>
                        <button class="panel-close" onclick="closeSiteDetails()">&times;</button>
                    </div>
                    <div class="panel-content" id="site-details-content">
                        <!-- ë™ì ìœ¼ë¡œ ë¡œë“œë  ìƒì„¸ì •ë³´ -->
                    </div>
                </div>
            </div>

            <!-- ì‚¬ì—…ì¥ ì¶”ê°€/ìˆ˜ì • ëª¨ë‹¬ -->
            <div id="site-modal" class="modal hidden">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 id="site-modal-title">ìƒˆ ì‚¬ì—…ì¥ ì¶”ê°€</h3>
                        <button class="modal-close" onclick="closeSiteModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <form id="site-form">
                            <input type="hidden" id="site-parent-id">
                            <input type="hidden" id="site-type">
                            
                            <div class="form-group">
                                <label>ì‚¬ì—…ì¥ëª…</label>
                                <input type="text" id="site-name" required>
                            </div>
                            
                            <div class="form-group">
                                <label>ë‹´ë‹¹ì</label>
                                <input type="text" id="site-contact-person">
                            </div>
                            
                            <div class="form-group">
                                <label>ì—°ë½ì²˜</label>
                                <input type="text" id="site-contact-phone">
                            </div>
                            
                            <div class="form-group">
                                <label>ì£¼ì†Œ</label>
                                <textarea id="site-address" rows="3"></textarea>
                            </div>
                            
                            <div class="form-group">
                                <label>1ì¸ë‹¹ ì œê³µëŸ‰ (g)</label>
                                <input type="number" id="site-portion-size" min="0">
                            </div>
                            
                            <div class="form-group">
                                <label>ì„¤ëª…</label>
                                <textarea id="site-description" rows="3"></textarea>
                            </div>
                            
                            <div class="form-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="site-is-active" checked>
                                    í™œì„± ìƒíƒœ
                                </label>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn-secondary" onclick="closeSiteModal()">ì·¨ì†Œ</button>
                        <button type="button" class="btn-primary" onclick="saveSite()">ì €ì¥</button>
                    </div>
                </div>
            </div>

            <div id="ingredients-page" class="page-content hidden">
                <h2>ì‹ìì¬/ì—…ì²´ ê´€ë¦¬ í˜ì´ì§€</h2>
                <p>ì‹ìì¬/ì—…ì²´ ê´€ë¦¬ ê¸°ëŠ¥ì´ ì—¬ê¸°ì— êµ¬í˜„ë  ì˜ˆì •ì…ë‹ˆë‹¤.</p>
            </div>

            <div id="pricing-page" class="page-content hidden">
                <h2>ë‹¨ê°€ ê´€ë¦¬ í˜ì´ì§€</h2>
                <p>ë‹¨ê°€ ê´€ë¦¬ ê¸°ëŠ¥ì´ ì—¬ê¸°ì— êµ¬í˜„ë  ì˜ˆì •ì…ë‹ˆë‹¤.</p>
            </div>

            <div id="settings-page" class="page-content hidden">
                <h2>ì‹œìŠ¤í…œ ì„¤ì • í˜ì´ì§€</h2>
                <p>ì‹œìŠ¤í…œ ì„¤ì • ê¸°ëŠ¥ì´ ì—¬ê¸°ì— êµ¬í˜„ë  ì˜ˆì •ì…ë‹ˆë‹¤.</p>
            </div>

            <div id="logs-page" class="page-content hidden">
                <h2>ë¡œê·¸ ê´€ë¦¬ í˜ì´ì§€</h2>
                <p>ë¡œê·¸ ê´€ë¦¬ ê¸°ëŠ¥ì´ ì—¬ê¸°ì— êµ¬í˜„ë  ì˜ˆì •ì…ë‹ˆë‹¤.</p>
            </div>
        </main>
    </div>

    <script>
        // í˜ì´ì§€ ë„¤ë¹„ê²Œì´ì…˜ ê´€ë¦¬
        function showPage(pageName) {
            // ëª¨ë“  í˜ì´ì§€ ìˆ¨ê¸°ê¸°
            document.querySelectorAll('.page-content').forEach(page => {
                page.classList.add('hidden');
            });
            
            // ì„ íƒëœ í˜ì´ì§€ ë³´ì´ê¸°
            const targetPage = document.getElementById(`${pageName}-page`);
            if (targetPage) {
                targetPage.classList.remove('hidden');
            }
            
            // ë„¤ë¹„ê²Œì´ì…˜ í™œì„± ìƒíƒœ ë³€ê²½
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            const activeItem = document.querySelector(`[data-page="${pageName}"]`);
            if (activeItem) {
                activeItem.classList.add('active');
            }
            
            // í˜ì´ì§€ ì œëª© ë³€ê²½
            const titles = {
                'dashboard': 'ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ',
                'users': 'ì‚¬ìš©ì ê´€ë¦¬',
                'sites': 'ì‚¬ì—…ì¥ ê´€ë¦¬', 
                'ingredients': 'ì‹ìì¬/ì—…ì²´ ê´€ë¦¬',
                'pricing': 'ë‹¨ê°€ ê´€ë¦¬',
                'settings': 'ì‹œìŠ¤í…œ ì„¤ì •',
                'logs': 'ë¡œê·¸ ê´€ë¦¬'
            };
            
            document.getElementById('page-title').textContent = titles[pageName] || 'ê´€ë¦¬ì ì‹œìŠ¤í…œ';
        }


        // ë„¤ë¹„ê²Œì´ì…˜ í´ë¦­ ì´ë²¤íŠ¸
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', (e) => {
                e.preventDefault();
                const pageName = e.currentTarget.getAttribute('data-page');
                showPage(pageName);
                
                // í˜ì´ì§€ë³„ ì´ˆê¸°í™”
                if (pageName === 'users') {
                    loadUsers();
                    loadManagedSites();
                } else if (pageName === 'sites') {
                    loadSitesTree();
                }
            });
        });

        // ë¡œê·¸ì•„ì›ƒ í•¨ìˆ˜
        function logout() {
            if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                window.location.href = '/';
            }
        }

        // ëŒ€ì‹œë³´ë“œ ë°ì´í„° ë¡œë“œ
        async function loadDashboardData() {
            try {
                // í†µê³„ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                const response = await fetch('/api/admin/dashboard-stats');
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('total-users').textContent = data.totalUsers || 0;
                    document.getElementById('total-sites').textContent = data.totalSites || 0;
                    document.getElementById('today-menus').textContent = data.todayMenus || 0;
                    document.getElementById('price-updates').textContent = data.priceUpdates || 0;
                }
            } catch (error) {
                console.error('ëŒ€ì‹œë³´ë“œ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        // ìµœê·¼ í™œë™ ë¡œê·¸ ë¡œë“œ
        async function loadRecentActivity() {
            try {
                const response = await fetch('/api/admin/recent-activity');
                const activities = await response.json();
                
                const activityList = document.getElementById('activity-list');
                if (activities.length === 0) {
                    activityList.innerHTML = '<div class="log-item">ìµœê·¼ í™œë™ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                    return;
                }
                
                activityList.innerHTML = activities.map(activity => `
                    <div class="log-item">
                        <div class="log-time">${activity.time}</div>
                        <div class="log-message">${activity.message}</div>
                        <div class="log-user">${activity.user}</div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('í™œë™ ë¡œê·¸ ë¡œë“œ ì‹¤íŒ¨:', error);
                document.getElementById('activity-list').innerHTML = 
                    '<div class="log-item">í™œë™ ë¡œê·¸ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
            }
        }

        // í˜ì´ì§€ ë¡œë“œì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', () => {
            // ëª¨ë“  ëª¨ë‹¬ì„ ëª…ì‹œì ìœ¼ë¡œ ìˆ¨ê¹€
            document.getElementById('user-modal').classList.add('hidden');
            document.getElementById('site-modal').classList.add('hidden');
            
            // ë³€ìˆ˜ ì´ˆê¸°í™”
            currentEditUserId = null;
            currentEditSiteId = null;
            
            // ê¸°ë³¸ìœ¼ë¡œ ëŒ€ì‹œë³´ë“œ í˜ì´ì§€ í‘œì‹œ
            showPage('dashboard');
            loadDashboardData();
            loadRecentActivity();
        });

        // ì‚¬ìš©ì ê´€ë¦¬ ê´€ë ¨ ë³€ìˆ˜
        let currentPage = 1;
        let totalPages = 1;
        let currentEditUserId = null;

        // ì‚¬ìš©ì ê´€ë¦¬ í•¨ìˆ˜ë“¤

        // ì‚¬ìš©ì ëª©ë¡ ë¡œë“œ
        async function loadUsers() {
            try {
                const response = await fetch('/api/admin/users');
                const data = await response.json();
                
                if (data.success) {
                    displayUsers(data.users);
                    updatePagination(data.currentPage, data.totalPages);
                }
            } catch (error) {
                console.error('ì‚¬ìš©ì ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
                document.getElementById('users-table-body').innerHTML = 
                    '<tr><td colspan="8">ì‚¬ìš©ì ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
            }
        }

        // ì‚¬ìš©ì ëª©ë¡ í‘œì‹œ
        function displayUsers(users) {
            const tbody = document.getElementById('users-table-body');
            
            if (!users || users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8">ë“±ë¡ëœ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                return;
            }
            
            tbody.innerHTML = users.map(user => `
                <tr>
                    <td>${user.id}</td>
                    <td>${user.username}</td>
                    <td>${getRoleDisplay(user.role)}</td>
                    <td>${user.department || '-'}</td>
                    <td>${user.managed_site || '-'}</td>
                    <td><span class="${user.is_active ? 'status-active' : 'status-inactive'}">
                        ${user.is_active ? 'í™œì„±' : 'ë¹„í™œì„±'}
                    </span></td>
                    <td>${user.last_login || 'ì ‘ì† ê¸°ë¡ ì—†ìŒ'}</td>
                    <td>
                        <button class="btn-small btn-edit" onclick="editUser(${user.id})">ìˆ˜ì •</button>
                        <button class="btn-small btn-reset" onclick="resetPassword(${user.id})">ì´ˆê¸°í™”</button>
                        <button class="btn-small btn-delete" onclick="deleteUser(${user.id})">ì‚­ì œ</button>
                    </td>
                </tr>
            `).join('');
        }

        // ì—­í•  í‘œì‹œëª… ë³€í™˜
        function getRoleDisplay(role) {
            const roleMap = {
                'nutritionist': 'ì˜ì–‘ì‚¬',
                'admin': 'ê´€ë¦¬ì', 
                'super_admin': 'ìµœê³ ê´€ë¦¬ì'
            };
            return roleMap[role] || role;
        }

        // í˜ì´ì§€ë„¤ì´ì…˜ ì—…ë°ì´íŠ¸
        function updatePagination(current, total) {
            currentPage = current;
            totalPages = total;
            document.getElementById('page-info').textContent = `${current} / ${total}`;
        }

        // í˜ì´ì§€ ë³€ê²½
        function changePage(direction) {
            const newPage = currentPage + direction;
            if (newPage >= 1 && newPage <= totalPages) {
                currentPage = newPage;
                loadUsers();
            }
        }

        // ì‚¬ìš©ì ê²€ìƒ‰
        function searchUsers() {
            const keyword = document.getElementById('user-search').value;
            // ì‹¤ì œ êµ¬í˜„ì—ì„œëŠ” ê²€ìƒ‰ API í˜¸ì¶œ
            console.log('ê²€ìƒ‰ í‚¤ì›Œë“œ:', keyword);
            loadUsers(); // ì„ì‹œë¡œ ì „ì²´ ëª©ë¡ ë‹¤ì‹œ ë¡œë“œ
        }

        // ë‹´ë‹¹ ì‚¬ì—…ì¥ ëª©ë¡ ë¡œë“œ
        async function loadManagedSites() {
            try {
                const response = await fetch('/api/admin/sites');
                const sites = await response.json();
                
                const select = document.getElementById('user-managed-site');
                select.innerHTML = '<option value="">ì„ íƒí•˜ì„¸ìš”</option>';
                
                sites.forEach(site => {
                    select.innerHTML += `<option value="${site.name}">${site.name}</option>`;
                });
            } catch (error) {
                console.error('ì‚¬ì—…ì¥ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        // ìƒˆ ì‚¬ìš©ì ì¶”ê°€ ëª¨ë‹¬ í‘œì‹œ
        function showAddUserModal() {
            currentEditUserId = null;
            document.getElementById('modal-title').textContent = 'ìƒˆ ì‚¬ìš©ì ì¶”ê°€';
            document.getElementById('user-form').reset();
            document.getElementById('user-modal').classList.remove('hidden');
        }

        // ì‚¬ìš©ì ìˆ˜ì • ëª¨ë‹¬ í‘œì‹œ
        async function editUser(userId) {
            try {
                const response = await fetch(`/api/admin/users/${userId}`);
                const user = await response.json();
                
                if (user) {
                    currentEditUserId = userId;
                    document.getElementById('modal-title').textContent = 'ì‚¬ìš©ì ì •ë³´ ìˆ˜ì •';
                    
                    // í¼ì— ê¸°ì¡´ ë°ì´í„° ì±„ìš°ê¸°
                    document.getElementById('user-username').value = user.username;
                    document.getElementById('user-password').value = ''; // ë¹„ë°€ë²ˆí˜¸ëŠ” ë¹„ì›€
                    document.getElementById('user-role').value = user.role;
                    document.getElementById('user-contact').value = user.contact_info || '';
                    document.getElementById('user-department').value = user.department || '';
                    document.getElementById('user-position').value = user.position || '';
                    document.getElementById('user-managed-site').value = user.managed_site || '';
                    document.getElementById('user-operator').checked = user.operator || false;
                    document.getElementById('user-semi-operator').checked = user.semi_operator || false;
                    
                    document.getElementById('user-modal').classList.remove('hidden');
                }
            } catch (error) {
                console.error('ì‚¬ìš©ì ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', error);
                alert('ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            }
        }

        // ì‚¬ìš©ì ëª¨ë‹¬ ë‹«ê¸°
        function closeUserModal() {
            document.getElementById('user-modal').classList.add('hidden');
            currentEditUserId = null;
        }

        // ì‚¬ìš©ì ì €ì¥
        async function saveUser() {
            const userData = {
                username: document.getElementById('user-username').value,
                password: document.getElementById('user-password').value,
                role: document.getElementById('user-role').value,
                contact_info: document.getElementById('user-contact').value,
                department: document.getElementById('user-department').value,
                position: document.getElementById('user-position').value,
                managed_site: document.getElementById('user-managed-site').value,
                operator: document.getElementById('user-operator').checked,
                semi_operator: document.getElementById('user-semi-operator').checked
            };

            try {
                const url = currentEditUserId ? 
                    `/api/admin/users/${currentEditUserId}` : 
                    '/api/admin/users';
                
                const method = currentEditUserId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(userData)
                });

                const result = await response.json();
                
                if (result.success) {
                    alert(currentEditUserId ? 'ì‚¬ìš©ìê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.' : 'ìƒˆ ì‚¬ìš©ìê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    closeUserModal();
                    loadUsers();
                } else {
                    alert(result.message || 'ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('ì‚¬ìš©ì ì €ì¥ ì‹¤íŒ¨:', error);
                alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ë¹„ë°€ë²ˆí˜¸ ì´ˆê¸°í™”
        async function resetPassword(userId) {
            if (!confirm('ì´ ì‚¬ìš©ìì˜ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }

            try {
                const response = await fetch(`/api/admin/users/${userId}/reset-password`, {
                    method: 'POST'
                });

                const result = await response.json();
                
                if (result.success) {
                    alert(`ë¹„ë°€ë²ˆí˜¸ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤. ìƒˆ ë¹„ë°€ë²ˆí˜¸: ${result.newPassword}`);
                } else {
                    alert('ë¹„ë°€ë²ˆí˜¸ ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('ë¹„ë°€ë²ˆí˜¸ ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
                alert('ë¹„ë°€ë²ˆí˜¸ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ì‚¬ìš©ì ì‚­ì œ
        async function deleteUser(userId) {
            if (!confirm('ì´ ì‚¬ìš©ìë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ì·¨ì†Œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
                return;
            }

            try {
                const response = await fetch(`/api/admin/users/${userId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();
                
                if (result.success) {
                    alert('ì‚¬ìš©ìê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    loadUsers();
                } else {
                    alert('ì‚¬ìš©ì ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('ì‚¬ìš©ì ì‚­ì œ ì‹¤íŒ¨:', error);
                alert('ì‚¬ìš©ì ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ì‚¬ì—…ì¥ ê´€ë¦¬ ê´€ë ¨ ë³€ìˆ˜
        let sitesData = [];
        let selectedSiteId = null;
        let currentEditSiteId = null;

        // ì‚¬ì—…ì¥ íŠ¸ë¦¬ ë¡œë“œ
        async function loadSitesTree() {
            try {
                const response = await fetch('/api/admin/sites/tree');
                const data = await response.json();
                
                if (data.success) {
                    sitesData = data.sites;
                    renderSitesTree();
                }
            } catch (error) {
                console.error('ì‚¬ì—…ì¥ íŠ¸ë¦¬ ë¡œë“œ ì‹¤íŒ¨:', error);
                document.getElementById('sites-tree').innerHTML = 
                    '<div class="text-center">ì‚¬ì—…ì¥ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
            }
        }

        // ì‚¬ì—…ì¥ íŠ¸ë¦¬ ë Œë”ë§
        function renderSitesTree() {
            const container = document.getElementById('sites-tree');
            container.innerHTML = '';
            
            if (sitesData.length === 0) {
                container.innerHTML = '<div class="text-center">ë“±ë¡ëœ ì‚¬ì—…ì¥ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }
            
            // í—¤ë“œ ì‚¬ì—…ì¥ë“¤ ë Œë”ë§
            const headSites = sitesData.filter(site => site.site_type === 'head');
            headSites.forEach(site => {
                container.appendChild(createTreeNode(site));
            });
        }

        // íŠ¸ë¦¬ ë…¸ë“œ ìƒì„±
        function createTreeNode(site) {
            const nodeDiv = document.createElement('div');
            nodeDiv.className = 'tree-node';
            nodeDiv.dataset.siteId = site.id;
            
            const contentDiv = document.createElement('div');
            contentDiv.className = `tree-node-content ${site.site_type}-site`;
            contentDiv.onclick = () => selectSite(site.id);
            
            // í™•ì¥/ì¶•ì†Œ ë²„íŠ¼
            const expandBtn = document.createElement('button');
            expandBtn.className = 'tree-expand-btn';
            const hasChildren = site.children && site.children.length > 0;
            
            if (hasChildren) {
                expandBtn.className += ' expanded';
                expandBtn.onclick = (e) => {
                    e.stopPropagation();
                    toggleNode(site.id);
                };
            } else {
                expandBtn.className += ' no-children';
            }
            
            // ì•„ì´ì½˜
            const iconSpan = document.createElement('span');
            iconSpan.className = 'tree-node-icon';
            iconSpan.textContent = getSiteIcon(site.site_type);
            
            // ë¼ë²¨
            const labelSpan = document.createElement('span');
            labelSpan.className = 'tree-node-label';
            labelSpan.textContent = site.name;
            
            // ìƒíƒœ
            const statusSpan = document.createElement('span');
            statusSpan.className = `tree-node-status ${site.is_active ? 'active' : 'inactive'}`;
            statusSpan.textContent = site.is_active ? 'í™œì„±' : 'ë¹„í™œì„±';
            
            // ì•¡ì…˜ ë²„íŠ¼ë“¤
            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'tree-node-actions';
            
            if (site.site_type === 'head') {
                const addDetailBtn = document.createElement('button');
                addDetailBtn.className = 'tree-action-btn add';
                addDetailBtn.textContent = '+ ì„¸ë¶€';
                addDetailBtn.onclick = (e) => {
                    e.stopPropagation();
                    showAddSiteModal('detail', site.id);
                };
                actionsDiv.appendChild(addDetailBtn);
            } else if (site.site_type === 'detail') {
                const addPeriodBtn = document.createElement('button');
                addPeriodBtn.className = 'tree-action-btn add';
                addPeriodBtn.textContent = '+ ê¸°ê°„';
                addPeriodBtn.onclick = (e) => {
                    e.stopPropagation();
                    showAddSiteModal('period', site.id);
                };
                actionsDiv.appendChild(addPeriodBtn);
            }
            
            const editBtn = document.createElement('button');
            editBtn.className = 'tree-action-btn edit';
            editBtn.textContent = 'ìˆ˜ì •';
            editBtn.onclick = (e) => {
                e.stopPropagation();
                editSite(site.id);
            };
            
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'tree-action-btn delete';
            deleteBtn.textContent = 'ì‚­ì œ';
            deleteBtn.onclick = (e) => {
                e.stopPropagation();
                deleteSite(site.id);
            };
            
            actionsDiv.appendChild(editBtn);
            actionsDiv.appendChild(deleteBtn);
            
            // ì»¨í…ì¸  ì¡°ë¦½
            contentDiv.appendChild(expandBtn);
            contentDiv.appendChild(iconSpan);
            contentDiv.appendChild(labelSpan);
            contentDiv.appendChild(statusSpan);
            contentDiv.appendChild(actionsDiv);
            
            nodeDiv.appendChild(contentDiv);
            
            // ìì‹ ë…¸ë“œë“¤
            if (hasChildren) {
                const childrenDiv = document.createElement('div');
                childrenDiv.className = 'tree-children';
                site.children.forEach(child => {
                    childrenDiv.appendChild(createTreeNode(child));
                });
                nodeDiv.appendChild(childrenDiv);
            }
            
            return nodeDiv;
        }

        // ì‚¬ì—…ì¥ ì•„ì´ì½˜ ê°€ì ¸ì˜¤ê¸°
        function getSiteIcon(siteType) {
            switch (siteType) {
                case 'head': return 'ğŸ¢';
                case 'detail': return 'ğŸ«';
                case 'period': return 'ğŸ“…';
                default: return 'ğŸ“';
            }
        }

        // ë…¸ë“œ í™•ì¥/ì¶•ì†Œ
        function toggleNode(siteId) {
            const node = document.querySelector(`[data-site-id="${siteId}"]`);
            if (!node) return;
            
            const expandBtn = node.querySelector('.tree-expand-btn');
            const childrenDiv = node.querySelector('.tree-children');
            
            if (!childrenDiv) return;
            
            if (expandBtn.classList.contains('expanded')) {
                expandBtn.className = expandBtn.className.replace('expanded', 'collapsed');
                childrenDiv.classList.add('hidden');
            } else {
                expandBtn.className = expandBtn.className.replace('collapsed', 'expanded');
                childrenDiv.classList.remove('hidden');
            }
        }

        // ëª¨ë“  ë…¸ë“œ í™•ì¥
        function expandAllSites() {
            document.querySelectorAll('.tree-expand-btn.collapsed').forEach(btn => {
                btn.className = btn.className.replace('collapsed', 'expanded');
            });
            document.querySelectorAll('.tree-children.hidden').forEach(children => {
                children.classList.remove('hidden');
            });
        }

        // ëª¨ë“  ë…¸ë“œ ì¶•ì†Œ
        function collapseAllSites() {
            document.querySelectorAll('.tree-expand-btn.expanded').forEach(btn => {
                btn.className = btn.className.replace('expanded', 'collapsed');
            });
            document.querySelectorAll('.tree-children').forEach(children => {
                children.classList.add('hidden');
            });
        }

        // ì‚¬ì—…ì¥ ì„ íƒ
        function selectSite(siteId) {
            // ì´ì „ ì„ íƒ í•´ì œ
            document.querySelectorAll('.tree-node-content.selected').forEach(node => {
                node.classList.remove('selected');
            });
            
            // ìƒˆ ì„ íƒ
            const node = document.querySelector(`[data-site-id="${siteId}"] .tree-node-content`);
            if (node) {
                node.classList.add('selected');
                selectedSiteId = siteId;
                showSiteDetails(siteId);
            }
        }

        // ì‚¬ì—…ì¥ ìƒì„¸ì •ë³´ í‘œì‹œ
        async function showSiteDetails(siteId) {
            try {
                const response = await fetch(`/api/admin/sites/${siteId}`);
                const site = await response.json();
                
                const panel = document.getElementById('site-details-panel');
                const content = document.getElementById('site-details-content');
                
                content.innerHTML = `
                    <div class="site-info-group">
                        <div class="site-info-label">ì‚¬ì—…ì¥ëª…</div>
                        <div class="site-info-value">${site.name}</div>
                    </div>
                    <div class="site-info-group">
                        <div class="site-info-label">ìœ í˜•</div>
                        <div class="site-info-value">${getSiteTypeDisplay(site.site_type)}</div>
                    </div>
                    <div class="site-info-group">
                        <div class="site-info-label">ë‹´ë‹¹ì</div>
                        <div class="site-info-value">${site.contact_person || '-'}</div>
                    </div>
                    <div class="site-info-group">
                        <div class="site-info-label">ì—°ë½ì²˜</div>
                        <div class="site-info-value">${site.contact_phone || '-'}</div>
                    </div>
                    <div class="site-info-group">
                        <div class="site-info-label">ì£¼ì†Œ</div>
                        <div class="site-info-value">${site.address || '-'}</div>
                    </div>
                    <div class="site-info-group">
                        <div class="site-info-label">1ì¸ë‹¹ ì œê³µëŸ‰</div>
                        <div class="site-info-value">${site.portion_size || 0}g</div>
                    </div>
                    <div class="site-stats">
                        <div class="stat-box">
                            <div class="stat-number">${site.menu_count || 0}</div>
                            <div class="stat-label">ë“±ë¡ëœ ì‹ë‹¨</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-number">${site.children_count || 0}</div>
                            <div class="stat-label">í•˜ìœ„ ì‚¬ì—…ì¥</div>
                        </div>
                    </div>
                `;
                
                panel.classList.remove('hidden');
            } catch (error) {
                console.error('ì‚¬ì—…ì¥ ìƒì„¸ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        // ì‚¬ì—…ì¥ ìœ í˜• í‘œì‹œëª…
        function getSiteTypeDisplay(siteType) {
            switch (siteType) {
                case 'head': return 'í—¤ë“œ ì‚¬ì—…ì¥';
                case 'detail': return 'ì„¸ë¶€ ì‚¬ì—…ì¥';
                case 'period': return 'ê¸°ê°„ë³„ ì‚¬ì—…ì¥';
                default: return siteType;
            }
        }

        // ìƒì„¸ì •ë³´ íŒ¨ë„ ë‹«ê¸°
        function closeSiteDetails() {
            document.getElementById('site-details-panel').classList.add('hidden');
            selectedSiteId = null;
            
            // ì„ íƒ í•´ì œ
            document.querySelectorAll('.tree-node-content.selected').forEach(node => {
                node.classList.remove('selected');
            });
        }

        // ì‚¬ì—…ì¥ ì¶”ê°€ ëª¨ë‹¬ í‘œì‹œ
        function showAddSiteModal(siteType, parentId = null) {
            currentEditSiteId = null;
            
            document.getElementById('site-modal-title').textContent = `ìƒˆ ${getSiteTypeDisplay(siteType)} ì¶”ê°€`;
            document.getElementById('site-form').reset();
            document.getElementById('site-parent-id').value = parentId || '';
            document.getElementById('site-type').value = siteType;
            document.getElementById('site-is-active').checked = true;
            
            document.getElementById('site-modal').classList.remove('hidden');
        }

        // ì‚¬ì—…ì¥ ìˆ˜ì •
        async function editSite(siteId) {
            try {
                const response = await fetch(`/api/admin/sites/${siteId}`);
                const site = await response.json();
                
                currentEditSiteId = siteId;
                document.getElementById('site-modal-title').textContent = 'ì‚¬ì—…ì¥ ì •ë³´ ìˆ˜ì •';
                
                // í¼ì— ê¸°ì¡´ ë°ì´í„° ì±„ìš°ê¸°
                document.getElementById('site-name').value = site.name;
                document.getElementById('site-contact-person').value = site.contact_person || '';
                document.getElementById('site-contact-phone').value = site.contact_phone || '';
                document.getElementById('site-address').value = site.address || '';
                document.getElementById('site-portion-size').value = site.portion_size || '';
                document.getElementById('site-description').value = site.description || '';
                document.getElementById('site-is-active').checked = site.is_active;
                
                document.getElementById('site-modal').classList.remove('hidden');
            } catch (error) {
                console.error('ì‚¬ì—…ì¥ ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', error);
                alert('ì‚¬ì—…ì¥ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            }
        }

        // ì‚¬ì—…ì¥ ì‚­ì œ
        async function deleteSite(siteId) {
            if (!confirm('ì´ ì‚¬ì—…ì¥ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? í•˜ìœ„ ì‚¬ì—…ì¥ë„ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤.')) {
                return;
            }

            try {
                const response = await fetch(`/api/admin/sites/${siteId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();
                
                if (result.success) {
                    alert('ì‚¬ì—…ì¥ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    loadSitesTree();
                    closeSiteDetails();
                } else {
                    alert('ì‚¬ì—…ì¥ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('ì‚¬ì—…ì¥ ì‚­ì œ ì‹¤íŒ¨:', error);
                alert('ì‚¬ì—…ì¥ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ì‚¬ì—…ì¥ ëª¨ë‹¬ ë‹«ê¸°
        function closeSiteModal() {
            document.getElementById('site-modal').classList.add('hidden');
            currentEditSiteId = null;
        }

        // ì‚¬ì—…ì¥ ì €ì¥
        async function saveSite() {
            const siteData = {
                name: document.getElementById('site-name').value,
                contact_person: document.getElementById('site-contact-person').value,
                contact_phone: document.getElementById('site-contact-phone').value,
                address: document.getElementById('site-address').value,
                portion_size: parseInt(document.getElementById('site-portion-size').value) || null,
                description: document.getElementById('site-description').value,
                is_active: document.getElementById('site-is-active').checked
            };

            if (!currentEditSiteId) {
                // ìƒˆ ì‚¬ì—…ì¥ ì¶”ê°€
                siteData.site_type = document.getElementById('site-type').value;
                siteData.parent_id = document.getElementById('site-parent-id').value || null;
            }

            try {
                const url = currentEditSiteId ? 
                    `/api/admin/sites/${currentEditSiteId}` : 
                    '/api/admin/sites';
                
                const method = currentEditSiteId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(siteData)
                });

                const result = await response.json();
                
                if (result.success) {
                    alert(currentEditSiteId ? 'ì‚¬ì—…ì¥ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.' : 'ìƒˆ ì‚¬ì—…ì¥ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    closeSiteModal();
                    loadSitesTree();
                } else {
                    alert(result.message || 'ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('ì‚¬ì—…ì¥ ì €ì¥ ì‹¤íŒ¨:', error);
                alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }
    </script>
</body>
</html>