<!-- 식단관리 페이지 컨텐츠 (마스터 레이아웃용) -->
<div style="padding: 0; margin: 0;">
    <!-- 페이지 헤더 -->
    <div style="background: linear-gradient(135deg, #F5881F 0%, #E67309 100%); color: white; padding: 25px; border-radius: 12px; margin-bottom: 25px; box-shadow: 0 4px 15px rgba(245, 136, 31, 0.2);">
        <h1 style="font-size: 24px; margin-bottom: 8px; display: flex; align-items: center; gap: 10px;">
            <i class="fas fa-utensils"></i>
            식단표 작성
        </h1>
        <p style="opacity: 0.9; font-size: 14px; margin: 0;" id="mealPlanDate">2025년 8월 29일 식단 작성</p>
    </div>

    <!-- 메인 컨텐츠 -->
    <div style="display: grid; grid-template-columns: 350px 1fr; gap: 25px; height: calc(100vh - 300px);">
        <!-- 좌측 레시피 검색 패널 -->
        <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); overflow: hidden;">
            <h3 style="font-size: 16px; margin-bottom: 15px; color: #333; border-bottom: 2px solid #e0e0e0; padding-bottom: 8px;">
                <i class="fas fa-search" style="color: #F5881F; margin-right: 8px;"></i>
                레시피 검색
            </h3>
            
            <div style="position: relative; margin-bottom: 15px;">
                <input type="text" id="recipeSearchInput" placeholder="레시피명을 입력하세요..." 
                       style="width: 100%; padding: 10px 35px 10px 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; transition: all 0.3s ease;"
                       onkeyup="searchRecipes()" onfocus="this.style.borderColor='#F5881F'" onblur="this.style.borderColor='#e0e0e0'">
                <button onclick="searchRecipes()" style="position: absolute; right: 5px; top: 50%; transform: translateY(-50%); background: #F5881F; border: none; color: white; padding: 6px 10px; border-radius: 6px; cursor: pointer;">
                    <i class="fas fa-search"></i>
                </button>
            </div>
            
            <div style="max-height: calc(100vh - 400px); overflow-y: auto;">
                <div id="recipeResults" style="display: flex; flex-direction: column; gap: 8px;">
                    <div style="text-align: center; color: #666; padding: 20px;">
                        <i class="fas fa-search" style="font-size: 32px; color: #ccc; margin-bottom: 10px;"></i>
                        <p>레시피를 검색해보세요</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 우측 식단표 작성 영역 -->
        <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); overflow: hidden;">
            <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #e0e0e0; padding-bottom: 15px;">
                <h3 style="font-size: 16px; color: #333; margin: 0;">
                    <i class="fas fa-clipboard-list" style="color: #F5881F; margin-right: 8px;"></i>
                    식단표 구성
                </h3>
                <div style="display: flex; gap: 10px;">
                    <button onclick="saveDietPlan()" style="background: #28a745; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-size: 13px; display: flex; align-items: center; gap: 5px;">
                        <i class="fas fa-save"></i> 저장
                    </button>
                    <button onclick="clearDietPlan()" style="background: #dc3545; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-size: 13px; display: flex; align-items: center; gap: 5px;">
                        <i class="fas fa-trash"></i> 초기화
                    </button>
                </div>
            </div>

            <!-- 식단 시간대별 구성 -->
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; height: calc(100% - 80px);">
                <!-- 조식 -->
                <div style="border: 2px dashed #28a745; border-radius: 8px; padding: 15px; background: #f8fff8;">
                    <h4 style="color: #28a745; margin-bottom: 12px; font-size: 14px; text-align: center; border-bottom: 1px solid #28a745; padding-bottom: 5px;">
                        <i class="fas fa-sun"></i> 조식
                    </h4>
                    <div id="breakfast-menu" class="meal-slot" style="min-height: 200px; max-height: calc(100vh - 500px); overflow-y: auto;">
                        <div class="empty-slot" style="text-align: center; color: #28a745; padding: 20px; opacity: 0.7;">
                            <i class="fas fa-plus-circle" style="font-size: 24px; margin-bottom: 8px;"></i>
                            <p style="font-size: 12px;">레시피를 드래그하여<br>추가하세요</p>
                        </div>
                    </div>
                </div>

                <!-- 중식 -->
                <div style="border: 2px dashed #F5881F; border-radius: 8px; padding: 15px; background: #fff8f0;">
                    <h4 style="color: #F5881F; margin-bottom: 12px; font-size: 14px; text-align: center; border-bottom: 1px solid #F5881F; padding-bottom: 5px;">
                        <i class="fas fa-sun"></i> 중식
                    </h4>
                    <div id="lunch-menu" class="meal-slot" style="min-height: 200px; max-height: calc(100vh - 500px); overflow-y: auto;">
                        <div class="empty-slot" style="text-align: center; color: #F5881F; padding: 20px; opacity: 0.7;">
                            <i class="fas fa-plus-circle" style="font-size: 24px; margin-bottom: 8px;"></i>
                            <p style="font-size: 12px;">레시피를 드래그하여<br>추가하세요</p>
                        </div>
                    </div>
                </div>

                <!-- 석식 -->
                <div style="border: 2px dashed #6f42c1; border-radius: 8px; padding: 15px; background: #f8f7ff;">
                    <h4 style="color: #6f42c1; margin-bottom: 12px; font-size: 14px; text-align: center; border-bottom: 1px solid #6f42c1; padding-bottom: 5px;">
                        <i class="fas fa-moon"></i> 석식
                    </h4>
                    <div id="dinner-menu" class="meal-slot" style="min-height: 200px; max-height: calc(100vh - 500px); overflow-y: auto;">
                        <div class="empty-slot" style="text-align: center; color: #6f42c1; padding: 20px; opacity: 0.7;">
                            <i class="fas fa-plus-circle" style="font-size: 24px; margin-bottom: 8px;"></i>
                            <p style="font-size: 12px;">레시피를 드래그하여<br>추가하세요</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 하단 요약 정보 -->
    <div id="summarySection" style="margin-top: 20px; background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); display: none;">
        <h4 style="color: #333; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
            <i class="fas fa-calculator" style="color: #F5881F;"></i>
            식단 요약 정보
        </h4>
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 20px;">
            <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                <div style="font-size: 24px; font-weight: bold; color: #28a745;" id="totalRecipes">0</div>
                <div style="font-size: 12px; color: #666;">총 레시피</div>
            </div>
            <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                <div style="font-size: 24px; font-weight: bold; color: #F5881F;" id="totalCost">₩0</div>
                <div style="font-size: 12px; color: #666;">예상 비용</div>
            </div>
            <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                <div style="font-size: 24px; font-weight: bold; color: #17a2b8;" id="totalCalories">0</div>
                <div style="font-size: 12px; color: #666;">총 칼로리</div>
            </div>
            <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                <div style="font-size: 24px; font-weight: bold; color: #6f42c1;" id="avgCostPerPerson">₩0</div>
                <div style="font-size: 12px; color: #666;">1인당 비용</div>
            </div>
        </div>
    </div>
</div>

<style>
/* 식단관리 전용 스타일 */
.recipe-item {
    background: #f8f9fa;
    border: 1px solid #e0e0e0;
    border-radius: 6px;
    padding: 8px 12px;
    cursor: grab;
    transition: all 0.3s ease;
    font-size: 13px;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.recipe-item:hover {
    background: #F5881F;
    color: white;
    border-color: #E67309;
    transform: translateX(3px);
}

.recipe-item:active {
    cursor: grabbing;
}

.meal-slot {
    border-radius: 6px;
}

.meal-slot.drag-over {
    background: rgba(245, 136, 31, 0.1) !important;
    border-style: solid !important;
}

.meal-item {
    background: white;
    border: 1px solid #e0e0e0;
    border-radius: 6px;
    padding: 8px 10px;
    margin-bottom: 6px;
    font-size: 12px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.meal-item .remove-btn {
    background: #dc3545;
    color: white;
    border: none;
    border-radius: 3px;
    width: 18px;
    height: 18px;
    font-size: 10px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
}

.empty-slot {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}

/* 반응형 */
@media (max-width: 768px) {
    [style*="grid-template-columns: 350px 1fr"] {
        grid-template-columns: 1fr !important;
        gap: 15px !important;
    }
    
    [style*="grid-template-columns: 1fr 1fr 1fr"] {
        grid-template-columns: 1fr !important;
        gap: 10px !important;
    }
}
</style>

<script>
// 식단관리 페이지 전용 스크립트
let currentRecipes = [];
let currentDietPlan = {
    breakfast: [],
    lunch: [],
    dinner: []
};

// 페이지 초기화
function mealPlanInit() {
    console.log('식단관리 페이지 초기화');
    
    // 날짜 정보 업데이트
    updateMealPlanDate();
    
    // 드래그 앤 드롭 설정
    setupDragAndDrop();
    
    // 초기 레시피 로드
    searchRecipes();
}

// 날짜 정보 업데이트
function updateMealPlanDate() {
    if (typeof getCurrentContext === 'function') {
        const context = getCurrentContext();
        const date = new Date(context.date);
        const dateStr = date.toLocaleDateString('ko-KR', {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });
        document.getElementById('mealPlanDate').textContent = `${dateStr} 식단 작성 (${context.businessName})`;
    }
}

// 레시피 검색
async function searchRecipes() {
    const keyword = document.getElementById('recipeSearchInput').value.trim();
    
    try {
        const response = await fetch('/api/search_recipes', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                keyword: keyword,
                limit: 20
            })
        });
        
        const recipes = await response.json();
        currentRecipes = recipes;
        displayRecipes(recipes);
        
    } catch (error) {
        console.error('레시피 검색 오류:', error);
        document.getElementById('recipeResults').innerHTML = `
            <div style="text-align: center; color: #dc3545; padding: 20px;">
                <i class="fas fa-exclamation-triangle" style="font-size: 24px; margin-bottom: 10px;"></i>
                <p>레시피 검색 중 오류가 발생했습니다</p>
            </div>
        `;
    }
}

// 레시피 목록 표시
function displayRecipes(recipes) {
    const container = document.getElementById('recipeResults');
    
    if (recipes.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; color: #666; padding: 20px;">
                <i class="fas fa-search" style="font-size: 24px; color: #ccc; margin-bottom: 10px;"></i>
                <p>검색 결과가 없습니다</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = recipes.map(recipe => `
        <div class="recipe-item" draggable="true" data-recipe-id="${recipe.id}" data-recipe-name="${recipe.name}">
            <span>${recipe.name}</span>
            <small style="opacity: 0.7;">~${recipe.estimated_cost || 5000}원</small>
        </div>
    `).join('');
    
    // 드래그 이벤트 설정
    container.querySelectorAll('.recipe-item').forEach(item => {
        item.addEventListener('dragstart', handleDragStart);
    });
}

// 드래그 앤 드롭 설정
function setupDragAndDrop() {
    const mealSlots = document.querySelectorAll('.meal-slot');
    
    mealSlots.forEach(slot => {
        slot.addEventListener('dragover', handleDragOver);
        slot.addEventListener('dragleave', handleDragLeave);
        slot.addEventListener('drop', handleDrop);
    });
}

// 드래그 시작
function handleDragStart(e) {
    e.dataTransfer.setData('text/plain', JSON.stringify({
        id: e.target.dataset.recipeId,
        name: e.target.dataset.recipeName
    }));
}

// 드래그 오버
function handleDragOver(e) {
    e.preventDefault();
    e.currentTarget.classList.add('drag-over');
}

// 드래그 떠남
function handleDragLeave(e) {
    e.currentTarget.classList.remove('drag-over');
}

// 드롭 처리
function handleDrop(e) {
    e.preventDefault();
    e.currentTarget.classList.remove('drag-over');
    
    try {
        const recipeData = JSON.parse(e.dataTransfer.getData('text/plain'));
        const slotId = e.currentTarget.id.replace('-menu', '');
        
        addRecipeToMeal(slotId, recipeData);
        updateSummary();
        
    } catch (error) {
        console.error('드롭 처리 오류:', error);
    }
}

// 메뉴에 레시피 추가
function addRecipeToMeal(mealType, recipe) {
    const slot = document.getElementById(mealType + '-menu');
    
    // 빈 슬롯 제거
    const emptySlot = slot.querySelector('.empty-slot');
    if (emptySlot) {
        emptySlot.remove();
    }
    
    // 레시피 아이템 추가
    const mealItem = document.createElement('div');
    mealItem.className = 'meal-item';
    mealItem.innerHTML = `
        <span>${recipe.name}</span>
        <button class="remove-btn" onclick="removeRecipeFromMeal('${mealType}', '${recipe.id}')">
            <i class="fas fa-times"></i>
        </button>
    `;
    
    slot.appendChild(mealItem);
    
    // 데이터 업데이트
    currentDietPlan[mealType].push(recipe);
    
    // 요약 섹션 표시
    document.getElementById('summarySection').style.display = 'block';
}

// 메뉴에서 레시피 제거
function removeRecipeFromMeal(mealType, recipeId) {
    const slot = document.getElementById(mealType + '-menu');
    const items = slot.querySelectorAll('.meal-item');
    
    items.forEach(item => {
        if (item.querySelector('.remove-btn').onclick.toString().includes(recipeId)) {
            item.remove();
        }
    });
    
    // 데이터에서 제거
    currentDietPlan[mealType] = currentDietPlan[mealType].filter(recipe => recipe.id !== recipeId);
    
    // 빈 슬롯 추가 (필요한 경우)
    if (slot.children.length === 0) {
        const colors = {
            breakfast: '#28a745',
            lunch: '#F5881F', 
            dinner: '#6f42c1'
        };
        slot.innerHTML = `
            <div class="empty-slot" style="text-align: center; color: ${colors[mealType]}; padding: 20px; opacity: 0.7;">
                <i class="fas fa-plus-circle" style="font-size: 24px; margin-bottom: 8px;"></i>
                <p style="font-size: 12px;">레시피를 드래그하여<br>추가하세요</p>
            </div>
        `;
    }
    
    updateSummary();
}

// 요약 정보 업데이트
function updateSummary() {
    const totalRecipes = currentDietPlan.breakfast.length + currentDietPlan.lunch.length + currentDietPlan.dinner.length;
    
    if (totalRecipes === 0) {
        document.getElementById('summarySection').style.display = 'none';
        return;
    }
    
    document.getElementById('totalRecipes').textContent = totalRecipes;
    // TODO: 실제 비용 계산 API 호출
    document.getElementById('totalCost').textContent = `₩${(totalRecipes * 5000).toLocaleString()}`;
    document.getElementById('totalCalories').textContent = `${totalRecipes * 350}`;
    document.getElementById('avgCostPerPerson').textContent = `₩${Math.round(totalRecipes * 5000 / 100).toLocaleString()}`;
}

// 식단표 저장
async function saveDietPlan() {
    const context = getCurrentContext();
    
    try {
        const response = await fetch('/api/create_diet_plan', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                date: context.date,
                business_location: context.business,
                diet_plan: currentDietPlan
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('식단표가 성공적으로 저장되었습니다!');
        } else {
            alert('저장 중 오류가 발생했습니다: ' + result.error);
        }
        
    } catch (error) {
        console.error('식단표 저장 오류:', error);
        alert('저장 중 오류가 발생했습니다.');
    }
}

// 식단표 초기화
function clearDietPlan() {
    if (confirm('현재 작성 중인 식단표를 모두 삭제하시겠습니까?')) {
        currentDietPlan = { breakfast: [], lunch: [], dinner: [] };
        
        // UI 초기화
        ['breakfast', 'lunch', 'dinner'].forEach(mealType => {
            const slot = document.getElementById(mealType + '-menu');
            const colors = {
                breakfast: '#28a745',
                lunch: '#F5881F', 
                dinner: '#6f42c1'
            };
            slot.innerHTML = `
                <div class="empty-slot" style="text-align: center; color: ${colors[mealType]}; padding: 20px; opacity: 0.7;">
                    <i class="fas fa-plus-circle" style="font-size: 24px; margin-bottom: 8px;"></i>
                    <p style="font-size: 12px;">레시피를 드래그하여<br>추가하세요</p>
                </div>
            `;
        });
        
        document.getElementById('summarySection').style.display = 'none';
    }
}

// 엔터 키로 검색
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('recipeSearchInput');
    if (searchInput) {
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchRecipes();
            }
        });
    }
});
</script>