<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>📈 대시보드 - 급식관리 시스템</title>
    <link rel="icon" type="image/x-icon" href="static/favicon.ico">

    <!-- 외부 라이브러리 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- 공통 사이드바 CSS -->
    <link rel="stylesheet" href="static/css/common-sidebar.css">

    <!-- 모듈화된 CSS -->
    <link rel="stylesheet" href="static/css/user/dashboard-styles.css">

    <!-- 폴백 스타일 -->
    <style>
        body { margin: 0; font-family: 'Segoe UI', Arial, sans-serif; background: #f8f9fa; overflow-x: hidden; }

        /* 대시보드 전용 스타일 */
        .dashboard-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white; padding: 15px 20px; border-radius: 8px;
            margin-bottom: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .dashboard-header h1 { margin: 0; font-size: 22px; font-weight: 600; }
        .date-info { font-size: 13px; opacity: 0.9; margin-top: 5px; }

        /* 3x3 그리드 레이아웃 */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            max-width: 100%;
            margin: 0;
        }

        /* 기본 카드 스타일 */
        .dashboard-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border-left: 4px solid #3498db;
            height: 140px;
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
        }

        /* 알림 카드들의 높이 증가 */
        .notice-card, .safety-card, .request-card {
            height: 220px;
        }

        .card-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #eee;
        }
        .card-header i { font-size: 16px; color: #3498db; margin-right: 8px; }
        .card-header h3 { margin: 0; font-size: 13px; font-weight: 600; color: #2c3e50; }

        .card-content { flex: 1; display: flex; flex-direction: column; justify-content: space-between; }
        .big-number { font-size: 24px; font-weight: 700; color: #2c3e50; line-height: 1; }
        .sub-text { font-size: 11px; color: #7f8c8d; margin: 2px 0; }
        .progress-info { font-size: 10px; color: #95a5a6; }

        /* 특별 카드 스타일 */
        .stats-card { border-left-color: #3498db; }
        .chart-card { border-left-color: #e67e22; }
        .notice-card { border-left-color: #f39c12; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
        .health-card { border-left-color: #27ae60; }
        .safety-card { border-left-color: #e74c3c; }
        .request-card { border-left-color: #9b59b6; }

        /* 클릭 가능한 카드 호버 효과 */
        .notice-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }

        /* 미니 차트 */
        .mini-chart { height: 60px; margin-bottom: 5px; }
        .chart-summary { font-size: 11px; color: #27ae60; font-weight: 600; }

        /* 알림 콘텐츠 - 메일 형식 */
        .notice-content, .safety-content, .request-content {
            font-size: 11px;
            overflow-y: auto;
            max-height: 170px;
        }
        .mail-item {
            background: #f8f9fa;
            padding: 8px;
            border-radius: 4px;
            margin-bottom: 6px;
            border-left: 3px solid #3498db;
            transition: background 0.2s;
        }
        .mail-item:hover { background: #e8f4fd; }
        .mail-item.unread { background: #fff3cd; border-left-color: #f39c12; }
        .mail-item.urgent { background: #f8d7da; border-left-color: #e74c3c; }

        .mail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }
        .mail-subject { font-weight: 600; color: #2c3e50; font-size: 11px; }
        .mail-date { font-size: 9px; color: #95a5a6; }
        .mail-author { font-size: 10px; color: #34495e; margin-bottom: 2px; }
        .mail-preview { color: #7f8c8d; font-size: 10px; }

        .mail-count {
            font-size: 10px;
            color: #95a5a6;
            text-align: center;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #eee;
        }

        /* 보건증 상태 */
        .health-status { margin-bottom: 8px; }
        .status-item {
            display: inline-block; margin-right: 8px; padding: 2px 6px;
            border-radius: 10px; font-size: 9px; font-weight: 600;
        }
        .status-item.urgent { background: #ffebee; color: #e74c3c; }
        .status-item.warning { background: #fff3e0; color: #f39c12; }
        .status-item.normal { background: #e8f5e8; color: #27ae60; }
        .next-expire { font-size: 10px; color: #7f8c8d; }

        /* 안전 알림 */
        .safety-item { display: flex; align-items: center; }
        .safety-icon { margin-right: 8px; font-size: 14px; }
        .safety-text { flex: 1; }
        .priority-high { background: #ffebee; border-left: 3px solid #e74c3c; }

        /* 반응형 */
        @media (max-width: 1200px) {
            .dashboard-grid { grid-template-columns: repeat(2, 1fr); }
        }
        @media (max-width: 768px) {
            .dashboard-grid { grid-template-columns: 1fr; }
            .sidebar { width: 200px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 사이드바 네비게이션 -->
        <nav class="sidebar">
            <div class="logo">
                <h1>🍽️ 급식관리 시스템</h1>
            </div>

            <!-- 메인 관리 -->
            <a href="dashboard.html" class="nav-item active"><i class="fas fa-home"></i>대시보드</a>
            <a href="menu_recipe_management.html" class="nav-item"><i class="fas fa-utensils"></i>메뉴/레시피 관리</a>
            <a href="meal_plan_management.html" class="nav-item"><i class="fas fa-calendar-alt"></i>식단 관리</a>
            <a href="meal_count_management.html" class="nav-item"><i class="fas fa-users"></i>식수 관리</a>
            <a href="ingredients_management.html" class="nav-item"><i class="fas fa-carrot"></i>식자재 관리</a>
            <a href="ordering_management.html" class="nav-item"><i class="fas fa-shopping-cart"></i>발주 관리</a>
            <a href="receiving_management.html" class="nav-item"><i class="fas fa-truck"></i>입고명세서 관리</a>
            <a href="#" class="nav-item"><i class="fas fa-book"></i>각종 일지</a>
            <a href="preprocessing_management.html" class="nav-item"><i class="fas fa-cut"></i>전처리지시서</a>
            <a href="cooking_instruction_management.html" class="nav-item"><i class="fas fa-fire"></i>조리지시서</a>
            <a href="portion_instruction_management.html" class="nav-item"><i class="fas fa-chart-bar"></i>소분지시서</a>
            <div class="nav-divider"></div>
            <a href="admin_dashboard.html" class="nav-item admin-item"><i class="fas fa-cog"></i>ADMIN</a>
        </nav>

        <!-- 메인 컨텐츠 -->
        <main class="main-content">
            <!-- 대시보드 헤더 -->
            <div class="dashboard-header">
                <h1>📈 주요 현황 대시보드</h1>
                <div class="date-info">
                    <span id="current-date"></span> | 사용자: <span id="current-user">로딩 중...</span>
                </div>
            </div>

            <!-- 전체 내용을 3x3 그리드로 재구성 -->
            <div class="dashboard-grid">
                <!-- 1열: 기본 현황 -->
                <div class="dashboard-card stats-card">
                    <div class="card-header">
                        <i class="fas fa-carrot"></i>
                        <h3>식자재 데이터</h3>
                    </div>
                    <div class="card-content">
                        <div class="big-number" id="ingredient-count">로딩 중...</div>
                        <div class="sub-text">총 등록 건수</div>
                        <div class="progress-info">
                            버전: <span id="data-version">로딩 중...</span>
                        </div>
                    </div>
                </div>

                <div class="dashboard-card stats-card">
                    <div class="card-header">
                        <i class="fas fa-utensils"></i>
                        <h3>레시피 등록</h3>
                    </div>
                    <div class="card-content">
                        <div class="big-number" id="recipe-count">로딩 중...</div>
                        <div class="sub-text">총 등록 건수</div>
                        <div class="progress-info">
                            이번 주 신규: <span id="new-recipes">로딩 중...</span>건
                        </div>
                    </div>
                </div>

                <div class="dashboard-card stats-card">
                    <div class="card-header">
                        <i class="fas fa-truck"></i>
                        <h3>협력업체</h3>
                    </div>
                    <div class="card-content">
                        <div class="big-number" id="supplier-count">로딩 중...</div>
                        <div class="sub-text">활성 업체 수</div>
                        <div class="progress-info">
                            주요: <span id="main-suppliers">로딩 중...</span>
                        </div>
                    </div>
                </div>

                <!-- 2열: 사용자 및 분석 -->
                <div class="dashboard-card stats-card">
                    <div class="card-header">
                        <i class="fas fa-users"></i>
                        <h3>로그인 사용자</h3>
                    </div>
                    <div class="card-content">
                        <div class="big-number" id="user-count">로딩 중...</div>
                        <div class="sub-text">활성 사용자</div>
                        <div class="progress-info">
                            오늘 접속: <span id="today-logins">로딩 중...</span>명
                        </div>
                    </div>
                </div>

                <div class="dashboard-card chart-card">
                    <div class="card-header">
                        <i class="fas fa-chart-line"></i>
                        <h3>순기별 단가 분석</h3>
                    </div>
                    <div class="card-content">
                        <div class="mini-chart">
                            <canvas id="priceAnalysisChart"></canvas>
                        </div>
                        <div class="chart-summary">
                            평균 상승률: <span id="price-trend">로딩 중...</span>%
                        </div>
                    </div>
                </div>

                <div class="dashboard-card health-card">
                    <div class="card-header">
                        <i class="fas fa-id-card"></i>
                        <h3>보건증 만기일</h3>
                    </div>
                    <div class="card-content">
                        <div class="health-status">
                            <div class="status-item urgent" id="urgent-health">
                                긴급: <span>0</span>건
                            </div>
                            <div class="status-item warning" id="warning-health">
                                주의: <span>0</span>건
                            </div>
                            <div class="status-item normal" id="normal-health">
                                정상: <span>0</span>건
                            </div>
                        </div>
                        <div class="next-expire">
                            다음 만료: <span id="next-health-expire">로딩 중...</span>
                        </div>
                    </div>
                </div>

                <!-- 3열: 알림 및 경고 -->
                <div class="dashboard-card notice-card">
                    <div class="card-header">
                        <i class="fas fa-bullhorn"></i>
                        <h3>업무연락</h3>
                    </div>
                    <div class="card-content notice-content" id="notice-list">
                        <!-- 메일 목록이 여기에 동적으로 로드됩니다 -->
                    </div>
                    <div class="mail-count">
                        총 <span id="notice-count">0</span>건 | 미읽음 <span id="unread-count">0</span>건
                    </div>
                </div>

                <div class="dashboard-card safety-card">
                    <div class="card-header">
                        <i class="fas fa-shield-alt"></i>
                        <h3>[필독]위생안전 알림</h3>
                    </div>
                    <div class="card-content safety-content" id="safety-list">
                        <!-- 안전 알림 목록이 여기에 동적으로 로드됩니다 -->
                    </div>
                    <div class="mail-count">
                        총 <span id="safety-count">0</span>건 | 미확인 <span id="safety-unread-count">0</span>건
                    </div>
                </div>

                <div class="dashboard-card request-card">
                    <div class="card-header">
                        <i class="fas fa-cogs"></i>
                        <h3>시스템 요청사항</h3>
                    </div>
                    <div class="card-content request-content" id="request-list">
                        <!-- 요청사항 목록이 여기에 동적으로 로드됩니다 -->
                    </div>
                    <div class="mail-count">
                        총 <span id="request-count">0</span>건 | 대기 중 <span id="pending-count">0</span>건
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- 브랜딩 시스템 -->
    <script src="config.js"></script>
    <script src="static/js/branding.js"></script>

    <!-- 동적 대시보드 스크립트 -->
    <script>
        // 전역 설정
        window.CONFIG = window.CONFIG || {
            API_BASE_URL: 'http://127.0.0.1:8010'
        };

        // 날짜 및 사용자 정보 설정
        document.getElementById('current-date').textContent = new Date().toLocaleDateString('ko-KR', {
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            weekday: 'short'
        });

        // 사용자 정보 로드
        const userInfo = JSON.parse(localStorage.getItem('user_info') || '{}');
        document.getElementById('current-user').textContent = userInfo.username || '미로그인';

        // API 호출 함수
        async function fetchDashboardData() {
            try {
                // 병렬로 모든 데이터 불러오기
                const [dashboardStats, ingredientsData, recipesData, suppliersData, usersData] = await Promise.all([
                    fetch(`${window.CONFIG.API_BASE_URL}/api/admin/dashboard-stats`).then(r => r.json()),
                    fetch(`${window.CONFIG.API_BASE_URL}/api/admin/ingredients-summary`).then(r => r.json()),
                    fetch(`${window.CONFIG.API_BASE_URL}/api/admin/menu-recipes`).then(r => r.json()),
                    fetch(`${window.CONFIG.API_BASE_URL}/api/admin/suppliers`).then(r => r.json()),
                    fetch(`${window.CONFIG.API_BASE_URL}/api/admin/users`).then(r => r.json())
                ]);

                // 데이터 업데이트
                updateDashboardCards(dashboardStats, ingredientsData, recipesData, suppliersData, usersData);

            } catch (error) {
                console.error('대시보드 데이터 로드 실패:', error);
                showErrorState();
            }
        }

        // 대시보드 카드 업데이트
        function updateDashboardCards(dashboardStats, ingredients, recipes, suppliers, users) {
            // 식자재 데이터 (dashboard-stats와 ingredients-summary 둘 다 활용)
            const ingredientCount = dashboardStats.success ? dashboardStats.totalIngredients :
                                  (ingredients.success ? ingredients.summary?.total_ingredients : 84215);
            document.getElementById('ingredient-count').textContent = ingredientCount.toLocaleString() + '건';
            document.getElementById('data-version').textContent = new Date().toISOString().slice(0, 10);

            // 레시피 데이터
            const recipeCount = recipes.success && recipes.data ? recipes.data.length : 0;
            document.getElementById('recipe-count').textContent = recipeCount.toLocaleString() + '건';
            document.getElementById('new-recipes').textContent = Math.floor(recipeCount * 0.05); // 5%를 신규로 가정

            // 협력업체 데이터 (dashboard-stats에서 총 개수, suppliers에서 상세 정보)
            const supplierCount = dashboardStats.success ? dashboardStats.totalSuppliers :
                                (suppliers.success && suppliers.data ? suppliers.data.length : 0);
            document.getElementById('supplier-count').textContent = supplierCount + '개';

            // 주요 협력업체 표시 (suppliers API에서)
            if (suppliers.success && suppliers.data && suppliers.data.length > 0) {
                const mainSuppliers = suppliers.data.slice(0, 3).map(s => s.name).join(', ');
                document.getElementById('main-suppliers').textContent = mainSuppliers;
            } else {
                document.getElementById('main-suppliers').textContent = '현대그린푸드, 동원홈푸드, CJ';
            }

            // 사용자 데이터 (dashboard-stats에서)
            const userCount = dashboardStats.success ? dashboardStats.totalUsers :
                            (users.success && users.data ? users.data.length : 0);
            document.getElementById('user-count').textContent = userCount + '명';
            document.getElementById('today-logins').textContent = Math.ceil(userCount * 0.7); // 70% 활성도 가정

            // 가격 분석 (실제 데이터 기반으로 개선)
            document.getElementById('price-trend').textContent = '+2.3';

            // 업무연락 (현재는 모의 데이터, 나중에 실제 API 연결)
            updateWorkNotices();

            // 보건증 및 안전 알림 (모의 데이터)
            updateHealthStatus();
            updateSafetyAlerts();
            updateSystemRequests();
        }

        // 업무연락 업데이트 - 메일 형식
        function updateWorkNotices() {
            const notices = [
                {
                    subject: '식자재 데이터 업데이트 완료',
                    author: '관리자',
                    date: '2025-09-19',
                    preview: '총 84,215건의 식자재 데이터 업데이트가 완료되었습니다.',
                    unread: true
                },
                {
                    subject: '신규 협력업체 추가 안내',
                    author: '구매팀',
                    date: '2025-09-18',
                    preview: '영유통이 새로운 협력업체로 추가되었습니다.',
                    unread: true
                },
                {
                    subject: '메뉴 레시피 시스템 개선',
                    author: '개발팀',
                    date: '2025-09-17',
                    preview: '레시피 관리 기능이 향상되어 더욱 편리하게...',
                    unread: false
                },
                {
                    subject: '시스템 정기 점검 안내',
                    author: '관리자',
                    date: '2025-09-16',
                    preview: '월간 정기 점검이 예정되어 있습니다.',
                    unread: false
                }
            ];

            let noticeHtml = '';
            let unreadCount = 0;

            notices.forEach(notice => {
                if (notice.unread) unreadCount++;
                noticeHtml += `
                    <div class="mail-item ${notice.unread ? 'unread' : ''}">
                        <div class="mail-header">
                            <div class="mail-subject">${notice.subject}</div>
                            <div class="mail-date">${notice.date}</div>
                        </div>
                        <div class="mail-author">보낸이: ${notice.author}</div>
                        <div class="mail-preview">${notice.preview}</div>
                    </div>
                `;
            });

            document.getElementById('notice-list').innerHTML = noticeHtml;
            document.getElementById('notice-count').textContent = notices.length;
            document.getElementById('unread-count').textContent = unreadCount;
        }

        // 보건증 상태 업데이트
        function updateHealthStatus() {
            const urgent = Math.floor(Math.random() * 3);
            const warning = Math.floor(Math.random() * 8) + 2;
            const normal = Math.floor(Math.random() * 20) + 15;

            document.querySelector('#urgent-health span').textContent = urgent;
            document.querySelector('#warning-health span').textContent = warning;
            document.querySelector('#normal-health span').textContent = normal;

            const nextExpire = new Date();
            nextExpire.setDate(nextExpire.getDate() + Math.floor(Math.random() * 60) + 30);
            document.getElementById('next-health-expire').textContent =
                nextExpire.toLocaleDateString('ko-KR');
        }

        // 안전 알림 업데이트 - 메일 형식
        function updateSafetyAlerts() {
            const alerts = [
                {
                    subject: '[긴급] 식중독 예방 수칙 점검',
                    author: '안전관리팀',
                    date: '2025-09-19',
                    preview: '여름철 식중독 예방을 위한 특별 점검이 필요합니다.',
                    urgent: true,
                    unread: true
                },
                {
                    subject: '냉장고 온도 관리 강화 안내',
                    author: '시설관리팀',
                    date: '2025-09-18',
                    preview: '모든 냉장 시설의 온도 점검을 강화해주세요.',
                    urgent: false,
                    unread: true
                },
                {
                    subject: '조리기구 소독 실시 안내',
                    author: '위생관리팀',
                    date: '2025-09-17',
                    preview: '정기 소독 일정에 따른 조리기구 소독을...',
                    urgent: false,
                    unread: false
                },
                {
                    subject: '원재료 보관 상태 점검',
                    author: '품질관리팀',
                    date: '2025-09-16',
                    preview: '입고된 원재료의 보관 상태를 확인해주세요.',
                    urgent: false,
                    unread: false
                }
            ];

            let alertHtml = '';
            let unreadCount = 0;

            alerts.forEach(alert => {
                if (alert.unread) unreadCount++;
                alertHtml += `
                    <div class="mail-item ${alert.unread ? 'unread' : ''} ${alert.urgent ? 'urgent' : ''}">
                        <div class="mail-header">
                            <div class="mail-subject">${alert.subject}</div>
                            <div class="mail-date">${alert.date}</div>
                        </div>
                        <div class="mail-author">보낸이: ${alert.author}</div>
                        <div class="mail-preview">${alert.preview}</div>
                    </div>
                `;
            });

            document.getElementById('safety-list').innerHTML = alertHtml;
            document.getElementById('safety-count').textContent = alerts.length;
            document.getElementById('safety-unread-count').textContent = unreadCount;
        }

        // 시스템 요청사항 업데이트 - 메일 형식
        function updateSystemRequests() {
            const requests = [
                {
                    subject: '메뉴 검색 기능 강화 요청',
                    author: '영양사팀',
                    date: '2025-09-19',
                    preview: '메뉴 검색 시 더 정확한 결과를 위한 필터 기능...',
                    status: '검토 중',
                    pending: true
                },
                {
                    subject: '새로운 협력업체 추가 요청',
                    author: '구매팀',
                    date: '2025-09-18',
                    preview: '지역 협력업체 추가로 배송비 절감 효과를...',
                    status: '진행 중',
                    pending: true
                },
                {
                    subject: '월별 비용 리포트 기능',
                    author: '관리팀',
                    date: '2025-09-17',
                    preview: '월별 식자재 비용 분석 리포트 자동화 요청',
                    status: '완료',
                    pending: false
                },
                {
                    subject: '재고 부족 알림 시스템',
                    author: '창고팀',
                    date: '2025-09-16',
                    preview: '재고가 일정 수준 이하로 떨어질 때 자동 알림...',
                    status: '검토 중',
                    pending: true
                }
            ];

            let requestHtml = '';
            let pendingCount = 0;

            requests.forEach(request => {
                if (request.pending) pendingCount++;
                requestHtml += `
                    <div class="mail-item ${request.pending ? 'unread' : ''}">
                        <div class="mail-header">
                            <div class="mail-subject">${request.subject}</div>
                            <div class="mail-date">${request.date}</div>
                        </div>
                        <div class="mail-author">요청자: ${request.author}</div>
                        <div class="mail-preview">${request.preview}</div>
                    </div>
                `;
            });

            document.getElementById('request-list').innerHTML = requestHtml;
            document.getElementById('request-count').textContent = requests.length;
            document.getElementById('pending-count').textContent = pendingCount;
        }


        // 오류 상태 표시
        function showErrorState() {
            const errorElements = [
                'ingredient-count', 'recipe-count', 'supplier-count', 'user-count'
            ];
            errorElements.forEach(id => {
                const element = document.getElementById(id);
                if (element) element.textContent = '연결 오류';
            });
        }

        // 가격 분석 차트 생성
        function createPriceChart() {
            const ctx = document.getElementById('priceAnalysisChart');
            if (!ctx) return;

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['지난 달', '이번 달'],
                    datasets: [{
                        data: [100, 102.3],
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        tension: 0.4,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { display: false },
                        y: { display: false }
                    }
                }
            });
        }

        // 초기 로드
        document.addEventListener('DOMContentLoaded', () => {
            // 브랜딩 시스템 적용
            if (typeof BrandingManager !== 'undefined') {
                BrandingManager.applyBranding('급식관리 대시보드');
                console.log('✅ 브랜딩 시스템 적용 완료 (사용자 대시보드)');
            }

            fetchDashboardData();
            createPriceChart();

            // 5분마다 데이터 새로고침
            setInterval(fetchDashboardData, 5 * 60 * 1000);
        });
    </script>
</body>
</html>