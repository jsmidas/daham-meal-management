<!-- BOKSILI 스타일 식단관리 페이지 컨텐츠 -->
<div style="padding: 0; margin: 0; background: #f5f5f5; min-height: calc(100vh - 130px);">
    <!-- BOKSILI 스타일 헤더 -->
    <div style="background: white; padding: 20px; margin: 0; border-bottom: 1px solid #e0e0e0;">
        <h1 style="font-size: 24px; color: #333; margin: 0; font-weight: normal;">메뉴관리 시스템</h1>
    </div>

    <!-- 관리자/사업장 선택 영역 -->
    <div style="background: white; padding: 15px 20px; border-bottom: 1px solid #e0e0e0; display: flex; align-items: center; gap: 15px;">
        <div style="display: flex; align-items: center; gap: 8px;">
            <i class="fas fa-user-cog" style="color: #F5881F; font-size: 16px;"></i>
            <span style="font-size: 14px; color: #666;">관리자</span>
        </div>
        
        <div style="margin-left: auto;">
            <select style="background: white; border: 2px solid #F5881F; color: #333; padding: 8px 15px; border-radius: 6px; font-size: 14px; min-width: 150px; cursor: pointer;" id="businessLocationSelect" onchange="onBusinessLocationChange()">
                <option value="all">전체 사업장</option>
                <option value="main">본사 (다함푸드)</option>
                <option value="factory1">1공장 (안양)</option>
                <option value="factory2">2공장 (수원)</option>
                <option value="branch1">분당지점</option>
                <option value="branch2">강남지점</option>
                <option value="branch3">영등포지점</option>
                <option value="school1">다함초등학교</option>
                <option value="school2">다함중학교</option>
                <option value="school3">다함고등학교</option>
            </select>
        </div>
    </div>

    <!-- 메인 컨텐츠 영역 -->
    <div style="padding: 20px;">
        <!-- 로딩 상태 (초기 표시) -->
        <div id="loadingState" style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 400px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <div style="width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #F5881F; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 15px;"></div>
            <div style="color: #666; font-size: 14px;">페이지를 불러오는 중...</div>
            <button onclick="forceLoadContent()" style="margin-top: 15px; background: #F5881F; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 12px;">바로 시작하기</button>
        </div>

        <!-- 실제 식단관리 컨텐츠 (로딩 완료 후 표시) -->
        <div id="mealPlanContent" style="display: none;">
            
            <!-- 식단 작성 도구 -->
            <div style="display: grid; grid-template-columns: 280px 1fr; gap: 20px; height: calc(100vh - 220px);">
                
                <!-- 좌측 메뉴 선택 패널 -->
                <div style="background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); overflow: hidden;">
                    <div style="background: #F5881F; color: white; padding: 15px; font-weight: bold; font-size: 16px;">
                        <i class="fas fa-utensils" style="margin-right: 8px;"></i>
                        메뉴 선택
                    </div>
                    
                    <!-- 검색 영역 -->
                    <div style="padding: 15px; border-bottom: 1px solid #f0f0f0;">
                        <div style="position: relative;">
                            <input type="text" id="menuSearchInput" placeholder="메뉴명을 입력하세요..." 
                                   style="width: 100%; padding: 10px 35px 10px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;"
                                   onkeyup="searchMenus()" onfocus="this.style.borderColor='#F5881F'" onblur="this.style.borderColor='#ddd'">
                            <button onclick="searchMenus()" style="position: absolute; right: 5px; top: 50%; transform: translateY(-50%); background: none; border: none; color: #F5881F; cursor: pointer; padding: 5px;">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- 메뉴 카테고리 탭 -->
                    <div style="display: flex; border-bottom: 1px solid #f0f0f0;">
                        <button class="category-tab active" data-category="all" onclick="selectCategory('all')" style="flex: 1; padding: 12px 8px; border: none; background: white; color: #F5881F; border-bottom: 2px solid #F5881F; cursor: pointer; font-size: 12px;">전체</button>
                        <button class="category-tab" data-category="rice" onclick="selectCategory('rice')" style="flex: 1; padding: 12px 8px; border: none; background: white; color: #666; border-bottom: 1px solid #f0f0f0; cursor: pointer; font-size: 12px;">밥류</button>
                        <button class="category-tab" data-category="soup" onclick="selectCategory('soup')" style="flex: 1; padding: 12px 8px; border: none; background: white; color: #666; border-bottom: 1px solid #f0f0f0; cursor: pointer; font-size: 12px;">국류</button>
                        <button class="category-tab" data-category="side" onclick="selectCategory('side')" style="flex: 1; padding: 12px 8px; border: none; background: white; color: #666; border-bottom: 1px solid #f0f0f0; cursor: pointer; font-size: 12px;">반찬</button>
                    </div>
                    
                    <!-- 메뉴 목록 -->
                    <div style="max-height: calc(100vh - 400px); overflow-y: auto; padding: 10px;">
                        <div id="menuResults">
                            <div style="text-align: center; color: #999; padding: 20px; font-size: 13px;">
                                <i class="fas fa-search" style="font-size: 24px; margin-bottom: 10px; display: block;"></i>
                                메뉴를 검색해보세요
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 우측 식단표 작성 영역 -->
                <div style="background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); padding: 20px;">
                    
                    <!-- 식단표 헤더 -->
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #f0f0f0;">
                        <div>
                            <h3 style="margin: 0; color: #333; font-size: 18px; display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-clipboard-list" style="color: #F5881F;"></i>
                                식단표 구성
                                <span style="font-size: 14px; color: #666; font-weight: normal;" id="currentDateDisplay">2025-08-29</span>
                            </h3>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button onclick="saveMealPlan()" style="background: #28a745; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 13px; display: flex; align-items: center; gap: 5px;">
                                <i class="fas fa-save"></i> 저장
                            </button>
                            <button onclick="clearMealPlan()" style="background: #dc3545; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 13px; display: flex; align-items: center; gap: 5px;">
                                <i class="fas fa-eraser"></i> 지우기
                            </button>
                        </div>
                    </div>

                    <!-- 식단 구성 테이블 -->
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; border: 1px solid #ddd;">
                            <thead>
                                <tr>
                                    <th style="background: #f8f9fa; padding: 12px 8px; border: 1px solid #ddd; text-align: center; font-size: 14px; color: #333; width: 80px;">구분</th>
                                    <th style="background: #f8f9fa; padding: 12px 8px; border: 1px solid #ddd; text-align: center; font-size: 14px; color: #333;">메뉴</th>
                                    <th style="background: #f8f9fa; padding: 12px 8px; border: 1px solid #ddd; text-align: center; font-size: 14px; color: #333; width: 100px;">인분</th>
                                    <th style="background: #f8f9fa; padding: 12px 8px; border: 1px solid #ddd; text-align: center; font-size: 14px; color: #333; width: 80px;">작업</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- 조식 -->
                                <tr>
                                    <td rowspan="4" style="background: rgba(40, 167, 69, 0.1); border: 1px solid #ddd; text-align: center; font-weight: bold; color: #28a745; vertical-align: top; padding: 15px 8px;">
                                        <i class="fas fa-sun" style="display: block; font-size: 16px; margin-bottom: 5px;"></i>
                                        조식
                                    </td>
                                    <td id="breakfast-menu-1" class="menu-cell" data-meal="breakfast" data-index="1" style="border: 1px solid #ddd; padding: 12px; min-height: 50px; cursor: pointer; color: #999; font-size: 13px;" onclick="selectMenuForCell(this)">클릭하여 메뉴 선택</td>
                                    <td style="border: 1px solid #ddd; text-align: center; padding: 12px;">
                                        <input type="number" placeholder="100" style="width: 60px; border: 1px solid #ddd; padding: 4px; text-align: center; border-radius: 3px;" value="100">
                                    </td>
                                    <td style="border: 1px solid #ddd; text-align: center; padding: 12px;">
                                        <button onclick="removeMenu(this)" style="background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 11px;">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </td>
                                </tr>
                                <tr>
                                    <td id="breakfast-menu-2" class="menu-cell" data-meal="breakfast" data-index="2" style="border: 1px solid #ddd; padding: 12px; min-height: 50px; cursor: pointer; color: #999; font-size: 13px;" onclick="selectMenuForCell(this)">클릭하여 메뉴 선택</td>
                                    <td style="border: 1px solid #ddd; text-align: center; padding: 12px;">
                                        <input type="number" placeholder="100" style="width: 60px; border: 1px solid #ddd; padding: 4px; text-align: center; border-radius: 3px;" value="100">
                                    </td>
                                    <td style="border: 1px solid #ddd; text-align: center; padding: 12px;">
                                        <button onclick="removeMenu(this)" style="background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 11px;">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </td>
                                </tr>
                                <tr>
                                    <td id="breakfast-menu-3" class="menu-cell" data-meal="breakfast" data-index="3" style="border: 1px solid #ddd; padding: 12px; min-height: 50px; cursor: pointer; color: #999; font-size: 13px;" onclick="selectMenuForCell(this)">클릭하여 메뉴 선택</td>
                                    <td style="border: 1px solid #ddd; text-align: center; padding: 12px;">
                                        <input type="number" placeholder="100" style="width: 60px; border: 1px solid #ddd; padding: 4px; text-align: center; border-radius: 3px;" value="100">
                                    </td>
                                    <td style="border: 1px solid #ddd; text-align: center; padding: 12px;">
                                        <button onclick="removeMenu(this)" style="background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 11px;">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </td>
                                </tr>
                                <tr>
                                    <td id="breakfast-menu-4" class="menu-cell" data-meal="breakfast" data-index="4" style="border: 1px solid #ddd; padding: 12px; min-height: 50px; cursor: pointer; color: #999; font-size: 13px;" onclick="selectMenuForCell(this)">클릭하여 메뉴 선택</td>
                                    <td style="border: 1px solid #ddd; text-align: center; padding: 12px;">
                                        <input type="number" placeholder="100" style="width: 60px; border: 1px solid #ddd; padding: 4px; text-align: center; border-radius: 3px;" value="100">
                                    </td>
                                    <td style="border: 1px solid #ddd; text-align: center; padding: 12px;">
                                        <button onclick="removeMenu(this)" style="background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 11px;">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </td>
                                </tr>

                                <!-- 중식 -->
                                <tr>
                                    <td rowspan="4" style="background: rgba(245, 136, 31, 0.1); border: 1px solid #ddd; text-align: center; font-weight: bold; color: #F5881F; vertical-align: top; padding: 15px 8px;">
                                        <i class="fas fa-sun" style="display: block; font-size: 16px; margin-bottom: 5px;"></i>
                                        중식
                                    </td>
                                    <td id="lunch-menu-1" class="menu-cell" data-meal="lunch" data-index="1" style="border: 1px solid #ddd; padding: 12px; min-height: 50px; cursor: pointer; color: #999; font-size: 13px;" onclick="selectMenuForCell(this)">클릭하여 메뉴 선택</td>
                                    <td style="border: 1px solid #ddd; text-align: center; padding: 12px;">
                                        <input type="number" placeholder="100" style="width: 60px; border: 1px solid #ddd; padding: 4px; text-align: center; border-radius: 3px;" value="100">
                                    </td>
                                    <td style="border: 1px solid #ddd; text-align: center; padding: 12px;">
                                        <button onclick="removeMenu(this)" style="background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 11px;">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </td>
                                </tr>
                                <tr>
                                    <td id="lunch-menu-2" class="menu-cell" data-meal="lunch" data-index="2" style="border: 1px solid #ddd; padding: 12px; min-height: 50px; cursor: pointer; color: #999; font-size: 13px;" onclick="selectMenuForCell(this)">클릭하여 메뉴 선택</td>
                                    <td style="border: 1px solid #ddd; text-align: center; padding: 12px;">
                                        <input type="number" placeholder="100" style="width: 60px; border: 1px solid #ddd; padding: 4px; text-align: center; border-radius: 3px;" value="100">
                                    </td>
                                    <td style="border: 1px solid #ddd; text-align: center; padding: 12px;">
                                        <button onclick="removeMenu(this)" style="background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 11px;">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </td>
                                </tr>
                                <tr>
                                    <td id="lunch-menu-3" class="menu-cell" data-meal="lunch" data-index="3" style="border: 1px solid #ddd; padding: 12px; min-height: 50px; cursor: pointer; color: #999; font-size: 13px;" onclick="selectMenuForCell(this)">클릭하여 메뉴 선택</td>
                                    <td style="border: 1px solid #ddd; text-align: center; padding: 12px;">
                                        <input type="number" placeholder="100" style="width: 60px; border: 1px solid #ddd; padding: 4px; text-align: center; border-radius: 3px;" value="100">
                                    </td>
                                    <td style="border: 1px solid #ddd; text-align: center; padding: 12px;">
                                        <button onclick="removeMenu(this)" style="background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 11px;">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </td>
                                </tr>
                                <tr>
                                    <td id="lunch-menu-4" class="menu-cell" data-meal="lunch" data-index="4" style="border: 1px solid #ddd; padding: 12px; min-height: 50px; cursor: pointer; color: #999; font-size: 13px;" onclick="selectMenuForCell(this)">클릭하여 메뉴 선택</td>
                                    <td style="border: 1px solid #ddd; text-align: center; padding: 12px;">
                                        <input type="number" placeholder="100" style="width: 60px; border: 1px solid #ddd; padding: 4px; text-align: center; border-radius: 3px;" value="100">
                                    </td>
                                    <td style="border: 1px solid #ddd; text-align: center; padding: 12px;">
                                        <button onclick="removeMenu(this)" style="background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 11px;">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </td>
                                </tr>

                                <!-- 석식 -->
                                <tr>
                                    <td rowspan="4" style="background: rgba(111, 66, 193, 0.1); border: 1px solid #ddd; text-align: center; font-weight: bold; color: #6f42c1; vertical-align: top; padding: 15px 8px;">
                                        <i class="fas fa-moon" style="display: block; font-size: 16px; margin-bottom: 5px;"></i>
                                        석식
                                    </td>
                                    <td id="dinner-menu-1" class="menu-cell" data-meal="dinner" data-index="1" style="border: 1px solid #ddd; padding: 12px; min-height: 50px; cursor: pointer; color: #999; font-size: 13px;" onclick="selectMenuForCell(this)">클릭하여 메뉴 선택</td>
                                    <td style="border: 1px solid #ddd; text-align: center; padding: 12px;">
                                        <input type="number" placeholder="100" style="width: 60px; border: 1px solid #ddd; padding: 4px; text-align: center; border-radius: 3px;" value="100">
                                    </td>
                                    <td style="border: 1px solid #ddd; text-align: center; padding: 12px;">
                                        <button onclick="removeMenu(this)" style="background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 11px;">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </td>
                                </tr>
                                <tr>
                                    <td id="dinner-menu-2" class="menu-cell" data-meal="dinner" data-index="2" style="border: 1px solid #ddd; padding: 12px; min-height: 50px; cursor: pointer; color: #999; font-size: 13px;" onclick="selectMenuForCell(this)">클릭하여 메뉴 선택</td>
                                    <td style="border: 1px solid #ddd; text-align: center; padding: 12px;">
                                        <input type="number" placeholder="100" style="width: 60px; border: 1px solid #ddd; padding: 4px; text-align: center; border-radius: 3px;" value="100">
                                    </td>
                                    <td style="border: 1px solid #ddd; text-align: center; padding: 12px;">
                                        <button onclick="removeMenu(this)" style="background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 11px;">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </td>
                                </tr>
                                <tr>
                                    <td id="dinner-menu-3" class="menu-cell" data-meal="dinner" data-index="3" style="border: 1px solid #ddd; padding: 12px; min-height: 50px; cursor: pointer; color: #999; font-size: 13px;" onclick="selectMenuForCell(this)">클릭하여 메뉴 선택</td>
                                    <td style="border: 1px solid #ddd; text-align: center; padding: 12px;">
                                        <input type="number" placeholder="100" style="width: 60px; border: 1px solid #ddd; padding: 4px; text-align: center; border-radius: 3px;" value="100">
                                    </td>
                                    <td style="border: 1px solid #ddd; text-align: center; padding: 12px;">
                                        <button onclick="removeMenu(this)" style="background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 11px;">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </td>
                                </tr>
                                <tr>
                                    <td id="dinner-menu-4" class="menu-cell" data-meal="dinner" data-index="4" style="border: 1px solid #ddd; padding: 12px; min-height: 50px; cursor: pointer; color: #999; font-size: 13px;" onclick="selectMenuForCell(this)">클릭하여 메뉴 선택</td>
                                    <td style="border: 1px solid #ddd; text-align: center; padding: 12px;">
                                        <input type="number" placeholder="100" style="width: 60px; border: 1px solid #ddd; padding: 4px; text-align: center; border-radius: 3px;" value="100">
                                    </td>
                                    <td style="border: 1px solid #ddd; text-align: center; padding: 12px;">
                                        <button onclick="removeMenu(this)" style="background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 11px;">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* BOKSILI 스타일 CSS */
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.category-tab.active {
    color: #F5881F !important;
    border-bottom: 2px solid #F5881F !important;
    background: #fff8f0 !important;
}

.category-tab:hover {
    background: #f8f9fa !important;
}

.menu-item {
    background: white;
    border: 1px solid #e0e0e0;
    border-radius: 4px;
    padding: 10px;
    margin-bottom: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 13px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.menu-item:hover {
    background: #fff8f0;
    border-color: #F5881F;
    transform: translateX(2px);
}

.menu-item.selected {
    background: #F5881F;
    color: white;
    border-color: #E67309;
}

.menu-cell:hover {
    background: #f8f9fa !important;
    border-color: #F5881F !important;
}

.menu-cell.selected {
    background: #fff8f0 !important;
    border-color: #F5881F !important;
    color: #333 !important;
}

/* 반응형 */
@media (max-width: 768px) {
    [style*="grid-template-columns: 280px 1fr"] {
        grid-template-columns: 1fr !important;
        gap: 15px !important;
    }
    
    .category-tab {
        font-size: 10px !important;
        padding: 10px 6px !important;
    }
}
</style>

<script>
// BOKSILI 스타일 식단관리 변수
let currentMenus = [];
let selectedCell = null;
let currentCategory = 'all';
let mealPlanData = {};

// 페이지 초기화
function mealPlanInit() {
    console.log('BOKSILI 스타일 식단관리 페이지 초기화');
    
    // DOM이 완전히 로드된 후 실행
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializePage);
    } else {
        initializePage();
    }
}

function initializePage() {
    // 날짜 정보 업데이트
    updateCurrentDate();
    
    // 사업장 선택 초기화
    initializeBusinessLocation();
    
    // 로딩 상태 표시 후 컨텐츠 로드 (1초로 단축)
    setTimeout(() => {
        try {
            const loadingState = document.getElementById('loadingState');
            const mealPlanContent = document.getElementById('mealPlanContent');
            
            if (loadingState && mealPlanContent) {
                loadingState.style.display = 'none';
                mealPlanContent.style.display = 'block';
                
                console.log('식단관리 컨텐츠 로드 완료');
                
                // 초기 메뉴 로드
                loadMenus();
            } else {
                console.error('로딩 상태 또는 메인 컨텐츠 요소를 찾을 수 없습니다');
            }
        } catch (error) {
            console.error('컨텐츠 로드 오류:', error);
        }
    }, 1000);
}

// 현재 날짜 업데이트
function updateCurrentDate() {
    try {
        const currentDateDisplay = document.getElementById('currentDateDisplay');
        if (currentDateDisplay) {
            if (typeof getCurrentContext === 'function') {
                const context = getCurrentContext();
                const date = new Date(context.date);
                const dateStr = date.toLocaleDateString('ko-KR', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit'
                }).replace(/\. /g, '-').replace('.', '');
                
                currentDateDisplay.textContent = `(${dateStr})`;
            } else {
                // 기본값 설정
                const today = new Date();
                today.setDate(today.getDate() + 1); // 내일 날짜
                const dateStr = today.toLocaleDateString('ko-KR', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit'
                }).replace(/\. /g, '-').replace('.', '');
                
                currentDateDisplay.textContent = `(${dateStr})`;
            }
        }
    } catch (error) {
        console.error('날짜 업데이트 오류:', error);
    }
}

// 사업장 선택 초기화
function initializeBusinessLocation() {
    try {
        const select = document.getElementById('businessLocationSelect');
        if (select) {
            if (typeof getCurrentContext === 'function') {
                const context = getCurrentContext();
                select.value = context.business || 'all';
            } else {
                select.value = 'all';
            }
        }
    } catch (error) {
        console.error('사업장 초기화 오류:', error);
    }
}

// 사업장 변경 처리
function onBusinessLocationChange() {
    const select = document.getElementById('businessLocationSelect');
    console.log('사업장 변경:', select.value);
    
    // 메뉴 데이터 다시 로드
    loadMenus();
}

// 메뉴 검색
async function searchMenus() {
    const keyword = document.getElementById('menuSearchInput').value.trim();
    
    try {
        const response = await fetch('/api/search_recipes', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                keyword: keyword,
                limit: 50
            })
        });
        
        const menus = await response.json();
        currentMenus = menus;
        displayMenus(menus);
        
    } catch (error) {
        console.error('메뉴 검색 오류:', error);
        document.getElementById('menuResults').innerHTML = `
            <div style="text-align: center; color: #dc3545; padding: 20px; font-size: 13px;">
                <i class="fas fa-exclamation-triangle" style="font-size: 20px; margin-bottom: 8px; display: block;"></i>
                검색 중 오류가 발생했습니다
            </div>
        `;
    }
}

// 카테고리 선택
function selectCategory(category) {
    // 탭 활성화 상태 변경
    document.querySelectorAll('.category-tab').forEach(tab => {
        tab.classList.remove('active');
        tab.style.color = '#666';
        tab.style.borderBottom = '1px solid #f0f0f0';
        tab.style.background = 'white';
    });
    
    const activeTab = document.querySelector(`[data-category="${category}"]`);
    activeTab.classList.add('active');
    
    currentCategory = category;
    
    // 카테고리별 메뉴 필터링
    const filteredMenus = currentMenus.filter(menu => {
        if (category === 'all') return true;
        // TODO: 실제 카테고리 필터링 로직 구현
        return true;
    });
    
    displayMenus(filteredMenus);
}

// 메뉴 목록 표시
function displayMenus(menus) {
    const container = document.getElementById('menuResults');
    
    if (menus.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; color: #999; padding: 20px; font-size: 13px;">
                <i class="fas fa-search" style="font-size: 20px; margin-bottom: 8px; display: block;"></i>
                검색 결과가 없습니다
            </div>
        `;
        return;
    }
    
    container.innerHTML = menus.map(menu => `
        <div class="menu-item" onclick="selectMenu('${menu.id}', '${menu.name.replace(/'/g, "&apos;")}')">
            <div>
                <div style="font-weight: bold; margin-bottom: 2px;">${menu.name}</div>
                <div style="font-size: 11px; color: #666;">~${menu.estimated_cost || 5000}원</div>
            </div>
            <i class="fas fa-plus" style="color: #F5881F;"></i>
        </div>
    `).join('');
}

// 메뉴 선택
function selectMenu(menuId, menuName) {
    if (!selectedCell) {
        alert('먼저 식단표에서 셀을 선택해주세요.');
        return;
    }
    
    // 선택된 셀에 메뉴 설정
    selectedCell.innerHTML = `<strong>${menuName}</strong>`;
    selectedCell.style.color = '#333';
    selectedCell.classList.add('selected');
    
    // 데이터 저장
    const meal = selectedCell.dataset.meal;
    const index = selectedCell.dataset.index;
    if (!mealPlanData[meal]) mealPlanData[meal] = {};
    mealPlanData[meal][index] = { id: menuId, name: menuName };
    
    // 셀 선택 해제
    selectedCell = null;
    document.querySelectorAll('.menu-cell').forEach(cell => {
        cell.classList.remove('selected');
    });
}

// 식단표 셀 선택
function selectMenuForCell(cell) {
    // 이전 선택 해제
    document.querySelectorAll('.menu-cell').forEach(c => {
        c.classList.remove('selected');
    });
    
    // 현재 셀 선택
    cell.classList.add('selected');
    selectedCell = cell;
    
    console.log('셀 선택됨:', cell.dataset.meal, cell.dataset.index);
}

// 메뉴 제거
function removeMenu(button) {
    const row = button.closest('tr');
    const menuCell = row.querySelector('.menu-cell');
    
    menuCell.innerHTML = '클릭하여 메뉴 선택';
    menuCell.style.color = '#999';
    menuCell.classList.remove('selected');
    
    // 데이터에서 제거
    const meal = menuCell.dataset.meal;
    const index = menuCell.dataset.index;
    if (mealPlanData[meal] && mealPlanData[meal][index]) {
        delete mealPlanData[meal][index];
    }
}

// 초기 메뉴 로드
function loadMenus() {
    try {
        console.log('초기 메뉴 로드 시작');
        // 초기 검색 (빈 키워드로 전체 메뉴 로드)
        searchMenus();
    } catch (error) {
        console.error('메뉴 로드 오류:', error);
    }
}

// 식단표 저장
async function saveMealPlan() {
    const context = getCurrentContext();
    
    try {
        // TODO: 실제 API 호출 구현
        console.log('저장할 식단표:', {
            date: context.date,
            business: context.business,
            mealPlan: mealPlanData
        });
        
        alert('식단표가 성공적으로 저장되었습니다!');
        
    } catch (error) {
        console.error('식단표 저장 오류:', error);
        alert('저장 중 오류가 발생했습니다.');
    }
}

// 식단표 초기화
function clearMealPlan() {
    if (confirm('현재 작성 중인 식단표를 모두 지우시겠습니까?')) {
        // 모든 셀 초기화
        document.querySelectorAll('.menu-cell').forEach(cell => {
            cell.innerHTML = '클릭하여 메뉴 선택';
            cell.style.color = '#999';
            cell.classList.remove('selected');
        });
        
        // 데이터 초기화
        mealPlanData = {};
        selectedCell = null;
        
        alert('식단표가 초기화되었습니다.');
    }
}

// 강제 컨텐츠 로드
function forceLoadContent() {
    try {
        const loadingState = document.getElementById('loadingState');
        const mealPlanContent = document.getElementById('mealPlanContent');
        
        if (loadingState && mealPlanContent) {
            loadingState.style.display = 'none';
            mealPlanContent.style.display = 'block';
            
            console.log('강제로 식단관리 컨텐츠 로드 완료');
            
            // 초기 메뉴 로드
            loadMenus();
        }
    } catch (error) {
        console.error('강제 로드 오류:', error);
    }
}

// 엔터 키로 검색
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('menuSearchInput');
    if (searchInput) {
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchMenus();
            }
        });
    }
});
</script>